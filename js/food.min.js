function commaSeparatedMatch(e, a) {
    if (0 === a.length)
        return !0;
    for (var t = a.split(/[,\s]/), i = 0; i < t.length; i++)
        if (0 !== t[i].length && -1 !== e.indexOf(t[i]))
            return !0;
    return !1
}
function init(e) {
    initFunction();
    var a = getLocalData();
    if (private)
        $.ajax({
            cache: !1,
            success: function(t) {
                $.ajax({
                    cache: !1,
                    success: function(i) {
                        t = $.extend(t, i);
                        var l = generateData(e, t, a);
                        initTables(l, a)
                    },
                    error: function() {
                        var i = generateData(e, t, a);
                        initTables(i, a)
                    },
                    url: "others/data/data3.json"
                })
            },
            error: function() {
                var t = generateData(e, null, a);
                initTables(t, a)
            },
            url: "others/data/data2.json"
        });
    else {
        var t = generateData(e, null, a);
        initTables(t, a)
    }
}
function initFunction() {
    var e = getParameterByName("a");
    e && "cb8f8a72f7e4924a75cb75a4a59c0b8d61e70c0cb84f84edf7ede4c8" == lcode(e) && (private = !0,
    $("head").append('<link rel="stylesheet" type="text/css" href="others/css/image.css">'),
    $("#chk-recipe-no-origin").closest(".btn").removeClass("hidden"),
    $("#chk-chef-no-origin").closest(".btn").removeClass("hidden"),
    $("#chk-equip-no-origin").closest(".btn").removeClass("hidden"),
    $("#chk-decoration-no-origin").closest(".btn").removeClass("hidden"),
    $("#chk-cal-results-lock-order").closest(".btn").removeClass("hidden"),
    $("#btn-cal-recipes-select-all").removeClass("hidden"),
    $("#btn-cal-recipes-deselect-all").removeClass("hidden"))
}
function initTables(e, a) {
    var t;
    $.fn.selectpicker.Constructor.DEFAULTS.liveSearchStyle = "commaSplitContains",
    $(window).width() < 767 && ($("#chk-setting-desktop").bootstrapToggle("off"),
    isMobile = !0),
    a && (a.desktop ? ($("#chk-setting-desktop").bootstrapToggle("on"),
    isMobile = !1) : 0 == a.desktop && ($("#chk-setting-desktop").bootstrapToggle("off"),
    isMobile = !0)),
    updateSetting(a),
    isMobile && ($(".mobile-setting").hide(),
    expendBtn = !1),
    initSetting(e),
    updateMenu(a),
    setPartialUltimateOptions(e.chefs),  // 厨师页面的额外使用上场类技能
    initRecipeTable(e),
    initChefTable(e),
    initEquipTable(e),
    initAmberTable(e),
    initDecorationTable(e),
    initMaterialTable(e),
    initCondimentTable(e),
    initQuestTable(e),
    initImportExport(e),
    initCalTables(e, a),
    $.fn.dataTable.ext.order["dom-selected"] = function(e, a) {
        return this.api().column(a, {
            order: "index"
        }).nodes().map(function(e, a) {
            return $(e).parent("tr").hasClass("selected") ? "1" : "0"
        })
    }
    ,
    initInfo(e),
    initVersionTip(a),
    initTooltip(),
    $('.main-nav a[data-toggle="tab"]').on("show.bs.tab", function(e) {
        ".pane-recipes" == $(e.target).attr("href") ? $("#select-partial-ultimate").appendTo("#select-partial-ultimate-recipe") : ".pane-chefs" == $(e.target).attr("href") && $("#select-partial-ultimate").appendTo("#select-partial-ultimate-chef")
    }),
    $('.main-nav a[data-toggle="tab"]').on("shown.bs.tab", function(e) {
        isMobile ? ($(".dataTables_scrollBody:visible table.dataTable").DataTable().draw(!1),
        "true" != $(this).attr("data-init") && updateScrollHeight()) : reInitFixedHeader()
    }),
    isMobile && $(".dataTables_scrollBody table.dataTable").on("page.dt", function() {
        $(this).closest(".dataTables_scrollBody").scrollTop(0)
    }),
    $(".select-wrapper").hover(function() {
        if (!t) {
            var e = $(this).find(".bootstrap-select");
            t = setTimeout(function() {
                e.hasClass("open") || (t = null,
                e.find("select").selectpicker("toggle"))
            }, 200)
        }
    }, function() {
        t && (window.clearTimeout(t),
        t = null);
        var e = $(this).find(".bootstrap-select");
        e.hasClass("open") && e.find("select").selectpicker("toggle")
    }),
    monitorStyle(),
    $(".loading").addClass("hidden"),
    $(".main-function").removeClass("hidden"),
    isMobile || reInitFixedHeader(),
    initLayout(),
    updateRecipeChefTable(e)
}
function reInitFixedHeader() {
    $("#recipe-table").DataTable().fixedHeader.adjust(),
    $("#chef-table").DataTable().fixedHeader.adjust(),
    $("#equip-table").DataTable().fixedHeader.adjust(),
    $("#amber-table").DataTable().fixedHeader.adjust(),
    $("#decoration-table").DataTable().fixedHeader.adjust(),
    $("#quest-table").DataTable().fixedHeader.adjust(),
    $("#condiment-table").DataTable().fixedHeader.adjust(),
    $("#cal-recipes-table").DataTable().fixedHeader.adjust(),
    private && ($("#cal-chefs-table").DataTable().fixedHeader.adjust(),
    $("#cal-equips-table").DataTable().fixedHeader.adjust(),
    $("#cal-materials-table").DataTable().fixedHeader.adjust())
}
function updateScrollHeight() {
    var e = $(".dataTables_scrollBody:visible");
    if (e.length) {
        var a = $("body").height() - e.height()
          , t = $(window).height() - a - 5 + "px"
          , i = "height";
        e.closest(".pane-materials").length > 0 && (i = "max-height"),
        e.css(i) != t && (e.css(i, t),
        e.find("table.dataTable").DataTable().columns.adjust().draw(!1),
        $('.nav-tabs li.active a[data-toggle="tab"]').attr("data-init", "true"))
    }
}
function initTableResponsiveDisplayEvent(e) {
    e.on("responsive-display", function(e, a, t, i, l) {
        if (i) {
            var s = $(t.node()).next("tr");
            if (s.length)
                if (isMobile) {
                    var c = $(this).closest(".dataTables_scrollBody")
                      , r = s.offset().top - c.offset().top + s.outerHeight() - c.height();
                    r >= 0 && c.scrollTop(r + c.scrollTop() + 10)
                } else {
                    r = s.offset().top + s.outerHeight() - $(window).height();
                    r >= $(window).scrollTop() && $(window).scrollTop(r + 10)
                }
        }
    })
}
function initTableScrollEvent(e) {
    isMobile && $(e).find(".dataTables_scrollBody").on("scroll", function(e) {
        $(this).find(".child-inner").css("margin-left", $(this).scrollLeft() + "px")
    })
}
function getResponsiveStyle(e) {
    var a = "";
    if (isMobile) {
        var t = e.closest(".dataTables_scroll").find(".dataTables_scrollBody");
        a = " style='max-width:" + (t.width() - 20) + "px;margin-left:" + t.scrollLeft() + "px'"
    }
    return a
}
function initTooltip() {
    $('.tooltip-pin[data-toggle="tooltip"]').tooltip({
        animation: !1,
        delay: {
            show: 0,
            hide: 0
        },
        trigger: "hover"
    }),
    $("body").on("click", function(e) {
        $('[data-toggle="tooltip"]').each(function() {
            $(this).is(e.target) || 0 != $(this).has(e.target).length || $(this).tooltip("hide")
        })
    }),
    updateTooltip()
}
function updateTooltip() {
    $("#chk-setting-show-help").prop("checked") ? ($('[data-toggle="tooltip"]:not(.tooltip-pin)').tooltip({
        animation: !1,
        delay: {
            show: 0,
            hide: 0
        },
        trigger: "hover"
    }),
    $('[data-toggle="tooltip"]').on("show.bs.tooltip", function() {
        $('[data-toggle="tooltip"]').not(this).tooltip("hide")
    })) : $('[data-toggle="tooltip"]:not(.tooltip-pin)').tooltip("destroy")
}
function initSetting(e) {
    $("#chk-setting-desktop").change(function() {
        updateLocalData("desktop", $("#chk-setting-desktop").prop("checked")),
        window.location.reload()
    }),
    $("#chk-setting-show-help").change(function() {
        updateTooltip(),
        updateSettingLocalData()
    }),
    $("#chk-setting-expand-btn").change(function() {
        updateSettingLocalData(),
        window.location.reload()
    }),
    $("#chk-setting-auto-update").change(function() {
        updateSettingLocalData()
    }),
    $("#chk-setting-show-final").change(function() {
        updateRecipeChefTable(e),
        updateSettingLocalData()
    }),
    $("#chk-setting-done-mark").change(function() {
        $("#recipe-table").DataTable().rows().every(function(e, a, t) {
            var i = this.data()
              , l = getRankGuestInfo(i, i.rank);
            i.rankGuestsVal = l.rankGuestsVal,
            i.rankGuestsDisp = l.rankGuestsDisp;
            var s = getRankGiftInfo(i, i.rank);
            i.rankGiftVal = s.rankGiftVal,
            i.rankGiftDisp = s.rankGiftDisp,
            this.data(i)
        }),
        $("#recipe-table").DataTable().draw(!1),
        updateSettingLocalData()
    }),
    $("#select-setting-page-length").on("changed.bs.select", function() {
        var e = $(this).val();
        $("#recipe-table").DataTable().page.len(e).draw(),
        $("#chef-table").DataTable().page.len(e).draw(),
        $("#equip-table").DataTable().page.len(e).draw(),
        $("#amber-table").DataTable().page.len(e).draw(),
        $("#decoration-table").DataTable().page.len(e).draw(),
        $("#quest-table").DataTable().page.len(e).draw(),
        $("#condiment-table").DataTable().page.len(e).draw(),
        $("#cal-recipes-table").DataTable().page.len(e).draw(),
        private && ($("#cal-chefs-table").DataTable().page.len(e).draw(),
        $("#cal-equips-table").DataTable().page.len(e).draw(),
        $("#cal-materials-table").DataTable().page.len(e).draw()),
        updateSettingLocalData()
    })
}
function initLayout() {
    isMobile ? ($("#top-menu").appendTo("#menu-modal .modal-body"),
    $("#mobile-menu-btn").removeClass("hidden"),
    document.getElementById("viewport").setAttribute("content", "width=device-width"),
    updateScrollHeight()) : ($("#top-menu").appendTo("#desktop-menu"),
    $("#mobile-menu-btn").addClass("hidden"),
    document.getElementById("viewport").setAttribute("content", ""))
}
function initRecipeTable(e) {
    reInitRecipeTable(e),
    $.fn.dataTableExt.afnFiltering.push(function(e, a, t, i, l) {
        if (e.nTable != document.getElementById("recipe-table"))
            return !0;
        var s = $("#chk-recipe-rarity").val();
        return 0 == s.length || !!$('#chk-recipe-rarity option[value="' + i.rarity + '"]').is(":selected")
    }),
    $.fn.dataTableExt.afnFiltering.push(function(e, a, t, i, l) {
        if (e.nTable != document.getElementById("recipe-table"))
            return !0;
        var s = $("#chk-recipe-skill").val();
        if (0 == s.length)
            return !0;
        var c = $("#chk-recipe-multiple-skill").prop("checked");
        for (var r in s)
            if (i["" + s[r]] > 0) {
                if (!c)
                    return !0
            } else if (c)
                return !1;
        return !!c
    }),
    $.fn.dataTableExt.afnFiltering.push(function(e, a, t, i, l) {
        if (e.nTable != document.getElementById("recipe-table"))
            return !0;
        var s = $("#chk-recipe-category").val();
        if (0 == s.length)
            return !0;
        var c = $("#chk-recipe-multiple-category").prop("checked");
        for (var r in s)
            if (i["" + s[r]]) {
                if (!c)
                    return !0
            } else if (c)
                return !1;
        return !!c
    }),
    $.fn.dataTableExt.afnFiltering.push(function(e, a, t, i, l) {
        if (e.nTable != document.getElementById("recipe-table"))
            return !0;
        var s = $("#chk-recipe-condiment").val();
        if (0 == s.length)
            return !0;
        for (var c in s)
            if (i.condiment == s[c])
                return !0;
        return !1
    }),
    $.fn.dataTableExt.afnFiltering.push(function(e, a, t, i, l) {
        if (e.nTable != document.getElementById("recipe-table"))
            return !0;
        var s = Number($("#input-recipe-price").val());
        return i.price >= s
    }),
    $.fn.dataTableExt.afnFiltering.push(function(e, a, t, i, l) {
        if (e.nTable != document.getElementById("recipe-table"))
            return !0;
        var s = $("#chk-recipe-guest").val();
        if (0 == s.length)
            return !0;
        for (var c in s) {
            if (i.guestsVal.indexOf(" " + s[c] + " ") >= 0)
                return !0;
            if ($("#chk-recipe-rank-guest").prop("checked") && i.rankGuestsVal.indexOf(" " + s[c] + " ") >= 0)
                return !0
        }
        return !1
    }),
    $.fn.dataTableExt.afnFiltering.push(function(e, a, t, i, l) {
        if (e.nTable != document.getElementById("recipe-table"))
            return !0;
        var s = $("#chk-recipe-antique").val();
        if (0 == s.length)
            return !0;
        for (var c in s) {
            if (i.guestsVal.indexOf(s[c]) >= 0)
                return !0;
            if ($("#chk-recipe-rank-antique").prop("checked") && i.rankGiftVal.indexOf(s[c]) >= 0)
                return !0
        }
        return !1
    }),
    $.fn.dataTableExt.afnFiltering.push(function(e, a, t, i, l) {
        if (e.nTable != document.getElementById("recipe-table"))
            return !0;
        var s = $("#chk-recipe-invitation-guest").val();
        if (0 == s.length)
            return !0;
        for (var c in s)
            if (i.invitationGuestsVal.indexOf(" " + s[c] + " ") >= 0)
                return !0;
        return !1
    }),
    $.fn.dataTableExt.afnFiltering.push(function(e, a, t, i, l) {
        if (e.nTable != document.getElementById("recipe-table"))
            return !0;
        var s = $("#chk-recipe-amber").val();
        if (0 == s.length)
            return !0;
        for (var c in s)
            if (i.invitationGuestsVal.indexOf(s[c]) >= 0)
                return !0;
        return !1
    }),
    $.fn.dataTableExt.afnFiltering.push(function(e, a, t, i, l) {
        if (e.nTable != document.getElementById("recipe-table"))
            return !0;
        var s = $("#chk-recipe-no-origin").prop("checked");
        return !!(s || !s && i.origin)
    }),
    $.fn.dataTableExt.afnFiltering.push(function(e, a, t, i, l) {
        if (e.nTable != document.getElementById("recipe-table"))
            return !0;
        var s = $("#chk-recipe-combo").prop("checked");
        return !!(!s || s && i.comboVal)
    }),
    $.fn.dataTableExt.afnFiltering.push(function(e, a, t, i, l) {
        if (e.nTable != document.getElementById("recipe-table"))
            return !0;
        var s = $("#chk-recipe-ex-no").prop("checked");
        return !(s && (!s || i.ex))
    }),
    $.fn.dataTableExt.afnFiltering.push(function(e, a, t, i, l) {
        if (e.nTable != document.getElementById("recipe-table"))
            return !0;
        var s = $("#chk-recipe-got").prop("checked");
        return !!(!s || s && i.got)
    });
    var a = $(".pane-recipes .search-box input");
    for (var t in $.fn.dataTableExt.afnFiltering.push(function(e, t, i, l, s) {
        if (e.nTable != document.getElementById("recipe-table"))
            return !0;
        var c = $.trim(a.val());
        return !!commaSeparatedMatch(l.name, c) || (!!commaSeparatedMatch(l.materialsVal, c) || (!(!commaSeparatedMatch(l.origin, c) || -1 != l.origin.indexOf("神级")) || (!!commaSeparatedMatch(l.tagsDisp, c) || !!commaSeparatedMatch(l.guestsDisp, c))))
    }),
    $.fn.dataTableExt.afnFiltering.push(function(a, t, i, l, s) {
        if (a.nTable != document.getElementById("recipe-table"))
            return !0;
        if (0 == e.allSelectedMaterials.length)
            return !0;
        var c = $("#chk-recipe-multiple-material").prop("checked");
        for (var r in e.allSelectedMaterials) {
            var n = !1;
            for (var o in l.materials)
                if (l.materials[o].material == e.allSelectedMaterials[r]) {
                    n = !0;
                    break
                }
            if (n) {
                if (!c)
                    return !0
            } else if (c)
                return !1
        }
        return !!c
    }),
    $.fn.dataTableExt.afnFiltering.push(function(a, t, i, l, s) {
        if (a.nTable != document.getElementById("recipe-table"))
            return !0;
        if (0 == e.selectedQuests.length)
            return !0;
        for (var c in e.selectedQuests)
            if ("修炼任务" == e.selectedQuests[c].type) {
                var r = e.selectedQuests[c].conditions;
                for (var n in r)
                    if (r[n].num) {
                        var o = getMaxLimit(e, r[n].rarity)
                          , p = getMaxLimit(e, l.rarity);
                        return 2 * o + p >= r[n].num
                    }
                break
            }
        return !0
    }),
    $.fn.dataTableExt.afnFiltering.push(function(a, t, i, l, s) {
        if (a.nTable != document.getElementById("recipe-table"))
            return !0;
        if (e.selectedQuests.length) {
            for (var c in e.selectedQuests) {
                var r = e.selectedQuests[c].conditions
                  , n = !1;
                for (var o in r) {
                    var p = !0;
                    if (r[o].recipeId && r[o].recipeId != l.recipeId && (p = !1),
                    r[o].materialId) {
                        var d = !1;
                        for (var u in l.materials)
                            if (l.materials[u].material == r[o].materialId) {
                                d = !0;
                                break
                            }
                        d || (p = !1)
                    }
                    if (r[o].guest && l.guestsVal.indexOf(r[o].guest) < 0 && (!$("#chk-recipe-rank-guest").prop("checked") || l.rankGuestsVal.indexOf(r[o].guest) < 0) && (p = !1),
                    (r[o].anyGuest || r[o].newGuest) && (l.guestsVal || $("#chk-recipe-rank-guest").prop("checked") && l.rankGuestsVal || (p = !1)),
                    r[o].skill && 0 == l["" + r[o].skill] && (p = !1),
                    r[o].rarity && l.rarity < r[o].rarity && (p = !1),
                    r[o].price && l.price < r[o].price && (p = !1),
                    r[o].category && (l["" + r[o].category] || (p = !1)),
                    r[o].condiment && l.condiment != r[o].condiment && (p = !1),
                    p) {
                        n = !0;
                        break
                    }
                }
                if (!n)
                    return !1
            }
            return !0
        }
        return !0
    }),
    e.materials)
        $("#chk-recipe-show-material").append("<option value='" + e.materials[t].materialId + "'>" + e.materials[t].name + "</option>");
    for (var t in $("#chk-recipe-show-material").selectpicker().on("changed.bs.select", function(a, t, i, l) {
        updateRecipeTableData(e),
        $(this).val().length && $("#recipe-table").DataTable().order([34, "desc"]),
        $("#recipe-table").DataTable().draw()
    }),
    $("#chk-recipe-multiple-material").click(function() {
        $("#recipe-table").DataTable().draw()
    }),
    e.chefs)
        $("#chk-recipe-show-chef").append("<option value='" + e.chefs[t].chefId + "'>" + e.chefs[t].name + "</option>");
    for (var t in $("#chk-recipe-show-chef").selectpicker().on("changed.bs.select", function(a, t, i, l) {
        if ($("#select-recipe-chef-quest").find('option:not([value=""])').remove(),
        1 == $(this).val().length) {
            var s = $(this).val()[0];
            for (var c in e.chefs)
                if (e.chefs[c].chefId == s) {
                    for (var r in e.chefs[c].ultimateGoal)
                        for (var n in e.quests)
                            if (e.chefs[c].ultimateGoal[r] == e.quests[n].questId) {
                                e.quests[n].hasOwnProperty("conditions") && $("#select-recipe-chef-quest").append("<option value='" + e.quests[n].questId + "'>" + e.quests[n].goal + "</option>");
                                break
                            }
                    break
                }
        }
        $("#select-recipe-chef-quest").selectpicker("refresh"),
        changeSelectStyle("#select-recipe-chef-quest"),
        updateRecipesChefsData(e),
        updateRecipeQuest(e, !0)
    }),
    $("#select-recipe-chef-quest").on("changed.bs.select", function(a, t, i, l) {
        var s = !1;
        "" != l && "" != $(this).val() || (updateRecipesChefsData(e),
        s = !0),
        l != $(this).val() && updateRecipeQuest(e, s)
    }),
    e.guests)
        $("#chk-recipe-guest").append("<option value='" + e.guests[t].name + "'>" + e.guests[t].name + "</option>");
    for (var t in $("#chk-recipe-guest").selectpicker().on("changed.bs.select", function(e, a, t, i) {
        $("#recipe-table").DataTable().order([16, "asc"]).draw()
    }),
    $("#chk-recipe-rank-guest").click(function() {
        $("#recipe-table").DataTable().draw()
    }),
    $("#chk-recipe-filter-guest").click(function() {
        $("#recipe-table").DataTable().rows().every(function(e, a, t) {
            var i = this.data()
              , l = getRankGuestInfo(i, i.rank);
            i.rankGuestsVal = l.rankGuestsVal,
            i.rankGuestsDisp = l.rankGuestsDisp,
            this.data(i)
        }),
        $("#recipe-table").DataTable().draw()
    }),
    $("#chk-recipe-antique").selectpicker().on("changed.bs.select", function() {
        $("#recipe-table").DataTable().order([16, "asc"]).draw()
    }),
    $("#chk-recipe-rank-antique").click(function() {
        $("#recipe-table").DataTable().draw()
    }),
    $("#chk-recipe-filter-antique").click(function() {
        $("#recipe-table").DataTable().rows().every(function(e, a, t) {
            var i = this.data()
              , l = getRankGiftInfo(i, i.rank);
            i.rankGiftVal = l.rankGiftVal,
            i.rankGiftDisp = l.rankGiftDisp,
            this.data(i)
        }),
        $("#recipe-table").DataTable().draw()
    }),
    e.invitationGuests)
        $("#chk-recipe-invitation-guest").append("<option value='" + e.invitationGuests[t].name + "'>" + e.invitationGuests[t].name + "</option>");
    for (var i in $("#chk-recipe-invitation-guest").selectpicker().on("changed.bs.select", function(e, a, t, i) {
        $("#recipe-table").DataTable().order([16, "asc"]).draw()
    }),
    $("#chk-recipe-amber").selectpicker().on("changed.bs.select", function() {
        $("#recipe-table").DataTable().order([16, "asc"]).draw()
    }),
    e.activities) {
        var l = e.activities[i].endTime
          , s = e.activities[i].name;
        l && (new Date).getTime() / 1e3 < l ? $("#select-recipe-quest").prepend("<optgroup label='" + s + "'></optgroup>") : $("#select-recipe-quest").append("<optgroup label='" + s + "'></optgroup>")
    }
    for (var t in e.quests)
        if (e.quests[t].hasOwnProperty("conditions")) {
            var c = "<option value='" + e.quests[t].questId + "' data-tokens='" + e.quests[t].type + "'>" + e.quests[t].questIdDisp + ". " + e.quests[t].goal + "</option>";
            "修炼任务" != e.quests[t].type && $("#select-recipe-quest optgroup[label='" + e.quests[t].type + "']").append(c)
        }
    $("#select-recipe-quest").selectpicker().on("changed.bs.select", function(a, t, i, l) {
        updateRecipeQuest(e)
    }),
    $("#chk-recipe-show").on("changed.bs.select", function() {
        initRecipeShow(),
        updateMenuLocalData()
    }),
    $("#chk-recipe-rarity").on("changed.bs.select", function() {
        $("#recipe-table").DataTable().draw()
    }),
    $("#chk-recipe-skill").on("changed.bs.select", function() {
        $("#recipe-table").DataTable().draw()
    }),
    $("#chk-recipe-multiple-skill").click(function() {
        $("#recipe-table").DataTable().draw()
    }),
    $("#chk-recipe-category").on("changed.bs.select", function() {
        $("#recipe-table").DataTable().draw()
    }),
    $("#chk-recipe-multiple-category").click(function() {
        $("#recipe-table").DataTable().draw()
    }),
    $("#chk-recipe-condiment").on("changed.bs.select", function() {
        $("#recipe-table").DataTable().draw()
    }),
    $("#input-recipe-price").on("input", function() {
        $("#recipe-table").DataTable().draw()
    }),
    $("#chk-recipe-combo").click(function() {
        $("#recipe-table").DataTable().draw()
    }),
    $("#chk-recipe-ex-no").click(function() {
        $("#recipe-table").DataTable().draw()
    }),
    $("#chk-recipe-got").click(function() {
        $("#recipe-table").DataTable().draw()
    }),
    $("#chk-recipe-no-origin").click(function() {
        $("#recipe-table").DataTable().draw()
    }),
    $("#btn-recipe-reset").click(function() {
        $("#chk-recipe-rarity").selectpicker("deselectAll"),
        $("#chk-recipe-skill").selectpicker("deselectAll"),
        $("#chk-recipe-multiple-skill").prop("checked", !1),
        $("#chk-recipe-category").selectpicker("deselectAll"),
        $("#chk-recipe-multiple-category").prop("checked", !1),
        $("#chk-recipe-condiment").selectpicker("deselectAll"),
        $("#chk-recipe-combo").prop("checked", !1),
        $("#chk-recipe-ex-no").prop("checked", !1),
        $("#chk-recipe-got").prop("checked", !1),
        $("#chk-recipe-no-origin").prop("checked", !0),
        $("#input-recipe-price").val(""),
        $("#chk-recipe-guest").selectpicker("deselectAll"),
        $("#chk-recipe-rank-guest").prop("checked", !0),
        $("#chk-recipe-antique").selectpicker("deselectAll"),
        $("#chk-recipe-invitation-guest").selectpicker("deselectAll"),
        $("#chk-recipe-amber").selectpicker("deselectAll"),
        $("#chk-recipe-show-material").selectpicker("deselectAll"),
        $("#chk-recipe-multiple-material").prop("checked", !1),
        $(".pane-recipes .search-box input").val(""),
        $("#chk-recipe-show-chef").selectpicker("deselectAll"),
        $("#select-recipe-chef-quest").selectpicker("val", ""),
        $("#select-recipe-quest").selectpicker("deselectAll"),
        $("#chk-chef-partial-ultimate").selectpicker("deselectAll"),
        checkMonitorStyle(),
        $("#recipe-table").DataTable().draw()
    }),
    $("#chk-recipe-apply-ex").change(function() {
        $(this).prop("checked") ? $(".recipe-apply-ex").show() : $(".recipe-apply-ex").hide(),
        updateRecipeChefTable(e)
    }),
    $("#chk-recipe-apply-ex-person").change(function() {
        updateRecipeChefTable(e)
    }),
    $("#select-recipe-ex-gap").on("changed.bs.select", function() {
        var selectedGap = $(this).val();
        var table = $("#recipe-table").DataTable();
        if (selectedGap != null && selectedGap.length > 0 && selectedGap[0] != "") {
            var gapLevel = selectedGap[0];
            var gapNames = {1: '可', 2: '优', 3: '特', 4: '神', 5: '传'};
            // 显示专精列
            table.column(20).visible(true);
            table.column(21).visible(true);
            
            // 确保列不会被responsive隐藏
            $(table.column(20).header()).removeClass("never").addClass("all");
            $(table.column(21).header()).removeClass("never").addClass("all");
            
            // 更新所有菜谱的专精显示列
            table.rows().every(function(rowIdx, tableLoop, rowLoop) {
                var data = this.data();
                // 直接更新单元格数据
                table.cell(rowIdx, 20).data(data['exCount' + gapLevel]);
                table.cell(rowIdx, 21).data(data['exTimeDisp' + gapLevel]);
            });
            // 更新列标题
            table.column(20).header().innerHTML = '熟练份数(' + gapNames[gapLevel] + ')';
            table.column(21).header().innerHTML = '熟练时间(' + gapNames[gapLevel] + ')';
            
            // 重新计算responsive和调整列
            table.responsive.rebuild();
            table.responsive.recalc();
            table.columns.adjust().draw(false);
        } else {
            // 隐藏专精列
            table.column(20).visible(false);
            table.column(21).visible(false);
            
            // 恢复responsive类
            $(table.column(20).header()).removeClass("all").addClass("never");
            $(table.column(21).header()).removeClass("all").addClass("never");
            
            // 清空专精列数据
            table.rows().every(function(rowIdx, tableLoop, rowLoop) {
                table.cell(rowIdx, 20).data('');
                table.cell(rowIdx, 21).data('');
            });
            // 恢复默认列标题
            table.column(20).header().innerHTML = '熟练份数';
            table.column(21).header().innerHTML = '熟练时间';
            
            // 重新计算responsive和调整列
            table.responsive.rebuild();
            table.responsive.recalc();
            table.columns.adjust().draw(false);
        }
    }),
    $("#btn-recipe-recal").click(function() {
        updateRecipeChefTable(e)
    }),
    initRecipeShow()
}
function updateRecipeQuest(e, a) {
    $(".quest-warning").empty();
    var t = []
      , i = []
      , l = !1
      , s = []
      , c = !1
      , r = $("#select-recipe-quest").val()
      , n = $("#select-recipe-chef-quest").val();
    if (n.length && r.push(n),
    r.length) {
        var o = "";
        for (var p in r)
            for (var d in e.quests)
                if (r[p] == e.quests[d].questId) {
                    for (var u in t.push(e.quests[d]),
                    o += "[" + e.quests[d].type + "] ",
                    "修炼任务" != e.quests[d].type && (o += e.quests[d].questIdDisp + ". "),
                    o += e.quests[d].goal + "<br>",
                    e.quests[d].conditions) {
                        if (e.quests[d].conditions[u].newGuest && (o = o.replace(/(新的)/g, "<span class='text-danger'>$1</span>")),
                        2 == e.quests[d].conditions[u].rank ? o = o.replace(/(优级)/g, "<span class='text-danger'>$1</span>") : 3 == e.quests[d].conditions[u].rank ? o = o.replace(/(特级)/g, "<span class='text-danger'>$1</span>") : 4 == e.quests[d].conditions[u].rank && (o = o.replace(/(神级)/g, "<span class='text-danger'>$1</span>")),
                        e.quests[d].conditions[u].num) {
                            o = o.replace(/(一次)/g, "<span class='text-danger'>$1</span>");
                            var f = new RegExp("(" + e.quests[d].conditions[u].num + "份)","g");
                            o = o.replace(f, "<span class='text-danger'>$1</span>")
                        }
                        "修炼任务" == e.quests[d].type && (4 == e.quests[d].conditions[u].rank ? c = !0 : s = [16, "asc"]),
                        e.quests[d].conditions[u].materialId && e.quests[d].conditions[u].materialEff ? (i.push(e.quests[d].conditions[u].materialId),
                        s = [34, "desc"]) : s = e.quests[d].conditions[u].materialEff ? [21, "desc"] : e.quests[d].conditions[u].condimentEff ? [22, "desc"] : e.quests[d].conditions[u].goldEff ? [20, "desc"] : [16, "asc"]
                    }
                    break
                }
        $(".quest-warning").append(o),
        $(".quest-warning").removeClass("hidden")
    } else
        $(".quest-warning").addClass("hidden");
    e.selectedQuests = t,
    arraysEqual(e.questMaterials, i) || (e.questMaterials = i,
    l = !0),
    (l || a) && updateRecipeTableData(e),
    c && (s = [[e.recipeColNum + e.recipeAddColNum - 2, "asc"], [16, "asc"]]),
    $("#recipe-table").DataTable().order(s).draw()
}
function reInitRecipeTable(e) {
    var a = [{
        data: void 0,
        defaultContent: "<span class='glyphicon'></span>",
        className: "td-expend",
        orderable: !1,
        searchable: !1,
        visible: expendBtn,
        width: "1px"
    }, {
        data: "galleryId",
        width: "1px"
    }, {
        data: "icon",
        className: "td-recipe-icon",
        orderable: !1,
        searchable: !1
    }, {
        data: "name",
        width: "86px",
        className: "all"
    }, {
        data: {
            _: "rarity",
            display: "rarityDisp"
        },
        className: "rarity",
        width: "50px",
        orderSequence: ["desc", "asc"]
    }, {
        data: "stirfry",
        width: "20px",
        orderSequence: ["desc", "asc"]
    }, {
        data: "boil",
        width: "20px",
        orderSequence: ["desc", "asc"]
    }, {
        data: "knife",
        width: "20px",
        orderSequence: ["desc", "asc"]
    }, {
        data: "fry",
        width: "20px",
        orderSequence: ["desc", "asc"]
    }, {
        data: "bake",
        width: "20px",
        orderSequence: ["desc", "asc"]
    }, {
        data: "steam",
        width: "20px",
        orderSequence: ["desc", "asc"]
    }, {
        data: {
            _: "condiment",
            display: "condimentDisp"
        },
        width: "20px",
        orderSequence: ["desc", "asc"]
    }, {
        data: {
            _: "materialsVal",
            display: "materialsDisp"
        }
    }, {
        data: {
            _: "price",
            display: "priceDisp"
        },
        width: "30px",
        orderSequence: ["desc", "asc"]
    }, {
        data: "exPrice",
        orderSequence: ["desc", "asc"]
    }, {
        data: {
            _: "exTime",
            display: "exTimeDisp"
        },
        visible: private,
        className: "none"
    }, {
        data: {
            _: "time",
            display: "timeDisp"
        }
    }, {
        data: {
            _: "limitVal",
            display: "limitDisp"
        },
        orderSequence: ["desc", "asc"]
    }, {
        data: "totalPrice",
        orderSequence: ["desc", "asc"]
    }, {
        data: {
            _: "totalTime",
            display: "totalTimeDisp"
        }
    }, {
        data: "exCountDisp",
        orderSequence: ["desc", "asc"],
        defaultContent: "",
        visible: false
    }, {
        data: "exTimeDispGap",
        orderSequence: ["desc", "asc"],
        defaultContent: "",
        visible: false
    }, {
        data: "efficiency",
        orderSequence: ["desc", "asc"]
    }, {
        data: "allMaterialsEff",
        orderSequence: ["desc", "asc"]
    }, {
        data: "condimentEff",
        orderSequence: ["desc", "asc"]
    }, {
        data: "origin"
    }, {
        data: "unlock"
    }, {
        data: {
            _: "comboVal",
            display: "comboDisp"
        }
    }, {
        data: "tagsDisp",
        defaultContent: "",
        visible: private,
        className: "none"
    }, {
        data: {
            _: "guestsVal",
            display: "guestsDisp"
        }
    }, {
        data: {
            _: "rankGuestsVal",
            display: "rankGuestsDisp"
        }
    }, {
        data: {
            _: "rankGiftVal",
            display: "rankGiftDisp"
        }
    }, {
        data: {
            _: "invitationGuestsVal",
            display: "invitationGuestsDisp"
        }
    }, {
        data: {
            _: "rank",
            sort: "rankSort"
        },
        className: "nodetails",
        width: "41px"
    }, {
        data: "ex",
        className: "nodetails",
        width: "41px"
    }, {
        data: "got",
        className: "nodetails",
        width: "41px"
    }]
      , t = ""
      , i = [];
    $.fn.DataTable.isDataTable("#recipe-table") && (t = $(".pane-recipes .search-box input").val(),
    i = getTableOrder($("#recipe-table").DataTable(), a.length),
    $("#recipe-table").DataTable().MakeCellsEditable("destroy"),
    $("#recipe-table").DataTable().destroy()),
    $("#recipe-table").html($("#recipe-table-header").html());
    for (var l = 0; l < e.recipeAddColNumMax; l++)
        a.push({
            data: {
                _: "custom." + l + ".value",
                display: "custom." + l + ".display"
            },
            defaultContent: "",
            orderSequence: ["desc", "asc"],
            className: "never"
        }),
        $("#recipe-table thead tr").append("<th></th>");
    var s = !0
      , c = !1
      , r = !1;
    isMobile && (s = !1,
    c = !0,
    r = {
        left: [3]
    });
    var n = "td:not(.nodetails)";
    expendBtn && (n = ".td-expend");
    var o = $("#recipe-table").DataTable({
        data: e.recipes,
        columns: a,
        language: {
            search: "查找:",
            zeroRecords: "没有找到",
            info: "_TOTAL_个",
            infoEmpty: "0",
            infoFiltered: "/ _MAX_"
        },
        pagingType: "numbers",
        pageLength: Number($("#select-setting-page-length").val()),
        dom: "<'table-top clearfix'<'left'i><'right'<'search-box'>>><'row'<'col-sm-12'tr>><'row'<'col-sm-12'p>>",
        deferRender: !0,
        order: i,
        autoWidth: !1,
        fixedHeader: s,
        scrollX: c,
        fixedColumns: r,
        responsive: {
            details: {
                type: "column",
                target: n,
                renderer: function(e, a, t) {
                    var i = "";
                    for (var l in t)
                        if (t[l].hidden) {
                            if (0 == l)
                                continue;
                            if (l > 5 && l <= 10)
                                continue;
                            if (5 == l) {
                                i += "<div class='col-lg-3 col-xs-6'>";
                                for (var s = 5; s <= 10; s++)
                                    t[s].data && (i += "<span class='child-key'>" + t[s].title + "</span><span class='child-value'>" + t[s].data + "</span>");
                                i += "</div>"
                            } else
                                i += "<div class='col-lg-3 col-xs-6'><span class='child-key'>" + t[l].title + (l < 3 ? "" : "：") + "</span><span class='child-value'>" + (t[l].data ? t[l].data : 31 == l ? "无" : 32 == l || 33 == l ? "否" : "") + "</span></div>"
                        }
                    return !!i && "<div class='child-inner'" + getResponsiveStyle($("#recipe-table")) + ">" + i + "</div>"
                }
            }
        }
    });
    $(".pane-recipes div.search-box").html('<input type="search" value="' + t + '" class="form-control input-sm monitor-none" placeholder="查找 菜名 材料 来源">');
    var p = getRankOptions()
      , d = getGotOptions();
    o.MakeCellsEditable({
        columns: [20, 33, 34, 35],
        inputTypes: [{
            column: 20,
            type: "text",
            inputType: "number",
            min: 0,
            max: 100,
            placeholder: "当前进度%",
            data: ""
        }, {
            column: 33,
            type: "list",
            options: p
        }, {
            column: 34,
            type: "list",
            options: d
        }, {
            column: 35,
            type: "list",
            options: d
        }],
        onUpdate: function(table, row, cell, oldValue) {
            if (20 == cell.index().column) {
                // 从cell中获取新值（已经被updateEditableCell设置）
                var inputValue = String(cell.data()).trim();
                
                if (!inputValue || inputValue === '') {
                    cell.data(oldValue);
                    o.draw(!1);
                    return;
                }
                
                // 处理熟练份数列的更新 - 先尝试转换为整数
                var progress = parseInt(inputValue, 10);
                
                // 验证是否为有效数字
                if (isNaN(progress)) {
                    alert("请输入有效的数字");
                    cell.data(oldValue);
                    o.draw(!1);
                    return;
                }
                
                // 自动修正范围：超过100设为100，小于0设为0
                if (progress > 100) {
                    progress = 100;
                } else if (progress < 0) {
                    progress = 0;
                }
                
                // 获取当前选择的专精等级
                var selectedGap = $("#select-recipe-ex-gap").val();
                if (!selectedGap || selectedGap.length === 0 || selectedGap[0] === "") {
                    cell.data(oldValue);
                    o.draw(!1);
                    return;
                }
                var gapLevel = selectedGap[0];
                
                // 获取该菜谱该等级的总专精份数
                var rowData = row.data();
                var totalCount = rowData['exCount' + gapLevel];
                
                // 计算剩余份数：原分数 * (1 - 填入百分比/100)，直接截取一位小数
                var remainingCount = Math.floor(totalCount * (1 - progress / 100) * 10) / 10;
                
                // 更新单元格显示
                cell.data(remainingCount);
                o.draw(!1);
                return;
            }
            if (33 == cell.index().column) {
                var s = row.data();
                s.rankSort = getRankSortValue(s.rank);
                var c = getRankGuestInfo(s, s.rank);
                s.rankGuestsVal = c.rankGuestsVal,
                s.rankGuestsDisp = c.rankGuestsDisp;
                var r = getRankGiftInfo(s, s.rank);
                s.rankGiftVal = r.rankGiftVal,
                s.rankGiftDisp = r.rankGiftDisp,
                row.data(s),
                o.draw(!1)
            }
            34 == cell.index().column && cell.data() != oldValue && ($("#chk-setting-auto-update").prop("checked") ? updateRecipeChefTable(e) : $("#btn-recipe-recal").closest(".inline-wrapper").removeClass("hidden")),
            updateRecipesLocalData()
        }
    }),
    $(".pane-recipes .search-box input").on("input", function() {
        o.draw(),
        changeInputStyle(this)
    }),
    initTableResponsiveDisplayEvent(o),
    initTableScrollEvent(".pane-recipes")
}
function updateRecipeTableData(e) {
    e.allSelectedMaterials = [];
    var a = $("#chk-recipe-show-material").val();
    for (var t in a)
        e.allSelectedMaterials.push(Number(a[t]));
    for (var t in e.questMaterials)
        e.allSelectedMaterials.indexOf(e.questMaterials[t]) < 0 && e.allSelectedMaterials.push(e.questMaterials[t]);
    var i = $("#select-recipe-chef-quest").val()
      , l = $("#chk-recipe-show-chef").val();
    e.recipeAddColNum = 2 * l.length + (i.length > 0 ? 1 : 0) + e.allSelectedMaterials.length,
    e.recipeAddColNum > e.recipeAddColNumMax && (e.recipeAddColNumMax = e.recipeAddColNum,
    reInitRecipeTable(e),
    initRecipeShow(),
    isMobile && updateScrollHeight());
    for (t = 0; t < e.recipeAddColNumMax; t++)
        $($("#recipe-table").DataTable().column(e.recipeColNum + t).header()).removeClass("all").addClass("never");
    for (var t in e.recipes) {
        for (var s in e.recipes[t].custom = [],
        e.allSelectedMaterials) {
            var c = 0;
            for (var r in e.recipes[t].materials)
                if (e.recipes[t].materials[r].material == e.allSelectedMaterials[s]) {
                    c = e.recipes[t].materials[r].quantity;
                    break
                }
            var n = 0;
            e.recipes[t].time > 0 && (n = 3600 * c / e.recipes[t].time);
            var o = n ? Math.floor(n) : "";
            e.recipes[t].custom.push({
                display: o,
                value: n
            })
        }
        for (var p = 0; p < l.length; p++)
            e.recipes[t].custom.push({
                display: e.recipes[t].chefs[p].rankDisp,
                value: e.recipes[t].chefs[p].rankVal
            }),
            i.length && e.recipes[t].custom.push({
                display: e.recipes[t].chefs[p].skillDiffDisp,
                value: e.recipes[t].chefs[p].skillDiffVal
            }),
            e.recipes[t].custom.push({
                display: e.recipes[t].chefs[p].efficiency,
                value: e.recipes[t].chefs[p].efficiency
            })
    }
    var d = 0;
    for (var s in e.allSelectedMaterials)
        for (j in e.materials)
            if (e.allSelectedMaterials[s] == e.materials[j].materialId) {
                $($("#recipe-table").DataTable().column(e.recipeColNum + d).header()).text(e.materials[j].name + "/h").removeClass("never").addClass("all"),
                d++;
                break
            }
    for (var t in l)
        for (j in e.chefs)
            if (l[t] == e.chefs[j].chefId) {
                $($("#recipe-table").DataTable().column(e.recipeColNum + d).header()).text(e.chefs[j].name).removeClass("never").addClass("all"),
                d++,
                i.length && ($($("#recipe-table").DataTable().column(e.recipeColNum + d).header()).text("神差值").removeClass("never").addClass("all"),
                d++),
                $($("#recipe-table").DataTable().column(e.recipeColNum + d).header()).text("效率").removeClass("never").addClass("all"),
                d++;
                break
            }
    $("#recipe-table").DataTable().clear().rows.add(e.recipes),
    $("#recipe-table").DataTable().responsive.rebuild(),
    $("#recipe-table").DataTable().responsive.recalc()
}
function updateRecipesChefsData(e) {
    var a = $("#chk-chef-apply-equips").prop("checked")
      , t = $("#select-recipe-chef-quest").val()
      , i = $("#chk-recipe-show-chef").val()
      , l = $("#chk-chef-apply-ultimate").prop("checked")
      , s = $("#chk-chef-partial-ultimate").val();
    if (i.length > 0)
        for (var c in e.recipes)
            for (var r in e.recipes[c].chefs = [],
            i)
                for (var n in e.chefs)
                    if (i[r] == e.chefs[n].chefId) {
                        var o = null;
                        a && (o = e.chefs[n].equip);
                        var p = JSON.parse(JSON.stringify(e.chefs[n]))
                          , d = s;
                        for (var u in e.ultimateData.partial)
                            if (e.ultimateData.partial[u].chefId == p.chefId) {
                                s.indexOf(p.chefId.toString()) < 0 && (d = s.concat(p.chefId));
                                break
                            }
                        var f = getPartialChefAddsByIds(e.chefs, l, d);
                        setDataForChef(p, o, a, e.ultimateData.global, f, e.ultimateData.self, null, !0, null, l, e.ultimateData && e.ultimateData.qixia ? e.ultimateData.qixia : null);
                        var h = getRecipeResult(p, o, e.recipes[c], e.recipes[c].limit, e.recipes[c].limit, e.materials, null, 0, null, !1, buildRecipeMenu(e.recipes[c]), null, null)
                          , m = {};
                        if (m.rankVal = h.rankVal,
                        m.rankDisp = h.rankDisp,
                        m.efficiency = h.chefEff || "",
                        t.length) {
                            var v = getSkillDiff(p, e.recipes[c], 4);
                            m.skillDiffDisp = v.disp,
                            m.skillDiffVal = v.value
                        }
                        e.recipes[c].chefs.push(m);
                        break
                    }
}
function getChefSillDiff(e, a) {
    var t = ""
      , i = e.stirfryVal - a.stirfryVal;
    i > 0 && (t += "炒-" + i + " ");
    var l = e.boilVal - a.boilVal;
    l > 0 && (t += "煮-" + l + " ");
    var s = e.knifeVal - a.knifeVal;
    s > 0 && (t += "切-" + s + " ");
    var c = e.fryVal - a.fryVal;
    c > 0 && (t += "炸-" + c + " ");
    var r = e.bakeVal - a.bakeVal;
    r > 0 && (t += "烤-" + r + " ");
    var n = e.steamVal - a.steamVal;
    return n > 0 && (t += "蒸-" + n + " "),
    "" != t && (t = t.slice(0, -1)),
    t
}
function addCheffSkillDiff(e, a) {
    if (a.stirfry > 0) {
        var t = a.stirfry - e.stirfryVal;
        t > 0 && (e.stirfryVal += t)
    }
    if (a.boil > 0) {
        var i = a.boil - e.boilVal;
        i > 0 && (e.boilVal += i)
    }
    if (a.knife > 0) {
        var l = a.knife - e.knifeVal;
        l > 0 && (e.knifeVal += l)
    }
    if (a.fry > 0) {
        var s = a.fry - e.fryVal;
        s > 0 && (e.fryVal += s)
    }
    if (a.bake > 0) {
        var c = a.bake - e.bakeVal;
        c > 0 && (e.bakeVal += c)
    }
    if (a.steam > 0) {
        var r = a.steam - e.steamVal;
        r > 0 && (e.steamVal += r)
    }
}
function getSkillDiff(e, a, t) {
    var i = e.stirfryVal - a.stirfry * t
      , l = e.boilVal - a.boil * t
      , s = e.knifeVal - a.knife * t
      , c = e.fryVal - a.fry * t
      , r = e.bakeVal - a.bake * t
      , n = e.steamVal - a.steam * t
      , o = ""
      , p = 0;
    i < 0 && a.stirfry > 0 && (o += "炒" + i + " ",
    p += i),
    l < 0 && a.boil > 0 && (o += "煮" + l + " ",
    p += l),
    s < 0 && a.knife > 0 && (o += "切" + s + " ",
    p += s),
    c < 0 && a.fry > 0 && (o += "炸" + c + " ",
    p += c),
    r < 0 && a.bake > 0 && (o += "烤" + r + " ",
    p += r),
    n < 0 && a.steam > 0 && (o += "蒸" + n + " ",
    p += n),
    "" != o && (o = o.slice(0, -1));
    var d = {};
    return d.disp = o,
    d.value = -p,
    d
}
function updateChefTableData(e) {
    var a = Number($("#chk-chef-show-skill-diff").val())
      , t = $("#chk-chef-show-recipe").val();
    e.chefAddColNum = t.length * (2 + (a ? 1 : 0)),
    e.chefAddColNum > e.chefAddColNumMax && (e.chefAddColNumMax = e.chefAddColNum,
    reInitChefTable(e),
    initChefShow(),
    isMobile && updateScrollHeight());
    for (var i = 0; i < e.chefAddColNumMax; i++)
        $($("#chef-table").DataTable().column(e.chefColNum + i).header()).removeClass("all").addClass("never");
    for (var i in e.chefs) {
        e.chefs[i].custom = [];
        for (var l = 0; l < t.length; l++)
            e.chefs[i].custom.push({
                display: e.chefs[i].recipes[l].rankDisp,
                value: e.chefs[i].recipes[l].rankVal
            }),
            a && e.chefs[i].custom.push({
                display: e.chefs[i].recipes[l].skillDiffDisp,
                value: e.chefs[i].recipes[l].skillDiffVal
            }),
            e.chefs[i].custom.push({
                display: e.chefs[i].recipes[l].efficiency,
                value: e.chefs[i].recipes[l].efficiency
            })
    }
    var s = 0;
    for (var i in t)
        for (j in e.recipes)
            if (t[i] == e.recipes[j].recipeId) {
                $($("#chef-table").DataTable().column(e.chefColNum + s).header()).text(e.recipes[j].name).removeClass("never").addClass("all"),
                s++,
                a && ($($("#chef-table").DataTable().column(e.chefColNum + s).header()).text(getSkillDiffText(a)).removeClass("never").addClass("all"),
                s++),
                $($("#chef-table").DataTable().column(e.chefColNum + s).header()).text("效率").removeClass("never").addClass("all"),
                s++;
                break
            }
    t.length && (order = a ? [[e.chefColNum + 1, "asc"], [e.chefColNum + 2, "desc"]] : [e.chefColNum + 1, "desc"],
    $("#chef-table").DataTable().order(order)),
    $("#chef-table").DataTable().clear().rows.add(e.chefs),
    $("#chef-table").DataTable().responsive.rebuild(),
    $("#chef-table").DataTable().responsive.recalc()
}
function getSkillDiffText(e) {
    return 5 == e ? "传差值" : 4 == e ? "神差值" : 3 == e ? "特差值" : 2 == e ? "优差值" : ""
}
function updateChefsRecipesData(e) {
    var a = $("#chk-chef-apply-equips").prop("checked")
      , t = Number($("#chk-chef-show-skill-diff").val())
      , i = $("#chk-chef-show-recipe").val()
      , l = $("#chk-chef-apply-ultimate").prop("checked")
      , s = $("#chk-chef-partial-ultimate").val();
    if (i.length > 0)
        for (var c in e.chefs)
            for (var r in e.chefs[c].recipes = [],
            i)
                for (var n in e.recipes)
                    if (i[r] == e.recipes[n].recipeId) {
                        var o = null;
                        a && (o = e.chefs[c].equip);
                        var p = JSON.parse(JSON.stringify(e.chefs[c]))
                          , d = s;
                        for (var u in e.ultimateData.partial)
                            if (e.ultimateData.partial[u].chefId == p.chefId) {
                                s.indexOf(p.chefId.toString()) < 0 && (d = s.concat(p.chefId));
                                break
                            }
                        var f = getPartialChefAddsByIds(e.chefs, l, d);
                        setDataForChef(p, o, a, e.ultimateData.global, f, e.ultimateData.self, null, !0, null, l, e.ultimateData && e.ultimateData.qixia ? e.ultimateData.qixia : null);
                        var h = getRecipeResult(p, o, e.recipes[n], e.recipes[n].limit, e.recipes[n].limit, e.materials, null, 0, null, !1, buildRecipeMenu(e.recipes[n]), null, null)
                          , m = {};
                        if (m.rankVal = h.rankVal,
                        m.rankDisp = h.rankDisp,
                        m.efficiency = h.chefEff || "",
                        t) {
                            var v = getSkillDiff(p, e.recipes[n], t);
                            m.skillDiffDisp = v.disp,
                            m.skillDiffVal = v.value
                        }
                        e.chefs[c].recipes.push(m)
                    }
}
function getTableOrder(e, a) {
    var t = []
      , i = e.order();
    for (var l in i) {
        var s = i[l][0];
        s < a && t.push(i[l])
    }
    return t
}
function initChefTable(e) {
    for (var a in reInitChefTable(e),
    e.recipes)
        $("#chk-chef-show-recipe").append("<option value='" + e.recipes[a].recipeId + "'>" + e.recipes[a].name + "</option>");
    var t = getAmbersOptions(e.ambers, null, !1);
    $("#chk-chef-amber").html(getOptionsString(t)).selectpicker();
    
    // 为批量应用遗玉选择框按颜色分组，并保存遗玉类型映射
    var ambersByType = {1: [], 2: [], 3: []};
    var amberTypeMap = {}; // 保存每个遗玉ID对应的类型
    for (var ambIdx in e.ambers) {
        var amb = e.ambers[ambIdx];
        if (amb.type && ambersByType[amb.type]) {
            ambersByType[amb.type].push(amb);
            amberTypeMap[amb.amberId] = amb.type;
        }
    }
    e.amberTypeMap = amberTypeMap; // 保存到全局数据中
    
    var amberGroupHtml = "";
    if (ambersByType[1].length > 0) {
        amberGroupHtml += "<optgroup label='红色遗玉'>";
        for (var i in ambersByType[1]) {
            var a = ambersByType[1][i];
            var skillDisp = a.skillDisp.replace(/<br>/g, " ");
            amberGroupHtml += "<option value='" + a.amberId + "' data-tokens='" + a.name + skillDisp + "' data-subtext='" + skillDisp + "'>" + a.name + "</option>";
        }
        amberGroupHtml += "</optgroup>";
    }
    if (ambersByType[2].length > 0) {
        amberGroupHtml += "<optgroup label='绿色遗玉'>";
        for (var i in ambersByType[2]) {
            var a = ambersByType[2][i];
            var skillDisp = a.skillDisp.replace(/<br>/g, " ");
            amberGroupHtml += "<option value='" + a.amberId + "' data-tokens='" + a.name + skillDisp + "' data-subtext='" + skillDisp + "'>" + a.name + "</option>";
        }
        amberGroupHtml += "</optgroup>";
    }
    if (ambersByType[3].length > 0) {
        amberGroupHtml += "<optgroup label='蓝色遗玉'>";
        for (var i in ambersByType[3]) {
            var a = ambersByType[3][i];
            var skillDisp = a.skillDisp.replace(/<br>/g, " ");
            amberGroupHtml += "<option value='" + a.amberId + "' data-tokens='" + a.name + skillDisp + "' data-subtext='" + skillDisp + "'>" + a.name + "</option>";
        }
        amberGroupHtml += "</optgroup>";
    }
    $("#chk-chef-apply-amber-select").html(amberGroupHtml).selectpicker().selectpicker("refresh");
    
    // 设置下拉框宽度
    $("#chk-chef-apply-amber-select").parent().find(".dropdown-menu").css({
        "min-width": "350px",
        "width": "350px"
    });
    
    // 为批量应用遗玉选择框添加 optgroup 折叠功能
    $("#chk-chef-apply-amber-select").on("shown.bs.select", function() {
        var $dropdown = $(this).parent().find(".dropdown-menu");
        
        // 设置下拉框宽度
        $dropdown.css({
            "min-width": "350px",
            "width": "350px"
        });
        
        // 为每个 optgroup 标签添加折叠功能
        $dropdown.find(".dropdown-header").each(function() {
            var $header = $(this);
            
            // 如果还没有添加折叠图标，则添加
            if (!$header.find(".collapse-icon").length) {
                // 添加可折叠类
                $header.addClass("collapsible");
                
                // 使用 Bootstrap 的 caret 样式
                var icon = $("<span class='collapse-icon caret'></span>");
                $header.append(icon);
                
                // 获取分组名称
                var groupLabel = $header.text().trim();
                
                // 默认折叠所有分组
                $header.data("collapsed", true);
                
                // 找到该 optgroup 下的所有选项并隐藏
                var $options = $header.nextUntil(".dropdown-header", "li");
                $options.hide();
                
                // 设置图标为折叠状态
                icon.css("transform", "translateY(-50%) rotate(-90deg)");
            }
            
            // 点击标题切换折叠状态
            $header.off("click").on("click", function(e) {
                e.stopPropagation();
                e.preventDefault();
                
                var $this = $(this);
                var isCollapsed = $this.data("collapsed");
                var $icon = $this.find(".collapse-icon");
                
                // 找到该 optgroup 下的所有选项
                var $options = $this.nextUntil(".dropdown-header", "li");
                
                if (isCollapsed) {
                    // 展开
                    $options.slideDown(200);
                    $icon.css("transform", "translateY(-50%) rotate(0deg)");
                    $this.data("collapsed", false);
                } else {
                    // 收起
                    $options.slideUp(200);
                    $icon.css("transform", "translateY(-50%) rotate(-90deg)");
                    $this.data("collapsed", true);
                }
            });
        });
    });
    
    var i = getEquipsOptions(e.equips, !1);
    $("#chk-chef-equip").html(getOptionsString(i)).selectpicker();
    $("#chk-chef-apply-equip-select").html('<option value="" selected class="hidden"></option>' + getOptionsString(i)).selectpicker("refresh"),
    $.fn.dataTableExt.afnFiltering.push(function(e, a, t, i, l) {
        if (e.nTable != document.getElementById("chef-table"))
            return !0;
        var s = $("#chk-chef-rarity").val();
        return 0 == s.length || !!$('#chk-chef-rarity option[value="' + i.rarity + '"]').is(":selected")
    }),
    $.fn.dataTableExt.afnFiltering.push(function(e, a, t, i, l) {
        if (e.nTable != document.getElementById("chef-table"))
            return !0;
        var s = $("#chk-chef-gender").val();
        return 0 == s.length || !!$('#chk-chef-gender option[value="' + i.gender + '"]').is(":selected")
    }),
    $.fn.dataTableExt.afnFiltering.push(function(e, a, t, i, l) {
        if (e.nTable != document.getElementById("chef-table"))
            return !0;
        var s = $("#chk-chef-category").val();
        if (0 == s.length)
            return !0;
        var c = $("#chk-chef-category-equip-amber").prop("checked")
          , r = i.specialSkillEffect.concat(i.ultimateSkillEffect);
        if (c)
            for (var n in i.equip && (r = r.concat(i.equip.effect)),
            i.disk.ambers) {
                var o = i.disk.ambers[n].data;
                o && (r = r.concat(o.allEffect[i.disk.level - 1]))
            }
        for (var n in s) {
            // 特殊处理：基础修炼（Global）
            if (s[n] == "Global") {
                var subtypes = $("#chk-chef-global-subtype").val() || [];
                var skillTypes = ["Stirfry", "Bake", "Boil", "Steam", "Fry", "Knife"];
                var priceTypes = ["UseAll"];
                var limitTypes = ["MaxEquipLimit"];
                var materialTypes = ["Material_Creation", "Material_Fish", "Material_Meat", "Material_Vegetable"];
                
                for (var p in r) {
                    if (r[p].condition == "Global") {
                        // 如果没有选择细分类型，显示所有基础修炼
                        if (subtypes.length == 0) {
                            return !0;
                        }
                        
                        // 检查是否匹配选中的细分类型
                        var effectType = r[p].type;
                        for (var st in subtypes) {
                            if (subtypes[st] == "skill" && skillTypes.indexOf(effectType) !== -1) {
                                return !0;
                            }
                            if (subtypes[st] == "price" && priceTypes.indexOf(effectType) !== -1) {
                                return !0;
                            }
                            if (subtypes[st] == "limit" && limitTypes.indexOf(effectType) !== -1) {
                                return !0;
                            }
                            if (subtypes[st] == "material" && materialTypes.indexOf(effectType) !== -1) {
                                return !0;
                            }
                            if (subtypes[st] == "other" && skillTypes.indexOf(effectType) === -1 && 
                                priceTypes.indexOf(effectType) === -1 && limitTypes.indexOf(effectType) === -1 &&
                                materialTypes.indexOf(effectType) === -1) {
                                return !0;
                            }
                        }
                    }
                }
            } else if (s[n] == "PriceAura") {
                // 售价光环：BasicPriceUseXXX，condition为Partial
                var auraSubtypes = $("#chk-chef-aura-subtype").val() || [];
                var skillTypes = ["Stirfry", "Bake", "Boil", "Steam", "Fry", "Knife"];
                
                for (var p in r) {
                    if (r[p].condition == "Partial" && r[p].type.indexOf("BasicPriceUse") === 0) {
                        // 如果没有选择技法类型，显示所有售价光环
                        if (auraSubtypes.length == 0) {
                            return !0;
                        }
                        
                        // 检查是否匹配选中的技法类型
                        for (var at in auraSubtypes) {
                            if (auraSubtypes[at] == "Other") {
                                // "其他"：匹配不是六种技法的售价光环
                                var isSkillType = false;
                                for (var st in skillTypes) {
                                    if (r[p].type == "BasicPriceUse" + skillTypes[st]) {
                                        isSkillType = true;
                                        break;
                                    }
                                }
                                if (!isSkillType) {
                                    return !0;
                                }
                            } else if (r[p].type == "BasicPriceUse" + auraSubtypes[at]) {
                                return !0;
                            }
                        }
                    }
                }
            } else if (s[n] == "SkillAura") {
                // 技法光环：Stirfry/Bake/Boil/Steam/Fry/Knife，condition为Partial或Next
                var auraSubtypes = $("#chk-chef-aura-subtype").val() || [];
                var skillTypes = ["Stirfry", "Bake", "Boil", "Steam", "Fry", "Knife"];
                
                for (var p in r) {
                    if ((r[p].condition == "Partial" || r[p].condition == "Next") && skillTypes.indexOf(r[p].type) !== -1) {
                        // 如果没有选择技法类型，显示所有技法光环
                        if (auraSubtypes.length == 0) {
                            return !0;
                        }
                        
                        // 检查是否匹配选中的技法类型
                        for (var at in auraSubtypes) {
                            if (r[p].type == auraSubtypes[at]) {
                                return !0;
                            }
                        }
                    }
                }
            } else {
                // 原有的type匹配逻辑
                for (var p in r) {
                    if (r[p].type == s[n]) {
                        if ("OpenTime" != r[p].type)
                            return !0;
                        if (r[p].value < 0)
                            return !0
                    }
                    // 处理加时间筛选
                    if (s[n] == "OpenTimePositive" && r[p].type == "OpenTime" && r[p].value > 0) {
                        return !0;
                    }
                }
            }
        }
        return !1
    }),
    $.fn.dataTableExt.afnFiltering.push(function(e, a, t, i, l) {
        if (e.nTable != document.getElementById("chef-table"))
            return !0;
        var s = $("#chk-chef-condiment").val();
        if (0 == s.length)
            return !0;
        for (var c in s)
            if (i[s[c] + "Val"] > 0)
                return !0;
        return !1
    }),
    $.fn.dataTableExt.afnFiltering.push(function(e, a, t, i, l) {
        if (e.nTable != document.getElementById("chef-table"))
            return !0;
        var s = $("#chk-chef-disk").val();
        if (0 == s.length)
            return !0;
        var c = $("#chk-chef-multiple-disk").prop("checked")
          , r = i.disk.ambers;
        for (var n in s) {
            var o = s[n].split("_")
              , p = Number(o[0])
              , d = Number(o[1])
              , u = 0;
            for (var f in r)
                r[f].type == p && u++;
            if (u >= d) {
                if (!c)
                    return !0
            } else if (c)
                return !1
        }
        return !!c
    }),
    $.fn.dataTableExt.afnFiltering.push(function(e, a, t, i, l) {
        if (e.nTable != document.getElementById("chef-table"))
            return !0;
        var s = $("#chk-chef-no-origin").prop("checked");
        return !!(s || !s && i.origin)
    }),
    $.fn.dataTableExt.afnFiltering.push(function(e, a, t, i, l) {
        if (e.nTable != document.getElementById("chef-table"))
            return !0;
        var s = $("#chk-chef-amber").val();
        if (0 == s.length)
            return !0;
        var c = i.disk.ambers;
        for (var r in s)
            for (var n in c)
                if (c[n].data && c[n].data.amberId == s[r])
                    return !0;
        return !1
    }),
    $.fn.dataTableExt.afnFiltering.push(function(e, a, t, i, l) {
        if (e.nTable != document.getElementById("chef-table"))
            return !0;
        var s = $("#chk-chef-equip").val();
        if (0 == s.length)
            return !0;
        for (var c in s)
            if (i.equipId == s[c])
                return !0;
        return !1
    }),
    $.fn.dataTableExt.afnFiltering.push(function(e, a, t, i, l) {
        if (e.nTable != document.getElementById("chef-table"))
            return !0;
        var s = $("#chk-chef-ultimate-no").prop("checked");
        return !(s && (!s || i.ultimate))
    }),
    $.fn.dataTableExt.afnFiltering.push(function(e, a, t, i, l) {
        if (e.nTable != document.getElementById("chef-table"))
            return !0;
        var s = $("#chk-chef-got").prop("checked");
        return !!(!s || s && i.got)
    }),
    $.fn.dataTableExt.afnFiltering.push(function(e, a, t, i, l) {
        if (e.nTable != document.getElementById("chef-table"))
            return !0;
        var s = $("#chk-chef-material-combo").val();
        if (!s || s === "")
            return !0;
        var comboValue = 0;
        if (s === "meat_creation") {
            comboValue = (i.meatVal || 0) + (i.creationVal || 0);
        } else if (s === "meat_veg") {
            comboValue = (i.meatVal || 0) + (i.vegVal || 0);
        } else if (s === "meat_fish") {
            comboValue = (i.meatVal || 0) + (i.fishVal || 0);
        } else if (s === "creation_veg") {
            comboValue = (i.creationVal || 0) + (i.vegVal || 0);
        } else if (s === "creation_fish") {
            comboValue = (i.creationVal || 0) + (i.fishVal || 0);
        } else if (s === "veg_fish") {
            comboValue = (i.vegVal || 0) + (i.fishVal || 0);
        }
        return comboValue > 0
    });
    var l = $(".pane-chefs .search-box input");
    $.fn.dataTableExt.afnFiltering.push(function(e, a, t, i, s) {
        if (e.nTable != document.getElementById("chef-table"))
            return !0;
        var c = $.trim(l.val());
        return !!commaSeparatedMatch(i.name, c) || (!!commaSeparatedMatch(i.specialSkillDisp, c) || (!!commaSeparatedMatch(i.origin, c) || (!!commaSeparatedMatch(i.ultimateSkillDisp, c) || !!commaSeparatedMatch(i.tagsDisp, c))))
    }),
    $("#chk-chef-show-recipe").selectpicker().on("changed.bs.select", function(a, t, i, l) {
        updateChefsRecipesData(e),
        updateChefTableData(e),
        $("#chef-table").DataTable().draw()
    }),
    $("#chk-chef-show-skill-diff").on("changed.bs.select", function() {
        $("#chk-chef-show-recipe").val().length && (updateChefsRecipesData(e),
        updateChefTableData(e),
        $("#chef-table").DataTable().draw())
    }),
    $("#chk-chef-show").on("changed.bs.select", function() {
        initChefShow(),
        updateMenuLocalData()
    }),
    $("#chk-chef-rarity").on("changed.bs.select", function() {
        $("#chef-table").DataTable().draw()
    }),
    $("#chk-chef-gender").on("changed.bs.select", function() {
        $("#chef-table").DataTable().draw()
    }),
    $("#chk-chef-category").on("changed.bs.select", function() {
        // 检查是否选择了"基础修炼"
        var selectedValues = $("#chk-chef-category").val() || [];
        if (selectedValues.indexOf("Global") !== -1) {
            $("#chef-global-subtype-wrapper").show();
        } else {
            $("#chef-global-subtype-wrapper").hide();
            $("#chk-chef-global-subtype").selectpicker("deselectAll");
        }
        
        // 检查是否选择了"售价光环"或"技法光环"
        var hasPriceAura = selectedValues.indexOf("PriceAura") !== -1;
        var hasSkillAura = selectedValues.indexOf("SkillAura") !== -1;
        
        if (hasPriceAura || hasSkillAura) {
            $("#chef-aura-subtype-wrapper").show();
            
            // 动态控制"其他"选项的显示
            var $otherOption = $("#chk-chef-aura-subtype option[value='Other']");
            if (hasSkillAura && !hasPriceAura) {
                // 只选择了技法光环：隐藏"其他"选项
                if ($otherOption.length > 0) {
                    $otherOption.remove();
                    $("#chk-chef-aura-subtype").selectpicker("refresh");
                }
            } else {
                // 选择了售价光环，或同时选择了两者：显示"其他"选项
                if ($otherOption.length == 0) {
                    $("#chk-chef-aura-subtype").append('<option value="Other">其他</option>');
                    $("#chk-chef-aura-subtype").selectpicker("refresh");
                }
            }
        } else {
            $("#chef-aura-subtype-wrapper").hide();
            $("#chk-chef-aura-subtype").selectpicker("deselectAll");
        }
        
        $("#chef-table").DataTable().draw()
    }),
    $("#chk-chef-global-subtype").on("changed.bs.select", function() {
        $("#chef-table").DataTable().draw()
    }),
    $("#chk-chef-aura-subtype").on("changed.bs.select", function() {
        $("#chef-table").DataTable().draw()
    }),
    $("#chk-chef-category-equip-amber").click(function() {
        $("#chef-table").DataTable().draw()
    }),
    $("#chk-chef-condiment").on("changed.bs.select", function() {
        $("#chef-table").DataTable().draw()
    }),
    $("#chk-chef-disk").on("changed.bs.select", function() {
        $("#chef-table").DataTable().draw()
    }),
    $("#chk-chef-multiple-disk").click(function() {
        $("#chef-table").DataTable().draw()
    }),
    $("#chk-chef-amber").on("changed.bs.select", function() {
        $("#chef-table").DataTable().draw()
    }),
    $("#chk-chef-equip").on("changed.bs.select", function() {
        $("#chef-table").DataTable().draw()
    }),
    $("#chk-chef-ultimate-no").click(function() {
        $("#chef-table").DataTable().draw()
    }),
    $("#chk-chef-got").click(function() {
        $("#chef-table").DataTable().draw()
    }),
    $("#chk-chef-no-origin").click(function() {
        $("#chef-table").DataTable().draw()
    }),
    $("#chk-chef-material-combo").on("changed.bs.select", function() {
        updateChefMaterialComboColumn(),
        $("#chef-table").DataTable().draw()
    }),
    $("#chk-chef-apply-ultimate").change(function() {
        $(this).prop("checked") ? $(".chef-apply-ultimate").show() : $(".chef-apply-ultimate").hide(),
        updateRecipeChefTable(e)
    }),
    $("#chk-chef-apply-ultimate-person").change(function() {
        updateRecipeChefTable(e)
    }),
    $("#chk-chef-partial-ultimate").selectpicker().on("changed.bs.select", function() {
        updateRecipeChefTable(e)
    }),
    $("#chk-chef-apply-ambers").change(function() {
        $(this).prop("checked") ? $(".chef-apply-ambers").show() : $(".chef-apply-ambers").hide(),
        updateRecipeChefTable(e)
    }),
    $("#chk-chef-apply-amber-select").selectpicker().on("changed.bs.select", function(event, clickedIndex, isSelected, previousValue) {
        if (isSelected) {
            // 正在选中一个遗玉
            var $option = $(this).find('option').eq(clickedIndex);
            var selectedAmberId = $option.val();
            var selectedAmberType = e.amberTypeMap[selectedAmberId];
            
            if (selectedAmberType) {
                // 获取当前所有选中的遗玉
                var currentSelection = $(this).val() || [];
                var newSelection = [];
                
                // 遍历当前选中的遗玉，移除同色的其他遗玉，保证每种颜色只选择一种遗玉
                for (var i in currentSelection) {
                    var amberId = currentSelection[i];
                    var amberType = e.amberTypeMap[amberId];
                    
                    // 如果是刚选中的遗玉，或者不是同色的遗玉，则保留
                    if (amberId == selectedAmberId || amberType != selectedAmberType) {
                        newSelection.push(amberId);
                    }
                }
                
                // 更新选择
                $(this).selectpicker('val', newSelection);
            }
        }
        
        updateRecipeChefTable(e)
    }),
    $("#chk-chef-max-disk-level").click(function() {
        updateRecipeChefTable(e)
    }),
    $("#chk-chef-apply-equips").change(function() {
        $(this).prop("checked") ? $(".chef-apply-equips").show() : $(".chef-apply-equips").hide(),
        updateRecipeChefTable(e)
    }),
    $("#chk-chef-apply-equip-select").selectpicker().on("changed.bs.select", function() {
        updateRecipeChefTable(e)
    }),
    $("#btn-chef-recal").click(function() {
        updateRecipeChefTable(e)
    }),
    $("#btn-chef-reset").click(function() {
        $("#chk-chef-rarity").selectpicker("deselectAll"),
        $("#chk-chef-gender").selectpicker("deselectAll"),
        $("#chk-chef-category").selectpicker("deselectAll"),
        $("#chk-chef-condiment").selectpicker("deselectAll"),
        $("#chk-chef-disk").selectpicker("deselectAll"),
        $("#chk-chef-multiple-disk").prop("checked", !1),
        $("#chk-chef-amber").selectpicker("deselectAll"),
        $("#chk-chef-equip").selectpicker("deselectAll"),
        $("#chk-chef-ultimate-no").prop("checked", !1),
        $("#chk-chef-got").prop("checked", !1),
        $("#chk-chef-no-origin").prop("checked", !0),
        $("#chk-chef-show-recipe").selectpicker("deselectAll"),
        $(".pane-chefs .search-box input").val(""),
        $("#chk-chef-partial-ultimate").selectpicker("deselectAll"),
        checkMonitorStyle(),
        $("#chef-table").DataTable().draw()
    }),
    initChefShow(),
    updateChefMaterialComboColumn()
}
function reInitChefTable(e) {
    var a = [{
        data: void 0,
        defaultContent: "<span class='glyphicon'></span>",
        className: "td-expend",
        orderable: !1,
        searchable: !1,
        visible: expendBtn,
        width: "1px"
    }, {
        data: "galleryId",
        width: "1px"
    }, {
        data: "icon",
        className: "td-chef-icon",
        orderable: !1,
        searchable: !1
    }, {
        data: "name",
        width: "81px",
        className: "all fixedcolumn"
    }, {
        data: {
            _: "rarity",
            display: "rarityDisp"
        },
        className: "rarity",
        width: "50px",
        orderSequence: ["desc", "asc"]
    }, {
        data: {
            _: "stirfryVal",
            display: "stirfryDisp"
        },
        width: "20px",
        orderSequence: ["desc", "asc"]
    }, {
        data: {
            _: "boilVal",
            display: "boilDisp"
        },
        width: "20px",
        orderSequence: ["desc", "asc"]
    }, {
        data: {
            _: "knifeVal",
            display: "knifeDisp"
        },
        width: "20px",
        orderSequence: ["desc", "asc"]
    }, {
        data: {
            _: "fryVal",
            display: "fryDisp"
        },
        width: "20px",
        orderSequence: ["desc", "asc"]
    }, {
        data: {
            _: "bakeVal",
            display: "bakeDisp"
        },
        width: "20px",
        orderSequence: ["desc", "asc"]
    }, {
        data: {
            _: "steamVal",
            display: "steamDisp"
        },
        width: "20px",
        orderSequence: ["desc", "asc"]
    }, {
        data: "specialSkillDisp"
    }, {
        data: {
            _: "meatVal",
            display: "meatDisp"
        },
        width: "20px",
        orderSequence: ["desc", "asc"]
    }, {
        data: {
            _: "creationVal",
            display: "creationDisp"
        },
        width: "20px",
        orderSequence: ["desc", "asc"]
    }, {
        data: {
            _: "vegVal",
            display: "vegDisp"
        },
        width: "20px",
        orderSequence: ["desc", "asc"]
    }, {
        data: {
            _: "fishVal",
            display: "fishDisp"
        },
        width: "20px",
        orderSequence: ["desc", "asc"]
    }, {
        data: "materialExpectation",
        defaultContent: "",
        width: "60px"
    }, {
        data: "materialCombo",
        defaultContent: "",
        width: "60px",
        visible: false
    }, {
        data: "gender",
        width: "30px"
    }, {
        data: {
            _: "sweetVal",
            display: "sweetDisp"
        },
        width: "20px",
        orderSequence: ["desc", "asc"]
    }, {
        data: {
            _: "sourVal",
            display: "sourDisp"
        },
        width: "20px",
        orderSequence: ["desc", "asc"]
    }, {
        data: {
            _: "spicyVal",
            display: "spicyDisp"
        },
        width: "20px",
        orderSequence: ["desc", "asc"]
    }, {
        data: {
            _: "saltyVal",
            display: "saltyDisp"
        },
        width: "20px",
        orderSequence: ["desc", "asc"]
    }, {
        data: {
            _: "bitterVal",
            display: "bitterDisp"
        },
        width: "20px",
        orderSequence: ["desc", "asc"]
    }, {
        data: {
            _: "tastyVal",
            display: "tastyDisp"
        },
        width: "20px",
        orderSequence: ["desc", "asc"]
    }, {
        data: "origin"
    }, {
        data: "tagsDisp",
        defaultContent: "",
        visible: private,
        className: "none"
    }, {
        data: {
            _: "diskId",
            display: "diskDisp"
        },
        className: "nodetails td-disk"
    }, {
        data: {
            _: "equipId",
            display: "equipDisp"
        },
        className: "nodetails"
    }, {
        data: "ultimateGoalDisp"
    }, {
        data: "ultimateSkillDisp"
    }, {
        data: "ultimate",
        className: "nodetails",
        width: "41px"
    }, {
        data: "got",
        className: "nodetails",
        width: "41px"
    }]
      , t = ""
      , i = [];
    $.fn.DataTable.isDataTable("#chef-table") && (t = $(".pane-chefs .search-box input").val(),
    i = getTableOrder($("#chef-table").DataTable(), a.length),
    $("#chef-table").DataTable().MakeCellsEditable("destroy"),
    $("#chef-table").DataTable().destroy()),
    $("#chef-table").html($("#chef-table-header").html());
    for (var l = 0; l < e.chefAddColNumMax; l++)
        a.push({
            data: {
                _: "custom." + l + ".value",
                display: "custom." + l + ".display"
            },
            defaultContent: "",
            orderSequence: ["desc", "asc"],
            className: "never"
        }),
        $("#chef-table thead tr").append("<th></th>");
    var s = !0
      , c = !1
      , r = !1;
    isMobile && (s = !1,
    c = !0,
    r = {
        left: [0, 3]
    });
    var n = "td:not(.nodetails)";
    expendBtn && (n = ".td-expend");
    var o = $("#chef-table").DataTable({
        data: e.chefs,
        columns: a,
        language: {
            search: "查找:",
            zeroRecords: "没有找到",
            info: "_TOTAL_个",
            infoEmpty: "0",
            infoFiltered: "/ _MAX_"
        },
        pagingType: "numbers",
        pageLength: Number($("#select-setting-page-length").val()),
        dom: "<'table-top clearfix'<'left'i><'right'<'search-box'>>><'row'<'col-sm-12'tr>><'row'<'col-sm-12'p>>",
        deferRender: !0,
        order: i,
        autoWidth: !1,
        fixedHeader: s,
        scrollX: c,
        fixedColumns: r,
        responsive: {
            details: {
                type: "column",
                target: n,
                renderer: function(e, a, t) {
                    var i = "";
                    for (var l in t)
                        if (t[l].hidden) {
                            if (0 == l)
                                continue;
                            if (l > 5 && l <= 10)
                                continue;
                            if (5 == l) {
                                i += "<div class='col-lg-3 col-xs-6'>";
                                for (var s = 5; s <= 10; s++)
                                    t[s].data && (i += "<span class='child-key'>" + t[s].title + "</span><span class='child-value'>" + t[s].data + "</span>");
                                i += "</div>"
                            } else {
                                if (l > 12 && l <= 15)
                                    continue;
                                if (12 == l) {
                                    i += "<div class='col-lg-3 col-xs-6'><span class='child-key'>采集：</span>";
                                    for (s = 12; s <= 15; s++)
                                        t[s].data && (i += "<span class='child-key'>" + t[s].title + "</span><span class='child-value'>" + t[s].data + "</span>");
                                    i += "</div>"
                                } else if (16 == l) {
                                    i += "<div class='col-lg-3 col-xs-6'><span class='child-key'>" + t[l].title + "：</span><span class='child-value'>" + (t[l].data ? t[l].data : "") + "</span></div>"
                                } else if (17 == l) {
                                    i += "<div class='col-lg-3 col-xs-6'><span class='child-key'>" + t[l].title + "：</span><span class='child-value'>" + (t[l].data ? t[l].data : "") + "</span></div>"
                                } else {
                                    if (l > 19 && l <= 24)
                                        continue;
                                    if (19 == l) {
                                        i += "<div class='col-lg-3 col-xs-6'><span class='child-key'>调料：</span>";
                                        for (s = 19; s <= 24; s++)
                                            t[s].data && (i += "<span class='child-key'>" + t[s].title + "</span><span class='child-value'>" + t[s].data + "</span>");
                                        i += "</div>"
                                    } else
                                        i += "<div class='col-lg-3 col-xs-6'><span class='child-key'>" + t[l].title + (l < 3 ? "" : "：") + "</span><span class='child-value'>" + (t[l].data ? t[l].data : 28 == l ? "无" : 31 == l || 32 == l ? "否" : "") + "</span></div>"
                                }
                            }
                        }
                    return !!i && "<div class='child-inner'" + getResponsiveStyle($("#chef-table")) + ">" + i + "</div>"
                }
            }
        }
    });
    $(".pane-chefs div.search-box").html('<input type="search" value="' + t + '" class="form-control input-sm monitor-none" placeholder="查找 名字 技能 来源">');
    var p = getGotOptions()
      , d = getEquipsOptions(e.equips, !0);
    o.MakeCellsEditable({
        columns: [28, 31, 32],
        inputTypes: [{
            column: 28,
            type: "list",
            search: !0,
            clear: !0,
            done: !0,
            options: d
        }, {
            column: 31,
            type: "list",
            options: p
        }, {
            column: 32,
            type: "list",
            options: p
        }],
        onUpdate: function(a, t, i, l) {
            if (28 == i.index().column) {
                var s = t.data();
                
                // 保存更换前的厨具，用于判断是否需要重新生成时间类列表
                var previousEquip = s.equip;
                
                // 首次加载厨具信息，使用当前的厨具作为初始厨具
                if (!s.hasOwnProperty('initialEquip')) {
                    s.initialEquip = s.equip || null;
                    s.initialEquipId = s.equipId || null;
                    s.initialEquipDisp = s.equipDisp || null;
                }
                
                // 如果还没有保存用于恢复的初始厨具，保存一份
                if (!s.hasOwnProperty('initialEquipForRestore')) {
                    s.initialEquipForRestore = s.equip || null;
                    s.initialEquipForRestoreId = s.equipId || null;
                    s.initialEquipForRestoreDisp = s.equipDisp || null;
                }
                                
                var c = null
                  , r = ""
                  , n = getEquipInfo(s.equipId, e.equips);
                
                // 如果用户清空了厨具（equipId为空或null）
                if (!s.equipId || s.equipId === "" || s.equipId === null) {
                    // 恢复到初始厨具（如果有的话）
                    if (s.initialEquip) {
                        c = s.initialEquip;
                        r = s.initialEquipDisp;
                        s.equipId = s.initialEquipId;
                    } else {
                        c = null;
                        r = "";
                    }
                } else {
                    // 用户设置了新厨具
                    n && (c = n, r = n.disp);
                }
                
                s.equip = c,
                s.equipDisp = r,
                // 手动设置时更新originalEquip，这样getUpdateData不会恢复它
                s.originalEquip = c,
                s.originalEquipId = s.equipId,
                s.originalEquipDisp = r,
                // 重新计算采集期望值
                s.materialExpectation = calculateMaterialExpectation(s, s.equip, s.disk),
                t.data(s),
                o.draw(!1);
                
                // 检查新厨具是否有OpenTime技能
                var hasOpenTimeEquip = false;
                if (c && c.effect) {
                    for (var ee in c.effect) {
                        if ("OpenTime" == c.effect[ee].type) {
                            hasOpenTimeEquip = true;
                            break;
                        }
                    }
                }
                
                // 检查更换前的厨具是否有OpenTime技能
                var hadOpenTimeEquip = false;
                if (previousEquip && previousEquip.effect) {
                    for (var oee in previousEquip.effect) {
                        if ("OpenTime" == previousEquip.effect[oee].type) {
                            hadOpenTimeEquip = true;
                            break;
                        }
                    }
                }
                
                // 如果更换的厨具有OpenTime技能，或者清空了有OpenTime技能的厨具，重新生成时间类厨师列表
                var needRegenerate = false;
                
                // 检查是否是时间类厨师（普通技能或修炼技能有OpenTime）
                var isTimeChef = false;
                if (s.specialSkillEffect) {
                    for (var se in s.specialSkillEffect) {
                        if ("OpenTime" == s.specialSkillEffect[se].type) {
                            isTimeChef = true;
                            break;
                        }
                    }
                }
                if (!isTimeChef && s.ultimateSkillEffect) {
                    for (var ue in s.ultimateSkillEffect) {
                        if (("Partial" == s.ultimateSkillEffect[ue].condition || "Next" == s.ultimateSkillEffect[ue].condition) && 
                            ("OpenTime" == s.ultimateSkillEffect[ue].type || "CookbookTime" == s.ultimateSkillEffect[ue].type)) {
                            isTimeChef = true;
                            break;
                        }
                    }
                }
                
                // 如果是时间类厨师，或者厨具有OpenTime，或者原来的厨具有OpenTime，需要重新生成列表
                if (isTimeChef || hasOpenTimeEquip || hadOpenTimeEquip) {
                    needRegenerate = true;
                }
                
                if (needRegenerate) {
                    // 保存当前选中的厨师
                    var selectedChefs = $('#chk-chef-partial-ultimate').val() || [];
                    
                    // 保存当前激活的标签页
                    var $dropdown = $('#chk-chef-partial-ultimate').parent().find('.dropdown-menu');
                    var $activeTab = $dropdown.find('.chef-type-tabs li.active a');
                    var isTimeTabActive = $activeTab.hasClass('chef-tab-time');
                    
                    // 从DataTable获取最新的厨师数据
                    var latestChefs = $("#chef-table").DataTable().data().toArray();
                    
                    // 清空并重新生成时间类厨师列表
                    $('#chk-chef-partial-ultimate').empty();
                    setPartialUltimateOptions(latestChefs);
                    
                    // 恢复之前选中的厨师
                    $('#chk-chef-partial-ultimate').selectpicker('val', selectedChefs);
                    $('#chk-chef-partial-ultimate').selectpicker('refresh');
                    
                    // 重新应用标签页过滤
                    setTimeout(function() {
                        var $select = $('#chk-chef-partial-ultimate');
                        var $newDropdown = $select.parent().find('.dropdown-menu');
                        
                        if (isTimeTabActive) {
                            // 显示时间类，隐藏技法类
                            var hasVisible = false;
                            $newDropdown.find('ul.dropdown-menu > li').each(function() {
                                var $li = $(this);
                                if ($li.hasClass('chef-empty-hint')) return;
                                var $option = $select.find('option').eq($li.index());
                                if ($option.hasClass('chef-time-type')) {
                                    $li.show();
                                    hasVisible = true;
                                } else if ($option.hasClass('chef-skill-type')) {
                                    $li.hide();
                                }
                            });
                            // 如果没有可见项，显示空状态提示
                            if (!hasVisible) {
                                $newDropdown.find('.chef-empty-hint').show();
                            } else {
                                $newDropdown.find('.chef-empty-hint').hide();
                            }
                        } else {
                            // 显示技法类，隐藏时间类
                            $newDropdown.find('ul.dropdown-menu > li').each(function() {
                                var $li = $(this);
                                if ($li.hasClass('chef-empty-hint')) return;
                                var $option = $select.find('option').eq($li.index());
                                if ($option.hasClass('chef-skill-type')) {
                                    $li.show();
                                } else if ($option.hasClass('chef-time-type')) {
                                    $li.hide();
                                }
                            });
                            $newDropdown.find('.chef-empty-hint').hide();
                        }
                    }, 100);
                }
            }
            // 当编辑厨具列（28）或已修炼列（31）时，如果数据改变了，需要重新计算
            if ((i.index().column == 28 || i.index().column == 31) && i.data() != l) {
                if ($("#chk-setting-auto-update").prop("checked")) {
                    updateRecipeChefTable(e);
                } else {
                    $("#btn-chef-recal").closest(".inline-wrapper").removeClass("hidden");
                }
            }
            updateChefsLocalData()
        }
    }),
    $(o.body()).on("click", "td.td-disk", function() {
        var a = $("#chef-table").DataTable().table().row($(this).parents("tr"))
          , t = a.data();
        $("#disk-modal .chef-name").html(t.name);
        var i = $("#disk-modal select.select-chef-disk-level")
          , l = getDiskLevelsOptions(t.disk);
        i.html(getOptionsString(l)).selectpicker("refresh"),
        i.off("changed.bs.select").on("changed.bs.select", function(i, l, s, c) {
            // 如果还没有保存用于恢复的初始等级，保存一份
            if (!t.hasOwnProperty('initialDiskLevelForRestore')) {
                t.initialDiskLevelForRestore = t.disk.level;
            }
            
            t.disk.level = Number($(this).val()),
            t.diskDisp = GetDiskDisp(t.disk),
            // 手动设置时更新originalDiskLevel，这样getUpdateData不会恢复它
            t.originalDiskLevel = t.disk.level,
            // 重新计算采集期望值
            t.materialExpectation = calculateMaterialExpectation(t, t.equip, t.disk),
            a.data(t),
            o.draw(!1);
            for (var r = 0; r < t.disk.ambers.length; r++)
                updateModalAmberDisplay(r, t.disk.ambers[r].data, t.disk.level);
            $("#chk-setting-auto-update").prop("checked") ? updateRecipeChefTable(e) : $("#btn-chef-recal").closest(".inline-wrapper").removeClass("hidden"),
            updateChefsLocalData()
        });
        for (var s = 0; s < t.disk.ambers.length; s++) {
            var c = t.disk.ambers[s]
              , r = $("#disk-modal select.select-chef-amber:eq(" + s + ")");
            r.closest(".amber-box").removeClass("hidden").find(".dropdown-toggle").removeClass("btn-primary btn-success btn-danger btn-default").addClass(getAmberBtnClass(c.type));
            var n = getAmbersOptions(e.ambers, c, !0);
            r.html(getOptionsString(n)).selectpicker("refresh"),
            r.off("changed.bs.select").on("changed.bs.select", function(i, l, s, c) {
                // 如果还没有保存用于恢复的初始遗玉，保存一份
                if (!t.hasOwnProperty('initialDiskAmbersForRestore')) {
                    t.initialDiskAmbersForRestore = JSON.parse(JSON.stringify(t.disk.ambers));
                }
                
                var r = Number($(this).val())
                  , n = $("#disk-modal").find(".amber-box").index($(this).closest(".amber-box"))
                  , p = getAmberInfo(r, e.ambers);
                t.disk.ambers[n].data = p,
                t.diskDisp = GetDiskDisp(t.disk),
                // 手动设置时更新originalDiskAmbers，这样getUpdateData不会恢复它
                t.originalDiskAmbers = JSON.parse(JSON.stringify(t.disk.ambers)),
                // 重新计算采集期望值
                t.materialExpectation = calculateMaterialExpectation(t, t.equip, t.disk),
                a.data(t),
                o.draw(!1),
                updateModalAmberDisplay(n, p, t.disk.level),
                $("#chk-setting-auto-update").prop("checked") ? updateRecipeChefTable(e) : $("#btn-chef-recal").closest(".inline-wrapper").removeClass("hidden"),
                updateChefsLocalData()
            }),
            updateModalAmberDisplay(s, c.data, t.disk.level)
        }
        for (s = t.disk.ambers.length; s < 3; s++)
            $("#disk-modal .amber-box:eq(" + s + ")").addClass("hidden");
        $("#disk-modal").modal()
    }),
    $(".pane-chefs .search-box input").on("input", function() {
        o.draw(),
        changeInputStyle(this)
    }),
    initTableResponsiveDisplayEvent(o),
    initTableScrollEvent(".pane-chefs")
}
function initEquipTable(e) {
    var a = [{
        data: void 0,
        defaultContent: "<span class='glyphicon'></span>",
        className: "td-expend",
        orderable: !1,
        searchable: !1,
        visible: expendBtn,
        width: "1px"
    }, {
        data: "galleryId",
        width: "1px"
    }, {
        data: "icon",
        className: "td-equip-icon",
        orderable: !1,
        searchable: !1
    }, {
        data: "name",
        width: "80px",
        className: "all fixedcolumn"
    }, {
        data: {
            _: "rarity",
            display: "rarityDisp"
        },
        className: "rarity",
        width: "35px",
        orderSequence: ["desc", "asc"]
    }, {
        data: {
            _: "skillDisp",
            sort: "skillSort"
        },
        type: "num"
    }, {
        data: "origin"
    }]
      , t = !0
      , i = !1
      , l = !1;
    isMobile && (t = !1,
    i = !0,
    l = {
        left: [0, 3]
    });
    var s = "td:not(.nodetails)";
    expendBtn && (s = ".td-expend");
    var c = $("#equip-table").DataTable({
        data: e.equips,
        columns: a,
        language: {
            search: "查找:",
            zeroRecords: "没有找到",
            info: "_TOTAL_个",
            infoEmpty: "0",
            infoFiltered: "/ _MAX_"
        },
        pagingType: "numbers",
        pageLength: Number($("#select-setting-page-length").val()),
        dom: "<'table-top clearfix'<'left'i><'right'<'search-box'>>><'row'<'col-sm-12'tr>><'row'<'col-sm-12'p>>",
        deferRender: !0,
        order: [],
        autoWidth: !1,
        fixedHeader: t,
        scrollX: i,
        fixedColumns: l,
        responsive: {
            details: {
                type: "column",
                target: s,
                renderer: function(e, a, t) {
                    var i = "";
                    for (var l in t)
                        if (t[l].hidden) {
                            if (0 == l)
                                continue;
                            i += "<div class='col-lg-3 col-xs-6'><span class='child-key'>" + t[l].title + (l < 3 ? "" : "：") + "</span><span class='child-value'>" + t[l].data + "</span></div>"
                        }
                    return !!i && "<div class='child-inner'" + getResponsiveStyle($("#equip-table")) + ">" + i + "</div>"
                }
            }
        }
    });
    $(".pane-equips div.search-box").html('<input type="search" class="form-control input-sm monitor-none" placeholder="查找 名字 技能 来源">'),
    $.fn.dataTableExt.afnFiltering.push(function(e, a, t, i, l) {
        if (e.nTable != document.getElementById("equip-table"))
            return !0;
        var s = $("#chk-equip-skill").val();
        if (0 == s.length)
            return !0;
        var c = i.effect
          , r = $("#chk-equip-multiple-skill").prop("checked")
          , n = !1;
        for (var o in (1 == s.length || r) && (n = $("#chk-equip-filter-negative-skill").prop("checked")),
        s) {
            var p = !0
              , d = s[o].split(",");
            for (var u in d) {
                var f = !1;
                for (var h in c)
                    if (c[h].type == d[u]) {
                        if (n && c[h].value < 0)
                            return !1;
                        f = !0;
                        break
                    }
                if (!f) {
                    if (r)
                        return !1;
                    p = !1;
                    break
                }
            }
            if (!r && p)
                return !0
        }
        return !!r
    }),
    $.fn.dataTableExt.afnFiltering.push(function(e, a, t, i, l) {
        if (e.nTable != document.getElementById("equip-table"))
            return !0;
        var s = $("#chk-equip-filter-all-skill").prop("checked");
        if (!s)
            return !0;
        var c = i.effect
          , r = "Stirfry,Boil,Knife,Fry,Bake,Steam"
          , n = r.split(",");
        for (var o in n) {
            var p = !1;
            for (var d in c)
                if (c[d].type == n[o]) {
                    p = !0;
                    break
                }
            if (!p)
                return !0
        }
        return !1
    }),
    $.fn.dataTableExt.afnFiltering.push(function(e, a, t, i, l) {
        if (e.nTable != document.getElementById("equip-table"))
            return !0;
        var s = $("#chk-equip-no-origin").prop("checked");
        return !!(s || !s && i.origin)
    });
    var r = $(".pane-equips .search-box input");
    $.fn.dataTableExt.afnFiltering.push(function(e, a, t, i, l) {
        if (e.nTable != document.getElementById("equip-table"))
            return !0;
        var s = $.trim(r.val());
        return !!commaSeparatedMatch(i.name, s) || (!!commaSeparatedMatch(i.skillDisp, s) || !!commaSeparatedMatch(i.origin, s))
    }),
    $("#chk-equip-show").on("changed.bs.select", function() {
        initEquipShow(),
        updateMenuLocalData()
    }),
    $("#chk-equip-skill").selectpicker().on("changed.bs.select", function() {
        var e = "";
        1 == $(this).val().length && (e = $(this).val()[0],
        c.order([5, "desc"]).order([3, "desc"])),
        c.rows().every(function(a, t, i) {
            var l = this.data();
            if ("" == e)
                l.skillSort = 0;
            else
                for (var s in l.effect)
                    if ((l.effect[s].type == e || e.indexOf(",") > 0 && e.split(",")[0] == l.effect[s].type) && (l.skillSort = l.effect[s].value,
                    "Percent" == l.effect[s].cal)) {
                        l.skillSort *= 1e4;
                        break
                    }
            this.data(l)
        }),
        c.draw()
    }),
    $("#chk-equip-no-origin").click(function() {
        c.draw()
    }),
    $("#chk-equip-multiple-skill").click(function() {
        c.draw()
    }),
    $("#chk-equip-filter-negative-skill").click(function() {
        c.draw()
    }),
    $("#chk-equip-filter-all-skill").click(function() {
        c.draw()
    }),
    $(".pane-equips .search-box input").on("input", function() {
        c.draw(),
        changeInputStyle(this)
    }),
    $("#btn-equip-reset").click(function() {
        $("#chk-equip-skill").selectpicker("deselectAll"),
        $("#chk-equip-multiple-skill").prop("checked", !1),
        $("#chk-equip-filter-negative-skill").prop("checked", !1),
        $("#chk-equip-filter-all-skill").prop("checked", !1),
        $("#chk-equip-no-origin").prop("checked", !0),
        $(".pane-equips .search-box input").val(""),
        checkMonitorStyle(),
        c.draw()
    }),
    initTableResponsiveDisplayEvent(c),
    initTableScrollEvent(".pane-equips"),
    initEquipShow()
}
function initAmberTable(e) {
    var a = [{
        data: void 0,
        defaultContent: "<span class='glyphicon'></span>",
        className: "td-expend",
        orderable: !1,
        searchable: !1,
        visible: expendBtn,
        width: "1px"
    }, {
        data: "amberId",
        width: "1px"
    }, {
        data: "icon",
        className: "td-amber-icon",
        orderable: !1,
        searchable: !1
    }, {
        data: "name",
        width: "80px",
        className: "all fixedcolumn"
    }, {
        data: {
            _: "rarity",
            display: "rarityDisp"
        },
        className: "rarity",
        width: "35px",
        orderSequence: ["desc", "asc"]
    }, {
        data: {
            _: "type",
            display: "typeDisp"
        },
        width: "35px"
    }, {
        data: {
            _: "skillDisp",
            sort: "skillSort"
        },
        type: "num"
    }, {
        data: "allDesc"
    }, {
        data: "origin"
    }]
      , t = !0
      , i = !1
      , l = !1;
    isMobile && (t = !1,
    i = !0,
    l = {
        left: [0, 3]
    });
    var s = "td:not(.nodetails)";
    expendBtn && (s = ".td-expend");
    var c = $("#amber-table").DataTable({
        data: e.ambers,
        columns: a,
        language: {
            search: "查找:",
            zeroRecords: "没有找到",
            info: "_TOTAL_个",
            infoEmpty: "0",
            infoFiltered: "/ _MAX_"
        },
        pagingType: "numbers",
        pageLength: Number($("#select-setting-page-length").val()),
        dom: "<'table-top clearfix'<'left'i><'right'<'search-box'>>><'row'<'col-sm-12'tr>><'row'<'col-sm-12'p>>",
        deferRender: !0,
        order: [],
        autoWidth: !1,
        fixedHeader: t,
        scrollX: i,
        fixedColumns: l,
        responsive: {
            details: {
                type: "column",
                target: s,
                renderer: function(e, a, t) {
                    var i = "";
                    for (var l in t)
                        if (t[l].hidden) {
                            if (0 == l)
                                continue;
                            i += "<div class='col-lg-3 col-xs-6'><span class='child-key'>" + t[l].title + (l < 3 ? "" : "：") + "</span><span class='child-value'>" + t[l].data + "</span></div>"
                        }
                    return !!i && "<div class='child-inner'" + getResponsiveStyle($("#amber-table")) + ">" + i + "</div>"
                }
            }
        }
    });
    $(".pane-ambers div.search-box").html('<input type="search" class="form-control input-sm monitor-none" placeholder="查找 名字 技能 来源">'),
    $.fn.dataTableExt.afnFiltering.push(function(e, a, t, i, l) {
        if (e.nTable != document.getElementById("amber-table"))
            return !0;
        var s = $("#chk-amber-origin").val();
        if (0 == s.length)
            return !0;
        for (var c in s)
            if (s[c] == i.origin)
                return !0;
        return !1
    }),
    $.fn.dataTableExt.afnFiltering.push(function(e, a, t, i, l) {
        if (e.nTable != document.getElementById("amber-table"))
            return !0;
        var s = $("#chk-amber-skill").val();
        if (0 == s.length)
            return !0;
        var c = i.effect;
        for (var r in s) {
            var n = !0
              , o = s[r].split(",");
            for (var p in o) {
                var d = !1;
                for (var u in c)
                    if (c[u].type == o[p]) {
                        d = !0;
                        break
                    }
                if (!d) {
                    n = !1;
                    break
                }
            }
            if (n)
                return !0
        }
        return !1
    });
    var r = $(".pane-ambers .search-box input");
    $.fn.dataTableExt.afnFiltering.push(function(e, a, t, i, l) {
        if (e.nTable != document.getElementById("amber-table"))
            return !0;
        var s = $.trim(r.val());
        return !!commaSeparatedMatch(i.name, s) || (!!commaSeparatedMatch(i.skillDisp, s) || (!!commaSeparatedMatch(i.allDesc, s) || !!commaSeparatedMatch(i.origin, s)))
    }),
    $("#chk-amber-show").on("changed.bs.select", function() {
        initAmberShow(),
        updateMenuLocalData()
    }),
    $("#chk-amber-origin").on("changed.bs.select", function() {
        c.draw()
    }),
    $("#chk-amber-skill").selectpicker().on("changed.bs.select", function() {
        var e = "";
        1 == $(this).val().length && (e = $(this).val()[0],
        c.order([6, "desc"])),
        c.rows().every(function(a, t, i) {
            var l = this.data();
            if ("" == e)
                l.skillSort = 0;
            else
                for (var s in l.effect)
                    if ((l.effect[s].type == e || e.indexOf(",") > 0 && e.split(",")[0] == l.effect[s].type) && (l.skillSort = l.effect[s].value,
                    "Percent" == l.effect[s].cal)) {
                        l.skillSort *= 1e4;
                        break
                    }
            this.data(l)
        }),
        c.draw()
    }),
    $(".pane-ambers .search-box input").on("input", function() {
        c.draw(),
        changeInputStyle(this)
    }),
    $("#btn-amber-reset").click(function() {
        $("#chk-amber-origin").selectpicker("deselectAll"),
        $("#chk-amber-skill").selectpicker("deselectAll"),
        $(".pane-ambers .search-box input").val(""),
        checkMonitorStyle(),
        c.draw()
    }),
    initTableResponsiveDisplayEvent(c),
    initTableScrollEvent(".pane-ambers"),
    initAmberShow()
}
function initDecorationTable(e) {
    var a = [{
        data: void 0,
        defaultContent: "",
        className: "select-checkbox nodetails all",
        orderDataType: "dom-selected",
        orderSequence: ["desc", "asc"],
        width: "30px"
    }, {
        data: void 0,
        defaultContent: "<span class='glyphicon'></span>",
        className: "td-expend",
        orderable: !1,
        searchable: !1,
        visible: expendBtn,
        width: "1px"
    }, {
        data: "id",
        width: "1px"
    }, {
        data: "icon",
        className: "td-decoration-icon",
        orderable: !1,
        searchable: !1
    }, {
        data: "name",
        width: "145px",
        className: "all fixedcolumn"
    }, {
        data: {
            _: "gold",
            display: "goldDisp"
        },
        orderSequence: ["desc", "asc"]
    }, {
        data: "tipMin",
        orderSequence: ["desc", "asc"]
    }, {
        data: "tipMax",
        orderSequence: ["desc", "asc"]
    }, {
        data: {
            _: "tipTime",
            display: "tipTimeDisp"
        },
        orderSequence: ["desc", "asc"]
    }, {
        data: "minEff",
        defaultContent: "-",
        orderSequence: ["desc", "asc"]
    }, {
        data: "maxEff",
        defaultContent: "-",
        orderSequence: ["desc", "asc"]
    }, {
        data: {
            _: "tAvgEff",
            display: "avgEffDisp"
        },
        defaultContent: "-",
        orderSequence: ["desc", "asc"]
    }, {
        data: "position"
    }, {
        data: {
            _: "suit",
            display: "suitDisp"
        },
        orderSequence: ["desc", "asc"]
    }, {
        data: {
            _: "suitGold",
            display: "suitGoldDisp"
        },
        orderSequence: ["desc", "asc"]
    }, {
        data: "origin"
    }]
      , t = !0
      , i = !1
      , l = !1;
    isMobile && (t = !1,
    i = !0,
    l = {
        left: [0, 4]
    });
    var s = "td:not(.nodetails)";
    expendBtn && (s = ".td-expend");
    var c = $("#decoration-table").DataTable({
        data: e.decorations,
        columns: a,
        language: {
            search: "查找:",
            zeroRecords: "没有找到",
            info: "_TOTAL_个",
            infoEmpty: "0",
            infoFiltered: "/ _MAX_",
            select: {
                rows: {
                    _: "选择了 %d 个装饰",
                    0: "",
                    1: "选择了 %d 个装饰"
                }
            }
        },
        pagingType: "numbers",
        pageLength: Number($("#select-setting-page-length").val()),
        dom: "<'table-top clearfix'<'left'i><'right'<'search-box'>>><'row'<'col-sm-12'tr>><'row'<'col-sm-12'p>>",
        select: {
            style: "multi",
            selector: "td.select-checkbox"
        },
        order: [[0, "desc"], [11, "desc"]],
        deferRender: !1,
        autoWidth: !1,
        fixedHeader: t,
        scrollX: i,
        fixedColumns: l,
        responsive: {
            details: {
                type: "column",
                target: s,
                renderer: function(e, a, t) {
                    var i = "";
                    for (var l in t)
                        if (t[l].hidden) {
                            if (l < 2)
                                continue;
                            i += "<div class='col-lg-3 col-xs-6'><span class='child-key'>" + t[l].title + (l < 4 ? "" : "：") + "</span><span class='child-value'>" + t[l].data + "</span></div>"
                        }
                    return !!i && "<div class='child-inner'" + getResponsiveStyle($("#decoration-table")) + ">" + i + "</div>"
                }
            }
        }
    });
    $(".pane-decorations div.search-box").html('<input type="search" class="form-control input-sm monitor-none" placeholder="查找 名字 套装 来源">'),
    $.fn.dataTableExt.afnFiltering.push(function(e, a, t, i, l) {
        if (e.nTable != document.getElementById("decoration-table"))
            return !0;
        var s = $("#chk-decoration-position").val();
        if (0 == s.length)
            return !0;
        var c = i.position;
        return !!$('#chk-decoration-position option[value="' + c + '"]').is(":selected")
    }),
    $.fn.dataTableExt.afnFiltering.push(function(e, a, t, i, l) {
        if (e.nTable != document.getElementById("decoration-table"))
            return !0;
        var s = $("#chk-decoration-no-origin").prop("checked");
        return !!(s || !s && i.origin)
    });
    var r = $(".pane-decorations .search-box input");
    $.fn.dataTableExt.afnFiltering.push(function(e, a, t, i, l) {
        if (e.nTable != document.getElementById("decoration-table"))
            return !0;
        var s = $.trim(r.val());
        return !!commaSeparatedMatch(i.name, s) || (!!commaSeparatedMatch(i.suit, s) || !!commaSeparatedMatch(i.origin, s))
    }),
    $("#chk-decoration-show").on("changed.bs.select", function() {
        initDecorationShow(),
        updateMenuLocalData()
    }),
    $("#chk-decoration-position").on("changed.bs.select", function() {
        c.draw()
    }),
    $("#chk-decoration-no-origin").click(function() {
        c.draw()
    }),
    $(".pane-decorations .search-box input").on("input", function() {
        c.draw(),
        changeInputStyle(this)
    });
    var n = "";
    
    // 添加表头
    var headerContent = '<span style="display:inline-block;width:50px;text-align:left;font-weight:bold;">排名</span>' +
                       '<span style="display:inline-block;width:130px;text-align:left;font-weight:bold;">套装名称</span>' +
                       '<span style="display:inline-block;width:60px;text-align:left;font-weight:bold;">日均玉璧</span>';
    n += "<option disabled data-content='" + headerContent + "'>表头</option>";
    
    // 计算排名
    var suitsWithRank = [];
    for (var o in e.suits) {
        suitsWithRank.push({
            index: o,
            name: e.suits[o].name,
            totalRAvgEff: e.suits[o].totalRAvgEff || 0
        });
    }
    
    // 按日均玉璧降序排序
    suitsWithRank.sort(function(a, b) {
        return b.totalRAvgEff - a.totalRAvgEff;
    });
    
    // 计算排名（相同值并列，后续排名跳过）
    var currentRank = 1;
    for (var i = 0; i < suitsWithRank.length; i++) {
        if (i > 0 && suitsWithRank[i].totalRAvgEff < suitsWithRank[i-1].totalRAvgEff) {
            currentRank = i + 1;
        }
        suitsWithRank[i].rank = currentRank;
    }
    
    // 按排名顺序生成选项
    for (var i = 0; i < suitsWithRank.length; i++) {
        var suitData = suitsWithRank[i];
        var o = suitData.index;
        var suitName = e.suits[o].name;
        var suitNameDisplay = suitName;
        // 如果是第一个套装（最新的），添加蓝色(新)标记
        if (o == 0) {
            suitNameDisplay = suitName + '<span style="color:#337ab7;"> (新)</span>';
        }
        var suitValue = "";
        if (e.suits[o].totalRAvgEff && e.suits[o].totalRAvgEff > 0) {   
            suitValue = e.suits[o].totalRAvgEff;
            // 使用inline-block布局，不使用绝对定位
            var contentHtml = '<span style="display:inline-block;width:50px;text-align:left;">' + suitData.rank + '</span>' +
                            '<span style="display:inline-block;width:130px;text-align:left;">' + suitNameDisplay + '</span>' +
                            '<span style="display:inline-block;width:60px;text-align:left;">' + suitValue + '</span>';
            n += "<option value='" + e.suits[o].name + "' data-content='" + contentHtml + "'>" + suitName + "</option>";
        } else {
            n += "<option value='" + e.suits[o].name + "'>" + suitName + "</option>";
        }
    }
    $("#select-decoration-suit").append(n).selectpicker();
    // 初始化后清空默认选择
    $("#select-decoration-suit").selectpicker("val", "");
    $("#select-decoration-suit").change(function() {
        var e = $("#select-decoration-suit").val();
        c.rows().deselect(),
        c.rows().every(function(a, t, i) {
            this.data().suit == e && this.select()
        }),
        c.draw()
    }),
    $("#btn-decoration-deselect-all").click(function() {
        $("#chk-decoration-position").selectpicker("deselectAll"),
        $("#select-decoration-suit").selectpicker("val", ""),
        c.rows().deselect()
    }),
    c.on("user-select", function(e, a, t, i, l) {
        var s = i.index().row
          , r = c.rows(s).data()[0];
        c.rows({
            selected: !0
        }).every(function(e, a, t) {
            this.data().position == r.position && this.data().id != r.id && this.deselect()
        })
    }),
    c.on("select", function(a, t, i, l) {
        updateDecorationSum(e)
    }),
    c.on("deselect", function(a, t, i, l) {
        updateDecorationSum(e)
    }),
    initTableResponsiveDisplayEvent(c),
    initTableScrollEvent(".pane-decorations"),
    initDecorationShow()
}
function updateDecorationSum(e) {
    var a = $("#decoration-table").DataTable().rows({
        selected: !0
    }).data().toArray()
      , t = 0
      , i = 0
      , l = 0
      , s = [];
    for (var c in a)
        a[c].suit && s.indexOf(a[c].suit) < 0 && s.push(a[c].suit),
        a[c].tAvgEff && (t += a[c].tAvgEff),
        a[c].rAvgEff && (i += a[c].rAvgEff),
        l += a[c].gold;
    var r = 0;
    for (var c in s)
        r += getSuitGold(e, a, s[c]);
    var n = "";
    a.length && (n = "平均玉璧/天: " + getDecorationAvgEffDisp(t, i) + " 收入加成: " + getPercentDisp(+(100 * (l + r)).toFixed(2))),
    $("#decoration-sum").html(n)
}
function getSuitGold(e, a, t) {
    for (var i in e.suits)
        if (e.suits[i].name == t) {
            for (var l in e.suits[i].decorations) {
                var s = !1;
                for (var c in a)
                    if (e.suits[i].decorations[l] == a[c].id) {
                        s = !0;
                        break
                    }
                if (!s)
                    return 0
            }
            return e.suits[i].gold
        }
    return 0
}
function initMaterialTable(e) {
    for (var a in e.maps)
        $("#select-material-origin").append("<option value='" + e.maps[a].name + "'>" + e.maps[a].name + "</option>");
    reInitMaterialTable(e),
    $("#select-material-origin").selectpicker().change(function() {
        reInitMaterialTable(e)
    }),
    $("#chk-material-season").click(function() {
        var a = getMaterialsData(e);
        $("#material-table").DataTable().clear().rows.add(a).draw()
    }),
    $("#input-material-addition, #input-material-skill").on("input", function() {
        var a = getMaterialsData(e);
        $("#material-table").DataTable().clear().rows.add(a).draw()
    })
}
function reInitMaterialTable(e) {
    var a = [{
        data: "name",
        className: "fixedcolumn"
    }, {
        data: "skill",
        defaultContent: ""
    }];
    $.fn.DataTable.isDataTable("#material-table") && $("#material-table").DataTable().destroy();
    var t, i = $("#select-material-origin").val();
    for (var l in e.maps)
        if (i == e.maps[l].name) {
            t = e.maps[l];
            break
        }
    for (var l in $("#material-table thead tr").first().html("").append("<th rowspan='2'>食材</th><th rowspan='2'>点数</th>"),
    $("#material-table thead tr").last().html(""),
    t.time)
        $("#material-table thead tr").first().append("<th colspan='2'>" + secondsToTime(t.time[l]) + "</th>"),
        $("#material-table thead tr").last().append("<th>最小</th><th>最大</th>"),
        a.push({
            data: "time." + l + ".0"
        }),
        a.push({
            data: "time." + l + ".1"
        });
    var s = getMaterialsData(e, t)
      , c = !1
      , r = !1;
    isMobile && (c = !0,
    r = {
        left: [0]
    });
    var n = $("#material-table").DataTable({
        data: s,
        columns: a,
        dom: "<'row'<'col-sm-12'tr>>",
        paging: !1,
        ordering: !1,
        info: !1,
        deferRender: !0,
        autoWidth: !1,
        scrollX: c,
        fixedColumns: r
    });
    initTableScrollEvent(".pane-materials"),
    n.draw()
}
function initCondimentTable(e) {
    var a = [{
        data: void 0,
        defaultContent: "<span class='glyphicon'></span>",
        className: "td-expend",
        orderable: !1,
        searchable: !1,
        visible: expendBtn,
        width: "1px"
    }, {
        data: "condimentId",
        width: "1px"
    }, {
        data: "icon",
        className: "td-condiment-icon",
        orderable: !1,
        searchable: !1
    }, {
        data: "name",
        width: "80px",
        className: "all fixedcolumn"
    }, {
        data: {
            _: "rarity",
            display: "rarityDisp"
        },
        className: "rarity",
        width: "35px",
        orderSequence: ["desc", "asc"]
    }, {
        data: {
            _: "skillDisp",
            sort: "skillSort"
        },
        type: "num"
    }, {
        data: "origin"
    }]
      , t = !0
      , i = !1
      , l = !1;
    isMobile && (t = !1,
    i = !0,
    l = {
        left: [0, 3]
    });
    var s = "td:not(.nodetails)";
    expendBtn && (s = ".td-expend");
    var c = $("#condiment-table").DataTable({
        data: e.condiments,
        columns: a,
        language: {
            search: "查找:",
            zeroRecords: "没有找到",
            info: "_TOTAL_个",
            infoEmpty: "0",
            infoFiltered: "/ _MAX_"
        },
        pagingType: "numbers",
        pageLength: Number($("#select-setting-page-length").val()),
        dom: "<'table-top clearfix'<'left'i><'right'<'search-box'>>><'row'<'col-sm-12'tr>><'row'<'col-sm-12'p>>",
        deferRender: !0,
        order: [],
        autoWidth: !1,
        fixedHeader: t,
        scrollX: i,
        fixedColumns: l,
        responsive: {
            details: {
                type: "column",
                target: s,
                renderer: function(e, a, t) {
                    var i = "";
                    for (var l in t)
                        if (t[l].hidden) {
                            if (0 == l)
                                continue;
                            i += "<div class='col-lg-3 col-xs-6'><span class='child-key'>" + t[l].title + (l < 3 ? "" : "：") + "</span><span class='child-value'>" + t[l].data + "</span></div>"
                        }
                    return !!i && "<div class='child-inner'" + getResponsiveStyle($("#condiment-table")) + ">" + i + "</div>"
                }
            }
        }
    });
    $(".pane-condiments div.search-box").html('<input type="search" class="form-control input-sm monitor-none" placeholder="查找 名字 技能 来源">'),
    $.fn.dataTableExt.afnFiltering.push(function(e, a, t, i, l) {
        if (e.nTable != document.getElementById("condiment-table"))
            return !0;
        var s = $("#chk-condiment-origin").val();
        if (0 == s.length)
            return !0;
        for (var c in s)
            if (s[c] == i.origin)
                return !0;
        return !1
    }),
    $.fn.dataTableExt.afnFiltering.push(function(e, a, t, i, l) {
        if (e.nTable != document.getElementById("condiment-table"))
            return !0;
        var s = $("#chk-condiment-skill").val();
        if (0 == s.length)
            return !0;
        var c = $("#chk-condiment-multiple-skill").prop("checked")
          , r = i.effect;
        for (var n in s) {
            var o = !0
              , p = s[n].split(",");
            for (var d in p) {
                var u = !1;
                for (var f in r)
                    if (r[f].type == p[d]) {
                        u = !0;
                        break
                    }
                if (!u) {
                    if (c)
                        return !1;
                    o = !1;
                    break
                }
            }
            if (!c && o)
                return !0
        }
        return !!c
    });
    var r = $(".pane-condiments .search-box input");
    $.fn.dataTableExt.afnFiltering.push(function(e, a, t, i, l) {
        if (e.nTable != document.getElementById("condiment-table"))
            return !0;
        var s = $.trim(r.val());
        return !!commaSeparatedMatch(i.name, s) || (!!commaSeparatedMatch(i.skillDisp, s) || !!commaSeparatedMatch(i.origin, s))
    }),
    $("#chk-condiment-show").on("changed.bs.select", function() {
        initCondimentShow(),
        updateMenuLocalData()
    }),
    $("#chk-condiment-origin").on("changed.bs.select", function() {
        c.draw()
    }),
    $("#chk-condiment-skill").selectpicker().on("changed.bs.select", function() {
        var e = "";
        1 == $(this).val().length && (e = $(this).val()[0],
        c.order([5, "desc"])),
        c.rows().every(function(a, t, i) {
            var l = this.data();
            if ("" == e)
                l.skillSort = 0;
            else
                for (var s in l.effect)
                    if ((l.effect[s].type == e || e.indexOf(",") > 0 && e.split(",")[0] == l.effect[s].type) && (l.skillSort = l.effect[s].value,
                    "Percent" == l.effect[s].cal)) {
                        l.skillSort *= 1e4;
                        break
                    }
            this.data(l)
        }),
        c.draw()
    }),
    $("#chk-condiment-multiple-skill").click(function() {
        c.draw()
    }),
    $(".pane-condiments .search-box input").on("input", function() {
        c.draw(),
        changeInputStyle(this)
    }),
    $("#btn-condiment-reset").click(function() {
        $("#chk-condiment-origin").selectpicker("deselectAll"),
        $("#chk-condiment-skill").selectpicker("deselectAll"),
        $("#chk-condiment-multiple-skill").prop("checked", !1),
        $(".pane-condiments .search-box input").val(""),
        checkMonitorStyle(),
        c.draw()
    }),
    initTableResponsiveDisplayEvent(c),
    initTableScrollEvent(".pane-condiments"),
    initCondimentShow()
}
function initQuestTable(e) {
    for (var a in e.activities) {
        var t = e.activities[a].endTime
          , i = e.activities[a].name;
        t && (new Date).getTime() / 1e3 < t ? $("#select-quest-type").prepend("<option value='" + i + "' selected>" + i + "</option>") : $("#select-quest-type").append("<option value='" + i + "'>" + i + "</option>")
    }
    var l = [{
        data: "questIdDisp",
        width: "25px",
        className: "fixedcolumn"
    }, {
        data: "preId",
        defaultContent: "",
        orderable: !1,
        width: "35px"
    }, {
        data: "goal"
    }, {
        data: {
            _: "rewardsVal",
            display: "rewardsDisp"
        }
    }]
      , s = getQuestsData(e.quests, $("#select-quest-type").val())
      , c = !0
      , r = !1
      , n = !1;
    isMobile && (c = !1,
    r = !0,
    n = {
        leftColumns: [0]
    });
    var o = $("#quest-table").DataTable({
        data: s,
        columns: l,
        language: {
            search: "查找:",
            zeroRecords: "没有找到",
            info: "_TOTAL_个",
            infoEmpty: "0",
            infoFiltered: "/ _MAX_"
        },
        pagingType: "numbers",
        pageLength: Number($("#select-setting-page-length").val()),
        dom: "<'table-top clearfix'<'left'i><'right'<'search-box'>>><'row'<'col-sm-12'tr>><'row'<'col-sm-12'p>>",
        deferRender: !0,
        order: [],
        autoWidth: !1,
        fixedHeader: c,
        scrollX: r,
        fixedColumns: n
    });
    $(".pane-quest div.search-box").html('<input type="search" class="form-control input-sm monitor-none" placeholder="查找 编号 任务 奖励">');
    var p = $(".pane-quest .search-box input");
    $.fn.dataTableExt.afnFiltering.push(function(e, a, t, i, l) {
        if (e.nTable != document.getElementById("quest-table"))
            return !0;
        var s = $.trim(p.val());
        return !!commaSeparatedMatch(i.questIdDisp.toString(), s) || (!!commaSeparatedMatch(i.goal, s) || !!commaSeparatedMatch(i.rewardsVal, s))
    }),
    $(".pane-quest .search-box input").on("input", function() {
        o.draw(),
        changeInputStyle(this)
    }),
    $("#select-quest-type").selectpicker().change(function() {
        var a = getQuestsData(e.quests, $(this).val());
        o.clear().rows.add(a).draw(),
        initQuestShow(o)
    }),
    initTableScrollEvent(".pane-quest"),
    initQuestShow(o)
}
function initImportExport(e) {
    $("#btn-import-data").click(function() {
        $("#input-import-data").val() ? ($.popupmsg({
            message: "导入中...",
            fade: !1
        }),
        $.ajax({
            cache: !1,
            success: function(a) {
                var t = JSON.parse(a);
                if ("S" == t.ret) {
                    var i = importData(e, JSON.stringify(t.msg));
                    if (i) {
                        $("#input-import-data").val("");
                        $.popupmsg({
                            message: "导入成功 !"
                        });
                        try {
                            // 清空计算器配置中的所有输入框（确保旧数据被清除）
                            $("#cal-ultimate input").val("");
                            
                            loadUltimate(e, !0);
                            
                            // 更新计算器配置数据（修炼值等）
                            setCalConfigData(e);
                            
                            // 保存当前激活的标签页
                            var $dropdown = $('#chk-chef-partial-ultimate').parent().find('.dropdown-menu');
                            var $activeTab = $dropdown.find('.chef-type-tabs li.active a');
                            var isTimeTabActive = $activeTab.hasClass('chef-tab-time');
                            
                            // 直接使用更新后的e.chefs数据重新生成额外上场技能列表
                            $('#chk-chef-partial-ultimate').empty();
                            setPartialUltimateOptions(e.chefs);
                            $('#chk-chef-partial-ultimate').selectpicker('refresh');
                            
                            // 重新应用标签页过滤
                            setTimeout(function() {
                                var $select = $('#chk-chef-partial-ultimate');
                                var $newDropdown = $select.parent().find('.dropdown-menu');
                                
                                if (isTimeTabActive) {
                                    // 显示时间类，隐藏技法类
                                    var hasVisible = false;
                                    $newDropdown.find('ul.dropdown-menu > li').each(function() {
                                        var $li = $(this);
                                        if ($li.hasClass('chef-empty-hint')) return;
                                        var $option = $select.find('option').eq($li.index());
                                        if ($option.hasClass('chef-time-type')) {
                                            $li.show();
                                            hasVisible = true;
                                        } else if ($option.hasClass('chef-skill-type')) {
                                            $li.hide();
                                        }
                                    });
                                    // 如果没有可见项，显示空状态提示
                                    if (!hasVisible) {
                                        $newDropdown.find('.chef-empty-hint').show();
                                    } else {
                                        $newDropdown.find('.chef-empty-hint').hide();
                                    }
                                } else {
                                    // 显示技法类，隐藏时间类
                                    $newDropdown.find('ul.dropdown-menu > li').each(function() {
                                        var $li = $(this);
                                        if ($li.hasClass('chef-empty-hint')) return;
                                        var $option = $select.find('option').eq($li.index());
                                        if ($option.hasClass('chef-skill-type')) {
                                            $li.show();
                                        } else if ($option.hasClass('chef-time-type')) {
                                            $li.hide();
                                        }
                                    });
                                    $newDropdown.find('.chef-empty-hint').hide();
                                }
                            }, 100);
                            
                            // 导入数据后重新计算熟练份数（因为ExperienceTimeRate状态可能改变）
                            // 传入false不显示加载提示，避免闪烁
                            updateRecipeChefTable(e, false);
                        } catch (err) {
                            // Error loading ultimate
                        }
                    } else {
                        $.popupmsg({
                            message: "导入失败 !",
                            type: "alert-danger"
                        })
                    }
                } else
                    $.popupmsg({
                        message: t.msg,
                        type: "alert-danger"
                    })
            },
            error: function() {
                $.popupmsg({
                    message: "获取失败 !",
                    type: "alert-danger"
                })
            },
            url: "https://yx518.com/api/archive.do?token=" + $("#input-import-data").val()
        })) : $("#input-import-data").focus()
    }),
    $("#btn-export").click(function() {
        $("#input-export-import").val(generateExportData())
    }),
    $("#btn-import").click(function() {
        $("#import-msg-2").html("导入中...").removeClass("hidden"),
        setTimeout(function() {
            var a = importData(e, $("#input-export-import").val());
            a ? ($("#input-export-import").val(""),
            $("#import-msg-2").html("导入成功 !")) : $("#import-msg-2").html("导入失败 !")
        }, 0)
    }),
    $("#btn-export-download").click(function() {
        var e = new Blob([generateExportData()],{
            type: "text/plain;charset=utf-8"
        });
        saveAs(e, "food.txt")
    }),
    $("#file-import").change(function() {
        $("#import-msg").html("导入中...").removeClass("hidden"),
        setTimeout(function() {
            var a = document.getElementById("file-import").files[0]
              , t = new FileReader;
            t.onload = function(a) {
                var t = importData(e, a.target.result);
                t ? $("#import-msg").html("导入成功 !") : $("#import-msg").html("导入失败 !")
            }
            ,
            t.readAsText(a, "UTF-8"),
            $("#file-import").val("")
        }, 0)
    }),
    $("#btn-import-bcjh-cloud").click(function() {
        $("#import-msg-bcjh-cloud").html("导入中...").removeClass("hidden"),
        $("#input-import-bcjh-cloud").val() ? setTimeout(function() {
            $.ajax({
                cache: !1,
                success: function(e) {
                    if (e.result) {
                        var a = importDataBcjh(e.data);
                        a ? $("#import-msg-bcjh-cloud").html("导入成功 !") : $("#import-msg-bcjh-cloud").html("导入失败 !")
                    } else
                        $("#import-msg-bcjh-cloud").html(e.msg)
                },
                error: function() {
                    $("#import-msg-bcjh-cloud").html("获取失败 !")
                },
                url: "https://bcjh.xyz/api/download_data?id=" + $("#input-import-bcjh-cloud").val()
            })
        }, 0) : $("#import-msg-bcjh-cloud").html("输入数据ID !")
    }),
    $("#btn-import-bcjh-text").click(function() {
        $("#import-msg-bcjh-text").html("导入中...").removeClass("hidden"),
        setTimeout(function() {
            var e = importDataBcjh($("#input-import-bcjh-text").val());
            e ? $("#import-msg-bcjh-text").html("导入成功 !") : $("#import-msg-bcjh-text").html("导入失败 !")
        }, 0)
    }),
    $("#file-import-bcjh").change(function() {
        $("#import-msg-bcjh-file").html("导入中...").removeClass("hidden"),
        setTimeout(function() {
            var e = document.getElementById("file-import-bcjh").files[0]
              , a = new FileReader;
            a.onload = function(e) {
                var a = importDataBcjh(e.target.result);
                a ? $("#import-msg-bcjh-file").html("导入成功 !") : $("#import-msg-bcjh-file").html("导入失败 !")
            }
            ,
            a.readAsText(e, "UTF-8"),
            $("#file-import-bcjh").val("")
        }, 0)
    })
}
function importDataBcjh(e) {
    var a;
    try {
        a = JSON.parse(e)
    } catch (e) {
        return !1
    }
    var t = a.userUltimate
      , i = a.repGot
      , l = a.chefGot;
    if (!t || !i || !l)
        return !1;
    $("#input-cal-decoration").val(t.decoBuff),
    $("#input-cal-ultimate-stirfry").val(t.Stirfry),
    $("#input-cal-ultimate-boil").val(t.Boil),
    $("#input-cal-ultimate-knife").val(t.Knife),
    $("#input-cal-ultimate-fry").val(t.Fry),
    $("#input-cal-ultimate-bake").val(t.Bake),
    $("#input-cal-ultimate-steam").val(t.Steam),
    $("#input-cal-ultimate-male-skill").val(Number(t.Male) + Number(t.All) || ""),
    $("#input-cal-ultimate-female-skill").val(Number(t.Female) + Number(t.All) || ""),
    $("#input-cal-ultimate-1-limit").val(t.MaxLimit_1),
    $("#input-cal-ultimate-2-limit").val(t.MaxLimit_2),
    $("#input-cal-ultimate-3-limit").val(t.MaxLimit_3),
    $("#input-cal-ultimate-4-limit").val(t.MaxLimit_4),
    $("#input-cal-ultimate-5-limit").val(t.MaxLimit_5),
    $("#input-cal-ultimate-1-price").val(t.PriceBuff_1),
    $("#input-cal-ultimate-2-price").val(t.PriceBuff_2),
    $("#input-cal-ultimate-3-price").val(t.PriceBuff_3),
    $("#input-cal-ultimate-4-price").val(t.PriceBuff_4),
    $("#input-cal-ultimate-5-price").val(t.PriceBuff_5);
    var s = [];
    for (var c in t.Partial.id)
        s.push(t.Partial.id[c].split(",")[0]);
    $("#chk-cal-partial-ultimate").selectpicker("val", s);
    var r = [];
    for (var c in t.Self.id)
        r.push(t.Self.id[c].split(",")[0]);
    for (var n in $("#chk-cal-self-ultimate").selectpicker("val", r),
    calCustomRule.rules) {
        var o = calCustomRule.rules[n];
        for (var c in o.recipes)
            for (var p in i)
                if (p == o.recipes[c].recipeId) {
                    o.recipes[c].got = i[p];
                    break
                }
        for (var c in o.chefs)
            for (var p in l)
                if (p == o.chefs[c].chefId) {
                    o.chefs[c].got = l[p];
                    break
                }
    }
    return $("#cal-recipes-table").DataTable().draw(),
    !0
}
function importRunResult(e) {
    for (var a = $("#input-import-run").val(), t = "厨师：", i = /-|\r\n|\r|\n/g, l = "菜谱：", s = "]", c = /；|;|\r\n|\r|\n/g, r = /\(/g, n = 0; n < calCustomRule.rules.length; n++) {
        var o = calCustomRule.rules[n]
          , p = o.custom;
        for (var d in p) {
            var u = a.indexOf(t);
            if (u >= 0) {
                a = a.substring(u + t.length);
                var f = ""
                  , h = a.search(i);
                h >= 0 && (f = a.substring(0, h),
                a = a.substring(h + 1));
                var m = getCustomChefIdByName(o.chefs, $.trim(f));
                if (!m)
                    break;
                setCustomChef(n, d, m)
            }
            var v = a.indexOf(l);
            if (v >= 0)
                for (var b in a = a.substring(v + l.length),
                p[d].recipes) {
                    var g = a.indexOf(s);
                    g >= 0 && (a = a.substring(g + 1));
                    f = a;
                    var k = a.search(c);
                    k >= 0 && (f = a.substring(0, k),
                    a = a.substring(k + 1));
                    var y = f.search(r);
                    y >= 0 && (f = f.substring(0, y));
                    var x = getCustomRecipeIdByName(o.menus, $.trim(f));
                    if (!x)
                        break;
                    setCustomRecipe(n, d, b, x)
                }
        }
    }
    calCustomResults(e),
    $("#input-import-run").val(""),
    $.popupmsg({
        message: "导入完毕 !"
    }),
    $("#import-run-modal").modal("hide")
}
function getCustomChefIdByName(e, a) {
    for (var t in e)
        if (e[t].name == a)
            return e[t].chefId;
    return null
}
function getCustomRecipeIdByName(e, a) {
    for (var t in e)
        if (e[t].recipe.data.name == a)
            return e[t].recipe.data.recipeId;
    return null
}
function importData(e, a) {
    var t;
    try {
        t = JSON.parse(a)
    } catch (e) {
        return !1
    }
    for (var i in e.recipes) {
        for (var l in t.recipes)
            if (e.recipes[i].recipeId == t.recipes[l].id) {
                if (t.recipes[l].hasOwnProperty("rank")) {
                    e.recipes[i].rank = t.recipes[l].rank,
                    e.recipes[i].rankSort = getRankSortValue(t.recipes[l].rank);
                    var s = getRankGuestInfo(e.recipes[i], e.recipes[i].rank);
                    e.recipes[i].rankGuestsVal = s.rankGuestsVal,
                    e.recipes[i].rankGuestsDisp = s.rankGuestsDisp;
                    var c = getRankGiftInfo(e.recipes[i], e.recipes[i].rank);
                    e.recipes[i].rankGiftVal = c.rankGiftVal,
                    e.recipes[i].rankGiftDisp = c.rankGiftDisp
                }
                t.recipes[l].hasOwnProperty("ex") && (e.recipes[i].ex = t.recipes[l].ex),
                t.recipes[l].hasOwnProperty("got") && (e.recipes[i].got = t.recipes[l].got);
                break
            }
        for (var l in t.recipesTags)
            if (e.recipes[i].recipeId == t.recipesTags[l].recipeId) {
                e.recipes[i].tags = t.recipesTags[l].tags,
                e.recipes[i].tagsDisp = getTagsDisp(t.recipesTags[l].tags, t.tags),
                e.recipes[i].exTime = t.recipesTags[l].experienceTime,
                e.recipes[i].exTimeDisp = getExTimeDisp(t.recipesTags[l].experienceTime, e.recipes[i].time);
                break
            }
    }
    for (var i in e.chefs)
        for (var l in updateChefByLocalData(e.chefs[i], t, e.equips, e.ambers),
        t.chefsTags)
            if (e.chefs[i].chefId == t.chefsTags[l].chefId) {
                e.chefs[i].tags = t.chefsTags[l].tags,
                e.chefs[i].tagsDisp = getTagsDisp(t.chefsTags[l].tags, t.tags);
                break
            }
    var r = "";
    for (var i in t.rules) {
        var n = !1;
        for (var l in e.rules)
            if (t.rules[i].Id == e.rules[l].Id) {
                e.rules[l] = t.rules[i],
                n = !0;
                break
            }
        n || (e.rules.push(t.rules[i]),
        r += "<option value='" + t.rules[i].Id + "'>" + t.rules[i].Title + "</option>")
    }
    $("#select-cal-rule").append(r).selectpicker("destroy").selectpicker(),
    t.calChefs && ($("#cal-chefs-table").DataTable().rows().deselect(),
    $("#cal-chefs-table").DataTable().rows(function(e, a, i) {
        for (var l in t.calChefs)
            if (a.chefId == t.calChefs[l])
                return !0;
        return !1
    }).select()),
    t.calEquips && ($("#cal-equips-table").DataTable().rows().deselect(),
    $("#cal-equips-table").DataTable().rows(function(e, a, i) {
        for (var l in t.calEquips)
            if (a.equipId == t.calEquips[l])
                return !0;
        return !1
    }).select()),
    t.buffs && (e.buffs = t.buffs),
    t.intents && (e.intents = t.intents);
    var o = getLocalData();
    for (var i in o.cal || (o.cal = []),
    t.cal) {
        var p = ""
          , d = !1;
        for (var l in o.cal)
            if (t.cal[i].id == o.cal[l].id) {
                for (var u in t.cal[i].data) {
                    var f = !1;
                    for (var h in o.cal[l].data)
                        if (t.cal[i].data[u].score == o.cal[l].data[h].score) {
                            o.cal[l].data[h].menu = t.cal[i].data[u].menu,
                            f = !0;
                            break
                        }
                    f || (o.cal[l].data.push(t.cal[i].data[u]),
                    t.cal[i].id == calCustomRule.id && (p += "<option value='" + t.cal[i].data[u].score + "'>" + t.cal[i].data[u].score + "</option>"))
                }
                d = !0;
                break
            }
        if (!d && (o.cal.push(t.cal[i]),
        t.cal[i].id == calCustomRule.id))
            for (var u in t.cal[i].data)
                p += "<option value='" + t.cal[i].data[u].score + "'>" + t.cal[i].data[u].score + "</option>";
        p && $("#select-cal-custom").append(p).selectpicker("destroy").selectpicker()
    }
    updateCalLocalData(o.cal),
    updateMenu(t),
    updateSetting(t),
    t.decorationEffect && (e.decorationEffect = t.decorationEffect,
    $("#input-cal-decoration").val(t.decorationEffect || ""));
    
    // 导入后强制更新原始值，确保批量应用后能恢复到导入的数据
    for (var i in e.chefs) {
        e.chefs[i].originalEquip = e.chefs[i].equip || null;
        e.chefs[i].originalEquipId = e.chefs[i].equipId || null;
        e.chefs[i].originalEquipDisp = e.chefs[i].equipDisp || null;
        e.chefs[i].originalDiskAmbers = e.chefs[i].disk && e.chefs[i].disk.ambers ? JSON.parse(JSON.stringify(e.chefs[i].disk.ambers)) : [];
        e.chefs[i].originalDiskLevel = e.chefs[i].disk && e.chefs[i].disk.level ? e.chefs[i].disk.level : 1;
        // 同时更新用于刷新页面后恢复的初始值
        e.chefs[i].initialEquipForRestore = e.chefs[i].equip || null;
        e.chefs[i].initialEquipForRestoreId = e.chefs[i].equipId || null;
        e.chefs[i].initialEquipForRestoreDisp = e.chefs[i].equipDisp || null;
        e.chefs[i].initialDiskAmbersForRestore = e.chefs[i].disk && e.chefs[i].disk.ambers ? JSON.parse(JSON.stringify(e.chefs[i].disk.ambers)) : [];
        e.chefs[i].initialDiskLevelForRestore = e.chefs[i].disk && e.chefs[i].disk.level ? e.chefs[i].disk.level : 1;
    }
    
    e = getUpdateData(e);
    updateRecipeTableData(e);
    updateChefTableData(e);
    
    // 在更新完DataTable后再保存到localStorage
    try {
        localStorage.setItem("data", generateExportData())
    } catch (e) {}
    
    initRecipeShow();
    initChefShow();
    initEquipShow();
    initAmberShow();
    initDecorationShow();
    initCondimentShow();
    
    // 导入完成后，模拟点击"读取已修炼"按钮的完整逻辑
    $("#cal-ultimate input").val("");
    loadUltimate(e, !0);
    setCalConfigData(e);
    
    return !0;
}
function updateChefByLocalData(e, a, t, i) {
    for (var l in a.chefs)
        if (e.chefId == a.chefs[l].id) {
            if (a.chefs[l].hasOwnProperty("got") && (e.got = a.chefs[l].got),
            a.chefs[l].hasOwnProperty("ult") && (e.ultimate = a.chefs[l].ult),
            a.chefs[l].hasOwnProperty("equip")) {
                var s = getEquipInfo(a.chefs[l].equip, t);
                s && (e.equip = s,
                e.equipId = s.equipId,
                e.equipDisp = s.disp)
            } else
                e.equip = null,
                e.equipId = "",
                e.equipDisp = "";
            if (a.chefs[l].hasOwnProperty("dlv")) {
                var c = a.chefs[l].dlv;
                Number.isInteger(c) && c > 0 && c <= e.disk.maxLevel && (e.disk.level = c)
            } else
                e.disk.level = 1;
            if (a.chefs[l].hasOwnProperty("ambers")) {
                var r = JSON.parse(JSON.stringify(a.chefs[l].ambers));
                for (var n in e.disk.ambers) {
                    var o = !1;
                    for (var p in r) {
                        if (0 == r[p]) {
                            r.splice(p, 1);
                            break
                        }
                        var d = getAmberInfo(r[p], i);
                        if (d && e.disk.ambers[n].type == d.type) {
                            e.disk.ambers[n].data = d,
                            r.splice(p, 1),
                            o = !0;
                            break
                        }
                    }
                    o || (e.disk.ambers[n].data = null)
                }
            } else
                for (var n in e.disk.ambers)
                    e.disk.ambers[n].data = null;
            e.diskDisp = GetDiskDisp(e.disk);
            break
        }
}
function updateCalLocalData(e) {
    updateLocalData("cal", e)
}
function updateRecipesLocalData() {
    updateLocalData("recipes", generateRecipesExportData())
}
function updateChefsLocalData() {
    updateLocalData("chefs", generateChefsExportData())
}
function updateMenuLocalData() {
    var e = getLocalData();
    updateLocalData("menu", generateMenuExportData(e.menu))
}
function updateSettingLocalData() {
    updateLocalData("setting", generateSettingExportData())
}
function updateDecorationLocalData() {
    updateLocalData("decorationEffect", Number($("#input-cal-decoration").val()))
}
function updateActivityLocalData() {
    var e = getLocalData();
    e.cal || (e.cal = []);
    var a = generateActivityExportData()
      , t = !1;
    for (var i in e.cal)
        if (e.cal[i].id == calCustomRule.id) {
            e.cal[i].activity = a,
            t = !0;
            break
        }
    if (!t) {
        var l = {};
        l.id = calCustomRule.id,
        l.activity = a,
        l.data = [],
        e.cal.push(l)
    }
    updateCalLocalData(e.cal)
}
function updateLocalData(e, a) {
    var t = getLocalData();
    t[e] = a;
    try {
        localStorage.setItem("data", JSON.stringify(t))
    } catch (e) {}
}
function getLocalData() {
    var e;
    try {
        var a = localStorage.getItem("data");
        e = JSON.parse(a)
    } catch (e) {}
    return e || (e = {}),
    e
}
// 判断厨师是否已修炼的公共函数
// 参数：chefId - 厨师ID, localData - 本地数据（可选）, configIds - 配置ID缓存（用于性能优化）
// 返回：true 表示已修炼，false 表示未修炼
function isChefUltimated(chefId, localData, configIds) {
    var chefIdStr = String(chefId);
    
    // 如果处于"全修炼"模式，所有厨师都视为已修炼
    if (typeof isAllUltimateMode !== 'undefined' && isAllUltimateMode) {
        return true;
    }
    
    // 检查本地数据（厨师页面标记）
    if (localData && localData.chefs) {
        for (var i = 0; i < localData.chefs.length; i++) {
            if (localData.chefs[i].id == chefId && "是" == localData.chefs[i].ult) {
                return true;
            }
        }
    }
    
    // 检查配置页面的下拉框（上场类已修炼、个人类已修炼）
    // 如果传入了 configIds 缓存，直接使用；否则重新获取
    if (!configIds) {
        configIds = getConfigUltimatedChefIds();
    }
    
    // 使用 Set 进行 O(1) 查找
    if (configIds.allSet && configIds.allSet[chefIdStr]) {
        return true;
    }
    
    return false;
}

function getConfigUltimatedChefIds() {
    var partialUltimatedChefIds = $("#chk-cal-partial-ultimate").val() || [];
    var selfUltimatedChefIds = $("#chk-cal-self-ultimate").val() || [];
    var allIds = partialUltimatedChefIds.concat(selfUltimatedChefIds);
    
    var allIdsSet = {};
    for (var i = 0; i < allIds.length; i++) {
        allIdsSet[allIds[i]] = true;
    }
    
    return {
        partial: partialUltimatedChefIds,
        self: selfUltimatedChefIds,
        all: allIds,
        allSet: allIdsSet 
    };
}
function generateExportData() {
    var e = getLocalData()
      , a = {};
    return a.recipes = generateRecipesExportData(),
    a.chefs = generateChefsExportData(),
    a.menu = generateMenuExportData(e.menu),
    a.setting = generateSettingExportData(),
    a.decorationEffect = Number($("#input-cal-decoration").val()),
    a.cal = e.cal,
    JSON.stringify(a)
}
function generateRecipesExportData() {
    var e = []
      , a = $("#recipe-table").DataTable().data().toArray();
    for (var t in a) {
        var i = {};
        i.id = a[t].recipeId,
        i.rank = a[t].rank,
        i.ex = a[t].ex,
        i.got = a[t].got,
        e.push(i)
    }
    return e
}
function generateChefsExportData() {
    var e = []
      , a = $("#chef-table").DataTable().data().toArray();
    for (var t in a) {
        var i = {};
        i.id = a[t].chefId,
        i.got = a[t].got,
        i.ult = a[t].ultimate,
        // 保存initialEquipForRestore而不是当前的equip，这样手动设置的厨具不会被保存
        a[t].initialEquipForRestore && (i.equip = a[t].initialEquipForRestore.equipId),
        // 保存initialDiskLevelForRestore而不是当前的disk.level
        a[t].initialDiskLevelForRestore && 1 != a[t].initialDiskLevelForRestore && (i.dlv = a[t].initialDiskLevelForRestore);
        var l = !1
          , s = [];
        // 保存initialDiskAmbersForRestore而不是当前的disk.ambers
        var ambersToSave = a[t].initialDiskAmbersForRestore || a[t].disk.ambers;
        for (var c in ambersToSave) {
            var r = ambersToSave[c].data;
            r ? (s.push(r.amberId),
            l = !0) : s.push(0)
        }
        l && (i.ambers = s),
        e.push(i)
    }
    return e
}
function generateMenuExportData(e) {
    var a = {
        version: 5
    };
    return a.recipe = $("#chk-recipe-show").val(),
    a.chef = $("#chk-chef-show").val(),
    a.equip = $("#chk-equip-show").val(),
    a.amber = $("#chk-amber-show").val(),
    a.decoration = $("#chk-decoration-show").val(),
    a.condiment = $("#chk-condiment-show").val(),
    a.caldd = $("#chk-cal-dd-show").val(),
    isMobile ? (a.calmui = $("#chk-cal-ui-show").val(),
    e && e.calui && (a.calui = e.calui)) : (a.calui = $("#chk-cal-ui-show").val(),
    e && e.calmui && (a.calmui = e.calmui)),
    a
}
function updateMenu(e) {
    e && e.menu && (2 == e.menu.version && (updateMenuForNewVersion(e.menu.recipe, 0, "0"),
    updateMenuForNewVersion(e.menu.chef, 0, "0"),
    updateMenuForNewVersion(e.menu.equip, 0, "0"),
    updateMenuForNewVersion(e.menu.decoration, 0, "1"),
    updateMenuForNewVersion(e.menu.condiment, 0, "0")),
    e.menu.version < 4 && updateMenuForNewVersion(e.menu.recipe, 22, null),
    4 == e.menu.version && (updateMenuForNewVersion(e.menu.recipe, 30, "30"),
    updateMenuForNewVersion(e.menu.chef, 25, "25")),
    $("#chk-recipe-show").selectpicker("val", e.menu.recipe),
    $("#chk-chef-show").selectpicker("val", e.menu.chef),
    $("#chk-equip-show").selectpicker("val", e.menu.equip),
    $("#chk-amber-show").selectpicker("val", e.menu.amber),
    $("#chk-decoration-show").selectpicker("val", e.menu.decoration),
    $("#chk-condiment-show").selectpicker("val", e.menu.condiment),
    e.menu.caldd && $("#chk-cal-dd-show").selectpicker("val", e.menu.caldd),
    isMobile ? e.menu.calmui && $("#chk-cal-ui-show").selectpicker("val", e.menu.calmui) : e.menu.calui && $("#chk-cal-ui-show").selectpicker("val", e.menu.calui))
}
function updateMenuForNewVersion(e, a, t) {
    if (a)
        for (var i in e)
            Number(e[i]) >= a && (e[i] = (Number(e[i]) + 1).toString());
    t && e.push(t)
}
function generateSettingExportData() {
    var e = {};
    return e.help = $("#chk-setting-show-help").prop("checked"),
    e.expandbtn = $("#chk-setting-expand-btn").prop("checked"),
    e.auto = $("#chk-setting-auto-update").prop("checked"),
    e.final = $("#chk-setting-show-final").prop("checked"),
    e.mark = $("#chk-setting-done-mark").prop("checked"),
    e.pagelen = Number($("#select-setting-page-length").val()),
    e
}
function updateSetting(e) {
    e && e.setting && ($("#chk-setting-show-help").prop("checked") != e.setting.help && (e.setting.help ? $("#chk-setting-show-help").bootstrapToggle("on") : $("#chk-setting-show-help").bootstrapToggle("off")),
    $("#chk-setting-expand-btn").prop("checked") != e.setting.expandbtn && (e.setting.expandbtn ? $("#chk-setting-expand-btn").bootstrapToggle("on") : ($("#chk-setting-expand-btn").bootstrapToggle("off"),
    expendBtn = !1)),
    $("#chk-setting-auto-update").prop("checked") != e.setting.auto && (e.setting.auto ? $("#chk-setting-auto-update").bootstrapToggle("on") : $("#chk-setting-auto-update").bootstrapToggle("off")),
    $("#chk-setting-show-final").prop("checked") != e.setting.final && (e.setting.final ? $("#chk-setting-show-final").bootstrapToggle("on") : $("#chk-setting-show-final").bootstrapToggle("off")),
    $("#chk-setting-done-mark").prop("checked") != e.setting.mark && (e.setting.mark ? $("#chk-setting-done-mark").bootstrapToggle("on") : $("#chk-setting-done-mark").bootstrapToggle("off")),
    Number($("#select-setting-page-length").val()) != e.setting.pagelen && e.setting.pagelen && $("#select-setting-page-length").selectpicker("val", e.setting.pagelen))
}
function generateActivityExportData() {
    var e = {};
    return e.stirfryPrice = $("#input-cal-activity-stirfry-price").val(),
    e.bakePrice = $("#input-cal-activity-bake-price").val(),
    e.steamPrice = $("#input-cal-activity-steam-price").val(),
    e.boilPrice = $("#input-cal-activity-boil-price").val(),
    e.fryPrice = $("#input-cal-activity-fry-price").val(),
    e.knifePrice = $("#input-cal-activity-knife-price").val(),
    e.sourPrice = $("#input-cal-activity-sour-price").val(),
    e.sweetPrice = $("#input-cal-activity-sweet-price").val(),
    e.bitterPrice = $("#input-cal-activity-bitter-price").val(),
    e.spicyPrice = $("#input-cal-activity-spicy-price").val(),
    e.saltyPrice = $("#input-cal-activity-salty-price").val(),
    e.tastyPrice = $("#input-cal-activity-tasty-price").val(),
    e.vegetablePrice = $("#input-cal-activity-vegetable-price").val(),
    e.creationPrice = $("#input-cal-activity-creation-price").val(),
    e.fishPrice = $("#input-cal-activity-fish-price").val(),
    e.meatPrice = $("#input-cal-activity-meat-price").val(),
    e.goldPrice = $("#input-cal-activity-gold-price").val(),
    e.stirfry = $("#input-cal-activity-stirfry").val(),
    e.bake = $("#input-cal-activity-bake").val(),
    e.steam = $("#input-cal-activity-steam").val(),
    e.boil = $("#input-cal-activity-boil").val(),
    e.fry = $("#input-cal-activity-fry").val(),
    e.knife = $("#input-cal-activity-knife").val(),
    e.limit1 = $("#input-cal-activity-1-limit").val(),
    e.limit2 = $("#input-cal-activity-2-limit").val(),
    e.limit3 = $("#input-cal-activity-3-limit").val(),
    e.limit4 = $("#input-cal-activity-4-limit").val(),
    e.limit5 = $("#input-cal-activity-5-limit").val(),
    e
}
function updateActivity(e) {
    e && ($("#input-cal-activity-stirfry-price").val(e.stirfryPrice),
    $("#input-cal-activity-bake-price").val(e.bakePrice),
    $("#input-cal-activity-steam-price").val(e.steamPrice),
    $("#input-cal-activity-boil-price").val(e.boilPrice),
    $("#input-cal-activity-fry-price").val(e.fryPrice),
    $("#input-cal-activity-knife-price").val(e.knifePrice),
    $("#input-cal-activity-sour-price").val(e.sourPrice),
    $("#input-cal-activity-sweet-price").val(e.sweetPrice),
    $("#input-cal-activity-bitter-price").val(e.bitterPrice),
    $("#input-cal-activity-spicy-price").val(e.spicyPrice),
    $("#input-cal-activity-salty-price").val(e.saltyPrice),
    $("#input-cal-activity-tasty-price").val(e.tastyPrice),
    $("#input-cal-activity-vegetable-price").val(e.vegetablePrice),
    $("#input-cal-activity-creation-price").val(e.creationPrice),
    $("#input-cal-activity-fish-price").val(e.fishPrice),
    $("#input-cal-activity-meat-price").val(e.meatPrice),
    $("#input-cal-activity-gold-price").val(e.goldPrice),
    $("#input-cal-activity-stirfry").val(e.stirfry),
    $("#input-cal-activity-bake").val(e.bake),
    $("#input-cal-activity-steam").val(e.steam),
    $("#input-cal-activity-boil").val(e.boil),
    $("#input-cal-activity-fry").val(e.fry),
    $("#input-cal-activity-knife").val(e.knife),
    $("#input-cal-activity-1-limit").val(e.limit1),
    $("#input-cal-activity-2-limit").val(e.limit2),
    $("#input-cal-activity-3-limit").val(e.limit3),
    $("#input-cal-activity-4-limit").val(e.limit4),
    $("#input-cal-activity-5-limit").val(e.limit5))
}
function initCalTables(e, a) {
    calCustomRule = {},
    calCustomRule.id = 0,
    calCustomRule.score = 0,
    calCustomRule.rules = [],
    setCalPartialUltimateOptions(e.chefs),  // 使用计算器专用的函数
    setSelfUltimateOptions(e.chefs),
    setExOptions(e.recipes),
    initCalRecipesTable(),
    initCalCustomTable(e),
    fetchNetworkRules(e, a),
    fetchHistoryRules(),
    private ? ($(".pane-cal").addClass("admin"),
    initCalChefsTable(e),
    initCalEquipsTable(e),
    initCalMaterialsTable(e),
    $("#input-cal-thread").val(navigator.hardwareConcurrency)) : $(".admin-only").remove();
    
    // 初始化贵客率计算器交互（gust.calcculator.js）
    if (typeof GuestRateCalculator !== 'undefined' && GuestRateCalculator.init) {
        GuestRateCalculator.init();
    }
}
function showCalSubPane() {
    $(".pane-cal-sub").addClass("hidden");
    var e = $("input[name='rad-cal-pane-options']:checked");
    ".pane-cal-recipes" == e.attr("data-pane") && "false" == $("#pane-cal-recipes").attr("data-cal") && ($("#pane-cal-recipes").attr("data-cal", "true"),
    calRecipesResults()),
    $(e.attr("data-pane")).removeClass("hidden"),
    ".pane-cal-rules" == e.attr("data-pane") && resizeCalCustomTable(),
    isMobile ? ($(".dataTables_scrollBody:visible table.dataTable").DataTable().draw(!1),
    "true" != $(e).attr("data-init") && ($(e).attr("data-init", "true"),
    updateScrollHeight())) : reInitFixedHeader()
}
function fetchNetworkRules(e, a) {
    $.ajax({
        url: "https://i.baochaojianghu.com/api/get_rule",
        dataType: "json",
        method: "GET",
        cache: true,
        beforeSend: function(xhr, settings) {
            settings.url = settings.url.split('?')[0];
        },
        success: function(t) {
            if (t && t.rules && t.rules.length > 0) {
                var i = [];
                for (var l in t.rules) {
                    var s = t.rules[l];
                    if (s.Id && s.Title) {
                        var c = {};
                        c.Id = s.Id;
                        c.Title = s.Title;
                        c.StartTime = s.start_time ? new Date(s.start_time).getTime() / 1e3 : null;
                        c.EndTime = s.end_time ? new Date(s.end_time).getTime() / 1e3 : null;
                        c.message = s.message || "";
                        c.DisableDecorationEffect = s.DisableDecorationEffect || 0;
                        c.DisableMultiCookbook = s.DisableMultiCookbook || 0;
                        c.PassLine = s.PassLine || [];
                        c.RecipeEffect = s.RecipeEffect || {};https://i.baochaojianghu.com/api/get_rule

                        c.MaterialsLimit = s.MaterialsLimit || null;
                        c.ChefTagEffect = s.ChefTagEffect || {};
                        c.Hide = !1;
                        c.isNetworkRule = !0;
                        i.push(c)
                    }
                }
                if (i.length > 0) {
                    for (var l = i.length - 1; l >= 0; l--)
                        e.rules.unshift(i[l]);
                    var r = $("#select-cal-rule optgroup[label='限时及厨神']");
                    if (!r.length) {
                        // 在"正常营业" optgroup 之后插入"限时及厨神"
                        var normalGroup = $("#select-cal-rule optgroup[label='正常营业']");
                        if (normalGroup.length) {
                            normalGroup.after("<optgroup label='限时及厨神'></optgroup>");
                        } else {
                            $("#select-cal-rule").prepend("<optgroup label='限时及厨神'></optgroup>");
                        }
                    }
                }
            }
            initCalRulesLocal(e, a)
        },
        error: function() {
            initCalRulesLocal(e, a)
        }
    })
}
var originalRules = null;
var historyRulesData = null;
var currentHistoryRulesDetail = null;
function loadHistoryRules(e) {
    if (historyRulesData && historyRulesData.length > 0) {
        originalRules = $("#select-cal-rule").html();
        $("#select-cal-rule").empty();
        
        // 创建两个分组
        var chefCompetitionGroup = $("<optgroup label='历史规则 - 厨神大赛'></optgroup>");
        var limitedEventGroup = $("<optgroup label='历史规则 - 限时活动'></optgroup>");
        
        for (var i = 0; i < historyRulesData.length; i++) {
            var option = $("<option></option>")
                .attr("value", "history_" + i)
                .text(historyRulesData[i].tag)
                .data("historyData", historyRulesData[i]);
            
            // 根据名称判断归类
            if (historyRulesData[i].tag.indexOf("大赛") >= 0) {
                chefCompetitionGroup.append(option);
            } else {
                limitedEventGroup.append(option);
            }
        }
        
        // 只添加有内容的分组
        if (chefCompetitionGroup.children().length > 0) {
            $("#select-cal-rule").append(chefCompetitionGroup);
        }
        if (limitedEventGroup.children().length > 0) {
            $("#select-cal-rule").append(limitedEventGroup);
        }
        
        $("#select-cal-rule").selectpicker("refresh");
        $("#btn-cal-history").text("返回当前").removeClass("btn-info").addClass("btn-info");
        
        // 自动选择第一个厨神大赛规则
        if (chefCompetitionGroup.children().length > 0) {
            // 找到第一个厨神大赛规则的索引
            var firstChefCompetitionOption = chefCompetitionGroup.children().first();
            var firstChefCompetitionValue = firstChefCompetitionOption.attr("value");
            var firstChefCompetitionData = firstChefCompetitionOption.data("historyData");
            
            // 选择第一个厨神大赛规则
            $("#select-cal-rule").val(firstChefCompetitionValue).selectpicker("refresh");
            
            // 触发 change 事件，显示详细规则选择框
            $("#select-cal-rule").trigger("change");
            
            // 加载详细规则列表
            if (firstChefCompetitionData && firstChefCompetitionData.start_time) {
                fetchHistoryRuleDetail(e, firstChefCompetitionData.start_time, null);
            }
        } else if (historyRulesData.length > 0) {
            // 如果没有厨神大赛规则，则选择第一个历史规则
            $("#select-cal-rule").val("history_0").selectpicker("refresh");
            $("#select-cal-rule").trigger("change");
            
            var firstStartTime = historyRulesData[0].start_time;
            fetchHistoryRuleDetail(e, firstStartTime, null);
        }
    } else {
        alert("历史规则数据未加载");
    }
}
function restoreCurrentRules(e) {
    if (originalRules) {
        $("#select-cal-rule").html(originalRules);
        $("#select-cal-rule").selectpicker("refresh");
        $("#btn-cal-history").text("历史计算器").removeClass("btn-info").addClass("btn-info");
        $("#history-sub-rule-wrapper").hide();
        $("#select-history-sub-rule").empty().selectpicker("refresh");
        currentHistoryRulesDetail = null;
        originalRules = null;
    }
}
function fetchHistoryRules() {
    $.ajax({
        url: "https://i.baochaojianghu.com/api/get_etc_rule",
        dataType: "json",
        method: "GET",
        cache: true,
        beforeSend: function(xhr, settings) {
            settings.url = settings.url.split('?')[0];
        },
        success: function(t) {
            if (t && t.length > 0) {
                historyRulesData = t;
            }
        },
        error: function() {
            console.log("加载历史规则失败");
        }
    })
}
function fetchHistoryRuleDetail(e, startTime, callback) {
    var isoTime = new Date(startTime).toISOString();
    
    $.ajax({
        url: "https://i.baochaojianghu.com/api/get_rule",
        dataType: "json",
        method: "GET",
        data: {
            time: isoTime
        },
        success: function(t) {
            if (t && t.rules && t.rules.length > 0) {
                currentHistoryRulesDetail = t.rules;
                
                if (t.rules.length > 1) {
                    $("#select-history-sub-rule").empty();
                    for (var i = 0; i < t.rules.length; i++) {
                        var option = $("<option></option>")
                            .attr("value", i)
                            .text(t.rules[i].Title || ("规则 " + (i + 1)));
                        $("#select-history-sub-rule").append(option);
                    }
                    $("#select-history-sub-rule").selectpicker("destroy").selectpicker();
                    $("#history-sub-rule-wrapper").show();
                    
                    // 自动选择第一个详细规则（但不加载）
                    $("#select-history-sub-rule").val("0").selectpicker("refresh");
                } else {
                    $("#history-sub-rule-wrapper").hide();
                }
                
                // 只在有 callback 时才加载规则内容
                if (callback) {
                    callback(t.rules[0]);
                }
            }
        },
        error: function() {
            alert("加载历史规则详情失败");
        }
    });
}
function loadHistoricalCalRule(e, historicalRule) {
    var tempRule = {
        Id: "history_temp",
        Title: historicalRule.Title || "历史规则",
        StartTime: historicalRule.start_time ? new Date(historicalRule.start_time).getTime() / 1e3 : null,
        EndTime: historicalRule.end_time ? new Date(historicalRule.end_time).getTime() / 1e3 : null,
        message: historicalRule.message || "",
        DisableDecorationEffect: historicalRule.DisableDecorationEffect || 0,
        DisableMultiCookbook: historicalRule.DisableMultiCookbook || 0,
        PassLine: historicalRule.PassLine || [],
        RecipeEffect: historicalRule.RecipeEffect || {},
        MaterialsLimit: historicalRule.MaterialsLimit || null,
        ChefTagEffect: historicalRule.ChefTagEffect || {},
        Hide: false,
        isNetworkRule: true,
        Satiety: historicalRule.Satiety,
        IntentList: historicalRule.IntentList,
        SatisfyRewardType: historicalRule.SatisfyRewardType,
        SatisfyExtraValue: historicalRule.SatisfyExtraValue,
        GlobalBuffList: historicalRule.GlobalBuffList,
        IsActivity: historicalRule.IsActivity,
        Group: historicalRule.Group
    };
    
    // 临时添加到规则列表
    var ruleExists = false;
    for (var i in e.rules) {
        if (e.rules[i].Id == "history_temp") {
            e.rules[i] = tempRule;
            ruleExists = true;
            break;
        }
    }
    if (!ruleExists) {
        e.rules.unshift(tempRule);
    }
    
    // 设置选中的规则ID并加载
    calCustomRule.rules = [];
    calCustomRule.id = "history_temp";
    calCustomRule.rules.push(tempRule);
    
    // 执行原有的加载逻辑（从loadCalRule复制）
    $("#input-cal-decoration").prop("disabled", !0);
    $("#cal-activity").hide();
    $(".btn-resize").hide();
    $(".cal-custom-item").hide();
    $(".cal-custom-item .selected-item").hide();
    
    for (var s = 0; s < calCustomRule.rules.length; s++) {
        var c = calCustomRule.rules[s];
        $(".cal-custom-item:eq(" + s + ")").show();
        var r = $(".cal-custom-item:eq(" + s + ") .btn-resize");
        r.hasClass("glyphicon-resize-full") && r.click();
        calCustomRule.rules.length > 1 && r.show();
        c.DisableDecorationEffect || $("#input-cal-decoration").prop("disabled", !1);
        c.IsActivity && $("#cal-activity").show();
        
        var n = "";
        if (c.Satiety) {
            for (var t = 0; t < c.IntentList.length; t++) {
                n += "<div class='item'>第" + (t + 1) + "轮:";
                for (var l in c.IntentList[t]) {
                    for (var o in e.intents) {
                        if (c.IntentList[t][l] == e.intents[o].intentId) {
                            n += "<span class='intent-" + t + l + " label label-default'>" + e.intents[o].desc + "</span>";
                            break;
                        }
                    }
                }
                n += "</div>";
                $(".cal-custom-item:eq(" + s + ") .selected-item:eq(" + t + ")").show();
            }
            
            if (1 == c.SatisfyRewardType) {
                n += "<div class='item'>";
                if (c.GlobalBuffList) {
                    for (var l in c.GlobalBuffList) {
                        for (var o in e.buffs) {
                            if (c.GlobalBuffList[l] == e.buffs[o].buffId) {
                                n += "<span class='label label-info'>" + e.buffs[o].desc + "</span>";
                                break;
                            }
                        }
                    }
                }
                n += "<span class='intent-satiety label label-default'>饱腹感达到" + c.Satiety + "时总售价+" + c.SatisfyExtraValue + "%</span></div>";
            }
            $("#pane-cal-custom").addClass("banquet");
            $("#btn-cal-import-run").show();
        } else {
            $("#pane-cal-custom").removeClass("banquet");
            $(".cal-custom-item:eq(" + s + ") .selected-item:nth-child(-n+3)").show();
            $("#btn-cal-import-run").hide();
        }
        $(".rule-desc:eq(" + s + ")").html(n);
    }
    
    $(".cal-custom-item .selected-item .recipe-box .recipe-condiment input").prop("checked", !0);
    calCustomRule.rules.length > 1 ? $(".pane-cal-recipes").hide() : $(".pane-cal-recipes").show();
    
    // 加载本地数据
    var p = getLocalData();
    var d = "";
    for (var t in p.cal) {
        if (p.cal[t].id == calCustomRule.id) {
            for (var i in p.cal[t].data) {
                d += "<option value='" + p.cal[t].data[i].score + "'>" + p.cal[t].data[i].score + "</option>";
            }
            calCustomRule.rules[0].IsActivity && updateActivity(p.cal[t].activity);
            break;
        }
    }
    $("#select-cal-custom").html(d).selectpicker("destroy").selectpicker();
    $("#input-import-run").val("");
    $("#btn-cal-rule-load").prop("disabled", !0);
    $(".loading").removeClass("hidden");
    
    setTimeout(function() {
        loadRule(e, calCustomRule);
        setCalConfigData(e);
        $("#pane-cal-recipes").attr("data-cal", "false");
        $(".loading").addClass("hidden");
        $(".cal-menu").removeClass("hidden");
        showCalSubPane();
        $("#btn-cal-rule-load").prop("disabled", !1).removeClass("btn-danger");
        initMaterialsLimit(e);
    }, 0);
}
function initCalRulesLocal(e, a) {
    for (var t in e.rules)
        if (!e.rules[t].Hide && e.rules[t].Id) {
            var i = e.rules[t].StartTime
              , l = e.rules[t].EndTime
              , s = (new Date).getTime() / 1e3;
            if (!(i && s < i || l && s > l)) {
                var c = e.rules[t].Title
                  , r = "<option value='" + e.rules[t].Id + "'>" + c + "</option>"
                  , n = !1;
                if (e.rules[t].isNetworkRule) {
                    var o = $("#select-cal-rule optgroup[label='限时及厨神']");
                    if (!o.length) {
                        // 在"正常营业" optgroup 之后插入"限时及厨神"
                        var normalGroup = $("#select-cal-rule optgroup[label='正常营业']");
                        if (normalGroup.length) {
                            normalGroup.after("<optgroup label='限时及厨神'></optgroup>");
                        } else {
                            $("#select-cal-rule").prepend("<optgroup label='限时及厨神'></optgroup>");
                        }
                        o = $("#select-cal-rule optgroup[label='限时及厨神']");
                    }
                    var p = $("#select-cal-rule option[value='" + e.rules[t].Id + "']");
                    p.length || (o.append(r),
                    n = !0)
                } else {
                    $("#select-cal-rule optgroup").each(function() {
                        var u = $(this).attr("label");
                        if ("限时及厨神" != u && c.indexOf(u) >= 0) {
                            var p = $("#select-cal-rule option[value='" + e.rules[t].Id + "']");
                            p.length || ($(this).append(r),
                            n = !0)
                        }
                    })
                }
                n || (l ? $("#select-cal-rule").prepend(r) : $("#select-cal-rule").append(r))
            }
        }
    // 为计算器规则选择框添加 optgroup 折叠功能
    $("#select-cal-rule").on("shown.bs.select", function() {
        var $dropdown = $(this).parent().find(".dropdown-menu");
        
        // 为每个 optgroup 标签添加折叠功能
        $dropdown.find(".dropdown-header").each(function() {
            var $header = $(this);
            
            // 如果还没有添加折叠图标，则添加
            if (!$header.find(".collapse-icon").length) {
                // 添加可折叠类
                $header.addClass("collapsible");
                
                // 使用 Bootstrap 的 caret 样式
                var icon = $("<span class='collapse-icon caret'></span>");
                $header.append(icon);
                
                // 获取分组名称
                var groupLabel = $header.text().trim();
                
                // 判断是否为默认展开的分组
                var shouldExpand = (groupLabel === "正常营业" || groupLabel === "限时及厨神" || 
                                   groupLabel.indexOf("历史规则") >= 0);
                
                // 设置初始状态
                if (shouldExpand) {
                    // 默认展开
                    $header.data("collapsed", false);
                } else {
                    // 默认收起
                    $header.data("collapsed", true);
                    icon.css("transform", "translateY(-50%) rotate(-90deg)");
                    // 隐藏该分组下的所有选项
                    $header.nextUntil(".dropdown-header", "li").hide();
                }
            }
            
            // 点击标题切换折叠状态
            $header.off("click").on("click", function(e) {
                e.stopPropagation();
                e.preventDefault();
                
                var $this = $(this);
                var isCollapsed = $this.data("collapsed");
                var $icon = $this.find(".collapse-icon");
                
                // 找到该 optgroup 下的所有选项
                var $options = $this.nextUntil(".dropdown-header", "li");
                
                if (isCollapsed) {
                    // 展开
                    $options.slideDown(200);
                    $icon.css("transform", "translateY(-50%) rotate(0deg)");
                    $this.data("collapsed", false);
                } else {
                    // 收起
                    $options.slideUp(200);
                    $icon.css("transform", "translateY(-50%) rotate(-90deg)");
                    $this.data("collapsed", true);
                }
            });
        });
    });
    $("#select-cal-rule").selectpicker().change(function() {
        $("#btn-cal-rule-load").addClass("btn-danger");
        
        // 检查是否选择了历史规则
        var selectedValue = $(this).val();
        if (selectedValue && selectedValue.toString().startsWith("history_")) {
            var historyIndex = parseInt(selectedValue.replace("history_", ""));
            if (historyRulesData && historyRulesData[historyIndex]) {
                var startTime = historyRulesData[historyIndex].start_time;
                fetchHistoryRuleDetail(e, startTime);
            }
        } else {
            // 非历史规则，隐藏子规则下拉框
            $("#history-sub-rule-wrapper").hide();
            currentHistoryRulesDetail = null;
        }
    });
    $("#select-history-sub-rule").selectpicker().change(function() {
        $("#btn-cal-rule-load").addClass("btn-danger");
    }),
    $("#input-cal-decoration").val(e.decorationEffect || ""),
    loadUltimate(e, !0),
    $("#btn-cal-rule-load").click(function() {
        $(this).hasClass("btn-danger") ? loadCalRule(e) : bootbox.confirm({
            size: "small",
            message: "<div class='text-center'>确定重新加载?</div>",
            locale: "zh_CN",
            callback: function(a) {
                a && loadCalRule(e)
            }
        })
    }),
    $("#btn-cal-history").click(function() {
        var btn = $(this);
        if (btn.text().trim() === "历史计算器") {
            loadHistoryRules(e);
        } else {
            restoreCurrentRules(e);
        }
    }),
    $("input[name='rad-cal-pane-options']").change(function() {
        showCalSubPane()
    }),
    $("#input-cal-decoration").on("input", function() {
        updateDecorationLocalData(),
        setCalConfigData(e),
        calCustomResults(e),
        $("#pane-cal-recipes").attr("data-cal", "false")
    }),
    $(".cal-settings input").on("input", function() {
        setCalConfigData(e),
        calCustomResults(e),
        $("#pane-cal-recipes").attr("data-cal", "false")
    }),
    $("#chk-cal-partial-ultimate").selectpicker().on("changed.bs.select", function() {
        setCalConfigData(e),
        calCustomResults(e)
    }),
    $("#chk-cal-self-ultimate").selectpicker().on("changed.bs.select", function() {
        setCalConfigData(e),
        calCustomResults(e)
    }),
    $("#chk-cal-ex").selectpicker().on("changed.bs.select", function() {
        setCalConfigData(e),
        calCustomResults(e),
        $("#pane-cal-recipes").attr("data-cal", "false")
    }),
    $("#btn-cal-load-ultimate").click(function() {
        $("#cal-ultimate input").val(""),
        loadUltimate(e, !0),
        setCalConfigData(e),
        calCustomResults(e),
        $("#pane-cal-recipes").attr("data-cal", "false")
    }),
    $("#btn-cal-load-all-ultimate").click(function() {
        $("#cal-ultimate input").val(""),
        loadUltimate(e, !1),
        setCalConfigData(e),
        calCustomResults(e),
        $("#pane-cal-recipes").attr("data-cal", "false")
    }),
    $("#btn-cal-clear-ultimate").click(function() {
        $("#cal-ultimate input").val(""),
        $("#chk-cal-partial-ultimate").selectpicker("deselectAll").selectpicker("refresh"),
        $("#chk-cal-self-ultimate").selectpicker("deselectAll").selectpicker("refresh"),
        $("#chk-cal-ex").selectpicker("deselectAll").selectpicker("refresh"),
        setCalConfigData(e),
        calCustomResults(e),
        $("#pane-cal-recipes").attr("data-cal", "false")
    }),
    $("#cal-activity input").on("input", function() {
        updateActivityLocalData()
    }),
    $("#btn-cal-clear-activity").click(function() {
        $("#cal-activity input").val(""),
        updateActivityLocalData(),
        setCalConfigData(e),
        calCustomResults(e),
        $("#pane-cal-recipes").attr("data-cal", "false")
    }),
    $("#select-cal-order").change(function() {
        sortRecipesResult()
    }),
    $("#chk-cal-dd-show").on("changed.bs.select", function() {
        updateMenuLocalData()
    }),
    $("#chk-cal-ui-show").on("changed.bs.select", function() {
        initCalCustomShow(),
        updateMenuLocalData()
    }),
    $("#btn-cal-clear-custom").click(function() {
        initCustomData(),
        calCustomResults(e);
        var a = calCustomRule.rules[0];
        a.hasOwnProperty("MaterialsNum") && $("#pane-cal-recipes").attr("data-cal", "false")
    }),
    $("#btn-cal-reset-custom").click(function() {
        $("#chk-cal-got").prop("checked", !1),
        $("#chk-cal-ultimated").prop("checked", !1).prop("disabled", !0),
        $("#label-cal-ultimated").hide(),
        $("#chk-cal-recipe-rarity").selectpicker("deselectAll"),
        $("#chk-cal-recipe-skill").selectpicker("deselectAll"),
        $("#chk-cal-recipe-multiple-skill").prop("checked", !1),
        $("#chk-cal-recipe-condiment").selectpicker("deselectAll"),
        checkMonitorStyle(),
        $("#cal-recipes-table").DataTable().draw()
    }),
    $("#chk-cal-got").change(function() {
        var isChecked = $(this).prop("checked");
        if (isChecked) {
            $("#chk-cal-ultimated").prop("disabled", !1);
            $("#label-cal-ultimated").show();
        } else {
            $("#chk-cal-ultimated").prop("checked", !1).prop("disabled", !0);
            $("#label-cal-ultimated").hide();
            changeCheckStyle($("#chk-cal-ultimated")[0]);
        }
    }),
    $("#btn-cal-custom-load").click(function() {
        var a = $("#select-cal-custom").val();
        if (a) {
            var t = getLocalData();
            for (var i in t.cal)
                if (t.cal[i].id == calCustomRule.id) {
                    for (var l in t.cal[i].data)
                        if (t.cal[i].data[l].score == a) {
                            var s = t.cal[i].data[l].menu;
                            for (var c in s)
                                for (var r in s[c]) {
                                    var n = s[c][r];
                                    if (setCustomChef(c, r, n.chef),
                                    n.chef && n.dlv)
                                        for (var o in setCustomDiskLevel(c, r, n.dlv),
                                        n.ambers)
                                            setCustomAmber(c, r, o, n.ambers[o]);
                                    for (var p in setCustomEquip(c, r, n.equip),
                                    setCustomCondiment(c, r, n.condiment, e),
                                    n.recipes) {
                                        var d = n.recipes[p];
                                        setCustomRecipe(c, r, p, d.id),
                                        setCustomRecipeQuantity(c, r, p, d.qty),
                                        updateCustomRecipeCondiment(c, r, p, d.cdt)
                                    }
                                }
                            break
                        }
                    break
                }
            calCustomResults(e),
            calCustomRule.rules[0].hasOwnProperty("MaterialsNum") && $("#pane-cal-recipes").attr("data-cal", "false")
        }
    }),
    $("#btn-cal-custom-delete").click(function() {
        var e = $("#select-cal-custom").val();
        e && bootbox.confirm({
            size: "small",
            message: "<div class='text-center'>确定删除?</div>",
            locale: "zh_CN",
            callback: function(a) {
                if (a) {
                    var t = getLocalData();
                    for (var i in t.cal)
                        if (t.cal[i].id == calCustomRule.id) {
                            for (var l in t.cal[i].data)
                                if (t.cal[i].data[l].score == e) {
                                    t.cal[i].data.splice(l, 1),
                                    $("#select-cal-custom option[value='" + e + "']").remove(),
                                    $("#select-cal-custom").selectpicker("destroy").selectpicker();
                                    break
                                }
                            break
                        }
                    updateCalLocalData(t.cal)
                }
            }
        })
    }),
    $("#btn-cal-custom-save").click(function() {
        if (calCustomRule.score) {
            var e = getLocalData();
            e.cal || (e.cal = []);
            var a = {};
            for (var t in a.score = calCustomRule.score,
            a.menu = [],
            calCustomRule.rules) {
                var i = []
                  , l = calCustomRule.rules[t].custom;
                for (var s in l) {
                    var c = {};
                    if (c.chef = l[s].chef.chefId,
                    l[s].chef.chefId)
                        for (var r in c.dlv = l[s].chef.disk.level,
                        c.ambers = [],
                        l[s].chef.disk.ambers) {
                            var n = 0;
                            l[s].chef.disk.ambers[r].data && (n = l[s].chef.disk.ambers[r].data.amberId),
                            c.ambers.push(n)
                        }
                    for (var r in c.equip = l[s].equip.equipId,
                    c.condiment = l[s].condiment.condimentId,
                    c.recipes = [],
                    l[s].recipes) {
                        n = {};
                        l[s].recipes[r].data && (n.id = l[s].recipes[r].data.recipeId,
                        n.qty = l[s].recipes[r].quantity,
                        n.cdt = l[s].recipes[r].useCondiment),
                        c.recipes.push(n)
                    }
                    i.push(c)
                }
                a.menu.push(i)
            }
            var o = !1
              , p = !1;
            for (var s in e.cal)
                if (e.cal[s].id == calCustomRule.id) {
                    var d = !1;
                    for (var r in e.cal[s].data)
                        if (e.cal[s].data[r].score == a.score) {
                            e.cal[s].data[r].menu = a.menu,
                            d = !0;
                            break
                        }
                    d || (e.cal[s].data.push(a),
                    o = !0),
                    p = !0;
                    break
                }
            if (!p) {
                var u = {};
                u.id = calCustomRule.id,
                u.data = [],
                u.data.push(a),
                e.cal.push(u),
                o = !0
            }
            if (o) {
                var f = "<option value='" + a.score + "'>" + a.score + "</option>";
                $("#select-cal-custom").append(f).selectpicker("destroy").selectpicker("val", a.score)
            }
            updateCalLocalData(e.cal)
        }
    }),
    $("#btn-cal-import-run").click(function() {
        $("#import-run-modal").modal(),
        $("#menu-modal").modal("hide")
    }),
    $("#btn-import-run").click(function() {
        importRunResult(e)
    }),
    $("#chk-cal-lock").click(function() {
        $(this).prop("checked") ? $(".selected-item").addClass("lock") : $(".selected-item").removeClass("lock")
    }),
    isMobile && $("#chk-cal-lock").closest(".btn").addClass("hidden");
    if (!a || !a.menu || !a.menu.calmui) {
        var o = [];
        o.push("chef_icon"),
        o.push("amber"),
        o.push("amber_icon"),
        o.push("amber_skill"),
        o.push("equip_icon"),
        o.push("equip_skill"),
        o.push("condiment"),
        o.push("condiment_icon"),
        o.push("condiment_skill"),
        o.push("recipe_icon"),
        $("#chk-cal-ui-show").selectpicker("val", o)
    }
    initCalCustomShow()
}
function loadCalRule(e) {
    var selectedValue = $("#select-cal-rule").val();
    
    // 检查是否选择了贵客率计算
    if (selectedValue === 'guest-rate') {
        // 贵客率计算使用与正常营业相同的逻辑，只是 ID 设置为特殊值
        selectedValue = 0; // 使用正常营业的规则
        calCustomRule.isGuestRate = true; // 标记为贵客率计算模式
    } else {
        calCustomRule.isGuestRate = false;
    }
    
    // 检查是否选择了历史规则
    if (selectedValue && selectedValue.toString().startsWith("history_")) {
        var historyIndex = parseInt(selectedValue.replace("history_", ""));
        if (historyRulesData && historyRulesData[historyIndex]) {
            var startTime = historyRulesData[historyIndex].start_time;
            
            // 如果已经加载过详情，直接使用
            if (currentHistoryRulesDetail && currentHistoryRulesDetail.length > 0) {
                var subRuleIndex = parseInt($("#select-history-sub-rule").val() || 0);
                loadHistoricalCalRule(e, currentHistoryRulesDetail[subRuleIndex]);
            } else {
                // 否则先加载详情
                fetchHistoryRuleDetail(e, startTime, function(firstRule) {
                    loadHistoricalCalRule(e, firstRule);
                });
            }
            return;
        }
    }
    
    // 原有的加载逻辑
    var a = Math.floor(selectedValue);
    for (var t in calCustomRule.rules = [],
    e.rules)
        if (e.rules[t].Id == a) {
            if (calCustomRule.id = a,
            e.rules[t].Group) {
                for (var i in e.rules[t].Group)
                    for (var l in e.rules)
                        if (e.rules[l].Id == e.rules[t].Group[i]) {
                            calCustomRule.rules.push(e.rules[l]);
                            break
                        }
            } else
                calCustomRule.rules.push(e.rules[t]);
            break
        }
    $("#input-cal-decoration").prop("disabled", !0),
    $("#cal-activity").hide(),
    $(".btn-resize").hide(),
    $(".cal-custom-item").hide(),
    $(".cal-custom-item .selected-item").hide();
    
    // 显示或隐藏贵客率计算结果区域
    if (calCustomRule.isGuestRate) {
        $("#guest-rate-result").removeClass("hidden");
        $("#pane-cal-custom").addClass("guest-rate-mode");
    } else {
        $("#guest-rate-result").addClass("hidden");
        $("#pane-cal-custom").removeClass("guest-rate-mode");
    }
    
    for (var s = 0; s < calCustomRule.rules.length; s++) {
        var c = calCustomRule.rules[s];
        $(".cal-custom-item:eq(" + s + ")").show();
        var r = $(".cal-custom-item:eq(" + s + ") .btn-resize");
        r.hasClass("glyphicon-resize-full") && r.click(),
        calCustomRule.rules.length > 1 && r.show(),
        c.DisableDecorationEffect || $("#input-cal-decoration").prop("disabled", !1),
        c.IsActivity && $("#cal-activity").show();
        var n = "";
        if (c.Satiety) {
            for (t = 0; t < c.IntentList.length; t++) {
                for (var l in n += "<div class='item'>第" + (t + 1) + "轮:",
                c.IntentList[t])
                    for (var o in e.intents)
                        if (c.IntentList[t][l] == e.intents[o].intentId) {
                            n += "<span class='intent-" + t + l + " label label-default'>" + e.intents[o].desc + "</span>";
                            break
                        }
                n += "</div>",
                $(".cal-custom-item:eq(" + s + ") .selected-item:eq(" + t + ")").show()
            }
            if (1 == c.SatisfyRewardType) {
                if (n += "<div class='item'>",
                c.GlobalBuffList)
                    for (var l in c.GlobalBuffList)
                        for (var o in e.buffs)
                            if (c.GlobalBuffList[l] == e.buffs[o].buffId) {
                                n += "<span class='label label-info'>" + e.buffs[o].desc + "</span>";
                                break
                            }
                n += "<span class='intent-satiety label label-default'>饱腹感达到" + c.Satiety + "时总售价+" + c.SatisfyExtraValue + "%</span></div>"
            }
            $("#pane-cal-custom").addClass("banquet"),
            $("#btn-cal-import-run").show()
        } else
            $("#pane-cal-custom").removeClass("banquet"),
            $(".cal-custom-item:eq(" + s + ") .selected-item:nth-child(-n+3)").show(),
            $("#btn-cal-import-run").hide();
        $(".rule-desc:eq(" + s + ")").html(n)
    }
    $(".cal-custom-item .selected-item .recipe-box .recipe-condiment input").prop("checked", !0),
    calCustomRule.rules.length > 1 ? $(".pane-cal-recipes").hide() : $(".pane-cal-recipes").show();
    var p = getLocalData()
      , d = "";
    for (var t in p.cal)
        if (p.cal[t].id == calCustomRule.id) {
            for (var i in p.cal[t].data)
                d += "<option value='" + p.cal[t].data[i].score + "'>" + p.cal[t].data[i].score + "</option>";
            calCustomRule.rules[0].IsActivity && updateActivity(p.cal[t].activity);
            break
        }
    $("#select-cal-custom").html(d).selectpicker("destroy").selectpicker(),
    $("#input-import-run").val(""),
    $("#btn-cal-rule-load").prop("disabled", !0),
    $(".loading").removeClass("hidden"),
    setTimeout(function() {
        loadRule(e, calCustomRule),
        setCalConfigData(e),
        $("#pane-cal-recipes").attr("data-cal", "false"),
        $(".loading").addClass("hidden"),
        $(".cal-menu").removeClass("hidden"),
        showCalSubPane(),
        $("#btn-cal-rule-load").prop("disabled", !1).removeClass("btn-danger"),
        initMaterialsLimit(e)
    }, 0)
}
function initMaterialsLimit(e) {
    if (calCustomRule.rules[0] && calCustomRule.rules[0].MaterialsLimit) {
        var materialsLimit = calCustomRule.rules[0].MaterialsLimit;
        calCustomRule.materialsAll = {};
        if (typeof materialsLimit === 'object') {
            for (var materialId in materialsLimit) {
                calCustomRule.materialsAll[materialId] = materialsLimit[materialId];
            }
        } else if (typeof materialsLimit === 'number') {
            for (var m in e.materials) {
                calCustomRule.materialsAll[e.materials[m].materialId] = materialsLimit;
            }
        }
    } else {
        calCustomRule.materialsAll = null;
    }
}
function loadUltimate(e, a) {
    // 设置全修炼模式标记：a = true 表示"读取已修炼"，a = false 表示"读取全修炼"
    isAllUltimateMode = !a;
    
    var t = getLocalData()
      , i = getUltimateData(e.chefs, t, !0, a, e.skills)
      , l = i.global;
    for (var s in l) {
        if ("Stirfry" == l[s].type && !l[s].tag) {
            $("#input-cal-ultimate-stirfry").val(l[s].value);
        } else if ("Boil" == l[s].type && !l[s].tag) {
            $("#input-cal-ultimate-boil").val(l[s].value);
        } else if ("Knife" == l[s].type && !l[s].tag) {
            $("#input-cal-ultimate-knife").val(l[s].value);
        } else if ("Fry" == l[s].type && !l[s].tag) {
            $("#input-cal-ultimate-fry").val(l[s].value);
        } else if ("Bake" == l[s].type && !l[s].tag) {
            $("#input-cal-ultimate-bake").val(l[s].value);
        } else if ("Steam" == l[s].type && !l[s].tag) {
            $("#input-cal-ultimate-steam").val(l[s].value);
        } else if (1 == l[s].tag) {
            $("#input-cal-ultimate-male-skill").val(l[s].value);
        } else if (2 == l[s].tag) {
            $("#input-cal-ultimate-female-skill").val(l[s].value);
        } else if ("MaxEquipLimit" == l[s].type && 1 == l[s].rarity) {
            $("#input-cal-ultimate-1-limit").val(l[s].value);
        } else if ("MaxEquipLimit" == l[s].type && 2 == l[s].rarity) {
            $("#input-cal-ultimate-2-limit").val(l[s].value);
        } else if ("MaxEquipLimit" == l[s].type && 3 == l[s].rarity) {
            $("#input-cal-ultimate-3-limit").val(l[s].value);
        } else if ("MaxEquipLimit" == l[s].type && 4 == l[s].rarity) {
            $("#input-cal-ultimate-4-limit").val(l[s].value);
        } else if ("MaxEquipLimit" == l[s].type && 5 == l[s].rarity) {
            $("#input-cal-ultimate-5-limit").val(l[s].value);
        } else if ("UseAll" == l[s].type && 1 == l[s].rarity) {
            $("#input-cal-ultimate-1-price").val(l[s].value);
        } else if ("UseAll" == l[s].type && 2 == l[s].rarity) {
            $("#input-cal-ultimate-2-price").val(l[s].value);
        } else if ("UseAll" == l[s].type && 3 == l[s].rarity) {
            $("#input-cal-ultimate-3-price").val(l[s].value);
        } else if ("UseAll" == l[s].type && 4 == l[s].rarity) {
            $("#input-cal-ultimate-4-price").val(l[s].value);
        } else if ("UseAll" == l[s].type && 5 == l[s].rarity) {
            $("#input-cal-ultimate-5-price").val(l[s].value);
        } else if ("Material_Gain" != l[s].type &&
             "Material_Vegetable" != l[s].type && 
             "Material_Meat" != l[s].type && 
             "Material_Fish" != l[s].type && 
             "Material_Creation" != l[s].type && 
             "ExperienceTimeRate" != l[s].type && 
             "GoalOpeningTimeAdd" != l[s].type && 
             "TimeChickenSeconds" != l[s].type) {
            console.log(l[s].type);
        }
    }
    var c = i.partial
      , r = [];
    for (var s in c)
        r.push(c[s].chefId);
    $("#chk-cal-partial-ultimate").selectpicker("val", r);
    var n = i.self
      , o = [];
    for (var s in n)
        o.push(n[s].chefId);
    $("#chk-cal-self-ultimate").selectpicker("val", o);
    var p = [];
    for (var s in e.recipes)
        (a && "是" == e.recipes[s].ex || !a) && p.push(e.recipes[s].recipeId);
    $("#chk-cal-ex").selectpicker("val", p);
    // 保存ultimateData到e对象，以便计算器页面可以使用七侠技法加成
    e.ultimateData = i;
}
function setCalConfigData(e) {
    // 确保e.ultimateData已初始化，如果没有则重新计算
    // 计算器页面默认启用修炼加成（!0），并使用已修炼数据（从chk-cal-self-ultimate获取）
    if (!e.ultimateData) {
        var localData = getLocalData();
        var applyUltimate = !0; // 计算器页面默认启用修炼加成
        var applyUltimatePerson = $("#chk-cal-self-ultimate").val() && $("#chk-cal-self-ultimate").val().length > 0;
        e.ultimateData = getUltimateData(e.chefs, localData, applyUltimate, applyUltimatePerson, e.skills);
    }
    for (var a in calCustomRule.rules) {
        var t = calCustomRule.rules[a];
        t.decorationEffect = Number($("#input-cal-decoration").val());
        var i = []
          , l = Number($("#input-cal-ultimate-stirfry").val());
        if (l) {
            var s = {
                type: "Stirfry"
            };
            s.value = l,
            s.condition = "Global",
            s.cal = "Abs",
            i.push(s)
        }
        var c = Number($("#input-cal-ultimate-boil").val());
        if (c) {
            s = {
                type: "Boil"
            };
            s.value = c,
            s.condition = "Global",
            s.cal = "Abs",
            i.push(s)
        }
        var r = Number($("#input-cal-ultimate-knife").val());
        if (r) {
            s = {
                type: "Knife"
            };
            s.value = r,
            s.condition = "Global",
            s.cal = "Abs",
            i.push(s)
        }
        var n = Number($("#input-cal-ultimate-fry").val());
        if (n) {
            s = {
                type: "Fry"
            };
            s.value = n,
            s.condition = "Global",
            s.cal = "Abs",
            i.push(s)
        }
        var o = Number($("#input-cal-ultimate-bake").val());
        if (o) {
            s = {
                type: "Bake"
            };
            s.value = o,
            s.condition = "Global",
            s.cal = "Abs",
            i.push(s)
        }
        var p = Number($("#input-cal-ultimate-steam").val());
        if (p) {
            s = {
                type: "Steam"
            };
            s.value = p,
            s.condition = "Global",
            s.cal = "Abs",
            i.push(s)
        }
        var d = Number($("#input-cal-ultimate-male-skill").val());
        if (d) {
            var u = {
                type: "Stirfry"
            };
            u.value = d,
            u.condition = "Global",
            u.cal = "Abs",
            u.tag = 1,
            i.push(u);
            var f = {
                type: "Boil"
            };
            f.value = d,
            f.condition = "Global",
            f.cal = "Abs",
            f.tag = 1,
            i.push(f);
            var h = {
                type: "Knife"
            };
            h.value = d,
            h.condition = "Global",
            h.cal = "Abs",
            h.tag = 1,
            i.push(h);
            var m = {
                type: "Fry"
            };
            m.value = d,
            m.condition = "Global",
            m.cal = "Abs",
            m.tag = 1,
            i.push(m);
            var v = {
                type: "Bake"
            };
            v.value = d,
            v.condition = "Global",
            v.cal = "Abs",
            v.tag = 1,
            i.push(v);
            var b = {
                type: "Steam"
            };
            b.value = d,
            b.condition = "Global",
            b.cal = "Abs",
            b.tag = 1,
            i.push(b)
        }
        var g = Number($("#input-cal-ultimate-female-skill").val());
        if (g) {
            u = {
                type: "Stirfry"
            };
            u.value = g,
            u.condition = "Global",
            u.cal = "Abs",
            u.tag = 2,
            i.push(u);
            f = {
                type: "Boil"
            };
            f.value = g,
            f.condition = "Global",
            f.cal = "Abs",
            f.tag = 2,
            i.push(f);
            h = {
                type: "Knife"
            };
            h.value = g,
            h.condition = "Global",
            h.cal = "Abs",
            h.tag = 2,
            i.push(h);
            m = {
                type: "Fry"
            };
            m.value = g,
            m.condition = "Global",
            m.cal = "Abs",
            m.tag = 2,
            i.push(m);
            v = {
                type: "Bake"
            };
            v.value = g,
            v.condition = "Global",
            v.cal = "Abs",
            v.tag = 2,
            i.push(v);
            b = {
                type: "Steam"
            };
            b.value = g,
            b.condition = "Global",
            b.cal = "Abs",
            b.tag = 2,
            i.push(b)
        }
        var k = Number($("#input-cal-ultimate-1-limit").val());
        if (k) {
            s = {
                type: "MaxEquipLimit"
            };
            s.value = k,
            s.condition = "Global",
            s.cal = "Abs",
            s.rarity = 1,
            i.push(s)
        }
        var y = Number($("#input-cal-ultimate-2-limit").val());
        if (y) {
            s = {
                type: "MaxEquipLimit"
            };
            s.value = y,
            s.condition = "Global",
            s.cal = "Abs",
            s.rarity = 2,
            i.push(s)
        }
        var x = Number($("#input-cal-ultimate-3-limit").val());
        if (x) {
            s = {
                type: "MaxEquipLimit"
            };
            s.value = x,
            s.condition = "Global",
            s.cal = "Abs",
            s.rarity = 3,
            i.push(s)
        }
        var D = Number($("#input-cal-ultimate-4-limit").val());
        if (D) {
            s = {
                type: "MaxEquipLimit"
            };
            s.value = D,
            s.condition = "Global",
            s.cal = "Abs",
            s.rarity = 4,
            i.push(s)
        }
        var C = Number($("#input-cal-ultimate-5-limit").val());
        if (C) {
            s = {
                type: "MaxEquipLimit"
            };
            s.value = C,
            s.condition = "Global",
            s.cal = "Abs",
            s.rarity = 5,
            i.push(s)
        }
        var w = Number($("#input-cal-ultimate-1-price").val());
        if (w) {
            s = {
                type: "UseAll"
            };
            s.value = w,
            s.condition = "Global",
            s.cal = "Percent",
            s.rarity = 1,
            i.push(s)
        }
        var T = Number($("#input-cal-ultimate-2-price").val());
        if (T) {
            s = {
                type: "UseAll"
            };
            s.value = T,
            s.condition = "Global",
            s.cal = "Percent",
            s.rarity = 2,
            i.push(s)
        }
        var S = Number($("#input-cal-ultimate-3-price").val());
        if (S) {
            s = {
                type: "UseAll"
            };
            s.value = S,
            s.condition = "Global",
            s.cal = "Percent",
            s.rarity = 3,
            i.push(s)
        }
        var q = Number($("#input-cal-ultimate-4-price").val());
        if (q) {
            s = {
                type: "UseAll"
            };
            s.value = q,
            s.condition = "Global",
            s.cal = "Percent",
            s.rarity = 4,
            i.push(s)
        }
        var E = Number($("#input-cal-ultimate-5-price").val());
        if (E) {
            s = {
                type: "UseAll"
            };
            s.value = E,
            s.condition = "Global",
            s.cal = "Percent",
            s.rarity = 5,
            i.push(s)
        }
        var I = $("#chk-cal-partial-ultimate").val();
        for (var R in I)
            I[R] = Number(I[R]);
        var N = $("#chk-cal-self-ultimate").val();
        for (var R in N)
            N[R] = Number(N[R]);
        var A = getSelfUltimateData(e.chefs, !0, N)
          , M = getActivityConfigData(t)
          , Q = e.ultimateData && e.ultimateData.qixia ? e.ultimateData.qixia : null;
        t.calGlobalUltimateData = i,
        t.calPartialChefIds = I,
        t.calSelfUltimateData = A,
        t.calActivityUltimateData = M,
        t.calQixiaData = Q;
        var O = $("#chk-cal-ex").val();
        for (var R in O)
            O[R] = Number(O[R]);
        for (var R in t.menus) {
            var _ = O.indexOf(t.menus[R].recipe.data.recipeId) >= 0;
            setDataForRecipe(t.menus[R].recipe.data, i, _, M, !0, t);
            var G;
            if (t.MaterialsLimit && calCustomRule.materialsAll) {
                var materialMax = calculateMaterialLimit(calCustomRule.materialsAll, t.menus[R].recipe.data, null);
                var recipeMax = getRecipeQuantity(t.menus[R].recipe.data, t.materials, t, null);
                G = Math.min(materialMax, recipeMax);
                if (t.DisableMultiCookbook) {
                    G = Math.min(G, 1);
                }
            } else {
                G = getRecipeQuantity(t.menus[R].recipe.data, t.materials, t, null);
            }
            var P = getRecipeResult(null, null, t.menus[R].recipe.data, G, G, t.materials, t, t.decorationEffect, null, !1, buildRecipeMenu(t.menus[R].recipe.data), null, null);
            P.available = G,
            P.availableScore = Math.ceil(+(P.totalScore / P.max * G).toFixed(2)),
            t.menus[R].recipe = P
        }
        for (var R in t.chefs)
            setDataForChef(t.chefs[R], null, !1, i, null, A, M, !0, t, !0, e.ultimateData && e.ultimateData.qixia ? e.ultimateData.qixia : null)
    }
}
function getActivityConfigData(e) {
    var a = [];
    if (e.IsActivity) {
        var t = Number($("#input-cal-activity-stirfry").val());
        if (t) {
            var i = {
                type: "Stirfry"
            };
            i.value = t,
            i.condition = "Global",
            i.cal = "Abs",
            a.push(i)
        }
        var l = Number($("#input-cal-activity-boil").val());
        if (l) {
            i = {
                type: "Boil"
            };
            i.value = l,
            i.condition = "Global",
            i.cal = "Abs",
            a.push(i)
        }
        var s = Number($("#input-cal-activity-knife").val());
        if (s) {
            i = {
                type: "Knife"
            };
            i.value = s,
            i.condition = "Global",
            i.cal = "Abs",
            a.push(i)
        }
        var c = Number($("#input-cal-activity-fry").val());
        if (c) {
            i = {
                type: "Fry"
            };
            i.value = c,
            i.condition = "Global",
            i.cal = "Abs",
            a.push(i)
        }
        var r = Number($("#input-cal-activity-bake").val());
        if (r) {
            i = {
                type: "Bake"
            };
            i.value = r,
            i.condition = "Global",
            i.cal = "Abs",
            a.push(i)
        }
        var n = Number($("#input-cal-activity-steam").val());
        if (n) {
            i = {
                type: "Steam"
            };
            i.value = n,
            i.condition = "Global",
            i.cal = "Abs",
            a.push(i)
        }
        var o = Number($("#input-cal-activity-1-limit").val());
        if (o) {
            i = {
                type: "MaxEquipLimit"
            };
            i.value = o,
            i.condition = "Global",
            i.cal = "Abs",
            i.rarity = 1,
            a.push(i)
        }
        var p = Number($("#input-cal-activity-2-limit").val());
        if (p) {
            i = {
                type: "MaxEquipLimit"
            };
            i.value = p,
            i.condition = "Global",
            i.cal = "Abs",
            i.rarity = 2,
            a.push(i)
        }
        var d = Number($("#input-cal-activity-3-limit").val());
        if (d) {
            i = {
                type: "MaxEquipLimit"
            };
            i.value = d,
            i.condition = "Global",
            i.cal = "Abs",
            i.rarity = 3,
            a.push(i)
        }
        var u = Number($("#input-cal-activity-4-limit").val());
        if (u) {
            i = {
                type: "MaxEquipLimit"
            };
            i.value = u,
            i.condition = "Global",
            i.cal = "Abs",
            i.rarity = 4,
            a.push(i)
        }
        var f = Number($("#input-cal-activity-5-limit").val());
        if (f) {
            i = {
                type: "MaxEquipLimit"
            };
            i.value = f,
            i.condition = "Global",
            i.cal = "Abs",
            i.rarity = 5,
            a.push(i)
        }
        var h = Number($("#input-cal-activity-stirfry-price").val());
        if (h) {
            i = {
                type: "UseStirfry"
            };
            i.value = h,
            i.condition = "Global",
            i.cal = "Percent",
            a.push(i)
        }
        var m = Number($("#input-cal-activity-boil-price").val());
        if (m) {
            i = {
                type: "UseBoil"
            };
            i.value = m,
            i.condition = "Global",
            i.cal = "Percent",
            a.push(i)
        }
        var v = Number($("#input-cal-activity-knife-price").val());
        if (v) {
            i = {
                type: "UseKnife"
            };
            i.value = v,
            i.condition = "Global",
            i.cal = "Percent",
            a.push(i)
        }
        var b = Number($("#input-cal-activity-fry-price").val());
        if (b) {
            i = {
                type: "UseFry"
            };
            i.value = b,
            i.condition = "Global",
            i.cal = "Percent",
            a.push(i)
        }
        var g = Number($("#input-cal-activity-bake-price").val());
        if (g) {
            i = {
                type: "UseBake"
            };
            i.value = g,
            i.condition = "Global",
            i.cal = "Percent",
            a.push(i)
        }
        var k = Number($("#input-cal-activity-steam-price").val());
        if (k) {
            i = {
                type: "UseSteam"
            };
            i.value = k,
            i.condition = "Global",
            i.cal = "Percent",
            a.push(i)
        }
        var y = Number($("#input-cal-activity-vegetable-price").val());
        if (y) {
            i = {
                type: "UseVegetable"
            };
            i.value = y,
            i.condition = "Global",
            i.cal = "Percent",
            a.push(i)
        }
        var x = Number($("#input-cal-activity-meat-price").val());
        if (x) {
            i = {
                type: "UseMeat"
            };
            i.value = x,
            i.condition = "Global",
            i.cal = "Percent",
            a.push(i)
        }
        var D = Number($("#input-cal-activity-creation-price").val());
        if (D) {
            i = {
                type: "UseCreation"
            };
            i.value = D,
            i.condition = "Global",
            i.cal = "Percent",
            a.push(i)
        }
        var C = Number($("#input-cal-activity-fish-price").val());
        if (C) {
            i = {
                type: "UseFish"
            };
            i.value = C,
            i.condition = "Global",
            i.cal = "Percent",
            a.push(i)
        }
        var w = Number($("#input-cal-activity-sweet-price").val());
        if (w) {
            i = {
                type: "UseSweet"
            };
            i.value = w,
            i.condition = "Global",
            i.cal = "Percent",
            a.push(i)
        }
        var T = Number($("#input-cal-activity-sour-price").val());
        if (T) {
            i = {
                type: "UseSour"
            };
            i.value = T,
            i.condition = "Global",
            i.cal = "Percent",
            a.push(i)
        }
        var S = Number($("#input-cal-activity-spicy-price").val());
        if (S) {
            i = {
                type: "UseSpicy"
            };
            i.value = S,
            i.condition = "Global",
            i.cal = "Percent",
            a.push(i)
        }
        var q = Number($("#input-cal-activity-salty-price").val());
        if (q) {
            i = {
                type: "UseSalty"
            };
            i.value = q,
            i.condition = "Global",
            i.cal = "Percent",
            a.push(i)
        }
        var E = Number($("#input-cal-activity-bitter-price").val());
        if (E) {
            i = {
                type: "UseBitter"
            };
            i.value = E,
            i.condition = "Global",
            i.cal = "Percent",
            a.push(i)
        }
        var I = Number($("#input-cal-activity-tasty-price").val());
        if (I) {
            i = {
                type: "UseTasty"
            };
            i.value = I,
            i.condition = "Global",
            i.cal = "Percent",
            a.push(i)
        }
        var R = Number($("#input-cal-activity-gold-price").val());
        if (R) {
            i = {
                type: "CookbookPrice"
            };
            i.value = R,
            i.condition = "Global",
            i.cal = "Percent",
            a.push(i)
        }
    }
    return a
}
function loadRule(e, a) {
    for (var t = 0; t < a.rules.length; t++) {
        var i = a.rules[t]
          , l = JSON.parse(JSON.stringify(e.recipes))
          , s = JSON.parse(JSON.stringify(e.chefs))
          , c = JSON.parse(JSON.stringify(e.ambers))
          , r = JSON.parse(JSON.stringify(e.equips))
          , n = JSON.parse(JSON.stringify(e.materials));
        for (var o in i.MaterialsEffect)
            for (var p in n)
                if (n[p].materialId == i.MaterialsEffect[o].MaterialID) {
                    n[p].addition = +(Number(n[p].addition) + i.MaterialsEffect[o].Effect).toFixed(2);
                    break
                }
        var d = [];
        if (i.hasOwnProperty("MaterialsNum")) {
            for (var o in i.MaterialsNum)
                for (var p in n)
                    if (n[p].materialId == i.MaterialsNum[o].MaterialID) {
                        1 != i.MaterialsNum[o].Num && (n[p].quantity = i.MaterialsNum[o].Num),
                        d.push(n[p]);
                        break
                    }
        } else
            for (var o in n)
                d.push(n[o]);
        var u = [];
        for (var o in l)
            if (!(l[o].hide || i.hasOwnProperty("CookbookRarityLimit") && l[o].rarity > i.CookbookRarityLimit)) {
                var f = getRecipeQuantity(l[o], d, i, null);
                if (0 != f) {
                    if (i.hasOwnProperty("RecipesTagsEffect"))
                        for (var p in l[o].tags)
                            for (var h in i.RecipesTagsEffect)
                                if (l[o].tags[p] == i.RecipesTagsEffect[h].TagID) {
                                    l[o].addition = +(Number(l[o].addition) + i.RecipesTagsEffect[h].Effect).toFixed(2);
                                    break
                                }
                    for (var h in i.RecipesEffect)
                        l[o].recipeId == i.RecipesEffect[h].RecipeID && (l[o].addition = +(Number(l[o].addition) + i.RecipesEffect[h].Effect).toFixed(2));
                    for (var h in i.RecipesSkillsEffect)
                        ("stirfry" == i.RecipesSkillsEffect[h].Skill && l[o].stirfry > 0 || "boil" == i.RecipesSkillsEffect[h].Skill && l[o].boil > 0 || "knife" == i.RecipesSkillsEffect[h].Skill && l[o].knife > 0 || "fry" == i.RecipesSkillsEffect[h].Skill && l[o].fry > 0 || "bake" == i.RecipesSkillsEffect[h].Skill && l[o].bake > 0 || "steam" == i.RecipesSkillsEffect[h].Skill && l[o].steam > 0) && (l[o].addition = +(Number(l[o].addition) + i.RecipesSkillsEffect[h].Effect).toFixed(2));
                    u.push(l[o])
                }
            }
        var m = [];
        for (var o in s)
            if (!(s[o].hide || i.hasOwnProperty("ChefRarityLimit") && s[o].rarity > i.ChefRarityLimit)) {
                var v = !1;
                if (i.hasOwnProperty("EnableChefTags")) {
                    for (var p in i.EnableChefTags)
                        if (s[o].tags.indexOf(i.EnableChefTags[p]) >= 0) {
                            v = !0;
                            break
                        }
                } else
                    v = !0;
                if (v) {
                    if (i.hasOwnProperty("ChefsTagsEffect"))
                        for (var p in s[o].tags)
                            for (var h in i.ChefsTagsEffect)
                                if (s[o].tags[p] == i.ChefsTagsEffect[h].TagID) {
                                    s[o].addition = +(Number(s[o].addition) + i.ChefsTagsEffect[h].Effect).toFixed(2);
                                    break
                                }
                    m.push(s[o])
                }
            }
        var b = [];
        for (var o in c)
            c[o].hide || b.push(c[o]);
        var g = [];
        for (var o in r)
            r[o].hide || g.push(r[o]);
        i.recipes = u,
        i.chefs = m,
        i.ambers = b,
        i.equips = g,
        i.materials = d,
        i.rest = d;
        var k = [];
        for (var p in i.recipes) {
            f = getRecipeQuantity(i.recipes[p], i.materials, i, null);
            var y = getRecipeResult(null, null, i.recipes[p], f, f, i.materials, i, i.decorationEffect, null, !1, buildRecipeMenu(i.recipes[p]), null, null);
            y.available = f,
            y.availableScore = y.totalScore / y.max * f;
            var x = {};
            x.recipe = y,
            k.push(x)
        }
        i.menus = k,
        i.hasOwnProperty("MaterialsEffect") || i.hasOwnProperty("ChefsTagsEffect") || i.hasOwnProperty("RecipesTagsEffect") || i.hasOwnProperty("RecipesSkillsEffect") || i.hasOwnProperty("RecipesEffect") ? i.hasRuleAddition = !0 : i.hasRuleAddition = !1,
        "正常营业" == i.Title ? (i.showTime = !0,
        i.showEff = !0,
        $('#select-cal-order option[value="分数"]').siblings().removeAttr("disabled")) : (i.showTime = !1,
        i.showEff = !1,
        $("#select-cal-order").val("分数"),
        $('#select-cal-order option[value="分数"]').siblings().attr("disabled", "disabled")),
        1 == a.rules.length && (sortRecipesResult(),
        $("#cal-recipes-table").DataTable().clear().rows.add(k).draw(),
        initCalRecipesShow($("#cal-recipes-table").DataTable()),
        private && ($("#cal-chefs-table").DataTable().clear().rows.add(m).draw(),
        $("#btn-cal-chefs-deselect-all").click(),
        $("#cal-equips-table").DataTable().clear().rows.add(g).draw(),
        $("#btn-cal-equips-deselect-all").click(),
        $("#cal-materials-table").DataTable().clear().rows.add(d).draw(),
        $("#btn-cal-materials-select-all").click()))
    }
    initCustomData(),
    calCustomResults(e)
}
function initCustomData() {
    for (var e in calCustomRule.rules) {
        var a = calCustomRule.rules[e];
        a.custom = [];
        for (var t = 0; t < getCustomRound(a); t++) {
            for (var i = {
                chef: {},
                equip: {},
                condiment: {},
                recipes: []
            }, l = 0; l < 3; l++) {
                var s = {};
                i.recipes.push(s)
            }
            a.custom.push(i)
        }
    }
}
function setCustomChef(e, a, t) {
    var i = calCustomRule.rules[e]
      , l = i.custom;
    if (l[a])
        if (t) {
            for (var s in i.chefs)
                if (i.chefs[s].chefId == t) {
                    if (l[a].chef = JSON.parse(JSON.stringify(i.chefs[s])),
                    // 保存原始心法盘等级
                    l[a].chef.disk.originalLevel = l[a].chef.disk.level,
                    !$("#chk-cal-use-amber").prop("checked"))
                        for (var c in i.chefs[s].disk.ambers)
                            setCustomAmber(e, a, c, null);
                    // 处理默认满级心法盘
                    if ($("#chk-cal-max-disk").prop("checked")) {
                        l[a].chef.disk.level = l[a].chef.disk.maxLevel;
                    }
                    $("#chk-cal-use-equip").prop("checked") && setCustomEquip(e, a, i.chefs[s].equipId);
                    break
                }
        } else
            l[a].chef = {}
}
function setCustomDiskLevel(e, a, t) {
    var i = calCustomRule.rules[e]
      , l = i.custom;
    l[a] && (l[a].chef.disk.level = t || 1)
}
function setCustomAmber(e, a, t, i) {
    var l = calCustomRule.rules[e]
      , s = l.custom;
    s[a] && (s[a].chef.disk.ambers[t].data = getAmberInfo(i, l.ambers))
}
function setCustomEquip(e, a, t) {
    var i = calCustomRule.rules[e]
      , l = i.custom;
    l[a] && (l[a].equip = t ? getEquipInfo(t, i.equips) : {})
}
function setCustomCondiment(e, a, t, i) {
    var l = calCustomRule.rules[e].custom;
    l[a] && (l[a].condiment = t ? getCondimentInfo(t, i.condiments) : {})
}
function setCustomRecipe(e, a, t, i) {
    var l = calCustomRule.rules[e]
      , s = l.custom;
    if (s[a]) {
        s[a].recipes[t] = {};
        var c = JSON.parse(JSON.stringify(l.materials));
        for (var r in s)
            for (var n in s[r].recipes)
                s[r].recipes[n].data && updateMaterialsData(c, s[r].recipes[n], s[r].recipes[n].quantity, s[r].chef);
        if (i)
            for (var o in l.menus)
                if (l.menus[o].recipe.data.recipeId == i) {
                    var p = getRecipeQuantity(l.menus[o].recipe.data, c, l, s[a].chef);
                    if (l.MaterialsLimit && calCustomRule.materialsAll) {
                        var remain = JSON.parse(JSON.stringify(calCustomRule.materialsAll));
                        for (var tempR in s) {
                            for (var tempN in s[tempR].recipes) {
                                if (tempR == a && tempN == t) {
                                    continue;
                                }
                                if (s[tempR].recipes[tempN].data && s[tempR].recipes[tempN].quantity > 0) {
                                    var tempRecipe = s[tempR].recipes[tempN];
                                    var tempChef = s[tempR].chef;
                                    for (var tempM = 0; tempM < tempRecipe.data.materials.length; tempM++) {
                                        var tempMaterial = tempRecipe.data.materials[tempM];
                                        var tempQuantity = calMaterialReduce(tempChef, tempMaterial.material, tempMaterial.quantity);
                                        remain[tempMaterial.material] -= (tempQuantity * tempRecipe.quantity);
                                    }
                                }
                            }
                        }
                        var materialLimit = calculateMaterialLimit(remain, l.menus[o].recipe.data, s[a].chef);
                        p = Math.min(p, materialLimit);
                        if (l.DisableMultiCookbook) {
                            p = Math.min(p, 1);
                        }
                    }
                    var d = {};
                    d.data = l.menus[o].recipe.data,
                    d.quantity = p,
                    s[a].recipes[t] = d;
                    break
                }
    }
}
function setCustomRecipeQuantity(e, a, t, i) {
    var l = calCustomRule.rules[e]
      , s = l.custom;
    s[a] && (s[a].recipes[t].quantity = i || 0)
}
function updateCustomRecipeCondiment(e, a, t, i) {
    var l = $(".cal-custom-item:eq(" + e + ") .selected-item:eq(" + a + ") .recipe-box:eq(" + t + ") .recipe-condiment input");
    i ? l.prop("checked", !0) : l.prop("checked", !1)
}
function getRemainMaterials(ruleIndex, itemIndex, recipeIndex) {
    if (!calCustomRule.materialsAll) return null;
    var remain = JSON.parse(JSON.stringify(calCustomRule.materialsAll));
    var rule = calCustomRule.rules[ruleIndex];
    var custom = rule.custom;
    for (var c in custom) {
        for (var r in custom[c].recipes) {
            if (c == itemIndex && r == recipeIndex) {
                continue;
            }
            var recipe = custom[c].recipes[r];
            if (recipe.data && recipe.quantity > 0) {
                var chef = custom[c].chef;
                for (var m = 0; m < recipe.data.materials.length; m++) {
                    var material = recipe.data.materials[m];
                    var quantity = calMaterialReduce(chef, material.material, material.quantity);
                    remain[material.material] -= (quantity * recipe.quantity);
                }
            }
        }
    }
    return remain;
}
function calculateMaterialLimit(remain, recipe, chef) {
    if (!remain || !calCustomRule.materialsAll) return 500;
    var limit = 500;
    for (var m = 0; m < recipe.materials.length; m++) {
        var material = recipe.materials[m];
        var quantity = calMaterialReduce(chef, material.material, material.quantity);
        var available = remain[material.material] || 0;
        var maxQty = Math.floor(available / quantity);
        limit = Math.min(limit, maxQty);
    }
    return limit;
}
function calCustomResults(e) {
    // 保存游戏数据到全局对象，供冲突检测使用
    if (e && e.guests) {
        calCustomRule.gameData = e;
    }
    
    for (var a = 0, t = 0; t < calCustomRule.rules.length; t++) {
        var i = calCustomRule.rules[t];
        // 检查 custom 属性是否存在
        if (!i.custom) {
            continue;
        }
        var l = i.custom
          , s = getPartialChefAdds(l, i);
        
        // 先更新菜谱数据
        for (var c in l) {
            for (var r in l[c].recipes)
                if (l[c].recipes[r].data)
                    for (var n in i.menus)
                        if (i.menus[n].recipe.data.recipeId == l[c].recipes[r].data.recipeId) {
                            l[c].recipes[r].data = i.menus[n].recipe.data;
                            break;
                        }
        }
        
        // 先设置厨师数据（包括心法盘效果），然后再计算max
        for (var c in l) {
            l[c].chef.chefId && setDataForChef(l[c].chef, l[c].equip, !0, i.calGlobalUltimateData, s[c], i.calSelfUltimateData, i.calActivityUltimateData, !0, i, !0, i.calQixiaData || null)
        }
        
        // 然后更新每个已选菜谱的max值（不自动调整quantity）
        for (var c in l) {
            for (var r in l[c].recipes)
                if (l[c].recipes[r].data) {
                    // 计算最大份数：使用全部食材计算食材限制后的最大份数
                    var recipeMax = getRecipeQuantity(l[c].recipes[r].data, i.materials, i, l[c].chef);
                    if (i.MaterialsLimit && calCustomRule.materialsAll) {
                        var maxWithMaterials = calculateMaterialLimit(calCustomRule.materialsAll, l[c].recipes[r].data, l[c].chef);
                        recipeMax = Math.min(recipeMax, maxWithMaterials);
                    }
                    if (i.DisableMultiCookbook) {
                        recipeMax = Math.min(recipeMax, 1);
                    }
                    l[c].recipes[r].max = recipeMax;
                    
                    // 贵客率计算模式时，不限制份数不能超过max
                    // 其他模式下，确保quantity不超过max
                    if (!calCustomRule.isGuestRate && l[c].recipes[r].quantity > recipeMax) {
                        l[c].recipes[r].quantity = recipeMax;
                    }
                }
        }
        var o = getPartialRecipeAdds(l, i)
          , p = getIntentAdds(t, l, e, !0)
          , d = 0
          , u = 0
          , f = 0
          , h = 1
          , ruleOriginPrice = 0
          , ruleScore = 0
          , scoreWithoutRule = 0;
        i && i.hasOwnProperty("scoreMultiply") && (h = i.scoreMultiply);
        var m = 1;
        i && i.hasOwnProperty("scorePow") && (m = i.scorePow);
        var v = 0;
        for (var c in i.hasOwnProperty("scoreAdd") && (v = i.scoreAdd),
        l)
            for (var r in l[c].recipes)
                if (l[c].recipes[r].data) {
                    var b = $(".cal-custom-item:eq(" + t + ") .selected-item:eq(" + c + ") .recipe-box:eq(" + r + ") .recipe-condiment input").prop("checked");
                    var actualQuantity = l[c].recipes[r].quantity;
                    var g = getRecipeResult(l[c].chef, l[c].equip, l[c].recipes[r].data, actualQuantity, l[c].recipes[r].max, i.materials, i, i.decorationEffect, b ? l[c].condiment : null, !0, l[c].recipes, o[3 * c + Number(r)], p[3 * c + Number(r)]);
                    if (l[c].recipes[r] = g,
                    f += g.totalTime,
                    d += g.totalBonusScore,
                    u += Math.ceil(+(g.totalScore * (1 + g.data.activityAddition / 100)).toFixed(2)),
                    ruleOriginPrice += g.data.price * g.quantity,
                    i.isNetworkRule && (i.hasOwnProperty("RecipeEffect") || i.hasOwnProperty("ChefTagEffect"))) {
                        var recipeWithoutRule = getRecipeResult(l[c].chef, l[c].equip, l[c].recipes[r].data, actualQuantity, l[c].recipes[r].max, i.materials, Object.assign({}, i, {RecipeEffect: null, ChefTagEffect: null}), i.decorationEffect, b ? l[c].condiment : null, !0, l[c].recipes, o[3 * c + Number(r)], p[3 * c + Number(r)]);
                        ruleScore += g.totalScore - recipeWithoutRule.totalScore;
                    }
                    if (0 == g.rankVal) {
                        var k = getSkillDiff(l[c].chef, l[c].recipes[r].data, 1);
                        l[c].recipes[r].skillDiff = k.disp
                    }
                }
        u = +(Math.pow(u, m) * h).toFixed(2),
        u = i.IsActivity ? Math.ceil(u) : Math.floor(u),
        u && (u += v);
        var y = checkMaterials(l, i.materials);
        
        // 检测食材冲突
        var materialConflicts = {};
        if (i.MaterialsLimit && calCustomRule.materialsAll) {
            var totalUsed = {};
            for (var c in l) {
                for (var r in l[c].recipes) {
                    if (l[c].recipes[r].data && l[c].recipes[r].quantity > 0) {
                        var recipe = l[c].recipes[r];
                        var chef = l[c].chef;
                        for (var m = 0; m < recipe.data.materials.length; m++) {
                            var material = recipe.data.materials[m];
                            var quantity = calMaterialReduce(chef, material.material, material.quantity);
                            var used = quantity * recipe.quantity;
                            if (!totalUsed[material.material]) {
                                totalUsed[material.material] = 0;
                            }
                            totalUsed[material.material] += used;
                        }
                    }
                }
            }
            // 检查哪些食材超用了
            for (var mat in totalUsed) {
                var available = calCustomRule.materialsAll[mat] || 0;
                if (totalUsed[mat] > available) {
                    materialConflicts[mat] = totalUsed[mat] - available;
                }
            }
        }
        
        for (var c in l)
            for (var r in l[c].recipes)
                if (l[c].recipes[r].data) {
                    var D;
                    // 最大份数：使用全部食材计算食材限制后的最大份数
                    D = getRecipeQuantity(l[c].recipes[r].data, i.materials, i, l[c].chef);
                    if (i.MaterialsLimit && calCustomRule.materialsAll) {
                        var maxWithMaterials = calculateMaterialLimit(calCustomRule.materialsAll, l[c].recipes[r].data, l[c].chef);
                        D = Math.min(D, maxWithMaterials);
                    }
                    if (i.DisableMultiCookbook) {
                        D = Math.min(D, 1);
                    }
                    l[c].recipes[r].max = D;
                    
                    // 不自动调整制作份数，保持用户设置的值
                    var actualQuantity = l[c].recipes[r].quantity;
                    // 贵客率计算模式时，不限制份数不能超过max
                    // 其他模式下，确保quantity不超过max
                    if (!calCustomRule.isGuestRate && actualQuantity > D) {
                        actualQuantity = D;
                        l[c].recipes[r].quantity = actualQuantity;
                    }
                    
                    var x = getRecipeQuantity(l[c].recipes[r].data, y.materials, i, l[c].chef);
                    var C = D - actualQuantity;
                    x > C && (x = C);
                    var w = $(".cal-custom-item:eq(" + t + ") .selected-item:eq(" + c + ") .recipe-box:eq(" + r + ") .recipe-quantity");
                    // 贵客率计算模式下，max设置为999；其他模式下设置为D
                    var maxValue = calCustomRule.isGuestRate ? 999 : D;
                    w.find("input").attr("max", maxValue).val(actualQuantity),
                    w.find(".max").html(D),
                    i.hasOwnProperty("MaterialsNum") ? w.find(".available").html(0 != x ? "(" + x + ")" : "") : w.find(".available").html(C < 0 && !i.MaterialsLimit ? "(" + C + ")" : "")
                }
        for (var c in i.rest = y.materials,
        l) {
            var T = $(".cal-custom-item:eq(" + t + ") .selected-item:eq(" + c + ") .chef-box");
            if (l[c].chef.chefId) {
                T.find(".chef-box-1 .content").html(getCalChefDisp(l[c].chef)),
                T.find(".chef-placeholder").addClass("hidden");
                var S = l[c].chef.disk;
                T.find(".disk-level-box .content").html("<div class='name'>心法盘等级 " + S.level + "</div>");
                for (n = 0; n < S.ambers.length; n++) {
                    var q = S.ambers[n]
                      , E = "";
                    E = q.data ? getCalAmberDisp(q.data, S.level) : "<div class='disk-" + q.type + " name'>+ 遗玉</div>",
                    T.find(".disk-box:eq(" + n + ")").removeClass("hidden").find(".content").html(E)
                }
                for (n = S.ambers.length; n < 3; n++)
                    T.find(".disk-box:eq(" + n + ")").addClass("hidden")
            } else
                T.find(".content").html(""),
                T.find(".chef-placeholder").html("+ 厨师").removeClass("hidden");
            var I = "";
            I = l[c].equip.equipId ? getCalEquipDisp(l[c].equip) : "+ 厨具",
            $(".cal-custom-item:eq(" + t + ") .selected-item:eq(" + c + ") .equip-box .content").html(I);
            var R = 0;
            for (var r in l[c].recipes) {
                w = $(".cal-custom-item:eq(" + t + ") .selected-item:eq(" + c + ") .recipe-box:eq(" + r + ")");
                if (l[c].recipes[r].data) {
                    var N = l[c].recipes[r];
                    w.find(".recipe-box-1 .content").html(getCalRecipeDisp(N));
                    var A = $("#chk-cal-ex").val()
                      , M = w.find(".recipe-ex input");
                    A.indexOf(l[c].recipes[r].data.recipeId.toString()) >= 0 ? M.prop("checked", !0) : M.prop("checked", !1),
                    w.find(".recipe-result .content").html(getCalRecipeResultDisp(N, i)),
                    w.find(".recipe-box-2 .content").html(getCalRecipeBox2Disp(N, i, l[c].chef));
                    
                    // 标红冲突的食材
                    if (Object.keys(materialConflicts).length > 0) {
                        w.find(".recipe-box-2 .material span").each(function() {
                            var materialId = $(this).attr("data-id");
                            if (materialId && materialConflicts[materialId]) {
                                $(this).css({"color": "red", "font-weight": "bold"});
                            }
                        });
                    }
                    
                    w.find(".recipe-placeholder").addClass("hidden"),
                    N.useCondiment && (R += N.data.rarity * N.quantity)
                } else
                    w.find(".content").html(""),
                    w.find(".recipe-placeholder").html("+ 菜谱").removeClass("hidden")
            }
            var O = "";
            O = l[c].condiment.condimentId ? getCalCondimentDisp(l[c].condiment, R) : "+ 调料",
            $(".cal-custom-item:eq(" + t + ") .selected-item:eq(" + c + ") .condiment-box .content").html(O)
        }
        var _ = "";
        if (calCustomRule.rules.length > 1 && (_ += i.Title + " "),
        i.Satiety) {
            $(".cal-custom-item:eq(" + t + ") .intent-satiety").addClass("label-default").removeClass("label-info");
            var G = calSatiety(l, i);
            _ += "饱腹：" + G.total + "/" + i.Satiety,
            G.done && (1 == i.SatisfyRewardType && G.total == i.Satiety && $(".cal-custom-item:eq(" + t + ") .intent-satiety").addClass("label-info").removeClass("label-default"),
            _ += " 加成：" + G.add + "%",
            u = calSatietyAdd(u, G.add))
        }
        if (i.isNetworkRule) {
            _ += " 原售价：" + Math.floor(ruleOriginPrice);
            if (ruleScore > 0) {
                _ += " 规则分：" + Math.floor(ruleScore);
            }
        }
        _ += " 总分：" + u,
        i.isNetworkRule && i.PassLine && u && (function() {
            var passLine = i.PassLine;
            var tips = [];
            if (passLine.length == 1) {
                tips = ['过线', '未过线'];
            } else if (passLine.length == 3) {
                tips = ['高保', '中保', '低保'];
            } else if (passLine.length == 4) {
                tips = ['高保', '中保', '低保', '分享保'];
            }
            var index = passLine.length;
            for (var j = 0; j < passLine.length; j++) {
                if (u >= passLine[j]) {
                    index = j;
                    break;
                }
            }
            if (tips[index]) {
                _ += " " + tips[index];
            }
        })(),
        calCustomRule.rules.length > 1 && (_ += " 合计：<span class='total-score'></span>"),
        a += u;
        if (i.showTime) {
            var P = 0;
            for (var c in l)
                if (l[c].chef.chefId) {
                    // 统计厨师技能的时间加成
                    if (!(i && i.hasOwnProperty("DisableChefSkillEffect") && 0 != i.DisableChefSkillEffect)) {
                        P += getTimeAddition(l[c].chef.specialSkillEffect);
                    }
                    // 统计修炼技能的时间加成
                    if (l[c].chef.ultimateSkillEffect) {
                        P += getTimeAddition(l[c].chef.ultimateSkillEffect);
                    }
                    // 统计厨具技能的时间加成
                    if ((!i || !i.hasOwnProperty("DisableEquipSkillEffect") || 0 == i.DisableEquipSkillEffect) && l[c].equip && l[c].equip.effect) {
                        var V = updateEquipmentEffect(l[c].equip.effect, l[c].chef.selfUltimateEffect);
                        P += getTimeAddition(V);
                    }
                }
            for (var c in o[0]) {
                var L = o[0][c].effect;
                "OpenTime" == L.type && (P += L.value)
            }
            0 != +P.toFixed(2) && (_ += " 原时间：" + (secondsToTime(f) || 0));
            var B = Math.ceil(+(f * (1 + P / 100)).toFixed(2));
            _ += " 总时间：" + (secondsToTime(B) || 0);
            var F = 0;
            B > 0 && (F = Math.floor(3600 * u / B)),
            _ += " 总效率：" + F + "金币/小时"
        }
        if (y.lackIds.length)
            for (var c in _ += " (" + y.message + ")",
            y.lackIds)
                $(".cal-custom-item:eq(" + t + ") .selected-item .recipe-box-2 .material span[data-id='" + y.lackIds[c] + "']").addClass("red");
        
        // 显示食材超用信息
        if (Object.keys(materialConflicts).length > 0) {
            var conflictMsg = "";
            for (var mat in materialConflicts) {
                var materialName = "";
                for (var m in i.materials) {
                    if (i.materials[m].materialId == mat) {
                        materialName = i.materials[m].name;
                        break;
                    }
                }
                if (materialName) {
                    conflictMsg += materialName + "-" + Math.ceil(materialConflicts[mat]) + " ";
                }
            }
            if (conflictMsg) {
                _ += " <span style='color:red;font-weight:bold'>(" + conflictMsg.trim() + ")</span>";
            }
        }
        $(".cal-custom-item:eq(" + t + ") .selected-sum").html(_);
        // 贵客率模式：显示贵客冲突提示
        if (typeof GuestRateCalculator !== 'undefined' && GuestRateCalculator.isGuestRateMode()) {
            var gameDataToUse = e || calCustomRule.gameData;
            GuestRateCalculator.displayGuestConflictWarning(t, gameDataToUse);
        }
    }
    calCustomRule.rules.length > 1 && $(".total-score").html(a),
    calCustomRule.score = a,
    
    // 更新是否过线、原售价、规则分显示
    updateCalSummaryDisplay(calCustomRule),
    
    updateCalMenus(),
    resizeCalCustomTable();
    // 贵客率模式：重新刷新所有菜谱选择框的冲突检测
    if (typeof GuestRateCalculator !== 'undefined' && GuestRateCalculator.isGuestRateMode()) {
        GuestRateCalculator.refreshAllRecipeConflictDetection();
    }
}

function updateCalSummaryDisplay(calCustomRule) {
    // 计算总原售价、总规则分、总得分
    var totalOriginPrice = 0;
    var totalRuleScore = 0;
    var totalScore = 0;
    
    for (var t = 0; t < calCustomRule.rules.length; t++) {
        var rule = calCustomRule.rules[t];
        var custom = rule.custom;
        
        // 计算每个规则的原售价和规则分
        var ruleOriginPrice = 0;
        var ruleRuleScore = 0;
        
        for (var c in custom) {
            for (var r in custom[c].recipes) {
                if (custom[c].recipes[r].data) {
                    var recipe = custom[c].recipes[r];
                    // 原售价 = 基础售价 * 数量
                    ruleOriginPrice += recipe.price * recipe.quantity;
                    // 规则分 = 规则加成分数
                    ruleRuleScore += recipe.bonusScore * recipe.quantity;
                }
            }
        }
        
        totalOriginPrice += ruleOriginPrice;
        totalRuleScore += ruleRuleScore;
    }
    
    totalScore = calCustomRule.score || 0;
    
    // 更新显示字段
    $("#display-cal-origin-price").val(Math.floor(totalOriginPrice));
    $("#display-cal-rule-score").val(Math.floor(totalRuleScore));
    
    // 计算并更新贵客率计算器的所有字段
    if (calCustomRule.isGuestRate && calCustomRule.rules.length > 0) {
        // updateSummaryDisplay方法
        if (typeof GuestRateCalculator !== 'undefined' && GuestRateCalculator.updateSummaryDisplay) {
            GuestRateCalculator.updateSummaryDisplay(calCustomRule);
        }
    }
    
    // 判断是否过线
    var passLineText = "";
    if (calCustomRule.rules.length > 0 && calCustomRule.rules[0].PassLine) {
        var passLine = calCustomRule.rules[0].PassLine;
        var tips = [];
        
        if (passLine.length == 1) {
            tips = ['过线', '未过线'];
        } else if (passLine.length == 3) {
            tips = ['高保', '中保', '低保'];
        } else if (passLine.length == 4) {
            tips = ['高保', '中保', '低保', '未过线'];
        }
        
        // 判断分数等级
        var index = passLine.length;
        for (var i = 0; i < passLine.length; i++) {
            if (totalScore >= passLine[i]) {
                index = i;
                break;
            }
        }
        
        passLineText = tips[index] || "";
    }
    
    $("#display-cal-pass-line").val(passLineText);
}
function resizeCalCustomTable() {
    resizeCalCustomTableSub(".chef-box-1", 0),
    resizeCalCustomTableSub(".chef-box", 40),
    resizeCalCustomTableSub(".equip-box", 40),
    resizeCalCustomTableSub(".condiment-box", 40),
    resizeCalCustomTableSub(".recipe-box:nth-child(3n+1)", 100),
    resizeCalCustomTableSub(".recipe-box:nth-child(3n+2)", 100),
    resizeCalCustomTableSub(".recipe-box:nth-child(3n+3)", 100)
}
function resizeCalCustomTableSub(e, a) {
    $(".cal-custom-item").each(function() {
        var t = a;
        $(this).find(e).css("min-height", ""),
        $(window).width() < 1310 && ($(this).find(e).css("min-height", t),
        $(this).find(e).each(function() {
            $(this).find(".content .name").length && (t = Math.max(t, Math.ceil($(this).height()) + 1))
        }),
        $(this).find(e).css("min-height", t))
    })
}
function getCalChefDisp(e) {
    var a = "<div class='name'>" + e.name + "</div><div class='icon-box'>" + e.icon + "</div><div class='skill'>";
    return e.stirfryDisp && (a += "<span>炒" + e.stirfryDisp + "</span>"),
    e.boilDisp && (a += "<span>煮" + e.boilDisp + "</span>"),
    e.knifeDisp && (a += "<span>切" + e.knifeDisp + "</span>"),
    e.fryDisp && (a += "<span>炸" + e.fryDisp + "</span>"),
    e.bakeDisp && (a += "<span>烤" + e.bakeDisp + "</span>"),
    e.steamDisp && (a += "<span>蒸" + e.steamDisp + "</span>"),
    a += "</div>",
    a
}
function getCalAmberDisp(e, a) {
    return "<div class='amber-in'><div class='icon-box'>" + e.icon + "</div><div class='disk-" + e.type + " name'>" + e.name + "</div></div><small>" + getAmberDisplayByLevel(e, a) + "</small>"
}
function getCalEquipDisp(e) {
    return "<div class='equip-in'><div class='icon-box'>" + e.icon + "</div><div class='name'>" + e.name + "</div></div><small>" + e.skillDisp + "</small>"
}
function getCalCondimentDisp(e, a) {
    return "<div class='condiment-in'><div class='icon-box'>" + e.icon + "</div><div class='name'>" + e.name + "<span class='rarity'> " + e.rarityDisp + (a ? "*" + a : "") + "</span></div></div><small>" + e.skillDisp + "</small>"
}
function getCalRecipeDisp(e) {
    var a = e.data;
    return "<div class='name'>" + a.name + "</div><div class='recipe-ric'><div class='rank'>" + (e.rankDisp ? e.rankDisp : "") + "</div><div class='icon-box'>" + a.icon + "</div><div class='condiment'>" + a.condimentDisp + "</div></div>"
}
function getCalRecipeResultDisp(e, a) {
    var t = "<div>" + e.score + "*" + e.quantity + "=<span class='score'>" + e.totalScore + "</span></div>";
    return a.showTime && (t += "<div class='time'>" + e.totalTimeDisp + "</div>"),
    t += e.skillDiff ? "<div class='red'>" + e.skillDiff + "</div>" : "",
    t
}
function getCalMaterialsDisp(e, a, t) {
    var i = "";
    for (var l in e.materials)
        for (var s in a)
            if (e.materials[l].material == a[s].materialId) {
                var c = calMaterialReduce(t, e.materials[l].material, e.materials[l].quantity);
                i += "<span data-id='" + a[s].materialId + "'>" + a[s].name + c + "</span>";
                break
            }
    return 1 == e.materials.length ? i += "<span></span><span></span>" : 2 == e.materials.length && (i += "<span></span>"),
    i
}
function getCalRecipeBox2Disp(e, a, t) {
    var i = "<div class='rarity'>" + e.data.rarityDisp + "</div>";
    return i += "<div class='skill'>",
    i += e.data.skillDisp,
    i += "</div>",
    i += "<div class='material'>",
    i += getCalMaterialsDisp(e.data, a.materials, t),
    i += "</div>",
    i += "<div class='add'>",
    e.rankAdditionDisp ? i += "<span>品阶" + e.rankAdditionDisp + "</span>" : i += "<span class='blank'>品阶</span>",
    e.chefSkillAdditionDisp ? i += "<span>技能" + e.chefSkillAdditionDisp + "</span>" : i += "<span class='blank'>技能</span>",
    e.equipSkillAdditionDisp ? i += "<span>厨具" + e.equipSkillAdditionDisp + "</span>" : i += "<span class='blank'>厨具</span>",
    a.hasOwnProperty("DisableCondimentEffect") && 0 != a.DisableCondimentEffect || (e.condimentSkillAdditionDisp ? i += "<span>调料" + e.condimentSkillAdditionDisp + "</span>" : i += "<span class='blank'>调料</span>"),
    a.isNetworkRule && e.ruleAdditionDisp ? i += "<span>规则" + e.ruleAdditionDisp + "</span>" : !a.isNetworkRule && e.bonusAdditionDisp ? i += "<span>规则" + e.bonusAdditionDisp + "</span>" : i += "<span class='blank'>规则</span>",
    e.data.ultimateAdditionDisp ? i += "<span>修炼" + e.data.ultimateAdditionDisp + "</span>" : i += "<span class='blank'>修炼</span>",
    a.hasOwnProperty("DisableDecorationEffect") && 0 != a.DisableDecorationEffect ? a.calActivityUltimateData.length > 0 && (e.data.activityAdditionDisp ? i += "<span>奇珍" + e.data.activityAdditionDisp + "</span>" : i += "<span class='blank'>奇珍</span>") : e.decorationAdditionDisp ? i += "<span>装饰" + e.decorationAdditionDisp + "</span>" : i += "<span class='blank'>装饰</span>",
    e.basicPercentDisp || e.basicAbsDisp ? (i += "<span>基础",
    i += e.basicPercentDisp ? e.basicPercentDisp : e.basicAbsDisp,
    i += "</span>") : i += "<span class='blank'>基础</span>",
    e.basicPercentDisp && e.basicAbsDisp && (i += "<span>基础" + e.basicAbsDisp + "</span>"),
    e.partialAdditionDisp ? i += "<span>在场" + e.partialAdditionDisp + "</span>" : i += "<span class='blank'>在场</span>",
    i += "</div>",
    i
}
function getIntentAdds(e, a, t, i) {
    var l = calCustomRule.rules[e]
      , s = [];
    if (l.Satiety) {
        for (var c = 0; c < 3 * l.IntentList.length; c++)
            s.push([]);
        if (l.GlobalBuffList)
            for (var r in l.GlobalBuffList)
                for (var n in t.buffs)
                    if (l.GlobalBuffList[r] == t.buffs[n].buffId)
                        for (var o in a)
                            for (var p in a[o].recipes)
                                a[o].recipes[p].data && checkIntent(t.buffs[n], a[o].recipes, p, a[o].chef) && s[3 * o + Number(p)].push(t.buffs[n]);
        for (c = 0; c < l.IntentList.length; c++)
            for (r = 0; r < l.IntentList[c].length; r++)
                for (var n in t.intents)
                    if (l.IntentList[c][r] == t.intents[n].intentId) {
                        i && $(".cal-custom-item:eq(" + e + ") .intent-" + c + r).addClass("label-default").removeClass("label-info");
                        var d = !1
                          , u = 0
                          , f = t.intents[n];
                        if ("Group" == f.conditionType)
                            d = checkIntent(f, a[c].recipes, null, null);
                        else
                            for (var o in a[c].recipes)
                                if (a[c].recipes[o].data && (d = checkIntent(f, a[c].recipes, o, a[c].chef),
                                d)) {
                                    u = Number(o);
                                    break
                                }
                        if (d)
                            if (i && $(".cal-custom-item:eq(" + e + ") .intent-" + c + r).addClass("label-info").removeClass("label-default"),
                            "CreateBuff" == f.effectType)
                                for (var o in t.buffs) {
                                    var h = t.buffs[o];
                                    if (h.buffId == f.effectValue) {
                                        for (p = 1; p <= h.lastRounds; p++)
                                            for (var m = 0; m < 3; m++)
                                                checkIntent(h, a[p + c].recipes, m, a[p + c].chef) && s[3 * (p + c) + m].push(h);
                                        break
                                    }
                                }
                            else if ("CreateIntent" == f.effectType && u < 2) {
                                for (var o in t.intents)
                                    if (t.intents[o].intentId == f.effectValue) {
                                        checkIntent(t.intents[o], a[c].recipes, u + 1, a[c].chef) && s[3 * c + u + 1].push(t.intents[o]);
                                        break
                                    }
                            } else
                                checkIntent(f, a[c].recipes, u, a[c].chef) && s[3 * c + u].push(f);
                        break
                    }
    }
    return s
}
function checkIntent(e, a, t, i) {
    if ("Group" == e.conditionType) {
        var l = 0;
        for (var s in a) {
            var c = a[s].data;
            c && c[e.conditionValue.toLowerCase()] > 0 && l++
        }
        if (3 == l)
            return !0
    } else if ("ChefStar" == e.conditionType) {
        if (i.chefId && i.rarity == e.conditionValue)
            return !0
    } else {
        c = a[t].data;
        if (c)
            if ("Rank" == e.conditionType) {
                if (i.chefId) {
                    var r = getRankInfo(c, i);
                    if (r.rankVal >= e.conditionValue)
                        return !0
                }
            } else if ("CondimentSkill" == e.conditionType && c.condiment == e.conditionValue || "CookSkill" == e.conditionType && c[e.conditionValue.toLowerCase()] > 0 || "Rarity" == e.conditionType && c.rarity == e.conditionValue || "Order" == e.conditionType && Number(t) + 1 == e.conditionValue || !e.conditionType)
                return !0
    }
    return !1
}
function getSatietyPercent(e, a) {
    return 1 == a.SatisfyRewardType && e == a.Satiety ? a.SatisfyExtraValue : -a.SatisfyDeductValue * Math.abs(e - a.Satiety)
}
function calSatiety(e, a) {
    var t = {
        total: 0,
        add: 0,
        done: !1
    };
    if (a.Satiety) {
        var i = 0;
        for (var l in e)
            for (var s in e[l].recipes)
                e[l].recipes[s].data && (t.total += e[l].recipes[s].satiety,
                i++);
        3 * a.IntentList.length == i && (t.done = !0,
        t.add = getSatietyPercent(t.total, a))
    }
    return t
}
function calSatietyAdd(e, a) {
    return Math.ceil(+(e * (1 + .01 * a)).toFixed(2))
}
function getCustomChefsOptions(e, a, t) {
    var i = $("#chk-cal-got").prop("checked")
      , l = $("#chk-cal-use-equip").prop("checked")
      , s = $("#chk-cal-use-amber").prop("checked")
      , maxDisk = $("#chk-cal-max-disk").prop("checked")
      , c = $("#chk-cal-dd-show").val()
      , r = calCustomRule.rules[e]
      , n = r.custom
      , o = !1;
    
    // 判断是否为网络规则
    if (r.isNetworkRule) {
        // 网络规则：检查全场其他位置是否有任何一个位置同时有厨师和菜谱
        for (var checkPos in n) {
            // 跳过当前正在选择厨师的位置
            if (checkPos == a) continue;
            
            if (n[checkPos].chef.chefId) {
                for (var checkRecipe in n[checkPos].recipes) {
                    if (n[checkPos].recipes[checkRecipe].data) {
                        o = !0;
                        break;
                    }
                }
                if (o) break;
            }
        }
        
        // 如果当前位置自己有菜谱，也应该计算分数
        if (!o) {
            for (var p in n[a].recipes) {
                if (n[a].recipes[p].data) {
                    o = !0;
                    break;
                }
            }
        }
    } else {
        // 非网络规则：保持原逻辑，只检查当前位置是否有菜谱
        for (var p in n[a].recipes) {
            if (n[a].recipes[p].data) {
                o = !0;
                break;
            }
        }
    }
    
    // 获取配置页面中勾选的已修炼厨师ID列表
    var configUltimatedIds = typeof getConfigUltimatedChefIds === 'function' ? getConfigUltimatedChefIds() : {allSet: {}};
    
    // 获取本地数据（用于判断厨师是否已修炼）
    var localData = typeof getLocalData === 'function' ? getLocalData() : null;
    
    var d = JSON.parse(JSON.stringify(n))
      , u = []
      , f = JSON.parse(JSON.stringify(r.chefs));
    for (var h in f) {
        // 判断厨师是否"已有"：
        // 1. f[h].got 为 true（厨师页面标记为已有）
        // 2. 或者在"上场类已修炼"下拉框中被勾选
        // 3. 或者在"个人类已修炼"下拉框中被勾选
        var chefIdStr = String(f[h].chefId);
        var isOwned = f[h].got || (configUltimatedIds.allSet && configUltimatedIds.allSet[chefIdStr]);
        
        if (!i || isOwned) {
            // 检查修炼状态过滤
            var ultimatedChecked = $("#chk-cal-ultimated").prop("checked");
            var shouldSkip = false;
            
            // 只有在勾选了"已有"且勾选了"已修炼"时，才需要检查修炼状态
            if (i && ultimatedChecked) {
                // 使用公共函数检查是否已修炼（传入缓存的 configUltimatedIds）
                var isChefUltimatedFlag = isChefUltimated(f[h].chefId, localData, configUltimatedIds);
                
                // 如果勾选了"已修炼"但厨师未修炼，跳过该厨师
                if (!isChefUltimatedFlag) {
                    shouldSkip = true;
                }
            }
            
            if (shouldSkip) {
                continue;
            }
        
            // 贵客率计算模式下，分析厨师技能
            var chefAnalysis = null;
            var isGuestRateModeFlag = calCustomRule && calCustomRule.isGuestRate === true;
            if (isGuestRateModeFlag && typeof GuestRateCalculator !== 'undefined' && GuestRateCalculator.analyzeChefGuestRateSkills) {
                chefAnalysis = GuestRateCalculator.analyzeChefGuestRateSkills(
                    f[h],
                    r.calQixiaData || null,
                    l, // useEquip
                    s, // useAmber
                    localData,
                    configUltimatedIds
                );
            }
        
            d[a].chef = f[h];
            var m = {};
            if (m.display = f[h].name,
            m.value = f[h].chefId,
            m.content = "<span class='name'>" + f[h].name + "</span>",
            n[a].chef.chefId == f[h].chefId && (m.selected = !0,
            d[a].chef.disk = n[a].chef.disk),
            
            // 添加贵客率计算模式的分类和技能值属性
            chefAnalysis && chefAnalysis.hasSkills && (m.category = chefAnalysis.categories,
            m.skillValues = chefAnalysis.skillValues),
            
            o) {
                var v = getPartialChefAdds(d, r);
                if (n[a].chef.chefId == f[h].chefId ? d[a].equip = n[a].equip : l && (d[a].equip = f[h].equip),
                !s && n[a].chef.chefId != f[h].chefId)
                    for (var b in d[a].chef.disk.ambers)
                        d[a].chef.disk.ambers[b].data = null;
                // 处理默认满级心法盘
                if (maxDisk && n[a].chef.chefId != f[h].chefId) {
                    d[a].chef.disk.level = d[a].chef.disk.maxLevel;
                }
                for (var g in d)
                    d[g].chef.chefId && (r.Satiety && g != a || setDataForChef(d[g].chef, d[g].equip, !0, r.calGlobalUltimateData, v[g], r.calSelfUltimateData, r.calActivityUltimateData, !0, r, !0, r.calQixiaData || null));
                var k = JSON.parse(JSON.stringify(d[a].chef));
                for (var p in d[a].recipes)
                    d[a].recipes[p].data && addCheffSkillDiff(k, d[a].recipes[p].data);
                var y = getChefSillDiff(k, d[a].chef);
                "" != y && (m.content += "<span class='skill'>" + y + "</span>",
                m.class = "warning-skill"),
                d[a].chef = k;
                var x = getPartialRecipeAdds(d, r)
                  , D = getIntentAdds(e, d, t, !1)
                  , C = 0;
                for (var g in d)
                    for (var w in d[g].recipes)
                        if (d[g].recipes[w].data) {
                            var T = getRecipeResult(d[g].chef, d[g].equip, d[g].recipes[w].data, d[g].recipes[w].quantity, d[g].recipes[w].max, r.materials, r, r.decorationEffect, d[g].recipes[w].useCondiment ? d[g].condiment : null, !0, d[g].recipes, x[3 * g + Number(w)], D[3 * g + Number(w)]);
                            d[g].recipes[w] = T,
                            C += T.totalScore
                        }
                var S = calSatiety(d, r);
                r.Satiety && (C = calSatietyAdd(C, S.add)),
                m.content += "<span class='score'>" + C + "</span>",
                m.order = C
            } else
                m.order = f[h].rarity;
            for (var q in c.indexOf("chef_rarity") >= 0 && (m.content += "<span class='subtext'>" + f[h].rarityDisp + "</span>"),
            c.indexOf("chef_specialSkill") >= 0 && (m.content += "<span class='skilltext'>" + f[h].specialSkillDisp.replace(/<br>/g, " ") + "</span>"),
            c.indexOf("chef_ultimate") >= 0 && (m.content += "<span class='skilltext'>" + f[h].ultimateCustomDisp + "</span>"),
            c.indexOf("chef_origin") >= 0 && (m.content += "<span class='subtext'>" + f[h].origin.replace(/<br>/g, " ") + "</span>"),
            calCustomRule.rules) {
                var E = calCustomRule.rules[q].custom;
                for (var w in E)
                    if (E[w].chef.chefId == f[h].chefId) {
                        m.disabled = !0;
                        break
                    }
            }
            u.push(m)
        }
    }
    u.sort(function(e, a) {
        return a.order - e.order
    });
    m = {
        display: "选择厨师",
        value: "",
        class: "hidden"
    };
    return u.unshift(m),
    u
}
function getChefUltimateCustomDisp(e, a) {
    var t = !1;
    for (var i in e) {
        if ("Partial" == e[i].condition) {
            t = !0;
            break
        }
        if ("Self" == e[i].condition) {
            if ("Material_Gain" != e[i].type) {
                t = !0;
                break
            }
        } else if ("Next" == e[i].condition) {
            t = !0;
            break
        }
    }
    return t ? a.replace(/<br>/g, " ") : ""
}
function getCustomDiskLevelsOptions(e, a, t) {
    var i = calCustomRule.rules[e]
      , l = i.custom
      , s = !1;
    for (var c in l[a].recipes)
        if (l[a].recipes[c].data) {
            s = !0;
            break
        }
    for (var r = JSON.parse(JSON.stringify(l)), n = getPartialChefAdds(r, i), o = r[a].chef.disk.maxLevel, p = r[a].chef.disk.level, d = [], u = o; u > 0; u--) {
        var f = {};
        if (f.display = u,
        f.value = u,
        f.content = "<span class='name'>等级 " + u + "</span>",
        r[a].chef.chefId && s) {
            r[a].chef.disk.level = u,
            setDataForChef(r[a].chef, r[a].equip, !0, i.calGlobalUltimateData, n[a], i.calSelfUltimateData, i.calActivityUltimateData, !0, i, !0, i.calQixiaData || null);
            var h = JSON.parse(JSON.stringify(r[a].chef));
            for (var c in r[a].recipes)
                r[a].recipes[c].data && addCheffSkillDiff(h, r[a].recipes[c].data);
            var m = getChefSillDiff(h, r[a].chef);
            "" != m && (f.content += "<span class='skill'>" + m + "</span>",
            f.class = "warning-skill"),
            r[a].chef = h;
            var v = getPartialRecipeAdds(r, i)
              , b = getIntentAdds(e, r, t, !1)
              , g = 0;
            for (var k in r)
                for (var $ in r[k].recipes)
                    if (r[k].recipes[$].data) {
                        var y = getRecipeResult(r[k].chef, r[k].equip, r[k].recipes[$].data, r[k].recipes[$].quantity, r[k].recipes[$].max, i.materials, i, i.decorationEffect, r[k].recipes[$].useCondiment ? r[k].condiment : null, !0, r[k].recipes, v[3 * k + Number($)], b[3 * k + Number($)]);
                        r[k].recipes[$] = y,
                        g += y.totalScore
                    }
            var x = calSatiety(r, i);
            i.Satiety && (g = calSatietyAdd(g, x.add)),
            f.content += "<span class='score'>" + g + "</span>",
            f.order = g
        }
        p == u && (f.selected = !0),
        d.push(f)
    }
    return d
}
function getCustomAmbersOptions(e, a, t, i, l) {
    var s = $("#chk-cal-dd-show").val()
      , c = calCustomRule.rules[e]
      , r = c.custom
      , n = !1;
    for (var o in r[a].recipes)
        if (r[a].recipes[o].data) {
            n = !0;
            break
        }
    var p = r[a].chef.disk
      , d = p.ambers[t]
      , u = JSON.parse(JSON.stringify(r))
      , f = getPartialChefAdds(u, c)
      , h = [];
    for (var m in i)
        if (i[m].type == d.type) {
            var v = i[m].skillDisp.replace(/<br>/g, " ")
              , b = {};
            if (b.display = i[m].name,
            b.value = i[m].amberId,
            b.content = "<span class='name'>" + i[m].name + "</span>",
            b.tokens = i[m].name + v,
            u[a].chef.chefId && n) {
                u[a].chef.disk.ambers[t].data = i[m],
                setDataForChef(u[a].chef, u[a].equip, !0, c.calGlobalUltimateData, f[a], c.calSelfUltimateData, c.calActivityUltimateData, !0, c, !0, c.calQixiaData || null);
                var g = JSON.parse(JSON.stringify(u[a].chef));
                for (var o in u[a].recipes)
                    u[a].recipes[o].data && addCheffSkillDiff(g, u[a].recipes[o].data);
                var k = getChefSillDiff(g, u[a].chef);
                "" != k && (b.content += "<span class='skill'>" + k + "</span>",
                b.class = "warning-skill"),
                u[a].chef = g;
                var y = getPartialRecipeAdds(u, c)
                  , x = getIntentAdds(e, u, l, !1)
                  , D = 0;
                for (var C in u)
                    for (var w in u[C].recipes)
                        if (u[C].recipes[w].data) {
                            var T = getRecipeResult(u[C].chef, u[C].equip, u[C].recipes[w].data, u[C].recipes[w].quantity, u[C].recipes[w].max, c.materials, c, c.decorationEffect, u[C].recipes[w].useCondiment ? u[C].condiment : null, !0, u[C].recipes, y[3 * C + Number(w)], x[3 * C + Number(w)]);
                            u[C].recipes[w] = T,
                            D += T.totalScore
                        }
                var S = calSatiety(u, c);
                c.Satiety && (D = calSatietyAdd(D, S.add)),
                b.content += "<span class='score'>" + D + "</span>",
                b.order = D
            }
            s.indexOf("amber_rarity") >= 0 && (b.content += "<span class='subtext'>" + i[m].rarityDisp + "</span>"),
            s.indexOf("amber_skill") >= 0 && (b.content += "<span class='subtext'>" + v + "</span>"),
            s.indexOf("amber_final") >= 0 && (b.content += "<span class='subtext'>[" + getAmberDisplayByLevel(i[m], p.level) + "]</span>"),
            s.indexOf("amber_origin") >= 0 && (b.content += "<span class='subtext'>" + i[m].origin.replace(/<br>/g, " ") + "</span>"),
            d.data && d.data.amberId == i[m].amberId && (b.selected = !0),
            h.push(b)
        }
    h.sort(function(e, a) {
        return a.order - e.order
    });
    b = {
        display: "无遗玉",
        value: "",
        class: "hidden"
    };
    return h.unshift(b),
    h
}
function getCustomEquipsOptions(e, a, t, i) {
    var l = $("#chk-cal-dd-show").val()
      , s = calCustomRule.rules[e]
      , c = s.custom
      , r = !1;
    for (var n in c[a].recipes)
        if (c[a].recipes[n].data) {
            r = !0;
            break
        }
    var o = JSON.parse(JSON.stringify(c))
      , p = getPartialChefAdds(o, s)
      , d = [];
    for (var u in t) {
        var f = t[u].skillDisp.replace(/<br>/g, " ")
          , h = {};
        
        // 贵客率计算模式下，分析厨具技能
        var equipAnalysis = null;
        var isGuestRateModeFlag = calCustomRule && calCustomRule.isGuestRate === true;
        if (isGuestRateModeFlag && typeof GuestRateCalculator !== 'undefined' && GuestRateCalculator.analyzeChefGuestRateSkills) {
            equipAnalysis = GuestRateCalculator.analyzeChefGuestRateSkills(
                t[u],
                null, // qixiaData - 厨具不需要
                false, // useEquip - 厨具不需要
                false, // useAmber - 厨具不需要
                null, // localData - 厨具不需要
                null, // configUltimatedIds - 厨具不需要
                'equip' // type - 指定为厨具
            );
        }
        
        if (h.display = t[u].name,
        h.value = t[u].equipId,
        h.content = "<span class='name'>" + t[u].name + "</span>",
        h.tokens = t[u].name + f,
        
        // 添加贵客率计算模式的分类和技能值属性
        equipAnalysis && equipAnalysis.hasSkills && (h.category = equipAnalysis.categories,
        h.skillValues = equipAnalysis.skillValues),
        
        o[a].chef.chefId && r) {
            o[a].equip = t[u],
            setDataForChef(o[a].chef, o[a].equip, !0, s.calGlobalUltimateData, p[a], s.calSelfUltimateData, s.calActivityUltimateData, !0, s, !0, s.calQixiaData || null);
            var m = JSON.parse(JSON.stringify(o[a].chef));
            for (var n in o[a].recipes)
                o[a].recipes[n].data && addCheffSkillDiff(m, o[a].recipes[n].data);
            var v = getChefSillDiff(m, o[a].chef);
            "" != v && (h.content += "<span class='skill'>" + v + "</span>",
            h.class = "warning-skill"),
            o[a].chef = m;
            var b = getPartialRecipeAdds(o, s)
              , g = getIntentAdds(e, o, i, !1)
              , k = 0;
            for (var y in o)
                for (var x in o[y].recipes)
                    if (o[y].recipes[x].data) {
                        var D = getRecipeResult(o[y].chef, o[y].equip, o[y].recipes[x].data, o[y].recipes[x].quantity, o[y].recipes[x].max, s.materials, s, s.decorationEffect, o[y].recipes[x].useCondiment ? o[y].condiment : null, !0, o[y].recipes, b[3 * y + Number(x)], g[3 * y + Number(x)]);
                        o[y].recipes[x] = D,
                        k += D.totalScore
                    }
            var C = calSatiety(o, s);
            s.Satiety && (k = calSatietyAdd(k, C.add)),
            h.content += "<span class='score'>" + k + "</span>",
            h.order = k
        }
        l.indexOf("equip_rarity") >= 0 && (h.content += "<span class='subtext'>" + t[u].rarityDisp + "</span>"),
        l.indexOf("equip_skill") >= 0 && (h.content += "<span class='subtext'>" + f + "</span>"),
        l.indexOf("equip_origin") >= 0 && (h.content += "<span class='subtext'>" + t[u].origin.replace(/<br>/g, " ") + "</span>"),
        c[a].equip.equipId == t[u].equipId && (h.selected = !0),
        d.push(h)
    }
    d.sort(function(e, a) {
        return a.order - e.order
    });
    h = {
        display: "无厨具",
        value: "",
        class: "hidden"
    };
    return d.unshift(h),
    d
}
function getCustomCondimentsOptions(e, a, t, i) {
    var l = $("#chk-cal-dd-show").val()
      , s = calCustomRule.rules[e]
      , c = s.custom
      , r = !1;
    for (var n in c[a].recipes)
        if (c[a].recipes[n].useCondiment) {
            r = !0;
            break
        }
    var o = JSON.parse(JSON.stringify(c))
      , p = getPartialRecipeAdds(o, s)
      , d = getIntentAdds(e, o, i, !1)
      , u = calSatiety(o, s)
      , f = [];
    for (var h in t) {
        var m = t[h].skillDisp.replace(/<br>/g, " ")
          , v = {};
        if (v.display = t[h].name,
        v.value = t[h].condimentId,
        v.content = "<span class='name'>" + t[h].name + "</span>",
        v.tokens = t[h].name + m,
        r) {
            o[a].condiment = t[h];
            var b = 0;
            for (var g in o)
                for (var k in o[g].recipes)
                    if (o[g].recipes[k].data) {
                        var y = getRecipeResult(o[g].chef, o[g].equip, o[g].recipes[k].data, o[g].recipes[k].quantity, o[g].recipes[k].max, s.materials, s, s.decorationEffect, o[g].recipes[k].useCondiment ? o[g].condiment : null, !0, o[g].recipes, p[3 * g + Number(k)], d[3 * g + Number(k)]);
                        o[g].recipes[k] = y,
                        b += y.totalScore
                    }
            s.Satiety && (b = calSatietyAdd(b, u.add)),
            v.content += "<span class='score'>" + b + "</span>",
            v.order = b
        }
        l.indexOf("condiment_rarity") >= 0 && (v.content += "<span class='subtext'>" + t[h].rarityDisp + "</span>"),
        l.indexOf("condiment_skill") >= 0 && (v.content += "<span class='subtext'>" + m + "</span>"),
        l.indexOf("condiment_origin") >= 0 && (v.content += "<span class='subtext'>" + t[h].origin.replace(/<br>/g, " ") + "</span>"),
        c[a].condiment.condimentId == t[h].condimentId && (v.selected = !0),
        f.push(v)
    }
    r && f.sort(function(e, a) {
        return a.order - e.order
    });
    v = {
        display: "无调料",
        value: "",
        class: "hidden"
    };
    return f.unshift(v),
    f
}
function getCustomRecipesOptions(e, a, t, i) {
    var l = $("#chk-cal-got").prop("checked")
      , s = $("#chk-cal-recipe-rarity").val()
      , c = $("#chk-cal-recipe-skill").val()
      , r = $("#chk-cal-recipe-multiple-skill").prop("checked")
      , n = $("#chk-cal-recipe-condiment").val()
      , o = $("#select-cal-order").val()
      , p = $(".cal-custom-item:eq(" + e + ") .selected-item:eq(" + a + ") .recipe-box:eq(" + t + ") .recipe-condiment input").prop("checked")
      , d = $("#chk-cal-dd-show").val()
      , u = calCustomRule.rules[e]
      , f = u.custom
      , h = JSON.parse(JSON.stringify(f));
    h[a].recipes[t] = {};
    var m = JSON.parse(JSON.stringify(u.materials));
    for (var v in h)
        for (var b in h[v].recipes)
            h[v].recipes[b].data && updateMaterialsData(m, h[v].recipes[b], h[v].recipes[b].quantity, h[v].chef);
    var g = []
      , k = u.menus;
    for (var y in k) {
        var x = k[y].recipe;
        if ((!l || x.data.got) && !(s.length > 0 && s.indexOf(x.data.rarity.toString()) < 0)) {
            if (c.length > 0) {
                var D = !1;
                for (var C in c)
                    if (x.data["" + c[C]] > 0) {
                        if (D = !0,
                        !r)
                            break
                    } else if (r) {
                        D = !1;
                        break
                    }
                if (!D)
                    continue
            }
            if (!(n.length > 0 && n.indexOf(x.data.condiment) < 0)) {
                var w = {};
                w.display = x.data.name,
                w.value = x.data.recipeId,
                w.content = "<span class='name'>" + x.data.name + "</span>";
                var T, S;
                if (u.MaterialsLimit && calCustomRule.materialsAll) {
                    var remainForThis = JSON.parse(JSON.stringify(calCustomRule.materialsAll));
                    for (var tempV in h) {
                        for (var tempB in h[tempV].recipes) {
                            if (tempV == a && tempB == t) {
                                continue;
                            }
                            if (h[tempV].recipes[tempB].data && h[tempV].recipes[tempB].quantity > 0) {
                                var tempRecipe = h[tempV].recipes[tempB];
                                var tempChef = h[tempV].chef;
                                for (var tempM = 0; tempM < tempRecipe.data.materials.length; tempM++) {
                                    var tempMaterial = tempRecipe.data.materials[tempM];
                                    var tempQuantity = calMaterialReduce(tempChef, tempMaterial.material, tempMaterial.quantity);
                                    remainForThis[tempMaterial.material] -= (tempQuantity * tempRecipe.quantity);
                                }
                            }
                        }
                    }
                    var materialMaxT = calculateMaterialLimit(remainForThis, x.data, h[a].chef);
                    var recipeMaxT = getRecipeQuantity(x.data, m, u, h[a].chef);
                    T = Math.min(materialMaxT, recipeMaxT);
                    
                    // S使用全部食材计算，不考虑其他菜谱的消耗
                    var materialMaxS = calculateMaterialLimit(calCustomRule.materialsAll, x.data, h[a].chef);
                    var recipeMaxS = getRecipeQuantity(x.data, u.materials, u, h[a].chef);
                    S = Math.min(materialMaxS, recipeMaxS);
                    
                    if (u.DisableMultiCookbook) {
                        T = Math.min(T, 1);
                        S = Math.min(S, 1);
                    }
                } else {
                    T = getRecipeQuantity(x.data, m, u, h[a].chef);
                    S = getRecipeQuantity(x.data, u.materials, u, h[a].chef);
                }
                h[a].recipes[t] = x,
                h[a].recipes[t].useCondiment = p,
                h[a].recipes[t].quantity = T,
                h[a].recipes[t].max = S;
                var q = getPartialRecipeAdds(h, u)
                  , E = getIntentAdds(e, h, i, !1)
                  , I = 0
                  , R = x.totalScore
                  , RWithT = 0
                  , RWithS = 0
                  , N = x.efficiency
                  , A = "";
                for (var b in h)
                    for (var v in h[b].recipes)
                        if (h[b].recipes[v].data) {
                            var M = getRecipeResult(h[b].chef, h[b].equip, h[b].recipes[v].data, h[b].recipes[v].quantity, h[b].recipes[v].max, u.materials, u, u.decorationEffect, h[b].recipes[v].useCondiment ? h[b].condiment : null, !0, h[b].recipes, q[3 * b + Number(v)], E[3 * b + Number(v)]);
                            if (I += M.totalScore,
                            b == a && v == t) {
                                // 计算使用T份数的分数
                                var MWithT = getRecipeResult(h[b].chef, h[b].equip, h[b].recipes[v].data, T, S, u.materials, u, u.decorationEffect, h[b].recipes[v].useCondiment ? h[b].condiment : null, !0, h[b].recipes, q[3 * b + Number(v)], E[3 * b + Number(v)]);
                                RWithT = MWithT.totalScore;
                                
                                // 计算使用S份数的分数
                                M = getRecipeResult(h[b].chef, h[b].equip, h[b].recipes[v].data, S, S, u.materials, u, u.decorationEffect, h[b].recipes[v].useCondiment ? h[b].condiment : null, !0, h[b].recipes, q[3 * b + Number(v)], E[3 * b + Number(v)]);
                                RWithS = M.totalScore;
                                R = RWithS;
                                N = M.efficiency;
                                
                                if (0 == M.rankVal) {
                                    var O = getSkillDiff(h[a].chef, x.data, 1);
                                    A = O.disp
                                }
                            }
                            h[b].recipes[v] = M
                        }
                var _ = calSatiety(h, u);
                for (var G in u.Satiety && (I = calSatietyAdd(I, _.add)),
                calCustomRule.rules) {
                    var P = calCustomRule.rules[G].custom;
                    for (var v in P)
                        for (var b in P[v].recipes)
                            if (P[v].recipes[b].data && P[v].recipes[b].data.recipeId == x.data.recipeId) {
                                if (G == e && v == a && b == t)
                                    continue;
                                w.disabled = !0,
                                I = 0
                            }
                }
                
                // 如果菜谱已在其他位置选择，跳过不添加到列表
                if (w.disabled) {
                    continue;
                }
                
                if (w.class = "",
                "" != A && (w.content += "<span class='skill'>" + A + "</span>",
                w.class += "warning-skill"),
                d.indexOf("recipe_rank") >= 0) {
                    var V = h[a].recipes[t].rankDisp;
                    V && "-" != V && (w.content += "<span class='subtext'>" + V + "</span>")
                }
                
                // 有食材限制时，显示份数信息（格式：可制作/最大）
                if (u.MaterialsLimit && calCustomRule.materialsAll && T !== undefined && S !== undefined) {
                    if (T < S) {
                        w.content += "<span class='subtext' style='color: #0066cc;'>" + T + "/" + S + "</span>";
                    } else {
                        w.content += "<span class='subtext'>" + T + "/" + S + "</span>";
                    }
                }
                
                if (u.hasOwnProperty("MaterialsNum")) {
                    var L = R / x.max * T;
                    T < x.max ? w.content += "<span class='available'>" + T + "/" + x.max + " " + L + "/" + R + "</span><span class='total'>" + I + "</span>" : w.content += "<span class='subtext'>" + T + "/" + x.max + " " + L + "</span><span class='total'>" + I + "</span>",
                    w.order = I
                } else {
                    // 检查是否为贵客率计算模式
                    var isGuestRateModeFlag = calCustomRule && calCustomRule.isGuestRate === true;
                    
                    if (isGuestRateModeFlag) {
                        // 贵客率计算模式：显示贵客信息
                        if (i && i.guests) {
                            var guestNames = [];
                            // 查找该菜谱对应的所有贵客
                            for (var guestIdx = 0; guestIdx < i.guests.length; guestIdx++) {
                                var guest = i.guests[guestIdx];
                                if (guest.gifts) {
                                    for (var giftIdx = 0; giftIdx < guest.gifts.length; giftIdx++) {
                                        var gift = guest.gifts[giftIdx];
                                        if (gift.recipe === x.data.name) {
                                            guestNames.push(guest.name);
                                            break;
                                        }
                                    }
                                }
                            }
                            
                            // 显示贵客信息
                            if (guestNames.length > 0) {
                                w.content += "<span class='subtext'>(" + guestNames.join('、') + ")</span>";
                            }
                        }
                        // 按时间排序
                        w.order = x.data.totalTime || 0;
                    } else {
                        // 非贵客率计算模式：显示分数
                        if ("分数" == o) {
                            if (T < S && u.MaterialsLimit && calCustomRule.materialsAll) {
                                w.content += "<span class='score' style='color: #0066cc;'>" + RWithT + "/" + RWithS + "</span><span class='total'>" + I + "</span>";
                            } else {
                                w.content += "<span class='score'>" + R + "</span><span class='total'>" + I + "</span>";
                            }
                            w.order = I;
                        } else if ("时间" == o) {
                            w.content += "<span class='score'>" + x.data.totalTimeDisp + "</span>";
                            w.order = x.data.totalTime;
                        } else if ("效率" == o) {
                            w.content += "<span class='score'>" + N + "</span>";
                            w.order = N;
                        }
                    }
                }
                d.indexOf("recipe_condiment") >= 0 && (w.content += "<span class='subtext'>" + x.data.condimentDisp + "</span>"),
                d.indexOf("recipe_rarity") >= 0 && (w.content += "<span class='subtext'>" + x.data.rarityDisp + "</span>"),
                d.indexOf("recipe_skill") >= 0 && (w.content += "<span class='skilltext'>" + x.data.skillDisp + "</span>"),
                d.indexOf("recipe_material") >= 0 && (w.content += "<span class='subtext'>" + x.data.materialsDisp.replace(/\*/g, "") + "</span>"),
                d.indexOf("recipe_origin") >= 0 && (w.content += "<span class='subtext'>" + x.data.origin.replace(/<br>/g, " ") + "</span>"),
                
                // 贵客率计算模式：添加符文分类信息
                // 使用 GuestRateCalculator 处理符文和贵客信息
                f[a].recipes[t].data && f[a].recipes[t].data.recipeId == x.data.recipeId && (w.selected = !0);
                
                // 如果是贵客率模式，使用 GuestRateCalculator 处理符文和贵客信息
                if (typeof GuestRateCalculator !== 'undefined' && GuestRateCalculator.addRuneAndGuestInfoToRecipeOption) {
                    var optionResults = GuestRateCalculator.addRuneAndGuestInfoToRecipeOption(w, x.data, i);
                    for (var optIdx = 0; optIdx < optionResults.length; optIdx++) {
                        g.push(optionResults[optIdx]);
                    }
                } else {
                    // 非贵客率模式或函数不存在，直接添加
                    g.push(w);
                }
            }
        }
    }
    g.sort(function(e, a) {
        return a.order - e.order
    });
    w = {
        display: "无菜谱",
        value: "",
        class: "hidden"
    };
    return g.unshift(w),
    g
}
function updateCalMenus() {
    // 检查 calCustomRule.rules 是否存在且有元素
    if (!calCustomRule.rules || calCustomRule.rules.length === 0) {
        return;
    }
    var e = calCustomRule.rules[0];
    // 检查 custom 属性是否存在
    if (!e.custom) {
        return;
    }
    var a = e.custom;
    for (var t in e.menus) {
        var i;
        if (e.MaterialsLimit && calCustomRule.materialsAll) {
            var remain = getRemainMaterials(0, -1, -1);
            i = calculateMaterialLimit(remain, e.menus[t].recipe.data, null);
            if (e.DisableMultiCookbook) {
                i = Math.min(i, 1);
            }
            for (var l in a)
                for (var s in a[l].recipes)
                    if (a[l].recipes[s].data && e.menus[t].recipe.data.recipeId == a[l].recipes[s].data.recipeId) {
                        i -= a[l].recipes[s].quantity;
                    }
            i = Math.max(0, i);
        } else {
            i = getRecipeQuantity(e.menus[t].recipe.data, e.rest, e, null);
            for (var l in a)
                for (var s in a[l].recipes)
                    if (a[l].recipes[s].data && e.menus[t].recipe.data.recipeId == a[l].recipes[s].data.recipeId) {
                        var c = e.menus[t].recipe.max - a[l].recipes[s].quantity;
                        c < 0 ? i = 0 : i > c && (i = c)
                    }
        }
        e.menus[t].recipe.available = i,
        e.menus[t].recipe.availableScore = Math.ceil(+(e.menus[t].recipe.totalScore / e.menus[t].recipe.max * i).toFixed(2))
    }
}
function calRecipesResults() {
    var e = $("#cal-recipes-table").DataTable()
      , a = e.rows({
        order: "applied"
    }).data().toArray()
      , t = e.rows({
        selected: !0
    }).data().toArray();
    updateCalMenus(),
    e.clear().rows.add(a),
    $("#chk-cal-results-lock-order").prop("checked") && e.order([]),
    e.rows(function(e, a, i) {
        for (var l in t)
            if (a.recipe.data.recipeId == t[l].recipe.data.recipeId)
                return !0;
        return !1
    }).select(),
    e.draw()
}
function sortRecipesResult() {
    var e = 7
      , a = $("#select-cal-order").val();
    "分数" == a ? e = 7 : "时间" == a ? e = 9 : "效率" == a && (e = 10);
    var t = !1
      , i = $("#cal-recipes-table").DataTable()
      , l = i.order();
    for (var s in l)
        if (l[s][0] == e && "desc" == l[s][1]) {
            t = !0;
            break
        }
    t || i.order([e, "desc"]).draw()
}
function checkMaterials(e, a) {
    var t = JSON.parse(JSON.stringify(a));
    for (var i in e) {
        var l = e[i].chef;
        for (var s in e[i].recipes) {
            var c = e[i].recipes[s];
            if (c.data)
                for (var r in c.data.materials)
                    for (var n in t)
                        if (c.data.materials[r].material == t[n].materialId) {
                            if (Number.isInteger(parseInt(t[n].quantity))) {
                                var o = calMaterialReduce(l, c.data.materials[r].material, c.data.materials[r].quantity);
                                t[n].quantity -= o * c.quantity
                            }
                            break
                        }
        }
    }
    var p = []
      , d = "";
    for (var n in t)
        t[n].quantity < 0 && (p.push(t[n].materialId),
        d += t[n].name + t[n].quantity);
    return {
        materials: t,
        lackIds: p,
        message: d
    }
}
function initCalChefsTable(e) {
    var a = [{
        data: void 0,
        defaultContent: "",
        className: "select-checkbox nodetails all",
        orderDataType: "dom-selected",
        orderSequence: ["desc", "asc"],
        width: "30px"
    }, {
        data: void 0,
        defaultContent: "<span class='glyphicon'></span>",
        className: "td-expend",
        orderable: !1,
        searchable: !1,
        visible: expendBtn,
        width: "1px"
    }, {
        data: "galleryId",
        width: "1px"
    }, {
        data: "name",
        width: "81px",
        className: "all"
    }, {
        data: {
            _: "rarity",
            display: "rarityDisp"
        },
        className: "rarity",
        width: "50px",
        orderSequence: ["desc", "asc"]
    }, {
        data: {
            _: "stirfryVal",
            display: "stirfryDisp"
        },
        width: "20px",
        orderSequence: ["desc", "asc"]
    }, {
        data: {
            _: "boilVal",
            display: "boilDisp"
        },
        width: "20px",
        orderSequence: ["desc", "asc"]
    }, {
        data: {
            _: "knifeVal",
            display: "knifeDisp"
        },
        width: "20px",
        orderSequence: ["desc", "asc"]
    }, {
        data: {
            _: "fryVal",
            display: "fryDisp"
        },
        width: "20px",
        orderSequence: ["desc", "asc"]
    }, {
        data: {
            _: "bakeVal",
            display: "bakeDisp"
        },
        width: "20px",
        orderSequence: ["desc", "asc"]
    }, {
        data: {
            _: "steamVal",
            display: "steamDisp"
        },
        width: "20px",
        orderSequence: ["desc", "asc"]
    }, {
        data: "specialSkillDisp"
    }, {
        data: "gender",
        width: "30px"
    }, {
        data: "origin"
    }, {
        data: "tagsDisp",
        defaultContent: ""
    }, {
        data: "addition",
        className: "all",
        orderSequence: ["desc", "asc"],
        width: "38px"
    }, {
        data: {
            _: "equipId",
            display: "equipDisp"
        },
        className: "cal-td-select-equip nodetails all",
        width: "101px"
    }]
      , t = !0
      , i = !1
      , l = !1;
    isMobile && (t = !1,
    i = !0,
    l = {
        left: [0, 3]
    });
    var s = "td:not(.nodetails)";
    expendBtn && (s = ".td-expend");
    var c = $("#cal-chefs-table").DataTable({
        data: [],
        columns: a,
        language: {
            search: "查找:",
            zeroRecords: "没有找到",
            info: "_TOTAL_个",
            infoEmpty: "0",
            infoFiltered: "/ _MAX_",
            select: {
                rows: {
                    _: "选择了 %d 个厨师",
                    0: "选择了 %d 个厨师",
                    1: "选择了 %d 个厨师"
                }
            }
        },
        pagingType: "numbers",
        pageLength: Number($("#select-setting-page-length").val()),
        dom: "<'table-top clearfix'<'left'i><'right'<'search-box'>>><'row'<'col-sm-12'tr>><'row'<'col-sm-12'p>>",
        select: {
            style: "multi",
            selector: "td.select-checkbox"
        },
        deferRender: !1,
        autoWidth: !1,
        fixedHeader: t,
        scrollX: i,
        fixedColumns: l,
        createdRow: function(e, a, t) {
            $(e).addClass("rarity-" + a.rarity)
        },
        responsive: {
            details: {
                type: "column",
                target: s,
                renderer: function(e, a, t) {
                    var i = "";
                    for (var l in t)
                        if (t[l].hidden) {
                            if (l < 2)
                                continue;
                            if (l > 5 && l <= 10)
                                continue;
                            if (5 == l) {
                                i += "<div class='col-lg-3 col-xs-6'>";
                                for (var s = 5; s <= 10; s++)
                                    t[s].data && (i += "<span class='child-key'>" + t[s].title + "</span><span class='child-value'>" + t[s].data + "</span>");
                                i += "</div>"
                            } else
                                i += "<div class='col-lg-3 col-xs-6'><span class='child-key'>" + t[l].title + (l < 3 ? "" : "：") + "</span><span class='child-value'>" + t[l].data + "</span></div>"
                        }
                    return !!i && "<div class='child-inner'" + getResponsiveStyle($("#cal-chefs-table")) + ">" + i + "</div>"
                }
            }
        }
    });
    $("#pane-cal-chefs div.search-box").html('<input type="search" class="form-control input-sm monitor-none" placeholder="查找 名字 性别">'),
    $.fn.dataTableExt.afnFiltering.push(function(e, a, t, i, l) {
        if (e.nTable != document.getElementById("cal-chefs-table"))
            return !0;
        var s = $.trim($("#pane-cal-chefs .search-box input").val());
        return !!commaSeparatedMatch(i.name, s) || (!!commaSeparatedMatch(i.gender, s) || !!commaSeparatedMatch(i.tagsDisp, s))
    });
    var r = getEquipsOptions(e.equips, !0);
    c.MakeCellsEditable({
        columns: [16],
        inputTypes: [{
            column: 16,
            type: "list",
            search: !0,
            clear: !0,
            done: !0,
            options: r
        }],
        onUpdate: function(a, t, i, l) {
            if (16 == i.index().column) {
                var s = t.data()
                  , r = null
                  , n = ""
                  , o = getEquipInfo(s.equipId, e.equips);
                o && (r = o,
                n = o.disp),
                s.equip = r,
                s.equipDisp = n,
                t.data(s),
                c.draw(!1)
            }
        }
    }),
    $("#chk-cal-chefs-show").on("changed.bs.select", function() {
        initCalChefsShow(c)
    }),
    $('.chk-cal-chefs-rarity input[type="checkbox"]').click(function() {
        var e = $(this).attr("data-rarity");
        $(this).prop("checked") ? c.rows(".rarity-" + e, {
            search: "applied"
        }).select() : c.rows(".rarity-" + e).deselect()
    }),
    $("#btn-cal-chefs-equip-clear").click(function() {
        c.rows().every(function(e, a, t) {
            var i = this.data();
            i.equip = null,
            i.equipId = "",
            i.equipDisp = "",
            this.data(i)
        })
    }),
    $("#pane-cal-chefs .search-box input").on("input", function() {
        c.draw(),
        changeInputStyle(this)
    }),
    $("#btn-cal-chefs-select-all").click(function() {
        $('.chk-cal-chefs-rarity input[type="checkbox"]').prop("checked", !0),
        c.rows({
            search: "applied"
        }).select()
    }),
    $("#btn-cal-chefs-deselect-all").click(function() {
        $('.chk-cal-chefs-rarity input[type="checkbox"]').prop("checked", !1),
        c.rows().deselect()
    }),
    $("#btn-cal-chefs-export").click(function() {
        var e = $("#cal-chefs-table").DataTable().rows({
            selected: !0
        }).data().toArray()
          , a = {
            calChefs: []
        };
        for (var t in e)
            a.calChefs.push(e[t].chefId);
        $("#input-export-import").val(JSON.stringify(a))
    }),
    initTableResponsiveDisplayEvent(c),
    initTableScrollEvent("#pane-cal-chefs"),
    initCalChefsShow(c)
}
function initCalEquipsTable(e) {
    var a = [{
        data: void 0,
        defaultContent: "",
        className: "select-checkbox nodetails all",
        orderDataType: "dom-selected",
        orderSequence: ["desc", "asc"],
        width: "30px"
    }, {
        data: void 0,
        defaultContent: "<span class='glyphicon'></span>",
        className: "td-expend",
        orderable: !1,
        searchable: !1,
        visible: expendBtn,
        width: "1px"
    }, {
        data: "galleryId",
        width: "1px"
    }, {
        data: "name",
        width: "80px",
        className: "all"
    }, {
        data: {
            _: "rarity",
            display: "rarityDisp"
        },
        className: "rarity",
        width: "35px",
        orderSequence: ["desc", "asc"]
    }, {
        data: "skillDisp"
    }, {
        data: "origin"
    }]
      , t = !0
      , i = !1
      , l = !1;
    isMobile && (t = !1,
    i = !0,
    l = {
        left: [0, 3]
    });
    var s = "td:not(.nodetails)";
    expendBtn && (s = ".td-expend");
    var c = $("#cal-equips-table").DataTable({
        data: [],
        columns: a,
        language: {
            search: "查找:",
            zeroRecords: "没有找到",
            info: "_TOTAL_个",
            infoEmpty: "0",
            infoFiltered: "/ _MAX_",
            select: {
                rows: {
                    _: "选择了 %d 个厨具",
                    0: "选择了 %d 个厨具",
                    1: "选择了 %d 个厨具"
                }
            }
        },
        pagingType: "numbers",
        pageLength: Number($("#select-setting-page-length").val()),
        dom: "<'table-top clearfix'<'left'i><'right'<'search-box'>>><'row'<'col-sm-12'tr>><'row'<'col-sm-12'p>>",
        select: {
            style: "multi",
            selector: "td.select-checkbox"
        },
        order: [[5, "desc"]],
        deferRender: !1,
        autoWidth: !1,
        fixedHeader: t,
        scrollX: i,
        fixedColumns: l,
        createdRow: function(e, a, t) {
            $(e).addClass("rarity-" + a.rarity)
        },
        responsive: {
            details: {
                type: "column",
                target: s,
                renderer: function(e, a, t) {
                    var i = "";
                    for (var l in t)
                        if (t[l].hidden) {
                            if (l < 2)
                                continue;
                            i += "<div class='col-lg-3 col-xs-6'><span class='child-key'>" + t[l].title + (l < 3 ? "" : "：") + "</span><span class='child-value'>" + t[l].data + "</span></div>"
                        }
                    return !!i && "<div class='child-inner'" + getResponsiveStyle($("#cal-equips-table")) + ">" + i + "</div>"
                }
            }
        }
    });
    $("#pane-cal-equips div.search-box").html('<input type="search" class="form-control input-sm monitor-none" placeholder="查找 名字 技能 来源">'),
    $.fn.dataTableExt.afnFiltering.push(function(e, a, t, i, l) {
        if (e.nTable != document.getElementById("cal-equips-table"))
            return !0;
        var s = $.trim($("#pane-cal-equips .search-box input").val());
        return !!commaSeparatedMatch(i.name, s) || (!!commaSeparatedMatch(i.skillDisp, s) || !!commaSeparatedMatch(i.origin, s))
    }),
    $("#chk-cal-equips-show").on("changed.bs.select", function() {
        initCalEquipsShow(c)
    }),
    $('.chk-cal-equips-rarity input[type="checkbox"]').click(function() {
        var e = $(this).attr("data-rarity");
        $(this).prop("checked") ? c.rows(".rarity-" + e).select() : c.rows(".rarity-" + e).deselect()
    }),
    $("#pane-cal-equips .search-box input").on("input", function() {
        c.draw(),
        changeInputStyle(this)
    }),
    $("#btn-cal-equips-select-all").click(function() {
        $('.chk-cal-equips-rarity input[type="checkbox"]').prop("checked", !0),
        c.rows().select()
    }),
    $("#btn-cal-equips-deselect-all").click(function() {
        $('.chk-cal-equips-rarity input[type="checkbox"]').prop("checked", !1),
        c.rows().deselect()
    }),
    $("#btn-cal-equips-export").click(function() {
        var e = $("#cal-equips-table").DataTable().rows({
            selected: !0
        }).data().toArray()
          , a = {
            calEquips: []
        };
        for (var t in e)
            a.calEquips.push(e[t].equipId);
        $("#input-export-import").val(JSON.stringify(a))
    }),
    initTableResponsiveDisplayEvent(c),
    initTableScrollEvent("#pane-cal-equips"),
    initCalEquipsShow(c)
}
function initCalMaterialsTable(e) {
    var a = [{
        data: void 0,
        defaultContent: "",
        className: "select-checkbox nodetails all",
        orderDataType: "dom-selected",
        orderSequence: ["desc", "asc"],
        width: "30px"
    }, {
        data: void 0,
        defaultContent: "<span class='glyphicon'></span>",
        className: "td-expend",
        orderable: !1,
        searchable: !1,
        visible: expendBtn,
        width: "1px"
    }, {
        data: "materialId",
        width: "1px"
    }, {
        data: "name",
        className: "all"
    }, {
        data: "origin"
    }, {
        data: "quantity",
        className: "all",
        orderSequence: ["desc", "asc"],
        width: "50px"
    }, {
        data: "addition",
        className: "all",
        orderSequence: ["desc", "asc"],
        width: "50px"
    }]
      , t = !0
      , i = !1
      , l = !1;
    isMobile && (t = !1,
    i = !0,
    l = {
        left: [0, 3]
    });
    var s = "td:not(.nodetails)";
    expendBtn && (s = ".td-expend");
    var c = $("#cal-materials-table").DataTable({
        data: [],
        columns: a,
        language: {
            search: "查找:",
            zeroRecords: "没有找到",
            info: "_TOTAL_个",
            infoEmpty: "0",
            infoFiltered: "/ _MAX_",
            select: {
                rows: {
                    _: "选择了 %d 个食材",
                    0: "选择了 %d 个食材",
                    1: "选择了 %d 个食材"
                }
            }
        },
        pagingType: "numbers",
        pageLength: Number($("#select-setting-page-length").val()),
        dom: "<'table-top clearfix'<'left'i><'right'<'search-box'>>><'row'<'col-sm-12'tr>><'row'<'col-sm-12'p>>",
        select: {
            style: "multi",
            selector: "td.select-checkbox"
        },
        order: [[4, "desc"]],
        deferRender: !1,
        autoWidth: !1,
        fixedHeader: t,
        scrollX: i,
        fixedColumns: l,
        createdRow: function(e, a, t) {
            $(e).addClass("origin-" + a.originVal)
        },
        responsive: {
            details: {
                type: "column",
                target: s,
                renderer: function(e, a, t) {
                    var i = "";
                    for (var l in t)
                        if (t[l].hidden) {
                            if (l < 2)
                                continue;
                            i += "<div class='col-lg-3 col-xs-6'><span class='child-key'>" + t[l].title + (l < 3 ? "" : "：") + "</span><span class='child-value'>" + t[l].data + "</span></div>"
                        }
                    return !!i && "<div class='child-inner'" + getResponsiveStyle($("#cal-materials-table")) + ">" + i + "</div>"
                }
            }
        }
    });
    $("#pane-cal-materials div.search-box").html('<input type="search" class="form-control input-sm monitor-none" placeholder="查找 名字 来源">'),
    $.fn.dataTableExt.afnFiltering.push(function(e, a, t, i, l) {
        if (e.nTable != document.getElementById("cal-materials-table"))
            return !0;
        var s = $.trim($("#pane-cal-materials .search-box input").val());
        return !!commaSeparatedMatch(i.name, s) || !!commaSeparatedMatch(i.origin, s)
    }),
    $("#chk-cal-materials-show").on("changed.bs.select", function() {
        initCalMaterialsShow(c)
    }),
    $('.chk-cal-materials-origin input[type="checkbox"]').click(function() {
        var e = $(this).attr("data-origin");
        $(this).prop("checked") ? c.rows(".origin-" + e).select() : c.rows(".origin-" + e).deselect()
    }),
    $("#pane-cal-materials .search-box input").on("input", function() {
        c.draw(),
        changeInputStyle(this)
    }),
    $("#btn-cal-materials-select-all").click(function() {
        $('.chk-cal-materials-origin input[type="checkbox"]').prop("checked", !0),
        c.rows().select()
    }),
    $("#btn-cal-materials-deselect-all").click(function() {
        $('.chk-cal-materials-origin input[type="checkbox"]').prop("checked", !1),
        c.rows().deselect()
    }),
    initTableResponsiveDisplayEvent(c),
    initTableScrollEvent("#pane-cal-materials"),
    initCalMaterialsShow(c)
}
function initCalCustomTable(e) {
    var a = $(".selected-item .chef-box-2 .disk-box")[0].outerHTML;
    $(".selected-item .chef-box-2").append(a).append(a);
    var t = $(".selected-item .recipe-box")[0].outerHTML;
    $(".selected-item").append(t).append(t);
    var i = $(".selected-item")[0].outerHTML;
    $(".selected-item-wrapper").append(i).append(i).append(i);
    var l = $(".cal-custom-item")[0].outerHTML;
    if ($("#pane-cal-custom").append(l).append(l),
    $(".selected-item-wrapper .select-picker select").on("show.bs.select", function(e) {
        $(this).closest(".edit-box").addClass("editing"),
        $("body").addClass("m-no-scroll")
    }),
    $(".selected-item-wrapper .select-picker select").on("hide.bs.select", function(e) {
        $(this).closest(".edit-box").removeClass("editing"),
        $("body").removeClass("m-no-scroll")
    }),
    $(".chef-box .chef-placeholder, .chef-box .chef-box-1").click(function() {
        var a = $(".cal-custom-item").index($(this).closest(".cal-custom-item"))
          , t = $(this).closest(".cal-custom-item").find(".selected-item").index($(this).closest(".selected-item"))
          , i = getCustomChefsOptions(a, t, e);
        $(this).closest(".chef-box").find("select.select-picker-chef").html(getOptionsString(i)).selectpicker("refresh").selectpicker("toggle")
    }),
    $("select.select-picker-chef").on("changed.bs.select", function(a, t, i, l) {
        var s = $(".cal-custom-item").index($(this).closest(".cal-custom-item"))
          , c = $(this).closest(".cal-custom-item").find(".selected-item").index($(this).closest(".selected-item"))
          , r = $(this).val();
        setCustomChef(s, c, r),
        calCustomResults(e)
    }),
    $(".disk-level-box").click(function() {
        var a = $(".cal-custom-item").index($(this).closest(".cal-custom-item"))
          , t = $(this).closest(".cal-custom-item").find(".selected-item").index($(this).closest(".selected-item"))
          , i = getCustomDiskLevelsOptions(a, t, e);
        $(this).find("select.select-picker-disk-level").html(getOptionsString(i)).selectpicker("refresh").selectpicker("toggle")
    }),
    $("select.select-picker-disk-level").on("changed.bs.select", function(a, t, i, l) {
        var s = $(".cal-custom-item").index($(this).closest(".cal-custom-item"))
          , c = $(this).closest(".cal-custom-item").find(".selected-item").index($(this).closest(".selected-item"))
          , r = Number($(this).val());
        setCustomDiskLevel(s, c, r),
        calCustomResults(e)
    }),
    $(".disk-box").click(function() {
        var a = $(".cal-custom-item").index($(this).closest(".cal-custom-item"))
          , t = $(this).closest(".cal-custom-item").find(".selected-item").index($(this).closest(".selected-item"))
          , i = $(this).closest(".chef-box").find(".disk-box").index($(this).closest(".disk-box"))
          , l = calCustomRule.rules[a]
          , s = getCustomAmbersOptions(a, t, i, l.ambers, e);
        $(this).find("select.select-picker-amber").html(getOptionsString(s)).selectpicker("refresh").selectpicker("toggle")
    }),
    $("select.select-picker-amber").on("changed.bs.select", function(a, t, i, l) {
        var s = $(".cal-custom-item").index($(this).closest(".cal-custom-item"))
          , c = $(this).closest(".cal-custom-item").find(".selected-item").index($(this).closest(".selected-item"))
          , r = $(this).closest(".chef-box").find(".disk-box").index($(this).closest(".disk-box"))
          , n = $(this).val();
        setCustomAmber(s, c, r, n),
        calCustomResults(e)
    }),
    $(".equip-box").click(function() {
        var a = $(".cal-custom-item").index($(this).closest(".cal-custom-item"))
          , t = $(this).closest(".cal-custom-item").find(".selected-item").index($(this).closest(".selected-item"))
          , i = calCustomRule.rules[a]
          , l = getCustomEquipsOptions(a, t, i.equips, e);
        $(this).find("select.select-picker-equip").html(getOptionsString(l)).selectpicker("refresh").selectpicker("toggle")
    }),
    $("select.select-picker-equip").on("changed.bs.select", function(a, t, i, l) {
        var s = $(".cal-custom-item").index($(this).closest(".cal-custom-item"))
          , c = $(this).closest(".cal-custom-item").find(".selected-item").index($(this).closest(".selected-item"))
          , r = $(this).val();
        setCustomEquip(s, c, r),
        calCustomResults(e)
    }),
    $(".condiment-box").click(function() {
        var a = $(".cal-custom-item").index($(this).closest(".cal-custom-item"))
          , t = $(this).closest(".cal-custom-item").find(".selected-item").index($(this).closest(".selected-item"))
          , i = getCustomCondimentsOptions(a, t, e.condiments, e);
        $(this).find("select.select-picker-condiment").html(getOptionsString(i)).selectpicker("refresh").selectpicker("toggle")
    }),
    $("select.select-picker-condiment").on("changed.bs.select", function(a, t, i, l) {
        var s = $(".cal-custom-item").index($(this).closest(".cal-custom-item"))
          , c = $(this).closest(".cal-custom-item").find(".selected-item").index($(this).closest(".selected-item"))
          , r = $(this).val();
        setCustomCondiment(s, c, r, e),
        calCustomResults(e)
    }),
    $(".recipe-box .recipe-placeholder, .recipe-box .content, .recipe-box .recipe-result, .recipe-box .recipe-box-2").click(function() {
        var a = $(".cal-custom-item").index($(this).closest(".cal-custom-item"))
          , t = $(this).closest(".cal-custom-item").find(".selected-item").index($(this).closest(".selected-item"))
          , i = $(this).closest(".selected-item").find(".recipe-box").index($(this).closest(".recipe-box"))
          , l = getCustomRecipesOptions(a, t, i, e);
        $(this).closest(".recipe-box").find("select.select-picker-recipe").html(getOptionsString(l)).selectpicker("refresh").selectpicker("toggle")
    }),
    $("select.select-picker-recipe").on("changed.bs.select", function(a, t, i, l) {
        var s = $(".cal-custom-item").index($(this).closest(".cal-custom-item"))
          , c = $(this).closest(".cal-custom-item").find(".selected-item").index($(this).closest(".selected-item"))
          , r = $(this).closest(".selected-item").find(".recipe-box").index($(this).closest(".recipe-box"))
          , n = $(this).val();
        setCustomRecipe(s, c, r, n),
        calCustomResults(e);
        var o = calCustomRule.rules[s];
        o.hasOwnProperty("MaterialsNum") && $("#pane-cal-recipes").attr("data-cal", "false")
    }),
    $(".recipe-box .recipe-quantity").click(function() {
        $(this).find("input").focus()
    }),
    $(".recipe-box .recipe-quantity input").on("input", function() {
        var a = $(".cal-custom-item").index($(this).closest(".cal-custom-item"))
          , t = $(this).closest(".cal-custom-item").find(".selected-item").index($(this).closest(".selected-item"))
          , i = $(this).closest(".selected-item").find(".recipe-box").index($(this).closest(".recipe-box"))
          , l = $(this).val();
        setCustomRecipeQuantity(a, t, i, l),
        calCustomResults(e);
        var s = calCustomRule.rules[a];
        s.hasOwnProperty("MaterialsNum") && $("#pane-cal-recipes").attr("data-cal", "false")
    }),
    $(".recipe-box .recipe-ex input").click(function() {
        var e = $(".cal-custom-item").index($(this).closest(".cal-custom-item"))
          , a = $(this).closest(".cal-custom-item").find(".selected-item").index($(this).closest(".selected-item"))
          , t = $(this).closest(".selected-item").find(".recipe-box").index($(this).closest(".recipe-box"))
          , i = calCustomRule.rules[e]
          , l = i.custom
          , s = l[a].recipes[t].data.recipeId.toString()
          , c = $("#chk-cal-ex").val()
          , r = c.indexOf(s);
        r < 0 ? c.push(s) : c.splice(r, 1),
        $("#chk-cal-ex").selectpicker("val", c)
    }),
    $(".recipe-box .recipe-condiment input").click(function() {
        calCustomResults(e)
    }),
    $(".btn-resize").click(function() {
        $(this).hasClass("glyphicon-resize-small") ? ($(this).closest(".cal-custom-item").find(".rule-desc").hide(),
        $(this).closest(".cal-custom-item").find(".selected-item-wrapper").hide(),
        $(this).addClass("glyphicon-resize-full").removeClass("glyphicon-resize-small")) : ($(this).closest(".cal-custom-item").find(".rule-desc").show(),
        $(this).closest(".cal-custom-item").find(".selected-item-wrapper").show(),
        $(this).addClass("glyphicon-resize-small").removeClass("glyphicon-resize-full"))
    }),
    private) {
        var s, c, r;
        try {
            var n = localStorage.getItem("cal");
            s = JSON.parse(n)
        } catch (e) {}
        for (var o in s || (s = []),
        s)
            $("#select-cal-save").append("<option value='" + s[o].key + "'>" + s[o].key + "</option>").selectpicker("refresh");
        $(".btn-cal-results-cal").click(function() {
            r = [];
            var a = $("#pane-cal-optimal-results");
            if (void 0 !== c && (c.terminate(),
            c = void 0),
            $("#cal-save-result").addClass("hidden"),
            $("#select-cal-save").selectpicker("val", ""),
            $(this).hasClass("stop"))
                return a.find(".cal-results-progress").addClass("hidden"),
                a.find(".btn-cal-results-cal.start").prop("disabled", !1),
                void a.find(".btn-cal-results-cal.stop").prop("disabled", !0);
            a.find(".optimal-result").html(""),
            a.find(".btn-cal-results-cal.start").prop("disabled", !0),
            a.find(".btn-cal-results-cal.stop").prop("disabled", !1),
            a.find(".cal-results-progress .progress-bar").css("width", "0%"),
            a.find(".cal-results-progress .progress-bar span").text("预处理中"),
            a.find(".cal-results-progress").removeClass("hidden"),
            c = new Worker("others/js/cal.js?v=" + (new Date).getTime()),
            c.onmessage = function(t) {
                t.data.progress ? (a.find(".cal-results-progress .progress-bar").css("width", t.data.progress.value + "%"),
                a.find(".cal-results-progress .progress-bar span").text(t.data.progress.display)) : t.data.menu ? (r = t.data.menu,
                showCalOptimalResult(r, e)) : t.data.done ? (a.find(".btn-cal-results-cal.stop").prop("disabled", !0),
                a.find(".btn-cal-results-cal.start").prop("disabled", !1),
                a.find(".cal-results-progress").addClass("hidden"),
                r.length && $("#cal-save-result").removeClass("hidden")) : t.data.error && bootbox.alert({
                    size: "small",
                    message: "<div class='text-center'>" + t.data.error + "</div>"
                })
            }
            ;
            var t = $("#cal-recipes-table").DataTable().rows({
                selected: !0
            }).data().toArray()
              , i = $("#cal-chefs-table").DataTable().rows({
                selected: !0
            }).data().toArray()
              , l = $("#cal-equips-table").DataTable().rows({
                selected: !0
            }).data().toArray()
              , s = $("#cal-materials-table").DataTable().rows({
                selected: !0
            }).data().toArray()
              , n = $("#chk-cal-results-no-equips").prop("checked")
              , o = $("#chk-cal-results-add-equips").prop("checked")
              , p = $("#chk-cal-results-change-equips").prop("checked")
              , d = $("#chk-cal-results-filter-equip-condiment").prop("checked")
              , u = $("#chk-cal-results-use-condiment").prop("checked")
              , f = Number($("#input-cal-min-score").val())
              , h = Number($("#input-cal-thread").val())
              , m = $("#select-cal-type").val()
              , v = calCustomRule.rules[0]
              , b = v.custom;
            c.postMessage({
                mode: m,
                rule: v,
                custom: b,
                recipes: t,
                chefs: i,
                equips: l,
                materials: s,
                odata: e,
                noEquips: n,
                addEquips: o,
                changeEquips: p,
                filterEquipCondiment: d,
                useCondiment: u,
                minScore: f,
                thread: h
            })
        }),
        $("#btn-cal-save").click(function() {
            var e = escapeHtml($("#input-cal-save-name").val());
            if (e.length) {
                $("#cal-save-result").addClass("hidden"),
                $("#select-cal-save").append("<option value='" + e + "'>" + e + "</option>").selectpicker("refresh"),
                $("#select-cal-save").selectpicker("val", e);
                var a = {};
                a.key = e,
                a.val = r,
                s.push(a);
                try {
                    localStorage.setItem("cal", JSON.stringify(s))
                } catch (e) {}
                $("#input-cal-save-name").val("")
            } else
                $("#input-cal-save-name").focus()
        }),
        $("#select-cal-save").change(function() {
            var a = $(this).val();
            for (var t in s)
                if (s[t].key == a) {
                    r = s[t].val,
                    showCalOptimalResult(r, e),
                    $("#cal-save-result").addClass("hidden");
                    break
                }
        }),
        $("#btn-cal-save-clear").click(function() {
            bootbox.confirm({
                size: "small",
                message: "<div class='text-center'>确定清空保存?</div>",
                locale: "zh_CN",
                callback: function(e) {
                    if (e) {
                        $("#select-cal-save").html("").append("<option></option>").selectpicker("refresh"),
                        s = [];
                        try {
                            localStorage.setItem("cal", "")
                        } catch (e) {}
                    }
                }
            })
        })
    }
    
    // 默认满级心法盘开关事件
    $("#chk-cal-max-disk").change(function() {
        var isChecked = $(this).prop("checked");
        // 遍历所有规则
        for (var ruleIdx = 0; ruleIdx < calCustomRule.rules.length; ruleIdx++) {
            var rule = calCustomRule.rules[ruleIdx];
            var custom = rule.custom;
            // 遍历所有位置
            for (var pos in custom) {
                if (custom[pos].chef.chefId) {
                    // 保存原始等级（如果还没保存）
                    if (!custom[pos].chef.disk.hasOwnProperty('originalLevel')) {
                        custom[pos].chef.disk.originalLevel = custom[pos].chef.disk.level;
                    }
                    // 设置或恢复心法盘等级
                    if (isChecked) {
                        custom[pos].chef.disk.level = custom[pos].chef.disk.maxLevel;
                    } else {
                        custom[pos].chef.disk.level = custom[pos].chef.disk.originalLevel || 1;
                    }
                }
            }
        }
        // 重新计算结果
        calCustomResults(e);
    });
}
function showCalOptimalResult(e, a) {
    var t = "<table class='table table-condensed'>";
    for (var i in t += "<tr><td>厨师</td><td>厨具</td><td>调料</td><td>菜谱</td></tr>",
    e) {
        var l = e[i].menu;
        for (var s in l) {
            for (var c in t += "<tr>",
            t += "<td>" + l[s].chef.name + "</td>",
            t += "<td>" + (l[s].equip.name ? l[s].equip.name : "") + "</td>",
            t += "<td>" + (l[s].condiment.name ? l[s].condiment.name : "") + "</td>",
            t += "<td>",
            l[s].recipes)
                t += l[s].recipes[c].data.name + "[" + l[s].recipes[c].data.condimentDisp + "]*" + l[s].recipes[c].quantity + " ";
            t += "</td>",
            t += "</tr>"
        }
        t += "<tr class='active'><td colspan='4'>",
        t += "分数: " + e[i].score,
        t += "<button data-id='" + i + "' class='btn btn-default btn-sm btn-cal-set-custom' type='button'>选择当前菜谱</button></td><tr>",
        t += "</td></tr>"
    }
    t += "</table>",
    $("#pane-cal-optimal-results").find(".optimal-result").html(t),
    $(".btn-cal-set-custom").click(function() {
        var t = Number($(this).attr("data-id"))
          , i = JSON.parse(JSON.stringify(e[t].menu));
        initCustomData();
        var l = 0
          , s = calCustomRule.rules[l]
          , c = s.custom;
        for (var r in i)
            for (var n in c[r].chef = i[r].chef,
            c[r].equip = i[r].equip,
            c[r].condiment = i[r].condiment,
            i[r].recipes)
                c[r].recipes[n] = i[r].recipes[n],
                updateCustomRecipeCondiment(l, r, n, c[r].recipes[n].useCondiment);
        calCustomResults(a),
        s.hasOwnProperty("MaterialsNum") && $("#pane-cal-recipes").attr("data-cal", "false")
    })
}
function initCalRecipesTable() {
    var e = [{
        data: void 0,
        defaultContent: "",
        className: "select-checkbox nodetails all",
        orderDataType: "dom-selected",
        orderSequence: ["desc", "asc"],
        width: "30px"
    }, {
        data: void 0,
        defaultContent: "<span class='glyphicon'></span>",
        className: "td-expend",
        orderable: !1,
        searchable: !1,
        visible: expendBtn,
        width: "1px"
    }, {
        data: "recipe.data.galleryId",
        width: "1px"
    }, {
        data: "recipe.data.icon",
        className: "td-recipe-icon",
        orderable: !1,
        searchable: !1
    }, {
        data: "recipe.data.name",
        width: "86px",
        className: "all"
    }, {
        data: "recipe.available",
        className: "all",
        orderSequence: ["desc", "asc"]
    }, {
        data: "recipe.max",
        className: "all",
        orderSequence: ["desc", "asc"]
    }, {
        data: "recipe.availableScore",
        className: "all",
        orderSequence: ["desc", "asc"]
    }, {
        data: "recipe.totalScore",
        orderSequence: ["desc", "asc"]
    }, {
        data: {
            _: "recipe.totalTime",
            display: "recipe.totalTimeDisp"
        }
    }, {
        data: "recipe.efficiency",
        orderSequence: ["desc", "asc"]
    }, {
        data: "recipe.bonusAdditionDisp",
        orderSequence: ["desc", "asc"]
    }, {
        data: "recipe.data.ultimateAdditionDisp",
        orderSequence: ["desc", "asc"]
    }, {
        data: "recipe.decorationAdditionDisp",
        orderSequence: ["desc", "asc"]
    }, {
        data: {
            _: "recipe.data.rarity",
            display: "recipe.data.rarityDisp"
        },
        className: "rarity",
        width: "50px",
        orderSequence: ["desc", "asc"]
    }, {
        data: {
            _: "recipe.data.condiment",
            display: "recipe.data.condimentDisp"
        },
        width: "20px",
        orderSequence: ["desc", "asc"]
    }, {
        data: "recipe.data.stirfry",
        width: "20px",
        orderSequence: ["desc", "asc"]
    }, {
        data: "recipe.data.boil",
        width: "20px",
        orderSequence: ["desc", "asc"]
    }, {
        data: "recipe.data.knife",
        width: "20px",
        orderSequence: ["desc", "asc"]
    }, {
        data: "recipe.data.fry",
        width: "20px",
        orderSequence: ["desc", "asc"]
    }, {
        data: "recipe.data.bake",
        width: "20px",
        orderSequence: ["desc", "asc"]
    }, {
        data: "recipe.data.steam",
        width: "20px",
        orderSequence: ["desc", "asc"]
    }, {
        data: {
            _: "recipe.data.materialsVal",
            display: "recipe.data.materialsDisp"
        }
    }, {
        data: {
            _: "recipe.data.price",
            display: "recipe.data.priceDisp"
        },
        width: "30px",
        orderSequence: ["desc", "asc"]
    }, {
        data: "recipe.data.exPrice",
        orderSequence: ["desc", "asc"]
    }, {
        data: {
            _: "recipe.data.time",
            display: "recipe.data.timeDisp"
        }
    }, {
        data: "recipe.data.origin"
    }, {
        data: "recipe.data.tagsDisp",
        defaultContent: "",
        visible: private,
        className: "none"
    }]
      , a = !0
      , t = !1
      , i = !1;
    isMobile && (a = !1,
    t = !0,
    i = {
        left: [0, 4]
    });
    var l = "td:not(.nodetails)";
    expendBtn && (l = ".td-expend");
    var s = $("#cal-recipes-table").DataTable({
        data: [],
        columns: e,
        language: {
            search: "查找:",
            zeroRecords: "没有找到",
            info: "_TOTAL_个",
            infoEmpty: "0",
            infoFiltered: "/ _MAX_",
            select: {
                rows: {
                    _: "选择了 %d 个菜谱",
                    0: "选择了 %d 个菜谱",
                    1: "选择了 %d 个菜谱"
                }
            }
        },
        pagingType: "numbers",
        pageLength: Number($("#select-setting-page-length").val()),
        dom: "<'table-top clearfix'<'left'i><'right'<'search-box'>>><'row'<'col-sm-12'tr>><'row'<'col-sm-12'p>>",
        select: {
            style: "multi",
            selector: "td.select-checkbox"
        },
        order: [],
        deferRender: !1,
        autoWidth: !1,
        fixedHeader: a,
        scrollX: t,
        fixedColumns: i,
        responsive: {
            details: {
                type: "column",
                target: l,
                renderer: function(e, a, t) {
                    var i = "";
                    for (var l in t)
                        if (t[l].hidden) {
                            if (l < 2)
                                continue;
                            if (l > 16 && l <= 21)
                                continue;
                            if (16 == l) {
                                i += "<div class='col-lg-3 col-xs-6'>";
                                for (var s = 16; s <= 21; s++)
                                    t[s].data && (i += "<span class='child-key'>" + t[s].title + "</span><span class='child-value'>" + t[s].data + "</span>");
                                i += "</div>"
                            } else
                                i += "<div class='col-lg-3 col-xs-6'><span class='child-key'>" + t[l].title + (l < 4 ? "" : "：") + "</span><span class='child-value'>" + t[l].data + "</span></div>"
                        }
                    return !!i && "<div class='child-inner'" + getResponsiveStyle($("#cal-recipes-table")) + ">" + i + "</div>"
                }
            }
        }
    });
    $("#pane-cal-recipes div.search-box").html('<input type="search" class="form-control input-sm monitor-none" placeholder="查找 菜名 材料">'),
    $("#pane-cal-recipes .search-box input").on("input", function() {
        s.draw(),
        changeInputStyle(this)
    }),
    $.fn.dataTableExt.afnFiltering.push(function(e, a, t, i, l) {
        if (e.nTable != document.getElementById("cal-recipes-table"))
            return !0;
        var s = $.trim($("#pane-cal-recipes .search-box input").val());
        return !!commaSeparatedMatch(i.recipe.data.name, s) || (!!commaSeparatedMatch(i.recipe.data.materialsVal, s) || !!commaSeparatedMatch(i.recipe.data.tagsDisp, s))
    }),
    $("#btn-cal-recipes-select-all").click(function() {
        s.rows({
            search: "applied"
        }).select()
    }),
    $("#btn-cal-recipes-deselect-all").click(function() {
        s.rows().deselect()
    }),
    $("#chk-cal-recipes-show").on("changed.bs.select", function() {
        initCalRecipesShow(s)
    }),
    initTableResponsiveDisplayEvent(s),
    initTableScrollEvent("#pane-cal-recipes"),
    initCalRecipesShow(s)
}
function generateData(e, a, t) {
    var i = {};
    if (a) {
        for (var l in a.equips)
            a.equips[l].hide = !0;
        for (var l in a.decorations)
            a.decorations[l].hide = !0;
        for (var l in a.recipes)
            a.recipes[l].hide = !0;
        for (var l in a.chefs)
            a.chefs[l].hide = !0;
        for (var l in a.ambers)
            a.ambers[l].hide = !0;
        e.guests = e.guests.concat(a.guests),
        e.equips = e.equips.concat(a.equips),
        e.decorations = e.decorations.concat(a.decorations),
        e.quests = e.quests.concat(a.quests),
        e.recipes = e.recipes.concat(a.recipes),
        e.chefs = e.chefs.concat(a.chefs),
        e.skills = e.skills.concat(a.skills),
        e.maps = e.maps.concat(a.maps),
        e.buffs = e.buffs.concat(a.buffs),
        e.intents = e.intents.concat(a.intents),
        e.rules = e.rules.concat(a.rules),
        e.activities = e.activities.concat(a.activities),
        i.ranks = a.ranks
    }
    i.maps = e.maps,
    i.activities = e.activities,
    i.guests = e.guests,
    i.invitationGuests = e.invitationGuests,
    i.history = e.history,
    i.skills = e.skills;
    var s = [];
    for (var l in e.skills)
        for (var c in e.skills[l].effect)
            if ("Partial" == e.skills[l].effect[c].condition || "Next" == e.skills[l].effect[c].condition) {
                s.push(e.skills[l]);
                break
            }
    i.partialSkill = s,
    i.rules = e.rules,
    i.intents = e.intents,
    i.buffs = e.buffs,
    i.decorationEffect = 0,
    t && t.decorationEffect && (i.decorationEffect = t.decorationEffect),
    e.materials.sort(function(e, a) {
        return e.origin.localeCompare(a.origin)
    });
    var r = [];
    for (var l in e.materials) {
        var n = e.materials[l];
        n.originVal = getOriginVal(e.materials[l].origin),
        n.addition = "",
        n.quantity = "",
        r.push(n)
    }
    i.materials = r;
    var o = [];
    for (var l in e.condiments) {
        var p = e.condiments[l];
        p.rarityDisp = getRarityDisp(e.condiments[l].rarity);
        var d = getSkillInfo(e.skills, e.condiments[l].skill);
        p.skillDisp = d.skillDisp,
        p.skillSort = 0,
        p.effect = d.skillEffect,
        p.icon = "<div class='icon-condiment condiment_" + e.condiments[l].condimentId + "'></div>",
        o.push(p)
    }
    i.condiments = o;
    var u = [];
    for (var l in e.equips)
        if (e.equips[l].name) {
            var f = e.equips[l];
            f.rarityDisp = getRarityDisp(e.equips[l].rarity);
            d = getSkillInfo(e.skills, e.equips[l].skill);
            f.skillDisp = d.skillDisp,
            f.skillSort = 0,
            f.effect = d.skillEffect,
            f.disp = "<span class='name'>" + e.equips[l].name + "</span><br><small>" + d.skillDisp + "</small>",
            e.equips[l].hide ? f.icon = "<div class='icon-equip2 equip_" + e.equips[l].equipId + "'></div>" : f.icon = "<div class='icon-equip equip_" + e.equips[l].equipId + "'></div>",
            u.push(f)
        }
    i.equips = u,
    i.disks = e.disks;
    var h = [];
    for (var l in e.ambers) {
        var m = e.ambers[l];
        m.typeDisp = getAmberTypeDisp(e.ambers[l].type),
        m.rarityDisp = getRarityDisp(e.ambers[l].rarity);
        d = getSkillInfo(e.skills, e.ambers[l].skill);
        m.skillDisp = d.skillDisp,
        m.skillSort = 0,
        m.effect = d.skillEffect,
        m.allDesc = "",
        m.allEffect = [];
        for (c = 1; c <= 5; c++) {
            m.allDesc += getAmberDisplayByLevel(m, c) + "<br>";
            var v = getAmberEffectByLevel(m, c);
            m.allEffect.push(v)
        }
        e.ambers[l].hide ? m.icon = "<div class='icon-amber2 amber_" + e.ambers[l].amberId + "'></div>" : m.icon = "<div class='icon-amber amber_" + e.ambers[l].amberId + "'></div>",
        h.push(m)
    }
    i.ambers = h;
    var b = []
      , g = [];
    for (var l in e.decorations) {
        var k = e.decorations[l];
        if (k.tipMin = k.tipMin || "-",
        k.tipMax = k.tipMax || "-",
        k.tipTimeDisp = secondsToTime(k.tipTime) || "-",
        k.tipTime) {
            k.minEff = +(3600 * k.tipMin * 24 / k.tipTime).toFixed(1),
            k.maxEff = +(3600 * k.tipMax * 24 / k.tipTime).toFixed(1),
            k.tAvgEff = +((k.tipMin + k.tipMax) / 2 * 3600 * 24 / k.tipTime).toFixed(1);
            var y = Math.ceil(k.tipTime / 3600 / 24);
            k.rAvgEff = +((k.tipMin + k.tipMax) / 2 / y).toFixed(1);
            k.avgEffDisp = getDecorationAvgEffDisp(k.tAvgEff, k.rAvgEff)
        }
        if (k.goldDisp = getPercentDisp(+(100 * k.gold).toFixed(2)) || "-",
        k.suitDisp = k.suit || "-",
        k.suitGoldDisp = getPercentDisp(+(100 * k.suitGold).toFixed(2)) || "-",
        e.decorations[l].hide ? k.icon = "<div class='icon-decoration2 decoration_" + k.icon + "'></div>" : k.icon = "<div class='icon-decoration decoration_" + k.icon + "'></div>",
        g.push(k),
        k.suit) {
            var x = !1;
            for (var c in b)
                if (b[c].name == k.suit) {
                    b[c].decorations.push(k.id),
                    b[c].totalRAvgEff = (b[c].totalRAvgEff || 0) + (k.rAvgEff || 0),
                    x = !0;
                    break
                }
            if (!x) {
                var D = {};
                D.name = k.suit,
                D.gold = k.suitGold,
                D.decorations = [],
                D.decorations.push(k.id),
                D.totalRAvgEff = k.rAvgEff || 0,
                b.push(D)
            }
        }
    }
    i.decorations = g,
    b.sort(function(a, b) {
        var aMaxId = Math.max.apply(Math, a.decorations);
        var bMaxId = Math.max.apply(Math, b.decorations);
        return bMaxId - aMaxId;
    }),
    i.suits = b;
    var C = [];
    for (var l in e.quests)
        if (e.quests[l].goal) {
            var w = e.quests[l];
            w.questIdDisp = e.quests[l].questIdDisp ? e.quests[l].questIdDisp : e.quests[l].questId;
            var T = ""
              , S = "";
            for (var c in e.quests[l].rewards)
                T += e.quests[l].rewards[c].name,
                e.quests[l].rewards[c].quantity && (T += "*" + e.quests[l].rewards[c].quantity),
                T += " ",
                S += e.quests[l].rewards[c].name;
            w.rewardsVal = S,
            w.rewardsDisp = T,
            C.push(w)
        }
    i.quests = C;
    var q = t && t.setting && t.setting.final
      , E = $("#chk-chef-apply-equips").prop("checked")
      , I = $("#chk-chef-apply-ultimate").prop("checked")
      , R = $("#chk-chef-apply-ultimate-person").prop("checked")
      , N = getUltimateData(e.chefs, t, I, R, e.skills);
    i.ultimateData = N;
    var A = [];
    for (var l in e.chefs)
        if (e.chefs[l].name) {
            var M = e.chefs[l];
            M.addition = "",
            M.rarityDisp = getRarityDisp(e.chefs[l].rarity),
            e.chefs[l].hide ? M.icon = "<div class='icon-chef2 chef_" + e.chefs[l].chefId + "'></div>" : M.icon = "<div class='icon-chef chef_" + e.chefs[l].chefId + "'></div>";
            d = getSkillInfo(e.skills, e.chefs[l].skill);
            if (M.specialSkillDisp = d.skillDisp,
            M.specialSkillEffect = d.skillEffect,
            M.tags = e.chefs[l].tags || [],
            M.tagsDisp = "",
            a)
                for (var c in a.chefsTags)
                    if (a.chefsTags[c].chefId == e.chefs[l].chefId) {
                        M.tags = a.chefsTags[c].tags,
                        M.tagsDisp = getTagsDisp(a.chefsTags[c].tags, a.tags);
                        break
                    }
            M.gender = getGender(M.tags);
            var O = "";
            for (var c in e.chefs[l].ultimateGoal)
                for (var _ in e.quests)
                    if (e.chefs[l].ultimateGoal[c] == e.quests[_].questId) {
                        O += e.quests[_].goal + "<br>";
                        break
                    }
            M.ultimateGoalDisp = O;
            var G = getSkillInfo(e.skills, e.chefs[l].ultimateSkillList || []);
            if (M.ultimateSkillDisp = G.skillDisp,
            e.chefs[l].ultimateSkillExtra) {
                var P = e.chefs[l].ultimateSkillList ? e.chefs[l].ultimateSkillList.slice() : [];
                P = P.concat(e.chefs[l].ultimateSkillExtra);
                var V = getSkillInfo(e.skills, P);
                M.ultimateSkillEffect = V.skillEffect
            } else
                M.ultimateSkillEffect = G.skillEffect;
            for (var c in M.ultimateCustomDisp = getChefUltimateCustomDisp(M.ultimateSkillEffect, M.ultimateSkillDisp),
            M.got = "",
            M.ultimate = "",
            M.equip = null,
            M.equipId = "",
            M.equipDisp = "",
            M.diskId = e.chefs[l].disk,
            M.disk = {},
            e.disks)
                if (e.disks[c].diskId == M.diskId) {
                    for (var _ in M.disk.maxLevel = e.disks[c].maxLevel,
                    M.disk.level = 1,
                    M.disk.ambers = [],
                    e.disks[c].info) {
                        m = {};
                        m.type = e.disks[c].info[_],
                        m.data = null,
                        M.disk.ambers.push(m)
                    }
                    break
                }
            M.diskDisp = GetDiskDisp(M.disk),
            t && updateChefByLocalData(M, t, u, h),
            setDataForChef(M, M.equip, E, N.global, null, N.self, null, q, null, !0, N.qixia),
            M.materialExpectation = calculateMaterialExpectation(M, M.equip, M.disk),
            A.push(M)
        }
    i.chefs = A;
    var L = [];
    for (var l in e.recipes)
        if (e.recipes[l].name) {
            var B = {};
            if (B = e.recipes[l],
            B.stirfry = e.recipes[l].stirfry || "",
            B.boil = e.recipes[l].boil || "",
            B.knife = e.recipes[l].knife || "",
            B.fry = e.recipes[l].fry || "",
            B.bake = e.recipes[l].bake || "",
            B.steam = e.recipes[l].steam || "",
            B.addition = "",
            B.skillDisp = getSkillDisp(e.recipes[l]),
            B.timeDisp = secondsToTime(e.recipes[l].time),
            B.rarityDisp = getRarityDisp(e.recipes[l].rarity),
            e.recipes[l].hide ? B.icon = "<div class='icon-recipe2 recipe_" + e.recipes[l].recipeId + "'></div>" : B.icon = "<div class='icon-recipe recipe_" + e.recipes[l].recipeId + "'></div>",
            B.tags = e.recipes[l].tags || [],
            B.tagsDisp = "",
            B.exTime = 0,
            B.exTimeDisp = "",
            a)
                for (var c in a.recipesTags)
                    if (a.recipesTags[c].recipeId == e.recipes[l].recipeId) {
                        B.tags = a.recipesTags[c].tags,
                        B.tagsDisp = getTagsDisp(a.recipesTags[c].tags, a.tags),
                        B.exTime = a.recipesTags[c].experienceTime,
                        B.exTimeDisp = getExTimeDisp(a.recipesTags[c].experienceTime, e.recipes[l].time);
                        break
                    }
            if (B.rank = "",
            B.rankSort = 1,
            B.ex = "",
            B.got = "",
            t)
                for (var c in t.recipes)
                    if (e.recipes[l].recipeId == t.recipes[c].id) {
                        t.recipes[c].hasOwnProperty("rank") && (B.rank = t.recipes[c].rank,
                        B.rankSort = getRankSortValue(t.recipes[c].rank)),
                        t.recipes[c].hasOwnProperty("ex") && (B.ex = t.recipes[c].ex),
                        t.recipes[c].hasOwnProperty("got") && (B.got = t.recipes[c].got);
                        break
                    }
            B.oPrice = e.recipes[l].price;
            B.oTime = e.recipes[l].time;
            var F = ifUseEx(B);
            setDataForRecipe(B, N.global, F, null, q, null),
            B.efficiency = Math.floor(3600 * e.recipes[l].price / e.recipes[l].time);
            
            // 计算专精耗时相关数据
            var rarityExCfg = {
                1: {x: 59.23, y: 0.36},
                2: {x: 59.23, y: 0.31},
                3: {x: 62.21, y: 0.26},
                4: {x: 83.65, y: 0.21},
                5: {x: 177.86, y: 0.16}
            };
            var cfg = rarityExCfg[e.recipes[l].rarity];
            B.exCount1 = Math.ceil(cfg.x * Math.pow(B.oPrice, cfg.y) * 10) / 10;
            // 快乐桶和蒸汽海鲜单独逻辑
            if (e.recipes[l].recipeId == 5001) {
                B.exCount1 = 387;
            }
            if (e.recipes[l].recipeId == 5002) {
                B.exCount1 = 407;
            }
            B.exCount2 = Math.ceil(B.exCount1 / 1.5 * 10) / 10;
            B.exCount3 = Math.ceil(B.exCount1 / 2 * 10) / 10;
            B.exCount4 = Math.ceil(B.exCount1 / 2.5 * 10) / 10;
            B.exCount5 = Math.ceil(B.exCount1 / 3 * 10) / 10;
            for (var exIdx = 1; exIdx <= 5; exIdx++) {
                B['exTime' + exIdx] = Math.ceil(B['exCount' + exIdx] * B.oTime);
                B['exTimeDisp' + exIdx] = secondsToTime(B['exTime' + exIdx]);
            }
            // 默认不显示专精列
            B.exCountDisp = '';
            B.exTimeDispGap = '';
            
            var U = getMaterialsInfo(e.recipes[l], e.materials);
            B.materialsVal = U.materialsVal,
            B.materialsDisp = U.materialsDisp,
            B.veg = U.veg,
            B.meat = U.meat,
            B.creation = U.creation,
            B.fish = U.fish;
            var j = 0
              , H = 0;
            e.recipes[l].time > 0 && (j = 3600 * U.materialsCount / e.recipes[l].time,
            H = 3600 * e.recipes[l].rarity / e.recipes[l].time),
            B.allMaterialsEff = j ? Math.floor(j) : "",
            B.condimentEff = H ? Math.floor(H) : "";
            var J = ""
              , z = "-";
            for (var Q in e.combos)
                for (var X in e.combos[Q].recipes)
                    if (e.combos[Q].recipes[X] == e.recipes[l].recipeId) {
                        for (var W in e.recipes)
                            if (e.recipes[W].recipeId == e.combos[Q].recipeId) {
                                J = e.recipes[W].recipeId,
                                z = e.recipes[W].name;
                                break
                            }
                        break
                    }
            B.comboVal = J,
            B.comboDisp = z;
            var K = getRankGuestInfo(e.recipes[l], B.rank);
            B.rankGuestsVal = K.rankGuestsVal,
            B.rankGuestsDisp = K.rankGuestsDisp;
            var Y = getRankGiftInfo(e.recipes[l], B.rank);
            B.rankGiftVal = Y.rankGiftVal,
            B.rankGiftDisp = Y.rankGiftDisp;
            var Z = ""
              , ee = "";
            for (var Q in e.guests)
                for (var X in e.guests[Q].gifts)
                    if (e.recipes[l].name == e.guests[Q].gifts[X].recipe) {
                        Z += " " + e.guests[Q].name + " " + e.guests[Q].gifts[X].antique + " ",
                        ee += e.guests[Q].name + "-" + e.guests[Q].gifts[X].antique + "<br>";
                        break
                    }
            B.guestsVal = Z,
            B.guestsDisp = ee || "-";
            var ae = ""
              , te = "";
            for (var Q in e.invitationGuests)
                for (var X in e.invitationGuests[Q].gifts)
                    if (e.recipes[l].recipeId == e.invitationGuests[Q].gifts[X].recipeId) {
                        ae += " " + e.invitationGuests[Q].name + " " + e.invitationGuests[Q].gifts[X].gift + " ",
                        te += e.invitationGuests[Q].name + "-" + e.invitationGuests[Q].gifts[X].gift + "<br>";
                        break
                    }
            B.invitationGuestsVal = ae,
            B.invitationGuestsDisp = te || "-",
            B.condimentDisp = getCondimentDisp(e.recipes[l].condiment),
            L.push(B)
        }
    return i.recipes = L,
    i.selectedQuests = [],
    i.questMaterials = [],
    i.allSelectedMaterials = [],
    i.recipeColNum = $("#recipe-table-header th").length,
    i.recipeAddColNum = 0,
    i.recipeAddColNumMax = 15,
    i.chefColNum = $("#chef-table-header th").length,
    i.chefAddColNum = 0,
    i.chefAddColNumMax = 15,
    i
}
function updateRecipeChefTable(e, showLoading) {
    // showLoading参数默认为true，只有明确传入false时才不显示加载提示
    if (showLoading !== false) {
        $(".loading").removeClass("hidden");
    }
    setTimeout(function() {
        e = getUpdateData(e);
        
        // 计算时间类厨师的OpenTime加成
        var timeAddition = 0;
        var partialChefIds = $("#chk-chef-partial-ultimate").val();
        if (partialChefIds && partialChefIds.length > 0) {
            for (var i in partialChefIds) {
                for (var j in e.chefs) {
                    if (e.chefs[j].chefId == partialChefIds[i]) {
                        var chefTimeAdd = 0;
                        // 检查普通技能
                        if (e.chefs[j].specialSkillEffect) {
                            var skillAdd = getTimeAddition(e.chefs[j].specialSkillEffect);
                            if (skillAdd != 0) {
                                chefTimeAdd += skillAdd;
                            }
                        }
                        // 检查修炼技能
                        if (e.chefs[j].ultimateSkillEffect) {
                            var ultAdd = getTimeAddition(e.chefs[j].ultimateSkillEffect);
                            if (ultAdd != 0) {
                                chefTimeAdd += ultAdd;
                            }
                        }
                        // 检查厨具技能
                        if (e.chefs[j].equip && e.chefs[j].equip.effect) {
                            // 处理MutiEquipmentSkill类技能（使厨具技能效果翻倍）
                            var equipEffect = updateEquipmentEffect(e.chefs[j].equip.effect, e.chefs[j].selfUltimateEffect || []);
                            var equipAdd = getTimeAddition(equipEffect);
                            if (equipAdd != 0) {
                                chefTimeAdd += equipAdd;
                            }
                        }
                        timeAddition += chefTimeAdd;
                        break;
                    }
                }
            }
        }
        
        // 应用时间加成到所有菜谱
        for (var k in e.recipes) {
            var originalTime = e.recipes[k].oTime || e.recipes[k].time;
            if (!e.recipes[k].oTime) {
                e.recipes[k].oTime = originalTime; // 保存原始时间
            }
            
            // 如果有时间加成，计算加成后的时间并存储到新字段
            if (timeAddition != 0) {
                // 计算加成后的单时间（用于显示和效率计算）
                // 使用四舍五入而不是向上取整，与计算器页面保持一致
                e.recipes[k].timeWithAddition = Math.round(originalTime * (1 + timeAddition / 100));
                e.recipes[k].timeDisp = secondsToTime(e.recipes[k].timeWithAddition);
                
                // 重新计算总时间：先算原始总时间，再应用加成，最后四舍五入
                var originalTotalTime = originalTime * e.recipes[k].limitVal;
                e.recipes[k].totalTime = Math.round(originalTotalTime * (1 + timeAddition / 100));
                e.recipes[k].totalTimeDisp = secondsToTime(e.recipes[k].totalTime);
                
                // 重新计算所有依赖时间的列（使用加成后的时间）
                e.recipes[k].efficiency = Math.floor(3600 * e.recipes[k].price / e.recipes[k].timeWithAddition);
                
                // 重新计算耗材料效率
                var materialsCount = 0;
                for (var m in e.recipes[k].materials) {
                    materialsCount += e.recipes[k].materials[m].quantity;
                }
                e.recipes[k].allMaterialsEff = Math.floor(3600 * materialsCount / e.recipes[k].timeWithAddition);
                
                // 重新计算耗调料效率
                e.recipes[k].condimentEff = Math.floor(3600 * e.recipes[k].rarity / e.recipes[k].timeWithAddition);
            } else {
                // 没有时间加成时，清除加成字段，恢复原始显示
                delete e.recipes[k].timeWithAddition;
                e.recipes[k].timeDisp = secondsToTime(e.recipes[k].time);
                e.recipes[k].totalTime = e.recipes[k].time * e.recipes[k].limitVal;
                e.recipes[k].totalTimeDisp = secondsToTime(e.recipes[k].totalTime);
                
                // 恢复原始效率计算
                e.recipes[k].efficiency = Math.floor(3600 * e.recipes[k].price / e.recipes[k].time);
                
                var materialsCount = 0;
                for (var m in e.recipes[k].materials) {
                    materialsCount += e.recipes[k].materials[m].quantity;
                }
                e.recipes[k].allMaterialsEff = e.recipes[k].time > 0 ? Math.floor(3600 * materialsCount / e.recipes[k].time) : "";
                e.recipes[k].condimentEff = e.recipes[k].time > 0 ? Math.floor(3600 * e.recipes[k].rarity / e.recipes[k].time) : "";
                
                // 恢复原始熟练份数
                var rarityExCfg = {
                    1: {x: 59.23, y: 0.36},
                    2: {x: 59.23, y: 0.31},
                    3: {x: 62.21, y: 0.26},
                    4: {x: 83.65, y: 0.21},
                    5: {x: 177.86, y: 0.16}
                };
                var cfg = rarityExCfg[e.recipes[k].rarity];
                e.recipes[k].exCount1 = Math.ceil(cfg.x * Math.pow(e.recipes[k].oPrice, cfg.y) * 10) / 10;
                
                // 快乐桶和蒸汽海鲜单独逻辑
                if (e.recipes[k].recipeId == 5001) {
                    e.recipes[k].exCount1 = 387;
                }
                if (e.recipes[k].recipeId == 5002) {
                    e.recipes[k].exCount1 = 407;
                }
                
                e.recipes[k].exCount2 = Math.ceil(e.recipes[k].exCount1 / 1.5 * 10) / 10;
                e.recipes[k].exCount3 = Math.ceil(e.recipes[k].exCount1 / 2 * 10) / 10;
                e.recipes[k].exCount4 = Math.ceil(e.recipes[k].exCount1 / 2.5 * 10) / 10;
                e.recipes[k].exCount5 = Math.ceil(e.recipes[k].exCount1 / 3 * 10) / 10;
            }
            
            // 统计所有已修炼厨师的ExperienceTimeRate技能（始终计算）
            var experienceTimeRateSum = 0;
            for (var chefIdx in e.chefs) {
                var chef = e.chefs[chefIdx];
                // 检查厨师是否已修炼（ultimate状态为"是"，并且有ultimateSkillEffect）
                if (chef.ultimate === "是" && chef.ultimateSkillEffect && chef.ultimateSkillEffect.length > 0) {
                    // 遍历修炼技能，查找ExperienceTimeRate类型
                    for (var skillIdx in chef.ultimateSkillEffect) {
                        var skill = chef.ultimateSkillEffect[skillIdx];
                        if (skill.type === "ExperienceTimeRate") {
                            experienceTimeRateSum += skill.value || 0;
                        }
                    }
                }
            }
            
            // 重新计算熟练时间（始终使用原始时间）
            // 如果有时间加成或ExperienceTimeRate，需要重新计算熟练份数
            if (timeAddition !== 0 || experienceTimeRateSum !== 0) {
                // 先保存原始的熟练时间（如果还没保存）
                for (var exIdx = 1; exIdx <= 5; exIdx++) {
                    if (!e.recipes[k].hasOwnProperty('oExTime' + exIdx)) {
                        e.recipes[k]['oExTime' + exIdx] = e.recipes[k]['exTime' + exIdx];
                    }
                }
                
                // 计算时间加成系数：CD = timeAddition / 100
                // 如果timeAddition = -80，则系数 = 1 + (-80/100) = 0.2
                // 如果timeAddition = 20，则系数 = 1 + (20/100) = 1.2
                // 再加上ExperienceTimeRate的值
                var timeFactor = 1 + (timeAddition / 100) + experienceTimeRateSum;
                
                // 获取稀有度配置
                var rarityExCfg = {
                    1: {x: 59.23, y: 0.36},
                    2: {x: 59.23, y: 0.31},
                    3: {x: 62.21, y: 0.26},
                    4: {x: 83.65, y: 0.21},
                    5: {x: 177.86, y: 0.16}
                };
                var cfg = rarityExCfg[e.recipes[k].rarity];
                
                // 重新计算可级份数：份数 = 基础份数 ÷ (1 + CD)
                var baseExCount1 = Math.ceil(cfg.x * Math.pow(e.recipes[k].oPrice, cfg.y) * 10) / 10;
                
                // 快乐桶和蒸汽海鲜单独逻辑
                if (e.recipes[k].recipeId == 5001) {
                    baseExCount1 = 387;
                }
                if (e.recipes[k].recipeId == 5002) {
                    baseExCount1 = 407;
                }
                
                // 应用时间加成到份数
                e.recipes[k].exCount1 = Math.ceil((baseExCount1 / timeFactor) * 10) / 10;
                e.recipes[k].exCount2 = Math.ceil(e.recipes[k].exCount1 / 1.5 * 10) / 10;
                e.recipes[k].exCount3 = Math.ceil(e.recipes[k].exCount1 / 2 * 10) / 10;
                e.recipes[k].exCount4 = Math.ceil(e.recipes[k].exCount1 / 2.5 * 10) / 10;
                e.recipes[k].exCount5 = Math.ceil(e.recipes[k].exCount1 / 3 * 10) / 10;
                
                // 熟练时间保持不变，使用原始保存的值
                for (var exIdx = 1; exIdx <= 5; exIdx++) {
                    e.recipes[k]['exTime' + exIdx] = e.recipes[k]['oExTime' + exIdx];
                    e.recipes[k]['exTimeDisp' + exIdx] = secondsToTime(e.recipes[k]['exTime' + exIdx]);
                }
            } else {
                // 没有任何时间加成时，如果之前保存了原始熟练时间，恢复它
                for (var exIdx = 1; exIdx <= 5; exIdx++) {
                    if (e.recipes[k].hasOwnProperty('oExTime' + exIdx)) {
                        e.recipes[k]['exTime' + exIdx] = e.recipes[k]['oExTime' + exIdx];
                        e.recipes[k]['exTimeDisp' + exIdx] = secondsToTime(e.recipes[k]['exTime' + exIdx]);
                    }
                }
            }
        }
        
        updateRecipeTableData(e);
        updateChefTableData(e);
        updateChefMaterialComboColumn();
        $("#recipe-table").DataTable().draw(!1);
        $("#chef-table").DataTable().draw(!1);
        // 重新应用专精等级选择
        var selectedGap = $("#select-recipe-ex-gap").val();
        if (selectedGap != null && selectedGap.length > 0 && selectedGap[0] != "") {
            var gapLevel = selectedGap[0];
            var gapNames = {1: '可', 2: '优', 3: '特', 4: '神', 5: '传'};
            var table = $("#recipe-table").DataTable();
            
            // 显示专精列
            table.column(20).visible(true);
            table.column(21).visible(true);
            
            // 确保列不会被responsive隐藏
            $(table.column(20).header()).removeClass("never").addClass("all");
            $(table.column(21).header()).removeClass("never").addClass("all");
            
            // 更新数据
            table.rows().every(function(rowIdx, tableLoop, rowLoop) {
                var data = this.data();
                table.cell(rowIdx, 20).data(data['exCount' + gapLevel]);
                table.cell(rowIdx, 21).data(data['exTimeDisp' + gapLevel]);
            });
            
            // 更新列标题
            table.column(20).header().innerHTML = '熟练份数(' + gapNames[gapLevel] + ')';
            table.column(21).header().innerHTML = '熟练时间(' + gapNames[gapLevel] + ')';
            
            // 重新计算responsive和调整列
            table.responsive.rebuild();
            table.responsive.recalc();
            table.columns.adjust().draw(false);
        }
        $(".loading").addClass("hidden");
    }, 0);
    $("#btn-chef-recal").closest(".inline-wrapper").addClass("hidden");
    $("#btn-recipe-recal").closest(".inline-wrapper").addClass("hidden");
}
function getUpdateData(e) {
    var a = getLocalData()
      , t = $("#chk-setting-show-final").prop("checked")
      , i = $("#chk-chef-apply-equips").prop("checked")
      , l = $("#chk-chef-apply-ultimate").prop("checked")
      , s = $("#chk-chef-apply-ultimate-person").prop("checked")
      , amb = $("#chk-chef-apply-ambers").prop("checked")
      , maxDiskLevel = $("#chk-chef-max-disk-level").prop("checked")
      , c = getUltimateData(e.chefs, a, l, s);
    e.ultimateData = c;
    var r = $("#chk-chef-partial-ultimate").val()
      , n = getPartialChefAddsByIds(e.chefs, l, r);
    var selectedEquipId = $("#chk-chef-apply-equip-select").val();
    var selectedEquip = null;
    if (selectedEquipId) {
        for (var eq in e.equips) {
            if (e.equips[eq].equipId == selectedEquipId) {
                selectedEquip = e.equips[eq];
                break;
            }
        }
    }
    var selectedAmberIds = $("#chk-chef-apply-amber-select").val() || [];
    var selectedAmbers = [];
    if (selectedAmberIds.length > 0) {
        for (var ambId in selectedAmberIds) {
            for (var ambIdx in e.ambers) {
                if (e.ambers[ambIdx].amberId == selectedAmberIds[ambId]) {
                    selectedAmbers.push(e.ambers[ambIdx]);
                    break;
                }
            }
        }
    }
    for (var o in e.chefs) {
        // 只在第一次初始化时保存原始值和初始值
        if (!e.chefs[o].hasOwnProperty('originalEquip')) {
            e.chefs[o].originalEquip = e.chefs[o].equip || null;
            e.chefs[o].originalEquipId = e.chefs[o].equipId || null;
            e.chefs[o].originalEquipDisp = e.chefs[o].equipDisp || null;
        }
        // 保存初始厨具（永远不变，用于清空时恢复）
        if (!e.chefs[o].hasOwnProperty('initialEquip')) {
            e.chefs[o].initialEquip = e.chefs[o].equip || null;
            e.chefs[o].initialEquipId = e.chefs[o].equipId || null;
            e.chefs[o].initialEquipDisp = e.chefs[o].equipDisp || null;
        }
        // 保存用于刷新页面后恢复的初始厨具
        if (!e.chefs[o].hasOwnProperty('initialEquipForRestore')) {
            e.chefs[o].initialEquipForRestore = e.chefs[o].equip || null;
            e.chefs[o].initialEquipForRestoreId = e.chefs[o].equipId || null;
            e.chefs[o].initialEquipForRestoreDisp = e.chefs[o].equipDisp || null;
        }
        if (!e.chefs[o].hasOwnProperty('originalDiskAmbers')) {
            e.chefs[o].originalDiskAmbers = e.chefs[o].disk && e.chefs[o].disk.ambers ? JSON.parse(JSON.stringify(e.chefs[o].disk.ambers)) : [];
        }
        if (!e.chefs[o].hasOwnProperty('originalDiskLevel')) {
            e.chefs[o].originalDiskLevel = e.chefs[o].disk && e.chefs[o].disk.level ? e.chefs[o].disk.level : 1;
        }
        // 保存用于刷新页面后恢复的初始遗玉和等级
        if (!e.chefs[o].hasOwnProperty('initialDiskAmbersForRestore')) {
            e.chefs[o].initialDiskAmbersForRestore = e.chefs[o].disk && e.chefs[o].disk.ambers ? JSON.parse(JSON.stringify(e.chefs[o].disk.ambers)) : [];
        }
        if (!e.chefs[o].hasOwnProperty('initialDiskLevelForRestore')) {
            e.chefs[o].initialDiskLevelForRestore = e.chefs[o].disk && e.chefs[o].disk.level ? e.chefs[o].disk.level : 1;
        }
        
        // 处理厨具：先恢复到原始厨具，然后再应用选择的厨具
        if (selectedEquip) {
            e.chefs[o].equip = selectedEquip;
            e.chefs[o].equipId = selectedEquip.equipId;
            e.chefs[o].equipDisp = selectedEquip.disp;
            // 批量应用时，同时更新originalEquip和initialEquipForRestore
            e.chefs[o].originalEquip = selectedEquip;
            e.chefs[o].originalEquipId = selectedEquip.equipId;
            e.chefs[o].originalEquipDisp = selectedEquip.disp;
            e.chefs[o].initialEquipForRestore = selectedEquip;
            e.chefs[o].initialEquipForRestoreId = selectedEquip.equipId;
            e.chefs[o].initialEquipForRestoreDisp = selectedEquip.disp;
        } else {
            // 没有选择批量应用厨具时，恢复到厨师自身的厨具
            e.chefs[o].equip = e.chefs[o].originalEquip || null;
            e.chefs[o].equipId = e.chefs[o].originalEquipId || null;
            e.chefs[o].equipDisp = e.chefs[o].originalEquipDisp || null;
        }
        var equipToUse = e.chefs[o].equip;
        
        // 只有当选择了应用遗玉时，才覆盖厨师自身的遗玉设置
        if (selectedAmbers.length > 0) {
            e.chefs[o].disk.ambers = e.chefs[o].originalDiskAmbers ? JSON.parse(JSON.stringify(e.chefs[o].originalDiskAmbers)) : [];
            for (var slotIdx in e.chefs[o].disk.ambers) {
                var slot = e.chefs[o].disk.ambers[slotIdx];
                for (var selAmb in selectedAmbers) {
                    if (slot.type == selectedAmbers[selAmb].type) {
                        slot.data = selectedAmbers[selAmb];
                        break;
                    }
                }
            }
            e.chefs[o].diskDisp = GetDiskDisp(e.chefs[o].disk);
            // 批量应用时，同时更新originalDiskAmbers和initialDiskAmbersForRestore
            e.chefs[o].originalDiskAmbers = JSON.parse(JSON.stringify(e.chefs[o].disk.ambers));
            e.chefs[o].initialDiskAmbersForRestore = JSON.parse(JSON.stringify(e.chefs[o].disk.ambers));
        } else {
            // 没有选择批量应用遗玉时，恢复到厨师自身佩戴的遗玉
            e.chefs[o].disk.ambers = e.chefs[o].originalDiskAmbers ? JSON.parse(JSON.stringify(e.chefs[o].originalDiskAmbers)) : [];
            e.chefs[o].diskDisp = GetDiskDisp(e.chefs[o].disk);
        }
        
        // 处理满级心法盘
        if (maxDiskLevel) {
            e.chefs[o].disk.level = e.chefs[o].disk.maxLevel || 1;
            e.chefs[o].diskDisp = GetDiskDisp(e.chefs[o].disk);
            // 批量应用满级时，同时更新originalDiskLevel和initialDiskLevelForRestore
            e.chefs[o].originalDiskLevel = e.chefs[o].disk.level;
            e.chefs[o].initialDiskLevelForRestore = e.chefs[o].disk.level;
        } else {
            e.chefs[o].disk.level = e.chefs[o].originalDiskLevel || 1;
            e.chefs[o].diskDisp = GetDiskDisp(e.chefs[o].disk);
        }
        
        setDataForChef(e.chefs[o], equipToUse, i, c.global, n, c.self, null, t, null, amb);
        
        // 计算采集期望值
        e.chefs[o].materialExpectation = calculateMaterialExpectation(e.chefs[o], equipToUse, e.chefs[o].disk);
    }
    for (var o in e.recipes) {
        var p = ifUseEx(e.recipes[o]);
        setDataForRecipe(e.recipes[o], c.global, p, null, t, null)
    }
    return updateRecipesChefsData(e),
    updateChefsRecipesData(e),
    e
}
function getQuestsData(e, a) {
    var t = [];
    for (var i in e)
        e[i].type == a && t.push(e[i]);
    return t
}
function getMaterialsData(e, a) {
    if (!a) {
        var t = $("#select-material-origin").val();
        for (var i in e.maps)
            if (t == e.maps[i].name) {
                a = e.maps[i];
                break
            }
    }
    var l = a.materials
      , s = []
      , c = $("#chk-material-season").prop("checked")
      , r = Number($("#input-material-addition").val())
      , n = $("#input-material-skill").val();
    for (var i in l) {
        var o = {};
        for (var p in o.name = l[i].name,
        o.skill = l[i].skill,
        o.time = [],
        l[i].quantity) {
            var d = 0
              , u = 0;
            ("" == n || Number(n) >= l[i].skill) && (d = l[i].quantity[p][0],
            u = l[i].quantity[p][1],
            c && (d += l[i].season[p],
            u += l[i].season[p]),
            r && (d = Math.ceil(+(d * (1 + r / 100)).toFixed(2)),
            u = Math.ceil(+(u * (1 + r / 100)).toFixed(2)))),
            o.time.push([d, u])
        }
        s.push(o)
    }
    var f = {
        name: "总计",
        time: []
    };
    for (var i in a.time) {
        d = 0,
        u = 0;
        for (var p in s)
            d += s[p].time[i][0],
            u += s[p].time[i][1];
        f.time.push([d, u])
    }
    return s.push(f),
    s
}
function getMaterialsInfo(e, a) {
    var t = {}
      , i = ""
      , l = ""
      , s = 0
      , c = !1
      , r = !1
      , n = !1
      , o = !1;
    for (var p in e.materials)
        for (var d in a)
            if (e.materials[p].material == a[d].materialId) {
                i += a[d].name + "*" + e.materials[p].quantity + " ",
                l += a[d].name + " ",
                s += e.materials[p].quantity,
                e.materials[p].origin = a[d].origin,
                "菜棚" == a[d].origin || "菜地" == a[d].origin || "森林" == a[d].origin ? c = !0 : "鸡舍" == a[d].origin || "猪圈" == a[d].origin || "牧场" == a[d].origin ? r = !0 : "作坊" == a[d].origin ? n = !0 : "池塘" == a[d].origin && (o = !0);
                break
            }
    return t.materialsDisp = i,
    t.materialsVal = l,
    t.materialsCount = s,
    t.veg = c,
    t.meat = r,
    t.creation = n,
    t.fish = o,
    t
}
function getGender(e) {
    return e.indexOf(1) >= 0 ? "男" : e.indexOf(2) >= 0 ? "女" : ""
}
function getTagsDisp(e, a) {
    var t = "";
    for (var i in e)
        for (var l in a)
            if (e[i] == a[l].Id) {
                t += a[l].name + " ";
                break
            }
    return t
}
function getExTimeDisp(e, a) {
    var t = e / 1.5
      , i = e / 2
      , l = e / 2.5
      , s = e / 3
      , c = "可-" + Math.ceil(e / a) + "-" + secondsToTime(e) + "<br>优-" + Math.ceil(t / a) + "-" + secondsToTime(t) + "<br>特-" + Math.ceil(i / a) + "-" + secondsToTime(i) + "<br>神-" + Math.ceil(l / a) + "-" + secondsToTime(l) + "<br>传-" + Math.ceil(s / a) + "-" + secondsToTime(s);
    return c
}
function getOriginVal(e) {
    var a = 0;
    return "菜棚" == e ? a = 1 : "菜地" == e ? a = 2 : "森林" == e ? a = 3 : "鸡舍" == e ? a = 4 : "猪圈" == e ? a = 5 : "牧场" == e ? a = 6 : "作坊" == e ? a = 7 : "池塘" == e ? a = 8 : console.log("cannot find origin: " + a),
    a
}
function getRankSortValue(e) {
    return "传" == e ? 5 : "神" == e ? 4 : "特" == e ? 3 : "优" == e ? 2 : 1
}
function getRankGuestInfo(e, a) {
    var t = ""
      , i = ""
      , l = $("#chk-recipe-filter-guest").prop("checked")
      , s = $("#chk-setting-done-mark").prop("checked");
    for (var c in e.guests) {
        var r = !1;
        ("优" == a && 0 == c || "特" == a && 2 != c || "神" == a || "传" == a) && (r = !0);
        var n = "";
        0 == c ? n = "优" : 1 == c ? n = "特" : 2 == c && (n = "神"),
        t += (r && s ? "<span class='rank-done'>" : "") + n + "-" + (e.guests[c].guest ? e.guests[c].guest : "未知") + (r && s ? "</span>" : "") + "<br>",
        (!l || l && !r) && (i += " " + e.guests[c].guest + " ")
    }
    var o = {};
    return o.rankGuestsDisp = t,
    o.rankGuestsVal = i,
    o
}
function getRankGiftInfo(e, a) {
    var t = e.gift
      , i = ""
      , l = $("#chk-recipe-filter-antique").prop("checked")
      , s = $("#chk-setting-done-mark").prop("checked");
    "神" != a && "传" != a || !s || (t = "<span class='rank-done'>" + t + "</span>"),
    (!l || l && "神" != a && "传" != a) && (i = e.gift);
    var c = {};
    return c.rankGiftDisp = t,
    c.rankGiftVal = i,
    c
}
function ifUseEx(e) {
    var a = $("#chk-recipe-apply-ex").prop("checked")
      , t = $("#chk-recipe-apply-ex-person").prop("checked");
    return !(!a || (!t || "是" != e.ex) && t)
}
function getUltimateData(e, a, t, i, skills) {
    var l = []
      , s = []
      , c = []
      , qixia = {};
    for (var r in e)
        if (t && (e[r].ultimateSkillList || e[r].ultimateSkillEffect)) {
            var n = !1;
            if (i) {
                if (a)
                    for (var o in a.chefs)
                        if (e[r].chefId == a.chefs[o].id && "是" == a.chefs[o].ult) {
                            n = !0;
                            break
                        }
            } else
                e[r].hide || (n = !0);
            if (n) {
                var p = []
                  , d = [];
                for (var u in e[r].ultimateSkillEffect) {
                    var f = e[r].ultimateSkillEffect[u];
                    if ("Partial" == f.condition || "Next" == f.condition)
                        p.push(f);
                    else if ("Global" == f.condition) {
                        var h = !1;
                        for (var m in l)
                            if (!(l[m].type != f.type || l[m].cal != f.cal && (l[m].cal || f.cal) || l[m].tag != f.tag && (l[m].tag || f.tag) || l[m].rarity != f.rarity && (l[m].rarity || f.rarity))) {
                                l[m].value = +(l[m].value + f.value).toFixed(2),
                                h = !0;
                                break
                            }
                        h || l.push(JSON.parse(JSON.stringify(f)))
                    } else
                        "Self" == f.condition && d.push(f)
                }
                if (p.length) {
                    var v = {};
                    v.chefId = e[r].chefId,
                    v.effect = p,
                    s.push(v)
                }
                if (d.length) {
                    var b = {};
                    b.chefId = e[r].chefId,
                    b.effect = d,
                    c.push(b)
                }
            }
            if (n && e[r].ultimateSkillList && skills) {
                for (var u in e[r].ultimateSkillList) {
                    var skillId = e[r].ultimateSkillList[u];
                    var skillObj = null;
                    for (var sk in skills)
                        if (skills[sk].skillId == skillId) {
                            skillObj = skills[sk];
                            break
                        }
                    if (skillObj && skillObj.effect && skillObj.effect.length > 0 && skillObj.effect[0].conditionType == "SwordsUnited") {
                        var hasUlt = !1;
                        if (i) {
                            if (a)
                                for (var o in a.chefs)
                                    if (e[r].chefId == a.chefs[o].id && "是" == a.chefs[o].ult) {
                                        hasUlt = !0;
                                        break
                                    }
                        } else
                            hasUlt = !0;
                        if (hasUlt && skillObj.effect && skillObj.effect.length > 0) {
                            var effect = skillObj.effect[0];
                            if (effect.conditionValueList && effect.conditionValueList.length > 0) {
                                var matchCount = 0;
                                for (var cv in effect.conditionValueList) {
                                    var conditionValue = effect.conditionValueList[cv];
                                    for (var ch in e) {
                                        if (e[ch].baseChefId == conditionValue) {
                                            var chefGot = !1;
                                            if (i) {
                                                // 使用已修炼：检查本地数据，必须同时满足 got 和 ult
                                                if (a && a.chefs) {
                                                    for (var ac in a.chefs)
                                                        if (a.chefs[ac].id == e[ch].chefId && a.chefs[ac].got && "是" == a.chefs[ac].ult) {
                                                            chefGot = !0;
                                                            break
                                                        }
                                                } else if (e[ch].got) {
                                                    chefGot = !0
                                                }
                                            } else {
                                                // 使用全修炼：默认所有厨师都已拥有且已修炼
                                                chefGot = !0
                                            }
                                            if (chefGot) {
                                                matchCount++;
                                                break
                                            }
                                        }
                                    }
                                }
                                if (matchCount >= effect.conditionValueList.length && effect.tag) {
                                    if (!qixia[effect.tag]) {
                                        qixia[effect.tag] = {
                                            Stirfry: 0,
                                            Boil: 0,
                                            Knife: 0,
                                            Fry: 0,
                                            Bake: 0,
                                            Steam: 0,
                                            GuestApearRate: 0,
                                            OpenTime: 0
                                        }
                                    }
                                    for (var eff in skillObj.effect) {
                                        var effObj = skillObj.effect[eff];
                                        if (effObj.tag == effect.tag && qixia[effect.tag][effObj.type] !== undefined) {
                                            qixia[effect.tag][effObj.type] += effObj.value || 0
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            }
        }
    var g = {};
    return g.global = l,
    g.partial = s,
    g.self = c,
    g.qixia = qixia,
    g
}
function setPartialUltimateOptions(e) {
    // 清空选择框，避免重复
    $("#chk-chef-partial-ultimate").empty();
    
    var skillTypeChefs = [];
    var timeTypeChefs = [];
    var processedChefs = {}; // 记录已处理的厨师，避免重复
        
    // 辅助函数：生成OpenTime技能描述
    function getOpenTimeDesc(effect) {
        var desc = "";
        for (var i in effect) {
            if ("OpenTime" == effect[i].type) {
                var value = effect[i].value;
                desc += "开业时间" + (value > 0 ? "+" : "") + value + "%";
                break;
            }
        }
        return desc;
    }
    
    // 辅助函数：生成完整的时间类技能描述（包括厨具）
    function getTimeChefFullDisp(chef) {
        var disp = "";
        
        // 添加厨师技能描述
        if (chef.specialSkillEffect) {
            for (var s in chef.specialSkillEffect) {
                if ("OpenTime" == chef.specialSkillEffect[s].type) {
                    disp = chef.specialSkillDisp;
                    break;
                }
            }
        }
        
        // 如果普通技能没有OpenTime，检查修炼技能
        if (!disp && chef.ultimateSkillEffect) {
            for (var u in chef.ultimateSkillEffect) {
                if (("Partial" == chef.ultimateSkillEffect[u].condition || "Next" == chef.ultimateSkillEffect[u].condition) && 
                    ("CookbookTime" == chef.ultimateSkillEffect[u].type || "OpenTime" == chef.ultimateSkillEffect[u].type)) {
                    disp = chef.ultimateSkillDisp;
                    break;
                }
            }
        }
        
        // 检查厨具是否有OpenTime技能
        if (chef.equip && chef.equip.effect) {
            var equipOpenTime = "";
            for (var e in chef.equip.effect) {
                if ("OpenTime" == chef.equip.effect[e].type) {
                    equipOpenTime = getOpenTimeDesc(chef.equip.effect);
                    break;
                }
            }
            
            // 如果厨具有OpenTime技能，添加到描述中
            if (equipOpenTime) {
                disp += " 厨具-" + chef.equip.name + " " + equipOpenTime;
            }
        }
        
        return disp;
    }
    
    // 第一遍：检查有Partial/Next修炼技能的厨师
    for (var t in e) {
        // 跳过已处理的厨师
        if (processedChefs[e[t].chefId]) {
            continue;
        }
        
        var hasPartialOrNext = false;
        for (var i in e[t].ultimateSkillEffect) {
            if ("Partial" == e[t].ultimateSkillEffect[i].condition || "Next" == e[t].ultimateSkillEffect[i].condition) {
                hasPartialOrNext = true;
                break;
            }
        }
        
        if (hasPartialOrNext) {
            var l = {};
            l.effect = e[t].ultimateSkillEffect;
            l.disp = e[t].ultimateSkillDisp;
            l.chef = e[t];
            var isSkillType = false;
            var isTimeType = false;
            
            // 检查修炼技能中的Partial/Next类型
            for (var r in l.effect) {
                if (("Partial" == l.effect[r].condition || "Next" == l.effect[r].condition)) {
                    if ("Bake" == l.effect[r].type || "Steam" == l.effect[r].type || "Boil" == l.effect[r].type || 
                        "Fry" == l.effect[r].type || "Knife" == l.effect[r].type || "Stirfry" == l.effect[r].type) {
                        isSkillType = true;
                    }
                    // 检查修炼技能中的CookbookTime和OpenTime类型
                    if ("CookbookTime" == l.effect[r].type || "OpenTime" == l.effect[r].type) {
                        isTimeType = true;
                    }
                }
            }
            
            // 检查普通技能中的OpenTime类型
            if (e[t].specialSkillEffect) {
                for (var s in e[t].specialSkillEffect) {
                    if ("OpenTime" == e[t].specialSkillEffect[s].type) {
                        isTimeType = true;
                        break;
                    }
                }
            }
            
            // 优先添加到技法类，如果既有技法又有时间，只添加到技法类
            if (isSkillType) {
                skillTypeChefs.push(l);
                processedChefs[e[t].chefId] = true;
            } else if (isTimeType) {
                // 只有没有技法类技能时，才添加到时间类
                var timeChef = {
                    effect: l.effect,
                    disp: getTimeChefFullDisp(e[t]), // 使用完整描述（包括厨具）
                    chef: l.chef
                };
                timeTypeChefs.push(timeChef);
                processedChefs[e[t].chefId] = true;
            }
        }
    }
    
    // 第二遍：检查普通技能中有OpenTime但没有Partial/Next修炼技能的厨师
    for (var t in e) {
        // 跳过已处理的厨师
        if (processedChefs[e[t].chefId]) {
            continue;
        }
        
        // 检查普通技能中的OpenTime类型
        if (e[t].specialSkillEffect) {
            for (var s in e[t].specialSkillEffect) {
                if ("OpenTime" == e[t].specialSkillEffect[s].type) {
                    var l = {};
                    l.effect = e[t].ultimateSkillEffect || [];
                    l.disp = getTimeChefFullDisp(e[t]); // 使用完整描述（包括厨具）
                    l.chef = e[t];
                    
                    timeTypeChefs.push(l);
                    processedChefs[e[t].chefId] = true;
                    break;
                }
            }
        }
    }
    
    // 第三遍：检查只有厨具有OpenTime技能的厨师
    for (var t in e) {
        // 跳过已处理的厨师
        if (processedChefs[e[t].chefId]) {
            continue;
        }
        
        // 检查厨具是否有OpenTime技能
        var hasEquipOpenTime = false;
        if (e[t].equip && e[t].equip.effect) {
            for (var eq in e[t].equip.effect) {
                if ("OpenTime" == e[t].equip.effect[eq].type) {
                    hasEquipOpenTime = true;
                    break;
                }
            }
        }
        
        if (hasEquipOpenTime) {
            var l = {};
            l.effect = e[t].ultimateSkillEffect || [];
            l.disp = getTimeChefFullDisp(e[t]); // 使用完整描述（包括厨具）
            l.chef = e[t];
            
            timeTypeChefs.push(l);
            processedChefs[e[t].chefId] = true;
        }
    }
        
    skillTypeChefs.sort(function(e, a) {
        return e.disp.localeCompare(a.disp)
    });
    
    // 时间类厨师按照总时间加成从小到大排序
    timeTypeChefs.sort(function(e, a) {
        // 计算厨师e的总时间加成
        var eTimeAdd = 0;
        if (e.chef.specialSkillEffect) {
            eTimeAdd += getTimeAddition(e.chef.specialSkillEffect);
        }
        if (e.chef.ultimateSkillEffect) {
            eTimeAdd += getTimeAddition(e.chef.ultimateSkillEffect);
        }
        if (e.chef.equip && e.chef.equip.effect) {
            // 处理MutiEquipmentSkill类技能（使厨具技能效果翻倍）
            var eEquipEffect = updateEquipmentEffect(e.chef.equip.effect, e.chef.selfUltimateEffect || []);
            eTimeAdd += getTimeAddition(eEquipEffect);
        }
        
        // 计算厨师a的总时间加成
        var aTimeAdd = 0;
        if (a.chef.specialSkillEffect) {
            aTimeAdd += getTimeAddition(a.chef.specialSkillEffect);
        }
        if (a.chef.ultimateSkillEffect) {
            aTimeAdd += getTimeAddition(a.chef.ultimateSkillEffect);
        }
        if (a.chef.equip && a.chef.equip.effect) {
            // 处理MutiEquipmentSkill类技能（使厨具技能效果翻倍）
            var aEquipEffect = updateEquipmentEffect(a.chef.equip.effect, a.chef.selfUltimateEffect || []);
            aTimeAdd += getTimeAddition(aEquipEffect);
        }
        
        // 按照总时间加成从小到大排序（时间加成是负数，所以越小越好）
        return eTimeAdd - aTimeAdd;
    });
    $("#chk-chef-partial-ultimate").on('loaded.bs.select', function() {
        var $select = $(this);
        var $dropdown = $select.parent().find('.dropdown-menu');
        var $actionsBox = $dropdown.find('.bs-actionsbox');
        
        if ($actionsBox.length && !$actionsBox.find('.chef-type-tabs').length) {
            var tabsHtml = '<ul class="nav nav-tabs chef-type-tabs" style="margin: 0 10px 10px 10px; border-bottom: 2px solid #ddd; display: table !important; width: 100% !important; table-layout: fixed !important;">' +
                '<li class="active" style="display: table-cell !important; float: none !important; width: 50% !important; text-align: center;"><a href="#" class="chef-tab-skill" style="padding: 8px 15px; display: block;">技法类</a></li>' +
                '<li style="display: table-cell !important; float: none !important; width: 50% !important; text-align: center;"><a href="#" class="chef-tab-time" style="padding: 8px 15px; display: block;">时间类</a></li>' +
                '</ul>';
            $actionsBox.prepend(tabsHtml);
            
            // 添加空状态提示元素
            var emptyHtml = '<li class="chef-empty-hint" style="display:none; padding: 20px; text-align: center; color: #999;">暂无时间类厨师</li>';
            $dropdown.find('ul.dropdown-menu').append(emptyHtml);
            
            $actionsBox.find('.chef-tab-skill').on('click', function(e) {
                e.stopPropagation();
                e.preventDefault();
                $(this).parent().addClass('active').siblings().removeClass('active');
                // 只操作下拉列表中的选项，不包括标签页
                var hasVisible = false;
                $dropdown.find('ul.dropdown-menu > li').each(function() {
                    var $li = $(this);
                    if ($li.hasClass('chef-empty-hint')) return;
                    var $option = $select.find('option').eq($li.index());
                    if ($option.hasClass('chef-skill-type')) {
                        $li.show();
                        hasVisible = true;
                    } else if ($option.hasClass('chef-time-type')) {
                        $li.hide();
                    }
                });
                $dropdown.find('.chef-empty-hint').hide();
                return false;
            });
            $actionsBox.find('.chef-tab-time').on('click', function(e) {
                e.stopPropagation();
                e.preventDefault();
                $(this).parent().addClass('active').siblings().removeClass('active');
                // 只操作下拉列表中的选项，不包括标签页
                var hasVisible = false;
                $dropdown.find('ul.dropdown-menu > li').each(function() {
                    var $li = $(this);
                    if ($li.hasClass('chef-empty-hint')) return;
                    var $option = $select.find('option').eq($li.index());
                    if ($option.hasClass('chef-time-type')) {
                        $li.show();
                        hasVisible = true;
                    } else if ($option.hasClass('chef-skill-type')) {
                        $li.hide();
                    }
                });
                // 如果没有可见项，显示空状态提示
                if (!hasVisible) {
                    $dropdown.find('.chef-empty-hint').show();
                }
                return false;
            });
        }
    });
    
    // 监听下拉框打开事件，确保默认显示技法类
    $("#chk-chef-partial-ultimate").on('show.bs.select', function() {
        var $select = $(this);
        var $dropdown = $select.parent().find('.dropdown-menu');
        
        // 检查当前激活的标签
        var $activeTab = $dropdown.find('.chef-type-tabs li.active a');
        
        // 如果技法类标签是激活的（默认状态），则只显示技法类厨师
        if ($activeTab.hasClass('chef-tab-skill')) {
            $dropdown.find('ul.dropdown-menu > li').each(function() {
                var $li = $(this);
                if ($li.hasClass('chef-empty-hint')) return;
                var $option = $select.find('option').eq($li.index());
                if ($option.hasClass('chef-skill-type')) {
                    $li.show();
                } else if ($option.hasClass('chef-time-type')) {
                    $li.hide();
                }
            });
            $dropdown.find('.chef-empty-hint').hide();
        }
    });
    
    // 添加技法类厨师到DOM，并去重
    var addedChefIds = {};
    for (var t in skillTypeChefs) {
        var chefId = skillTypeChefs[t].chef.chefId;
        if (!addedChefIds[chefId]) {
            var s = "<option value='" + chefId + "' data-subtext='" + skillTypeChefs[t].disp.replace(/<br>/g, " ") + "' class='chef-skill-type'>" + skillTypeChefs[t].chef.name + "</option>";
            $("#chk-chef-partial-ultimate").append(s);
            addedChefIds[chefId] = true;
        }
    }
    for (var t in timeTypeChefs) {
        var chefId = timeTypeChefs[t].chef.chefId;
        if (!addedChefIds[chefId]) {
            var s = "<option value='" + chefId + "' data-subtext='" + timeTypeChefs[t].disp.replace(/<br>/g, " ") + "' class='chef-time-type'>" + timeTypeChefs[t].chef.name + "</option>";
            $("#chk-chef-partial-ultimate").append(s);
            addedChefIds[chefId] = true;
        }
    }
}
function setCalPartialUltimateOptions(e) {
    // 计算器页面专用：只考虑厨师自身的修炼技能，不考虑厨具
    var a = [];
    var processedChefs = {}; // 用于去重
    
    for (var t in e) {
        // 跳过已处理的厨师
        if (processedChefs[e[t].chefId]) {
            continue;
        }
        
        // 只检查厨师自身的ultimateSkillEffect，不考虑厨具
        if (e[t].ultimateSkillEffect) {
            var hasValidSkill = false;
            // 检查是否有Partial或Next条件的修炼技能，但排除时间类
            for (var i in e[t].ultimateSkillEffect) {
                if (("Partial" == e[t].ultimateSkillEffect[i].condition || "Next" == e[t].ultimateSkillEffect[i].condition) &&
                    "OpenTime" != e[t].ultimateSkillEffect[i].type && 
                    "CookbookTime" != e[t].ultimateSkillEffect[i].type) {
                    hasValidSkill = true;
                    break;
                }
            }
            // 只有具有非时间类的Partial或Next技能的厨师才加入列表
            if (hasValidSkill) {
                var l = {};
                l.effect = e[t].ultimateSkillEffect,
                l.disp = e[t].ultimateSkillDisp,
                l.chef = e[t],
                a.push(l);
                processedChefs[e[t].chefId] = true; // 标记为已处理
            }
        }
    }
    
    // 按技能描述排序
    a.sort(function(e, a) {
        return e.disp.localeCompare(a.disp)
    });
    
    // 获取本地数据，用于检查厨师是否已修炼
    var localData = getLocalData();
    var ultimatedChefIds = []; // 存储已修炼的厨师ID
    
    // 添加所有筛选出的厨师到计算器选择框
    for (var t in a) {
        var s = "<option value='" + a[t].chef.chefId + "' data-subtext='" + a[t].disp.replace(/<br>/g, " ") + "'>" + a[t].chef.name + "</option>";
        $("#chk-cal-partial-ultimate").append(s);
        
        // 检查该厨师是否已修炼
        if (localData && localData.chefs) {
            for (var lci = 0; lci < localData.chefs.length; lci++) {
                if (localData.chefs[lci].id == a[t].chef.chefId && "是" == localData.chefs[lci].ult) {
                    ultimatedChefIds.push(a[t].chef.chefId);
                    break;
                }
            }
        }
    }
    
    // 刷新selectpicker并设置已修炼的厨师为选中状态
    $("#chk-cal-partial-ultimate").selectpicker('refresh');
    if (ultimatedChefIds.length > 0) {
        $("#chk-cal-partial-ultimate").selectpicker('val', ultimatedChefIds);
    }
}
function setSelfUltimateOptions(e) {
    var count = 0;
    var skipped = [];
    
    // 获取本地数据，用于检查厨师是否已修炼
    var localData = getLocalData();
    var ultimatedChefIds = []; // 存储已修炼的厨师ID
    
    for (var a in e) {
        var hasValidSkill = false;
        for (var t in e[a].ultimateSkillEffect) {
            var i = e[a].ultimateSkillEffect[t];
            if ("Self" == i.condition && "Material_Gain" != i.type) {
                var l = "<option value='" + e[a].chefId + "' data-subtext='" + e[a].ultimateSkillDisp.replace(/<br>/g, " ") + "'>" + e[a].name + "</option>";
                $("#chk-cal-self-ultimate").append(l);
                count++;
                hasValidSkill = true;
                
                // 检查该厨师是否已修炼
                if (localData && localData.chefs) {
                    for (var lci = 0; lci < localData.chefs.length; lci++) {
                        if (localData.chefs[lci].id == e[a].chefId && "是" == localData.chefs[lci].ult) {
                            ultimatedChefIds.push(e[a].chefId);
                            break;
                        }
                    }
                }
                
                break
            }
        }
    }
    
    // 刷新selectpicker并设置已修炼的厨师为选中状态
    $("#chk-cal-self-ultimate").selectpicker('refresh');
    if (ultimatedChefIds.length > 0) {
        $("#chk-cal-self-ultimate").selectpicker('val', ultimatedChefIds);
    }
}
function setExOptions(e) {
    for (var a in e) {
        var t = "<option value='" + e[a].recipeId + "' data-subtext='+" + e[a].exPrice + "'>" + e[a].name + "</option>";
        $("#chk-cal-ex").append(t)
    }
}
function setDataForRecipe(e, a, t, i, l, s) {
    if (e.limitVal = e.limit,
    e.ultimateAddition = 0,
    !s || !s.hasOwnProperty("DisableChefSkillEffect") || 0 == s.DisableChefSkillEffect) {
        for (var c in a)
            "MaxEquipLimit" == a[c].type && a[c].rarity == e.rarity && (e.limitVal += a[c].value);
        e.ultimateAddition = getRecipeAddition(a, null, null, e, null, s).price
    }
    for (var c in i)
        "MaxEquipLimit" == i[c].type && i[c].rarity == e.rarity && (e.limitVal += i[c].value);
    e.limitDisp = getAtrributeDisp(e.limitVal, e.limit, l),
    e.ultimateAdditionDisp = getPercentDisp(e.ultimateAddition),
    e.activityAddition = getRecipeAddition(i, null, null, e, null, s).price,
    e.activityAdditionDisp = getPercentDisp(e.activityAddition),
    e.price = e.oPrice,
    t && (e.price += e.exPrice),
    e.priceDisp = getAtrributeDisp(e.price, e.oPrice, l),
    e.totalPrice = e.price * e.limitVal,
    e.totalTime = e.time * e.limitVal,
    e.totalTimeDisp = secondsToTime(e.totalTime)
}
function getRankOptions() {
    var e = []
      , a = {
        display: "",
        value: ""
    };
    return e.push(a),
    a = {},
    a.display = "优",
    a.value = "优",
    e.push(a),
    a = {},
    a.display = "特",
    a.value = "特",
    e.push(a),
    a = {},
    a.display = "神",
    a.value = "神",
    e.push(a),
    a = {},
    a.display = "传",
    a.value = "传",
    e.push(a),
    e
}
function getCondimentDisp(e) {
    return "Sweet" == e ? "甜" : "Sour" == e ? "酸" : "Spicy" == e ? "辣" : "Salty" == e ? "咸" : "Bitter" == e ? "苦" : "Tasty" == e ? "鲜" : ""
}
function getGotOptions() {
    var e = []
      , a = {
        display: "否",
        value: ""
    };
    return e.push(a),
    a = {},
    a.display = "是",
    a.value = "是",
    e.push(a),
    e
}
function getEquipsOptions(e, a) {
    var t = [];
    if (a) {
        var i = {
            display: "无厨具",
            subtext: "",
            tokens: "",
            value: "",
            class: "hidden"
        };
        t.push(i)
    }
    for (var l in e) {
        var s = e[l].skillDisp.replace(/<br>/g, " ");
        i = {};
        i.display = e[l].name,
        i.subtext = s,
        i.tokens = e[l].name + s,
        i.value = e[l].equipId,
        t.push(i)
    }
    return t
}
function getDiskLevelsOptions(e) {
    for (var a = [], t = 1; t <= e.maxLevel; t++) {
        var i = {};
        i.display = "心法盘等级 " + t,
        i.value = t,
        e.level == t && (i.selected = !0),
        a.push(i)
    }
    return a
}
function getAmberBtnClass(e) {
    return 1 == e ? "btn-danger" : 2 == e ? "btn-success" : 3 == e ? "btn-primary" : "btn-default"
}
function getAmbersOptions(e, a, t) {
    var i = [];
    if (t) {
        var l = {
            display: "无遗玉",
            subtext: "",
            tokens: "",
            value: "",
            class: "hidden"
        };
        i.push(l)
    }
    for (var s in e) {
        var c = e[s];
        if (!a || c.type == a.type) {
            var r = e[s].skillDisp.replace(/<br>/g, " ");
            l = {};
            l.display = c.name,
            l.subtext = r,
            l.tokens = c.name + r,
            l.value = c.amberId,
            a && a.data && a.data.amberId == c.amberId && (l.selected = !0),
            i.push(l)
        }
    }
    return i
}
function getOptionsString(e) {
    var a = "";
    return $.each(e, function(e, t) {
        a = a + "<option value='" + t.value + "'",
        t.tokens && (a += " data-tokens='" + t.tokens + "'"),
        t.subtext && (a += " data-subtext='" + t.subtext + "'"),
        t.content && (a += ' data-content="' + t.content + '"'),
        t.class && (a += " class='" + t.class + "'"),
        t.category && (a += " data-category='" + t.category + "'"),
        t.skillValues && (a += " data-skill-values='" + JSON.stringify(t.skillValues).replace(/'/g, "&apos;") + "'"),
        t.runeName && (a += " data-rune-name='" + t.runeName + "'"),
        t.guestNames && (a += " data-guest-names='" + t.guestNames + "'"),
        t.time !== undefined && (a += " data-time='" + t.time + "'"),
        t.disabled && (a += " disabled"),
        t.selected && (a += " selected"),
        a += ">" + t.display + "</option>"
    }),
    a
}
function getSkillInfo(e, a) {
    var t = {}
      , i = ""
      , l = []
      , s = [];
    if (!a || a === null || a === undefined) {
        return t.skillDisp = i,
        t.skillEffect = l,
        t
    }
    for (var c in a.constructor === Array ? s = a : a && s.push(a),
    s) {
        var r = !1;
        for (var n in e)
            if (e[n].skillId == s[c]) {
                i += e[n].desc + "<br>",
                l = l.concat(e[n].effect),
                r = !0;
                break
            }
        r || console.log(s[c])
    }
    return t.skillDisp = i,
    t.skillEffect = l,
    t
}
function getSkillDisp(e) {
    var a = "";
    return e.stirfry && (a += "<span>炒" + e.stirfry + "</span>"),
    e.boil && (a += "<span>煮" + e.boil + "</span>"),
    e.knife && (a += "<span>切" + e.knife + "</span>"),
    e.fry && (a += "<span>炸" + e.fry + "</span>"),
    e.bake && (a += "<span>烤" + e.bake + "</span>"),
    e.steam && (a += "<span>蒸" + e.steam + "</span>"),
    a
}
function GetDiskDisp(e) {
    var a = "心法盘等级 " + e.level + "<br>";
    for (var t in e.ambers) {
        var i = e.ambers[t];
        a += getAmberTypeDisp(i.type),
        i.data && (a += "-" + i.data.name),
        a += " "
    }
    return a
}
function getAmberTypeDisp(e) {
    return 1 == e ? "红" : 2 == e ? "绿" : 3 == e ? "蓝" : ""
}
function getAmberDisplayByLevel(e, a) {
    var t = e.effect[0].value + (a - 1) * e.amplification;
    return e.desc.replace(/_/g, t)
}
function getAmberEffectByLevel(e, a) {
    var t = JSON.parse(JSON.stringify(e.effect));
    for (var i in t)
        t[i].value = t[i].value + (a - 1) * e.amplification;
    return t
}
function getAmberInfo(e, a) {
    var t = null;
    if (e)
        for (var i in a)
            if (e == a[i].amberId)
                return a[i];
    return t
}
function updateModalAmberDisplay(e, a, t) {
    var i = "";
    a && (i = "<div class='icon'>" + a.icon + "</div><small>" + getAmberDisplayByLevel(a, t) + "</small>"),
    $("#disk-modal .amber-box:eq(" + e + ") .content").html(i)
}
function getDecorationAvgEffDisp(e, a) {
    var t = "(理论)" + +e.toFixed(1);
    return a && (t += " (实际)" + +a.toFixed(1)),
    t
}
function getMaxLimit(e, a) {
    var t = 0;
    for (var i in 1 == a ? t = 40 : 2 == a ? t = 30 : 3 == a ? t = 25 : 4 == a ? t = 20 : 5 == a && (t = 15),
    e.ultimateData.global)
        if (e.ultimateData.global[i].rarity == a && "MaxEquipLimit" == e.ultimateData.global[i].type) {
            t += e.ultimateData.global[i].value;
            break
        }
    var l = $("#chk-recipe-show-chef").val();
    if (1 == l.length) {
        var s = l[0];
        for (var i in e.chefs)
            if (e.chefs[i].chefId == s) {
                var c = e.chefs[i];
                for (var r in c.maxLimitEffect)
                    c.maxLimitEffect[r].rarity == a && (t += c.maxLimitEffect[r].value);
                break
            }
    }
    return t
}
function monitorStyle() {
    $("select.monitor-none").on("changed.bs.select", function() {
        changeSelectStyle(this)
    }),
    $("input[type=text].monitor-none, input[type=number].monitor-none").on("input", function() {
        changeInputStyle(this)
    }),
    $("input[type=checkbox].monitor-none").click(function() {
        changeCheckStyle(this)
    })
}
function changeSelectStyle(e) {
    var val = $(e).val();
    (val == null || val.length == 0) ? $(e).selectpicker("setStyle", "btn-info", "remove") : $(e).selectpicker("setStyle", "btn-info", "add")
}
function changeInputStyle(e) {
    $.trim($(e).val()).length > 0 ? $(e).addClass("btn-info") : $(e).removeClass("btn-info")
}
function changeCheckStyle(e) {
    $(e).prop("checked") ? $(e).closest(".btn").addClass("btn-info") : $(e).closest(".btn").removeClass("btn-info")
}
function checkMonitorStyle() {
    $("input[type=text].monitor-none, input[type=number].monitor-none").each(function() {
        changeInputStyle(this)
    }),
    $("input[type=search].monitor-none").each(function() {
        changeInputStyle(this)
    }),
    $("input[type=checkbox].monitor-none").each(function() {
        changeCheckStyle(this)
    })
}
function arraysEqual(e, a) {
    if (e.length != a.length)
        return !1;
    for (var t = 0; t < e.length; t++)
        if (a.indexOf(e[t]) < 0)
            return !1;
    return !0
}
function changeTableHeaderClass(e, a, t) {
    t ? $(e.column(a).header()).removeClass("none never").addClass("all") : $(e.column(a).header()).removeClass("all never").addClass("none")
}
function resetExpendColumn(e, a) {
    var t = $(a).val()
      , i = a + " option"
      , l = $(i + ":first").val()
      , s = t.indexOf(l);
    s >= 0 && t.splice(s, 1),
    t.length == $(i).length - 1 && changeTableHeaderClass(e, Number(l), !1)
}
function initRecipeShow() {
    var e = $("#recipe-table").DataTable();
    $("#chk-recipe-show option").each(function() {
        var colIndex = Number($(this).val());
        // 跳过专精列（20和21），这两列只由专精等级选择框控制
        if (colIndex !== 20 && colIndex !== 21) {
            changeTableHeaderClass(e, colIndex, this.selected);
        }
    });
    for (var a = $("#chk-recipe-show option[value=5]").is(":selected"), t = 6; t <= 10; t++)
        changeTableHeaderClass(e, t, a);
    resetExpendColumn(e, "#chk-recipe-show"),
    e.responsive.rebuild(),
    e.responsive.recalc(),
    e.columns.adjust().draw(!1)
}
function initChefShow() {
    var e = $("#chef-table").DataTable();
    $("#chk-chef-show option").each(function() {
        changeTableHeaderClass(e, Number($(this).val()), this.selected)
    });
    for (var a = $("#chk-chef-show option[value=5]").is(":selected"), t = 6; t <= 10; t++)
        changeTableHeaderClass(e, t, a);
    var i = $("#chk-chef-show option[value=12]").is(":selected");
    // 采集选项只控制第12-15列（肉、面、菜、鱼）
    for (t = 12; t <= 15; t++)
        changeTableHeaderClass(e, t, i);
    // 采集期望值列（第16列）由独立选项控制，在上面的each循环中已处理
    // 采集类型列（第17列）的显示由采集组合下拉框控制，在updateChefMaterialComboColumn中处理
    for (i = $("#chk-chef-show option[value=19]").is(":selected"),
    t = 19; t <= 24; t++)
        changeTableHeaderClass(e, t, i);
    resetExpendColumn(e, "#chk-chef-show"),
    e.responsive.rebuild(),
    e.responsive.recalc(),
    e.columns.adjust().draw(!1)
}
function updateChefMaterialComboColumn() {
    var e = $("#chef-table").DataTable()
      , a = $("#chk-chef-material-combo").val();
    if (a) {
        // 选择了采集组合，显示采集类型列
        e.column(17).visible(true);
        
        // 确保列不会被responsive隐藏
        $(e.column(17).header()).removeClass("never").addClass("all");

        var t = {
            meat_creation: "肉+面（苦）",
            meat_veg: "肉+菜（甜）",
            meat_fish: "肉+鱼（酸）",
            creation_veg: "面+菜（咸）",
            creation_fish: "面+鱼（鲜）",
            veg_fish: "菜+鱼（辣）"
        };
        var i = t[a] || a;
        e.column(17).header().innerHTML = "采集类型-" + i;
        
        e.rows().every(function(index) {
            var row = this.data();
            var comboValue = 0;
            
            if (a === "meat_creation") {
                comboValue = (row.meatVal || 0) + (row.creationVal || 0);
            } else if (a === "meat_veg") {
                comboValue = (row.meatVal || 0) + (row.vegVal || 0);
            } else if (a === "meat_fish") {
                comboValue = (row.meatVal || 0) + (row.fishVal || 0);
            } else if (a === "creation_veg") {
                comboValue = (row.creationVal || 0) + (row.vegVal || 0);
            } else if (a === "creation_fish") {
                comboValue = (row.creationVal || 0) + (row.fishVal || 0);
            } else if (a === "veg_fish") {
                comboValue = (row.vegVal || 0) + (row.fishVal || 0);
            }
            
            row.materialCombo = comboValue;
            this.data(row);
        });
    } else {
        // 清空了采集组合，隐藏采集类型列
        e.column(17).visible(false);
        
        // 恢复列的responsive类
        $(e.column(17).header()).removeClass("all").addClass("never");
        
        e.column(17).header().innerHTML = "采集类型";
        e.rows().every(function(index) {
            var row = this.data();
            row.materialCombo = "";
            this.data(row);
        });
    }
    
    // 重新计算responsive和调整列
    e.responsive.rebuild();
    e.responsive.recalc();
    e.columns.adjust().draw(!1)
}
function initEquipShow() {
    var e = $("#equip-table").DataTable();
    $("#chk-equip-show option").each(function() {
        changeTableHeaderClass(e, Number($(this).val()), this.selected)
    }),
    resetExpendColumn(e, "#chk-equip-show"),
    e.responsive.rebuild(),
    e.responsive.recalc(),
    e.columns.adjust().draw(!1)
}
function initAmberShow() {
    var e = $("#amber-table").DataTable();
    $("#chk-amber-show option").each(function() {
        changeTableHeaderClass(e, Number($(this).val()), this.selected)
    }),
    resetExpendColumn(e, "#chk-amber-show"),
    e.responsive.rebuild(),
    e.responsive.recalc(),
    e.columns.adjust().draw(!1)
}
function initCondimentShow() {
    var e = $("#condiment-table").DataTable();
    $("#chk-condiment-show option").each(function() {
        changeTableHeaderClass(e, Number($(this).val()), this.selected)
    }),
    resetExpendColumn(e, "#chk-condiment-show"),
    e.responsive.rebuild(),
    e.responsive.recalc(),
    e.columns.adjust().draw(!1)
}
function initDecorationShow() {
    var e = $("#decoration-table").DataTable();
    $("#chk-decoration-show option").each(function() {
        changeTableHeaderClass(e, Number($(this).val()), this.selected)
    }),
    resetExpendColumn(e, "#chk-decoration-show"),
    e.responsive.rebuild(),
    e.responsive.recalc(),
    e.columns.adjust().draw(!1)
}
function initQuestShow(e) {
    e.column(1).visible("旧支线任务" == $("#select-quest-type").val(), !1),
    e.columns.adjust().draw(!1)
}
function initCalChefsShow(e) {
    $("#chk-cal-chefs-show option").each(function() {
        changeTableHeaderClass(e, Number($(this).val()), this.selected)
    });
    for (var a = $("#chk-cal-chefs-show option[value=5]").is(":selected"), t = 6; t <= 10; t++)
        changeTableHeaderClass(e, t, a);
    resetExpendColumn(e, "#chk-cal-chefs-show"),
    e.responsive.rebuild(),
    e.responsive.recalc(),
    e.columns.adjust().draw(!1)
}
function initCalEquipsShow(e) {
    $("#chk-cal-equips-show option").each(function() {
        changeTableHeaderClass(e, Number($(this).val()), this.selected)
    }),
    resetExpendColumn(e, "#chk-cal-equips-show"),
    e.responsive.rebuild(),
    e.responsive.recalc(),
    e.columns.adjust().draw(!1)
}
function initCalMaterialsShow(e) {
    $("#chk-cal-materials-show option").each(function() {
        changeTableHeaderClass(e, Number($(this).val()), this.selected)
    }),
    resetExpendColumn(e, "#chk-cal-materials-show"),
    e.responsive.rebuild(),
    e.responsive.recalc(),
    e.columns.adjust().draw(!1)
}
function initCalRecipesShow(e) {
    $("#chk-cal-recipes-show option").each(function() {
        changeTableHeaderClass(e, Number($(this).val()), this.selected)
    });
    for (var a = $("#chk-cal-recipes-show option[value=16]").is(":selected"), t = 17; t <= 21; t++)
        changeTableHeaderClass(e, t, a);
    resetExpendColumn(e, "#chk-cal-recipes-show"),
    private || e.column(0).visible(!1, !1);
    var i = calCustomRule.rules[0];
    i && i.hasOwnProperty("MaterialsNum") ? e.column(5).visible(!0, !1) : e.column(5).visible(!1, !1),
    i && i.showTime && e.column(9).visible(!0, !1),
    i && i.showEff && e.column(10).visible(!0, !1),
    e.responsive.rebuild(),
    e.responsive.recalc(),
    e.columns.adjust().draw(!1)
}
function initCalCustomShow() {
    var e = $("#chk-cal-ui-show").val();
    e.indexOf("chef_icon") >= 0 ? $(".chef-box-1").removeClass("no-icon") : $(".chef-box-1").addClass("no-icon"),
    e.indexOf("chef_skill") >= 0 ? $(".chef-box-1").removeClass("no-skill") : $(".chef-box-1").addClass("no-skill"),
    e.indexOf("amber") >= 0 ? $(".chef-box-2").removeClass("no-box") : $(".chef-box-2").addClass("no-box"),
    e.indexOf("amber_icon") >= 0 ? $(".chef-box-2").removeClass("no-icon") : $(".chef-box-2").addClass("no-icon"),
    e.indexOf("amber_skill") >= 0 ? $(".chef-box-2").removeClass("no-skill") : $(".chef-box-2").addClass("no-skill"),
    e.indexOf("equip_icon") >= 0 ? $(".equip-box").removeClass("no-icon") : $(".equip-box").addClass("no-icon"),
    e.indexOf("equip_skill") >= 0 ? $(".equip-box").removeClass("no-skill") : $(".equip-box").addClass("no-skill"),
    e.indexOf("condiment") >= 0 ? $(".condiment-box").removeClass("no-condiment") : $(".condiment-box").addClass("no-condiment"),
    e.indexOf("condiment_icon") >= 0 ? $(".condiment-box").removeClass("no-icon") : $(".condiment-box").addClass("no-icon"),
    e.indexOf("condiment_skill") >= 0 ? $(".condiment-box").removeClass("no-skill") : $(".condiment-box").addClass("no-skill"),
    e.indexOf("recipe_icon") >= 0 ? $(".recipe-box-1").removeClass("no-icon") : $(".recipe-box-1").addClass("no-icon"),
    e.indexOf("recipe_time") >= 0 ? $(".recipe-box-1").removeClass("no-time") : $(".recipe-box-1").addClass("no-time"),
    e.indexOf("recipe_rarity") >= 0 ? $(".recipe-box-2").removeClass("no-rarity") : $(".recipe-box-2").addClass("no-rarity"),
    e.indexOf("recipe_skill") >= 0 ? $(".recipe-box-2").removeClass("no-skill") : $(".recipe-box-2").addClass("no-skill"),
    e.indexOf("recipe_material") >= 0 ? $(".recipe-box-2").removeClass("no-material") : $(".recipe-box-2").addClass("no-material"),
    e.indexOf("recipe_add") >= 0 ? $(".recipe-box-2").removeClass("no-add") : $(".recipe-box-2").addClass("no-add"),
    e.indexOf("recipe_rarity") < 0 && e.indexOf("recipe_skill") < 0 && e.indexOf("recipe_material") < 0 && e.indexOf("recipe_add") < 0 ? $(".recipe-box-2").addClass("hidden") : $(".recipe-box-2").removeClass("hidden"),
    resizeCalCustomTable()
}
function initInfo(e) {
    $("#pagination-history").pagination({
        dataSource: e.history,
        callback: function(e, a) {
            var t = historyTemplate(e);
            $("#data-history").html(t)
        },
        pageSize: 5,
        showPageNumbers: !1,
        showNavigator: !0,
        showPrevious: !0,
        showNext: !0
    })
}
function historyTemplate(e) {
    var a = '<table class="table table-condensed history-table">';
    return $.each(e, function(e, t) {
        a += '<tr><td class="history-dt">' + t.date + "</td><td>" + t.content + "<td></tr>"
    }),
    a += "</table>",
    a
}
function initVersionTip(e) {
    $(".alert-version").each(function() {
        if ("true" == $(this).attr("data-show")) {
            var a = $(this).attr("data-id")
              , t = Number($(this).attr("data-version"))
              , i = !0;
            e && e[a] && Number(e[a]) == t && (i = !1),
            i && $(this).removeClass("hidden"),
            $(this).on("closed.bs.alert", function() {
                updateLocalData(a, t),
                isMobile && updateScrollHeight()
            })
        }
    })
}
function getInputHtml(e, a, t, i, l) {
    var s, c, r;
    switch (r = {
        type: "input",
        html: null,
        settings: null
    },
    t.inputTypes && $.each(t.inputTypes, function(e, t) {
        t.column == a && (s = t,
        c = s.type.toLowerCase())
    }),
    r.settings = s,
    c) {
    case "list":
        var n = "data-live-search='false'";
        s.search && (n = "data-live-search='true'");
        var o, p = " ";
        s.clear && (p = " data-actions-box='true' data-deselect-all-text='清空'"),
        s.done && (p += " data-done-button='true' data-done-button-text='关闭'"),
        r.html = "<div class='table-select-picker' style='left:" + l.clientX + "px;top:" + l.clientY + "px'><select " + n + p + " data-width='fit' data-dropdown-align-right='auto' data-live-search-placeholder='查找' data-none-results-text='没有找到' data-none-selected-text=''>",
        o = s.optionsp ? s.options[e] : s.options,
        $.each(o, function(e, a) {
            r.html = r.html + "<option value='" + a.value + "'",
            a.tokens && (r.html += " data-tokens='" + a.tokens + "'"),
            a.subtext && (r.html += " data-subtext='" + a.subtext + "'"),
            a.class && (r.html += " class='" + a.class + "'"),
            i == a.value && (r.html += " selected"),
            r.html += ">" + a.display + "</option>"
        }),
        r.html = r.html + "</select></div>",
        r.type = c;
        break;
    default:
        var placeholder = s && s.placeholder ? " placeholder='" + s.placeholder + "'" : "";
        var inputValue = s && s.data !== undefined ? s.data : i;
        var inputType = s && s.inputType ? " type='" + s.inputType + "'" : "";
        var minMax = s && s.min !== undefined && s.max !== undefined ? " min='" + s.min + "' max='" + s.max + "'" : "";
        var style = s && s.inputType === "number" ? " style='width: 100px;'" : "";
        r.html = "<input class='form-control' value='" + inputValue + "'" + inputType + minMax + placeholder + style + "></input>"
    }
    return r
}
function sanitizeCellValue(e) {
    return null == e || e.length < 1 ? "" : (isNaN(e) && (e = e.replace(/'/g, "&#39;")),
    e)
}
function getParameterByName(e, a) {
    a || (a = window.location.href),
    e = e.replace(/[\[\]]/g, "\\$&");
    var t = new RegExp("[?&]" + e + "(=([^&#]*)|&|#|$)")
      , i = t.exec(a);
    return i ? i[2] ? decodeURIComponent(i[2].replace(/\+/g, " ")) : "" : null
}
function UpdateQueryString(e, a, t) {
    t || (t = window.location.href);
    var i, l = new RegExp("([?&])" + e + "=.*?(&|#|$)(.*)","gi");
    if (l.test(t))
        return null != a ? t.replace(l, "$1" + e + "=" + a + "$2$3") : (i = t.split("#"),
        t = i[0].replace(l, "$1$3").replace(/(&|\?)$/, ""),
        void 0 !== i[1] && null !== i[1] && (t += "#" + i[1]),
        t);
    if (null != a) {
        var s = -1 !== t.indexOf("?") ? "&" : "?";
        return i = t.split("#"),
        t = i[0] + s + e + "=" + a,
        void 0 !== i[1] && null !== i[1] && (t += "#" + i[1]),
        t
    }
    return t
}
function escapeHtml(e) {
    return e.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;")
}
function centerModal() {
    var e = $(this).find(".modal-dialog");
    $(window).width() >= 767 ? e.css("margin-top", Math.max(0, ($(window).height() - e.height()) / 2)) : e.css("margin-top", "")
}
var calCustomRule, private = !1, isMobile = !1, expendBtn = !0, isAllUltimateMode = !1;
$.fn.dataTable.Api.register("MakeCellsEditable()", function(e) {
    var a = this.table();
    $.fn.extend({
        updateEditableCell: function(e, a) {
            var t = $(e).closest("table").DataTable().table()
              , i = t.row($(e).parents("tr"))
              , l = t.cell($(e).closest("td"))
              , s = $(e)
              , c = l.data()
              , r = s.val();
            l.data(r),
            a.onUpdate && a.onUpdate(t, i, l, c)
        }
    }),
    "destroy" === e && ($(a.body()).off("click", "td"),
    a = null),
    null != a && $(a.body()).on("click", "td", function(t) {
        if (!$(this).hasClass("child") && !$(this).hasClass("dataTables_empty")) {
            var i = a.cell(this).index().row
              , l = a.cell(this).index().column;
            if (e.columns && e.columns.indexOf(l) > -1 || !e.columns) {
                var s = a.cell(this).node()
                  , c = a.cell(this).data();
                if (c = sanitizeCellValue(c),
                !$(s).find("input").length && !$(s).find("select").length) {
                    var r = getInputHtml(i, l, e, c, t);
                    $(s).html($(s).html() + r.html),
                    "input" == r.type ? $(s).find("input").select().focus().on("focusout", function() {
                        $(this).updateEditableCell(this, e)
                    }) : "list" == r.type && ($(a.cells().nodes()).removeClass("editing"),
                    $(s).addClass("editing"),
                    $(s).find("select").selectpicker("hide").on("hidden.bs.select", function(a) {
                        $(this).updateEditableCell(this, e),
                        $(s).removeClass("editing")
                    }),
                    $(s).find("select").on("show.bs.select", function(e) {
                        var a = $(s).find(".dropdown-menu")
                          , i = a.outerWidth()
                          , l = t.clientX;
                        if (a.hasClass("dropdown-menu-right")) {
                            var c = i - l;
                            c > 0 && (l += c,
                            $(s).find(".table-select-picker").css("left", l))
                        } else {
                            c = i - $(window).width() + l;
                            c > 0 && (l -= c,
                            $(s).find(".table-select-picker").css("left", l))
                        }
                    }),
                    setTimeout(function() {
                        $(s).find("select").selectpicker("show").selectpicker("toggle")
                    }, 0))
                }
            }
        }
    })
}),
$(function() {
    $(".modal.center").on("shown.bs.modal", centerModal),
    $(window).on("resize", function() {
        $(".modal.center:visible").each(centerModal),
        resizeCalCustomTable()
    }),
    $.popupmsg = function(e) {
        var a, t, i = $.extend({
            event: null,
            message: "",
            mleft: 0,
            mtop: 0,
            fade: !0,
            delay: 1e3,
            type: "alert-info"
        }, e);
        i.message ? (0 == $("#popupmsg").length && $("body").append("<div id='popupmsg'></div>"),
        $("#popupmsg").stop(!0, !0).html(i.message),
        i.event ? (a = i.event.pageX - $(document).scrollLeft(),
        t = i.event.pageY - $(document).scrollTop() - 40) : (a = window.innerWidth / 2 - ($("#popupmsg").width() + 30) / 2,
        t = window.innerHeight / 2 - 40),
        $("#popupmsg").attr("class", "alert " + i.type),
        $("#popupmsg").css({
            left: a + i.mleft,
            top: t + i.mtop
        }).show(),
        i.fade && $("#popupmsg").delay(i.delay).fadeOut()) : $("#popupmsg").hide()
    }
});

